[{"id":"e18c38da.82ab78","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"38c422f8.b82bf6","type":"tab","label":"useback","disabled":false,"info":""},{"id":"5df15275.2888ec","type":"tab","label":"Flow 2","disabled":false,"info":""},{"id":"2a761808.610238","type":"tab","label":"ttp","disabled":false,"info":""},{"id":"5f98db3a.7ab21c","type":"tab","label":"API","disabled":false,"info":""},{"id":"89dcb365.f1eba","type":"group","z":"38c422f8.b82bf6","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["13f2257b.01983b","a445188a.34a218","71acd437.96b3dc","18fc789.fac9d87","79163972.5bdbe8","a9b8fcea.cf55d","e34cab2c.f35798","e545caa6.7236c8","623691b3.5a4c","d010274c.5b8918","23a461b5.8934de","34642144.ae139e"],"x":74,"y":859},{"id":"c0b0e6b5.5e71f","type":"group","z":"38c422f8.b82bf6","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["12960d0b.36ef23","3e18acb8.6ea274","90df249b.c0cbf"],"x":2154,"y":619},{"id":"339f6357.48270c","type":"group","z":"38c422f8.b82bf6","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["503437af.280cc8","8deed84b.3c9898","d4a5db44.14dd68","1cce308b.ed6fef","4a9286e5.e8f4e8","29caead0.b6b606","2c379b0e.e23f04","7ecd73a6.b4458c","5ad83996.397588","3c339a4d.3cb876","7e0a8361.60fa3c","e7c33b5d.af48d8","89105352.909da","ed38b6eb.ce69b","3df007b7.771648"],"x":74,"y":379},{"id":"6d0bae3e.4983b8","type":"group","z":"38c422f8.b82bf6","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["7792f18e.f49f5","4d01ab16.cd9554","e68822f4.50329","d42587f0.33b758","eb102c0d.9fc26","da9e4dd8.dda28","536d19d6.716798","9d731fd4.ec333","ab453ff0.f0607","e72704f9.38636","2e2d6018.33d4f8","cf8e2d12.ded23","1b14a050.631f9","1692a27.8368fde","cc1a6775.26469","83eb55cb.4546","8e1f3271.c24088"],"x":74,"y":619},{"id":"3a58fc05.972e0c","type":"group","z":"38c422f8.b82bf6","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["79227fcb.dc9d18","9a3b7f9.5e6b8","e7bf2df8.cfa0a","81f7b446.8c8718","4cbecb3c.bf7ee4","ef77d89b.b36608"],"x":1094,"y":59},{"id":"c4471f11.5e9398","type":"group","z":"38c422f8.b82bf6","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["168e0396.d38efc","c971a180.2a71c8","f13d409b.6445f8","76409bc.077dee4"],"x":1134,"y":1639},{"id":"205eec04.74c0d4","type":"group","z":"38c422f8.b82bf6","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["78ca5c87.8628d4","ac559e43.94903","160b4dd4.4f8e12","61b59ea7.10c3a","550838d7.0c4118","89848e2c.9b815","f369c890.c7bf58","e7b2e93a.d772a8","99328f1c.3a173","d9c2af4e.ac296","6efa7034.90b4e","b3a83312.3848e","ce43fd6d.7b213","10907153.2feab7","2bde6947.f7ecae","27dbb0df.4fa588","4377a687.40ea08","dc26dcc0.bdbe6","64ef31ed.e495e8","34f31521.2b27d2","5e6d0362.224584","230838f7.7d169","415a64d7.94e364","63a1b9e8.5ea0a","650ece50.fb118","e7d6b6d2.32065"],"x":74,"y":1079},{"id":"945a2cf3.e1d6b8","type":"group","z":"38c422f8.b82bf6","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["4bec0d5b.469514","5f90666a.62c228","52aaa619.191ba8","2fe76646.8b5a0a","5a6c84db.e2549c","f29872c6.957f88","41a863d8.9f125c","abce4774.171ad8","7e390ec5.73031","1c21e572.487e03","4dd8ae72.bac7a8","645bd981.f21eb","cfa961f2.56de9","a9c4dd18.15e2d8","93e330da.07ba58","7a1798ac.2961e","cecfe42a.4e6e6","73a29c92.5b5454","cedee7.bd3d7118","829d56ef.f0827"],"x":74,"y":39},{"id":"3e767551.3d299a","type":"group","z":"5df15275.2888ec","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["133c3e4a.687a62","a7ef7b74.1301e8","9f82a757.25f3d"],"x":2334,"y":1059,"w":372,"h":202},{"id":"bc481bc2.f1ae08","type":"group","z":"5df15275.2888ec","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["7ee8ada7.9818bc","e0440623.2ec6e","cba3e711.97d4a8","c23f0bc3.badbc","6eb4d4b9.112f6c","b0b01bc4.45a1e8","a359f524.2e00e8","cf20b67b.cbc6e","a0142b1a.f25d9","941fc9d2.76b05","8040b017.7a26f8","189b2b68.7c485d","842e37da.0d09"],"x":2214,"y":1319,"w":1112,"h":262},{"id":"8fac538c.5d4a48","type":"group","z":"5df15275.2888ec","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["c3e2eace.6fef4","f88e6307.876b78","3e3a1491.e31a74","fb84e297.7e169","8275986.8fc5d68","97442da1.47403","c0dcb78d.280fb","da741b09.f3974","3201780f.c931f","d43a0074.4523c","d6651eda.7b83","dfa11988.0cfa6","9a76b6bf.1016d","fe2a6027.b22b48","4bd2ed9.fa5d114","a790f90b.998d8","b080e3fb.60616","bec7265d.ad8278","cec096cd.d93358","be118eed.3c8348","5bbb44fa.ec4574","aa865712.dd6a08","3b6f26a5.932aba"],"x":34,"y":1059,"w":2092,"h":222},{"id":"c2109678.33bc38","type":"group","z":"5df15275.2888ec","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["754f373f.b15518","444e001d.21432","5d94f71d.d3668","edea6dff.e44","1e4c98d9.ba7367","c982d578.5cca4","90d93514.efa9e8","24812b74.9bc644","54724e9d.5a21d8","5beb39ef.f84b7","a707b53d.3343e","2ac45d8.4ea1022","fe43ccbb.7a083","8f2b992a.2a5888","3d3d989e.3a00f","a2a98d92.7d7ac8","2ffac69a.1af06a","b72aec1b.3ff6d","36be307e.92e14","f00f32f3.dec218"],"x":34,"y":839,"w":2832,"h":202},{"id":"5b21035.9c9f6fc","type":"group","z":"5df15275.2888ec","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["fe0a5fc8.c442f","50d2f56d.d89b5c","24e3759c.ccab7a","493967b2.355f88","a77ec084.8fffe","81b674e0.619348","c192b5ce.f292e8","f5e48d6b.8af42","9c3f6550.f65078","534028b7.335048","d3e6b44f.196458","ac588a65.521198","496429d7.3e65b8","daa3ab85.3e3f08","839251af.05aeb","49b11422.104a8c","7417b1f3.5548","5602a224.0e7904","35ea30c8.7cd8b8"],"x":4094,"y":1479,"w":752,"h":502},{"id":"74a41043.26c49","type":"group","z":"5df15275.2888ec","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["eda0b98c.624f38","dda68ce4.be4548","33a98cf6.520fbc","cd451268.3a6058","14fd3fa0.82928","7cd3ed75.b496ac"],"x":74,"y":2619,"w":592,"h":122},{"id":"814286d0.6067d8","type":"group","z":"5df15275.2888ec","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["94da8ee9.b72fe","bf51802f.063bd","b7b9b18a.8dfb9","fded4c6c.fd4ec","8cca2e22.fccc2","c9b54b0d.edb998","cdb21624.aff3e8","62366394.d8c3cc","c6b1502f.7e4af"],"x":2614,"y":3199,"w":1382,"h":162},{"id":"8b69f61d.c89028","type":"group","z":"5df15275.2888ec","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["317ffc4b.f9f944","2da38506.59c15a","cd9c83a2.b44c9","98e142f2.2387b","9814b19b.3a9ff","657e86cb.b16d68","e3789e7.ad48a6","70ea442f.d8d06c","c6f7047b.a7d5b8","b878da1d.130a08","1b8e9eca.e770e1","e7053289.ff4a1","12823fc.46bb5c","53c0296c.86d5e8","567ea009.d6895","afeffd54.f2fdf","addf44a8.eeead8","38fa3076.5c174","51dac58a.ae1ccc","3b77b4a5.7373fc","35298c0e.de04e4"],"x":3914,"y":39,"w":1052,"h":502},{"id":"93990b56.ce7428","type":"group","z":"5df15275.2888ec","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["506a8391.c574dc","31e84ef9.15d452","5331f2f3.26e314","b876d5aa.b5314","193726e9.3199d9","c1a0c26f.ded73","7c1162f3.2e02bc","1180bcc7.96539b","74dd9f83.8b4a38","1ee92671.77db3a","890bff65.ae92a","7be2e3c6.f4f0dc","c18bfab4.a6c398","4a2da56.007bbdc","634b7ee.4a33b8","a2076fe3.e1e4c8","5c218091.24dc2","d9152924.0b6fa","8a90f52f.5e82b8","b9301109.6d837"],"x":3914,"y":579,"w":1052,"h":502},{"id":"154b2e1c.6272e2","type":"group","z":"5df15275.2888ec","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["9cbb75e6.0f4498","6f87fcb7.9335e4","d2e4b8ad.2f61c8","f0503628.d8df98","80d7c6d0.cd5e08","712f8721.08ce18"],"x":4014,"y":1119,"w":952,"h":82},{"id":"9234522a.3a33c","type":"group","z":"5df15275.2888ec","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["1a05e8c0.3a30d7","239253ed.cd5e7c","13685612.fa676a","192054d1.4fe29b","4c5eb819.338738","c94a0180.3474a","cefaef13.fdbe38"],"x":3834,"y":1239,"w":1132,"h":182},{"id":"c625f482.ef7058","type":"group","z":"5df15275.2888ec","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["8c51dfe6.41bf1","456373bf.34e8d4","9d5e1703.2251f8","88d1f442.5d291","bca0f523.f10a5","9929a915.a7192","84fc47b3.40a288","72938161.c1d328","39200d24.d193aa","2e79e684.725d42","6d61a71c.3be1e","d5710ed3.1f0ed8","82c581f1.3d7b2","4e808ea9.9699f8","c996e15f.6cd09","de421236.7ddad8","3ea27905.a93e8e","c419c89c.c82b7","ee122abb.ffdf2","dc63781f.d7f54","e12b76fa.94dc68","e1b6a373.027e3","be80ac0a.3fcc6","225135a2.08288a","32fd021f.9c3646","dce2a78c.7fb6c","22c83041.c57288","5a0e3510.93269c","274d4375.725ad4","dfdf853a.fea128","fc027fe9.e8d708","ba3e6008.7e12f8","3c92a9f.7208756","1bdf10d4.260a9f","4a190c44.e49f5c","3b3eb9c4.74e1ce","2508abe7.d6a684","f728a67.fc3a3d8","fd75bbec.1aee88","38fe7af7.4b2106","c458d7d.41524a8","c9147459.15de58","b9afe11.e8147a","1ecd91cb.e68c46","c3c68186.76c01","229ee0ff.22e48","e47a380a.5fd968","bcbb540b.558ae8","6115d0a9.4e59f","695f8ecb.2536a","63dd941.f161b6c","1fd9091b.b7c747","1da56dc9.817ee2","4af43326.f9b1bc","3e8866d4.739e9a","c83cd378.b93ca","3eef8d0b.468082","5799f4ed.f46bec","dd20db68.d00b68","e0daded4.e68d9","32d4b8b1.77def8","4c173f0f.94538","7b28a869.162e18","5775cffa.8e5f8","e7904fa1.77f64","2b86e90f.d5bac6"],"x":34,"y":99,"w":1552,"h":682},{"id":"c7dcb289.e5232","type":"group","z":"2a761808.610238","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["9f535577.3cdc98","203e6ef2.430c62","26cad534.28973a"],"x":2814,"y":219},{"id":"74e1a04.6df746","type":"group","z":"2a761808.610238","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["d4c6b3ea.b0118","a0ad9ee6.aa105","4c9d9272.a06d2c","ddf77463.b02678","599eef92.8ee31","77f17fe7.b95ae","799698b0.78a948","fe8b13e1.db5bf","10d73930.850c67","2e524180.ede67e","da5d3bc9.d65b18","461d3964.de54f8","5b61698e.e6e8b8","f18cbfd9.f0367","3d559730.32d2c8","f347b3fa.86c68","e7cd9c55.03487","7e462ed6.19cfd","3e882d4e.c91df2","1494284.0d799d8","8ff82160.e2aa7","c863368d.dbc0e8","c0f1d50f.14d058","3c03470a.507ec8"],"x":94,"y":219},{"id":"115b1d61.ba4ba3","type":"group","z":"2a761808.610238","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["6ae38ed.612797","9539cd06.048d1","61edcde5.92f5f4","4ea4b575.92fb0c","8d2ce50.2e70018","bdd4eff7.879af"],"x":94,"y":59},{"id":"79e296b2.11a2d8","type":"group","z":"5f98db3a.7ab21c","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["1adeb6d2.0028b1","174c55c9.364c72","af87984e.38efa8","af6bd09e.c7c798","9a835f6c.6a1ab"],"x":14,"y":19,"w":632,"h":162},{"id":"f120eab2.0a60a8","type":"redis-config","name":"redis:6379","options":"redis:6379","cluster":false,"optionsType":"str"},{"id":"acbee441.8c1e1","type":"ui_tab","name":"Home","icon":"dashboard","disabled":false,"hidden":false},{"id":"a328c3be.7f91c8","type":"ui_group","name":"BTC","tab":"acbee441.8c1e1","order":1,"disp":false,"width":"14","collapse":false},{"id":"7eefe30b.94c464","type":"ui_base","theme":{"name":"theme-dark","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#097479","value":"#097479","edited":true},"page-titlebar-backgroundColor":{"value":"#097479","edited":false},"page-backgroundColor":{"value":"#111111","edited":false},"page-sidebar-backgroundColor":{"value":"#333333","edited":false},"group-textColor":{"value":"#0eb8c0","edited":false},"group-borderColor":{"value":"#555555","edited":false},"group-backgroundColor":{"value":"#333333","edited":false},"widget-textColor":{"value":"#eeeeee","edited":false},"widget-backgroundColor":{"value":"#097479","edited":false},"widget-borderColor":{"value":"#333333","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"true","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"261e447.e94ad3c","type":"ui_group","name":"work mode","tab":"acbee441.8c1e1","order":2,"disp":true,"width":"6","collapse":false},{"id":"ab190c2e.90269","type":"graphql-server","endpoint":"http://strapi:1337/graphql","name":""},{"id":"848f142.6165868","type":"telegrambot-config","botname":"Tibot","usernames":"","chatIds":"454883204","pollInterval":"300"},{"id":"f244fee6.d2627","type":"ui_group","name":"ttp","tab":"acbee441.8c1e1","order":3,"disp":true,"width":"6","collapse":false},{"id":"3c770aff.9ba2a6","type":"ui_tab","name":"Main Tab","icon":"dashboard","order":1},{"id":"654fe96.8349098","type":"sqlitedb","db":"/data/sqlite.db","mode":"RWC"},{"id":"8f0952be.200eb","type":"sqlitedb","db":"test.sqlite"},{"id":"1c25415d.b8427f","type":"sqlitedb","db":"/data/sqlite.db","mode":"RWC"},{"id":"156af96f.f8fd27","type":"ui_tab","name":"Home","icon":"home","order":"1"},{"id":"1e3fe400.0baf5c","type":"ui_tab","name":"Reports","icon":"dashboard","order":9},{"id":"1545968.e1c906a","type":"debug","z":"e18c38da.82ab78","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":4250,"y":1400,"wires":[]},{"id":"f7720481.a6b768","type":"debug","z":"e18c38da.82ab78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4830,"y":1820,"wires":[]},{"id":"c8d58e7e.1e7bd","type":"inject","z":"e18c38da.82ab78","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":4300,"y":1820,"wires":[["e317dfb9.7d7d6"]]},{"id":"ac083a6a.9f5fb8","type":"inject","z":"e18c38da.82ab78","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"a\":1,\"b\":2}","payloadType":"json","x":4310,"y":1780,"wires":[["e317dfb9.7d7d6"]]},{"id":"436e7966.32db48","type":"inject","z":"e18c38da.82ab78","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":4300,"y":1880,"wires":[["5ddd1f18.80ccb"]]},{"id":"6947d8f0.801bc8","type":"debug","z":"e18c38da.82ab78","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":4810,"y":1880,"wires":[]},{"id":"fcc4fbad.ddd958","type":"catch","z":"e18c38da.82ab78","name":"","scope":null,"uncaught":false,"x":1000,"y":460,"wires":[["1936271a.516719"]]},{"id":"1936271a.516719","type":"debug","z":"e18c38da.82ab78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1150,"y":460,"wires":[]},{"id":"cac53ba2.730bf8","type":"inject","z":"e18c38da.82ab78","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"[\"key\",\"value\"]","payloadType":"json","x":4300,"y":1940,"wires":[["2edf9cf.3bc1064","858eec9b.c706b"]]},{"id":"858eec9b.c706b","type":"debug","z":"e18c38da.82ab78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":4810,"y":1940,"wires":[]},{"id":"d8fab639.e93688","type":"inject","z":"e18c38da.82ab78","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"key","payload":"[\"value\"]","payloadType":"json","x":4310,"y":2000,"wires":[["4195201e.7c0c2"]]},{"id":"1cc32d0c.3d2c23","type":"debug","z":"e18c38da.82ab78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":4810,"y":2000,"wires":[]},{"id":"b0f97501.fe7a08","type":"inject","z":"e18c38da.82ab78","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"myHash","payload":"{\"a\":1,\"b\":2}","payloadType":"json","x":4330,"y":2120,"wires":[["2cedf9d2.7b13f6"]]},{"id":"e3d6a8ff.a0fd68","type":"debug","z":"e18c38da.82ab78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":4810,"y":2120,"wires":[]},{"id":"37aea6c9.caf68a","type":"inject","z":"e18c38da.82ab78","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"false","payloadType":"bool","x":4290,"y":2180,"wires":[["7e3816a4.30a3e8"]]},{"id":"1841c999.5b1966","type":"debug","z":"e18c38da.82ab78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":4810,"y":2180,"wires":[]},{"id":"da8feb7a.117ed8","type":"inject","z":"e18c38da.82ab78","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"false","payloadType":"bool","x":3590,"y":2240,"wires":[["434c360e.228778"]]},{"id":"9f711677.ee0268","type":"debug","z":"e18c38da.82ab78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":4110,"y":2240,"wires":[]},{"id":"b9db9bc4.92afd8","type":"inject","z":"e18c38da.82ab78","name":"start","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"botname","v":"payload.botname","vt":"msg"},{"p":"start","v":"","vt":"date"},{"p":"userid","v":"d3fmoh2rVoVNgIcpLTFZBE0jHnI2","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"botlist:d3fmoh2rVoVNgIcpLTFZBE0jHnI2","payload":"{}","payloadType":"json","x":176,"y":640,"wires":[[]]},{"id":"cdf56fc8.88d7d","type":"inject","z":"e18c38da.82ab78","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":4300,"y":2360,"wires":[["90058663.4f0bd8"]]},{"id":"2bc51ced.3ff1f4","type":"debug","z":"e18c38da.82ab78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4830,"y":2360,"wires":[]},{"id":"7e0a5330.f69bac","type":"inject","z":"e18c38da.82ab78","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"false","payloadType":"bool","x":3590,"y":2300,"wires":[["23fd40d3.acb38"]]},{"id":"349f6ec3.6b7852","type":"debug","z":"e18c38da.82ab78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":4110,"y":2300,"wires":[]},{"id":"cd0e6fa6.c019a","type":"inject","z":"e18c38da.82ab78","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":4300,"y":2420,"wires":[["3db5b456.716e3c"]]},{"id":"89688cf4.1cf64","type":"debug","z":"e18c38da.82ab78","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":4830,"y":2420,"wires":[]},{"id":"2c0c2179.bcb1ee","type":"debug","z":"e18c38da.82ab78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":4830,"y":1600,"wires":[]},{"id":"58e730d0.10957","type":"debug","z":"e18c38da.82ab78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":4830,"y":1660,"wires":[]},{"id":"1a45847f.7c2afc","type":"inject","z":"e18c38da.82ab78","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"a\":1,\"b\":2}","payloadType":"json","x":4230,"y":1680,"wires":[["7de99e6d.248ca"]]},{"id":"8aad4370.49b93","type":"inject","z":"e18c38da.82ab78","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"key","payload":"[]","payloadType":"json","x":4290,"y":2480,"wires":[["2702ea82.368396"]]},{"id":"51de21f9.91dfa","type":"debug","z":"e18c38da.82ab78","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":4830,"y":2480,"wires":[]},{"id":"b7f83a18.236328","type":"inject","z":"e18c38da.82ab78","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":4280,"y":2580,"wires":[["fb5f6142.dddcb"]]},{"id":"fb5f6142.dddcb","type":"function","z":"e18c38da.82ab78","name":"","func":"let redis = context.flow.get('redis');\n\nredis.info().then((data)=>{\n    msg.payload = data\n    node.send(msg);\n})\n\n\nredis.call(\"anycmd\").then((data)=>{\n    msg.payload = data\n    node.send(msg);\n})","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4510,"y":2580,"wires":[["efc1f70e.2e9938"]]},{"id":"efc1f70e.2e9938","type":"debug","z":"e18c38da.82ab78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":4830,"y":2580,"wires":[]},{"id":"29cbd2ee.db14ee","type":"trigger","z":"e18c38da.82ab78","name":"","op1":"","op2":"0","op1type":"pay","op2type":"str","duration":"-500","extend":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":226,"y":520,"wires":[["ee0b50b4.bf43e"]]},{"id":"8b629a9b.465648","type":"comment","z":"e18c38da.82ab78","name":"Получаем список ботов пользователя","info":"Получаем список ботов пользователя","x":380,"y":78,"wires":[]},{"id":"d02ce6e5.3bd2d8","type":"inject","z":"e18c38da.82ab78","name":"stop","props":[{"p":"payload"},{"p":"reset","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":356,"y":640,"wires":[[]]},{"id":"955b159c.952dc8","type":"split","z":"e18c38da.82ab78","name":"split","splt":",","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":273,"y":119,"wires":[["28ba88d6.966048"]]},{"id":"d73e3124.bc835","type":"json","z":"e18c38da.82ab78","name":"","property":"payload","action":"","pretty":true,"x":276,"y":200,"wires":[["955b159c.952dc8"]]},{"id":"28ba88d6.966048","type":"function","z":"e18c38da.82ab78","name":"name +\"-settings\";","func":"var a = msg.payload[1]+\"-settings\";\nvar ttpprefix = msg.payload[1]+\":ttp\";\n//node.warn(a);\n//node.send(msg,false);\nmsg.botname =  msg.payload[1];\nmsg.ttpprefix = ttpprefix;\n\nmsg.payload = [];\nmsg.topic = a;\n\nreturn msg;","outputs":2,"noerr":0,"initialize":"","finalize":"","x":693,"y":119,"wires":[["4fb041e4.85159"],[]]},{"id":"96e0f4d3.3184d8","type":"comment","z":"e18c38da.82ab78","name":"для каждого бота - получение данных","info":"","x":763,"y":78,"wires":[]},{"id":"527ca317.06788c","type":"json","z":"e18c38da.82ab78","name":"","property":"payload","action":"","pretty":false,"x":653,"y":239,"wires":[["fbdfe1cc.2a3bb"]]},{"id":"fbdfe1cc.2a3bb","type":"function","z":"e18c38da.82ab78","name":"","func":"let moneta = msg.payload.quotacoin + msg.payload.basecoin;\nmsg.topic = \"prices:\"+moneta;\nmsg.moneta = moneta;\nmsg.digitq =  msg.payload.digitq;\nmsg.digitprice =  msg.payload.digitprice;\nmsg.minprice =  msg.payload.minprice;\nmsg.ofsetbottom =  msg.payload.ofsetbottom;\nmsg.ofsettop =  msg.payload.ofsettop;\nmsg.minpriceforzakup =  msg.payload.minpriceforzakup;\n\nmsg.payload = [];\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":663,"y":299,"wires":[["a462101b.ddaa4"]]},{"id":"b6bddfd2.4946","type":"function","z":"e18c38da.82ab78","name":"","func":"msg.price = msg.payload;\nmsg.payload = [];\n\nmsg.topic = msg.ttpprefix + \":busy\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":663,"y":419,"wires":[["3db6985f.950708"]]},{"id":"599dcfa5.d3fd7","type":"function","z":"e18c38da.82ab78","name":"","func":"msg.busy = msg.payload;\nmsg.payload = [];\n\nmsg.topic = msg.ttpprefix + \":curorderid\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":663,"y":539,"wires":[["dc3e7170.4deaa"]]},{"id":"601527cc.0da2c8","type":"function","z":"e18c38da.82ab78","name":"","func":"msg.curorderid = msg.payload;\nmsg.payload = [];\n\nmsg.topic = msg.ttpprefix + \":curstop\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":663,"y":659,"wires":[["fb628e8e.97a9e"]]},{"id":"e91cd8e4.ed5b68","type":"function","z":"e18c38da.82ab78","name":"","func":"msg.curstop = msg.payload;\nmsg.payload = [];\n\nmsg.topic = msg.ttpprefix + \":issell\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":663,"y":779,"wires":[["c030a5a4.ddc4e8"]]},{"id":"39efc222.4d67be","type":"function","z":"e18c38da.82ab78","name":"","func":"msg.issell = msg.payload;\nmsg.payload = [];\n\nmsg.topic = msg.ttpprefix + \":quantity\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":663,"y":899,"wires":[["720f2b18.2e51b4"]]},{"id":"15f5c4bd.141afb","type":"function","z":"e18c38da.82ab78","name":"","func":"msg.quantity = msg.payload;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":663,"y":1019,"wires":[["7c03c838.7624f8"]]},{"id":"7c03c838.7624f8","type":"switch","z":"e18c38da.82ab78","name":"quantity check","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"lte","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1000,"y":240,"wires":[["110e8c64.659ec4"],["bc2329c.3bacbd8"]]},{"id":"24b5069b.61c8da","type":"comment","z":"e18c38da.82ab78","name":"ttp pilot","info":"","x":970,"y":201,"wires":[]},{"id":"e3131777.68d7f8","type":"function","z":"e18c38da.82ab78","name":"замер времени","func":"\nmsg.est = new Date() - msg.start - 1000;\n//node.warn(msg.est);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1660,"y":2060,"wires":[["23e1f5c3.d4d8ca"]]},{"id":"cb505a1a.20ffd8","type":"function","z":"e18c38da.82ab78","name":"Вычисление raschstopprice","func":"msg.curstop = Number(msg.curstop);\nmsg.raschstopprice = Number((msg.price - msg.price / 100 * msg.ofsettop).toFixed(msg.digitprice));\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1660,"y":121,"wires":[["470f90df.5283b"]]},{"id":"470f90df.5283b","type":"switch","z":"e18c38da.82ab78","name":"если raschstopprice > curstop","property":"msg.raschstopprice","propertyType":"msg","rules":[{"t":"gt","v":"curstop","vt":"msg"},{"t":"lt","v":"curstop","vt":"msg"}],"checkall":"false","repair":false,"outputs":2,"x":1950,"y":121,"wires":[["fbec8182.cd1b6"],["6e3ce36c.5c768c"]]},{"id":"d482103.2213cf","type":"comment","z":"e18c38da.82ab78","name":"запускаем ТТП / передвигаем ордер","info":"","x":2293,"y":81,"wires":[]},{"id":"8da90b90.4f95d8","type":"comment","z":"e18c38da.82ab78","name":"слушаем статус ордера","info":"","x":2256,"y":600,"wires":[]},{"id":"d6f54eac.51539","type":"inject","z":"e18c38da.82ab78","name":"Inject","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"1","payload":"","payloadType":"date","x":4390,"y":1040,"wires":[["62d49473.af24fc"]]},{"id":"62d49473.af24fc","type":"switch","z":"e18c38da.82ab78","name":"Context based routing","property":"state","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"num"},{"t":"eq","v":"3","vt":"num"}],"checkall":"true","repair":false,"outputs":3,"x":4600,"y":1040,"wires":[["2d9d7f34.4c624"],["a1035bdc.f42b08"],["d154304.092dcd"]]},{"id":"2d9d7f34.4c624","type":"debug","z":"e18c38da.82ab78","name":"Output 1","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":4820,"y":980,"wires":[]},{"id":"a1035bdc.f42b08","type":"debug","z":"e18c38da.82ab78","name":"Output 2","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":4820,"y":1040,"wires":[]},{"id":"d154304.092dcd","type":"debug","z":"e18c38da.82ab78","name":"Output 3","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":4820,"y":1100,"wires":[]},{"id":"5786e5f7.c9cf5c","type":"inject","z":"e18c38da.82ab78","name":"Set state 0","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"0","payloadType":"num","x":4400,"y":1120,"wires":[["da262cf6.d8e1f"]]},{"id":"8622b7b9.dc5568","type":"inject","z":"e18c38da.82ab78","name":"Set state 1","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":4400,"y":1160,"wires":[["da262cf6.d8e1f"]]},{"id":"d6da540f.260308","type":"inject","z":"e18c38da.82ab78","name":"Set state 2","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"2","payloadType":"num","x":4400,"y":1240,"wires":[["da262cf6.d8e1f"]]},{"id":"77a5ac4f.4329b4","type":"inject","z":"e18c38da.82ab78","name":"Set state 3","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"3","payloadType":"num","x":4400,"y":1280,"wires":[["da262cf6.d8e1f"]]},{"id":"da262cf6.d8e1f","type":"change","z":"e18c38da.82ab78","name":"Set flow.state","rules":[{"t":"set","p":"state","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":4620,"y":1200,"wires":[[]]},{"id":"7a2fa3af.debc1c","type":"inject","z":"e18c38da.82ab78","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"","topic":"","payload":"Started!","payloadType":"str","x":1940,"y":2060,"wires":[["b0b30a21.c4f7b8"]]},{"id":"b0b30a21.c4f7b8","type":"debug","z":"e18c38da.82ab78","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":2110,"y":2060,"wires":[]},{"id":"e1b15f04.5ef47","type":"function","z":"e18c38da.82ab78","name":"start timer","func":"msg.start = new Date();\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":750,"y":2060,"wires":[["1a234b23.ce38d5"]]},{"id":"2609222a.0e9bae","type":"trigger","z":"e18c38da.82ab78","name":"","op1":"","op2":"0","op1type":"pay","op2type":"str","duration":"-2","extend":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":660,"y":2120,"wires":[["e1b15f04.5ef47"]]},{"id":"c49cc406.851928","type":"inject","z":"e18c38da.82ab78","name":"reset","props":[{"p":"payload"},{"p":"reset","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":490,"y":2140,"wires":[["2609222a.0e9bae"]]},{"id":"d23e1261.84cc5","type":"function","z":"e18c38da.82ab78","name":"get order status","func":"function parseApiError(error) {\n  if (error.body) {\n    try {\n      var resp = JSON.parse(error.body);\n      return resp.msg;\n    } catch (error) {/* pass thru */}\n  }\n  return \"Unknown error. Status code: \"+error.statsCode;\n}\n\nlet LBinance = global.get(\"gBinance\");\n\n\nlet binance = new LBinance().options({\n\tAPIKEY: \"1mUrLnaTdDiUHWQ2drxlQPnr0MqaJevIwJaqnEJFi5JIHLdTwLxTbnbMzMm5dj7i\",\n\tAPISECRET: \"exqgFmgHcb4Fr13JI6pDIpMTBXRDqzgbTelDoEikKRvzVU5KbB3F9iq9GPP2Onjn\",\n\t\"reconnect\": false\n});\n\nlet orderid = msg.orderid;\nlet moneta = msg.moneta;\n//node.warn(binance);\nbinance.orderStatus(moneta, orderid, function (error, qjson) {\n\tif (error) {\n\t\tvar errorMsg = parseApiError(error);\n\t\tnode.error(errorMsg);\n\t\tnode.status({ fill: \"red\", shape: \"ring\", text: errorMsg });\n\t\treturn;\n\t}\n    msg.st = qjson.status;\n\tnode.send(msg);\n\n\n});\n//msg.payload = \"qjson.status\";\nreturn;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1300,"y":2100,"wires":[["773763b2.06730c","658c7c0.bf19a84"]],"inputLabels":["orderid, moneta"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"b84003b.42367","type":"debug","z":"e18c38da.82ab78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":950,"y":2120,"wires":[]},{"id":"658c7c0.bf19a84","type":"function","z":"e18c38da.82ab78","name":"cansel order","func":"function parseApiError(error) {\n  if (error.body) {\n    try {\n      var resp = JSON.parse(error.body);\n      return resp.msg;\n    } catch (error) {/* pass thru */}\n  }\n  return \"Unknown error. Status code: \"+error.statsCode;\n}\n\nlet LBinance = global.get(\"gBinance\");\n\n\nlet binance = new LBinance().options({\n    APIKEY: \"1mUrLnaTdDiUHWQ2drxlQPnr0MqaJevIwJaqnEJFi5JIHLdTwLxTbnbMzMm5dj7i\",\n    APISECRET: \"exqgFmgHcb4Fr13JI6pDIpMTBXRDqzgbTelDoEikKRvzVU5KbB3F9iq9GPP2Onjn\",\n    \"reconnect\": false\n});\n\nlet orderid = msg.orderid;\nlet moneta = msg.moneta;\n//node.warn(binance);\n\nbinance.cancel(moneta, orderid, function (error, response) {\n                if (error) {\n                    var errorMsg = parseApiError(error);\n\t\t            node.error(errorMsg);\n\t            \tnode.status({ fill: \"red\", shape: \"ring\", text: errorMsg });\n\t            \treturn;\n\n                }\n                if (response) {\n                    \n                    node.send(msg);\n                }\n            });\n            \n//msg.payload = \"qjson.status\";\nreturn;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1490,"y":2060,"wires":[["e3131777.68d7f8"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"8d0fe702.193ce8","type":"inject","z":"e18c38da.82ab78","name":"","props":[{"p":"moneta","v":"TRXUSDT","vt":"str"},{"p":"payload.price","v":"0.022","vt":"str"},{"p":"payload.stopprice","v":"0.025","vt":"str"},{"p":"payload.quantity","v":"1000","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":490,"y":2060,"wires":[["2609222a.0e9bae"]]},{"id":"1a234b23.ce38d5","type":"function","z":"e18c38da.82ab78","name":"stopsell order","func":"function parseApiError(error) {\n\tif (error.body) {\n\t\ttry {\n\t\t\tvar resp = JSON.parse(error.body);\n\t\t\treturn resp.msg;\n\t\t} catch (error) {/* pass thru */ }\n\t}\n\treturn \"Unknown error. Status code: \" + error.statsCode;\n}\n\nlet LBinance = global.get(\"gBinance\");\n\n\nlet binance = new LBinance().options({\n\tAPIKEY: \"1mUrLnaTdDiUHWQ2drxlQPnr0MqaJevIwJaqnEJFi5JIHLdTwLxTbnbMzMm5dj7i\",\n\tAPISECRET: \"exqgFmgHcb4Fr13JI6pDIpMTBXRDqzgbTelDoEikKRvzVU5KbB3F9iq9GPP2Onjn\",\n\t\"reconnect\": false\n});\n\n\nlet moneta = msg.moneta;\nlet price = parseFloat(msg.payload.price);\nlet priceb = price;\nlet stopprice = parseFloat(msg.payload.stopprice);\nlet quantity = parseFloat(msg.payload.quantity);\n//node.warn(binance);\n\n\n\n\n binance.sell(moneta, quantity, priceb, { stopPrice: stopprice, type: \"STOP_LOSS_LIMIT\" }, function (err, resp) {\n          if (err) {\n            var errorMsg = parseApiError(err);\n            node.error(errorMsg, msg);\n            node.status({fill: \"red\", shape: \"ring\", text: errorMsg});\n            return;\n          }\n          node.status({}); //clear status message\n          msg.orderid = resp.orderId;\n          node.send(msg);\n        });\n\n\n\nreturn;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":960,"y":2060,"wires":[["b84003b.42367","b5aaaa45.56f138"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"b5aaaa45.56f138","type":"delay","z":"e18c38da.82ab78","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1160,"y":2060,"wires":[["658c7c0.bf19a84"]]},{"id":"773763b2.06730c","type":"debug","z":"e18c38da.82ab78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1290,"y":2140,"wires":[]},{"id":"23e1f5c3.d4d8ca","type":"debug","z":"e18c38da.82ab78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"est","targetType":"msg","statusVal":"","statusType":"auto","x":1660,"y":2120,"wires":[]},{"id":"29d84efa.f40d82","type":"switch","z":"e18c38da.82ab78","name":"curorderid > 0 check","property":"curorderid","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"neq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":2433,"y":115,"wires":[["fce253ed.baf93"],["e02fb2fe.f03b3"]]},{"id":"fce253ed.baf93","type":"function","z":"e18c38da.82ab78","name":"stopsell order","func":"function parseApiError(error) {\n\tif (error.body) {\n\t\ttry {\n\t\t\tvar resp = JSON.parse(error.body);\n\t\t\treturn resp.msg;\n\t\t} catch (error) {/* pass thru */ }\n\t}\n\treturn \"Unknown error. Status code: \" + error.statsCode;\n}\n\nlet LBinance = global.get(\"gBinance\");\n\n\nlet binance = new LBinance().options({\n\tAPIKEY: \"1mUrLnaTdDiUHWQ2drxlQPnr0MqaJevIwJaqnEJFi5JIHLdTwLxTbnbMzMm5dj7i\",\n\tAPISECRET: \"exqgFmgHcb4Fr13JI6pDIpMTBXRDqzgbTelDoEikKRvzVU5KbB3F9iq9GPP2Onjn\",\n\t\"reconnect\": false\n});\n\n\nlet priceb = parseFloat((msg.raschstopprice - msg.raschstopprice / 100 * msg.ofsetbottom).toFixed(msg.digitprice));\nlet stopprice = parseFloat(msg.raschstopprice);\n\nlet moneta = msg.moneta;\n\nlet quantity = parseFloat(msg.quantity);\n//node.warn(binance);\n\n\n\n\n binance.sell(moneta, quantity, priceb, { stopPrice: stopprice, type: \"STOP_LOSS_LIMIT\" }, function (err, resp) {\n          if (err) {\n            var errorMsg = parseApiError(err) + \", moneta:\" + moneta;\n            node.error(errorMsg, msg);\n            node.status({fill: \"red\", shape: \"ring\", text: errorMsg});\n            node.send(msg);\n          return;\n            \n          }\n          if (resp) {\n                        msg.orderid = resp.orderId;\n                        msg.curstop = stopprice;\n                        node.status({fill: \"green\", shape: \"ring\", text: resp.orderId});\n          }\n          //node.status({}); //clear status message\n\n          \n          node.send(msg);\n          return;\n        });\n\n    \n    \n\n\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2669,"y":109,"wires":[["6f29699c.7d8cd8","1f25bcea.390523","f6b19fb0.a1624"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"font-awesome/fa-bolt"},{"id":"10f90f8c.75f76","type":"comment","z":"e18c38da.82ab78","name":"стартуем ттп","info":"","x":2659,"y":75,"wires":[]},{"id":"2ecf8586.7a904a","type":"comment","z":"e18c38da.82ab78","name":"Передвигаем ордер","info":"","x":2689,"y":276,"wires":[]},{"id":"d9d135cf.f57068","type":"function","z":"e18c38da.82ab78","name":"Let Free!","func":"\nmsg.busy = \"0\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3400,"y":109,"wires":[["54b4fc44.e47f74"]]},{"id":"e02fb2fe.f03b3","type":"function","z":"e18c38da.82ab78","name":"cansel order","func":"function parseApiError(error) {\n  if (error.body) {\n    try {\n      var resp = JSON.parse(error.body);\n      return resp.msg;\n    } catch (error) {/* pass thru */}\n  }\n  return \"Unknown error. Status code: \"+error.statsCode;\n}\n\nlet LBinance = global.get(\"gBinance\");\n\n\nlet binance = new LBinance().options({\n    APIKEY: \"1mUrLnaTdDiUHWQ2drxlQPnr0MqaJevIwJaqnEJFi5JIHLdTwLxTbnbMzMm5dj7i\",\n    APISECRET: \"exqgFmgHcb4Fr13JI6pDIpMTBXRDqzgbTelDoEikKRvzVU5KbB3F9iq9GPP2Onjn\",\n    \"reconnect\": false\n});\n\nlet orderid = msg.curorderid;\nlet moneta = msg.moneta;\n//node.warn(binance);\n\n    binance.cancel(moneta, orderid, function (error, response) {\n                    if (error) {\n                        var errorMsg = parseApiError(error);\n                        errorMsg = errorMsg + \":\" + orderid;\n    \t\t            node.error(errorMsg);\n    \t            \tnode.status({ fill: \"red\", shape: \"ring\", text: errorMsg });\n    \t            \tnode.send(msg);\n    \t            \treturn;\n    \n                    }\n                    if (response) {\n                        \n                        node.send(msg);\n                        return;\n                    }\n                });\n\n            \n//msg.payload = \"qjson.status\";\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2659,"y":310,"wires":[["81dcf2d7.1d002","f6b19fb0.a1624","3e469775.4f8288"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"6f29699c.7d8cd8","type":"function","z":"e18c38da.82ab78","name":"parse order id","func":"\nmsg.payload = [msg.ttpprefix+\":curorderid\", msg.orderid];\nmsg.topic = \"\";\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2869,"y":109,"wires":[["a139deac.acf0d"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"1f25bcea.390523","type":"function","z":"e18c38da.82ab78","name":"parse curstop","func":"\nmsg.payload = [msg.ttpprefix+\":curstop\", msg.curstop];\nmsg.topic = \"\";\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2870,"y":156,"wires":[["42f0d139.ff43e"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"f5b655c4.bf17c8","type":"debug","z":"e18c38da.82ab78","name":"","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":3970,"y":169,"wires":[]},{"id":"81dcf2d7.1d002","type":"function","z":"e18c38da.82ab78","name":"stopsell order","func":"function parseApiError(error) {\n\tif (error.body) {\n\t\ttry {\n\t\t\tvar resp = JSON.parse(error.body);\n\t\t\treturn resp.msg;\n\t\t} catch (error) {/* pass thru */ }\n\t}\n\treturn \"Unknown error. Status code: \" + error.statsCode;\n}\n\nlet LBinance = global.get(\"gBinance\");\n\n\nlet binance = new LBinance().options({\n\tAPIKEY: \"1mUrLnaTdDiUHWQ2drxlQPnr0MqaJevIwJaqnEJFi5JIHLdTwLxTbnbMzMm5dj7i\",\n\tAPISECRET: \"exqgFmgHcb4Fr13JI6pDIpMTBXRDqzgbTelDoEikKRvzVU5KbB3F9iq9GPP2Onjn\",\n\t\"reconnect\": false\n});\n\n\nlet priceb = parseFloat((msg.raschstopprice - msg.raschstopprice / 100 * msg.ofsetbottom).toFixed(msg.digitprice));\nlet stopprice = parseFloat(msg.raschstopprice);\n\nlet moneta = msg.moneta;\n\nlet quantity = parseFloat(msg.quantity);\n//node.warn(binance);\n\n\n\n\n binance.sell(moneta, quantity, priceb, { stopPrice: stopprice, type: \"STOP_LOSS_LIMIT\" }, function (err, resp) {\n          if (err) {\n            var errorMsg = parseApiError(err);\n            node.error(errorMsg, msg);\n            node.status({fill: \"red\", shape: \"ring\", text: errorMsg});\n            \n          }\n          if (resp) {\n                        msg.orderid = resp.orderId;\n                        msg.curstop = stopprice;\n          }\n          node.status({}); //clear status message\n\n          \n          node.send(msg);\n          return;\n        });\n\n\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2849,"y":310,"wires":[["2e7fba73.8c9c26","7992df6a.5d562"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"font-awesome/fa-bolt"},{"id":"2e7fba73.8c9c26","type":"function","z":"e18c38da.82ab78","name":"parse order id","func":"\nmsg.payload = [msg.ttpprefix+\":curorderid\", msg.orderid];\nmsg.topic = \"\";\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3069,"y":310,"wires":[["f4244b00.a987b8"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"7992df6a.5d562","type":"function","z":"e18c38da.82ab78","name":"parse curstop","func":"\nmsg.payload = [msg.ttpprefix+\":curstop\", msg.curstop];\nmsg.topic = \"\";\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3069,"y":270,"wires":[["e306772e.1ae1f8"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"168d1083.aa2fcf","type":"switch","z":"e18c38da.82ab78","name":"","property":"st","propertyType":"msg","rules":[{"t":"eq","v":"FILLED","vt":"str"},{"t":"neq","v":"FILLED","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":2453,"y":641,"wires":[["c0f6d1b1.5db1b"],[]]},{"id":"9c148319.45527","type":"function","z":"e18c38da.82ab78","name":"reset order id","func":"\nmsg.payload = [msg.ttpprefix+\":curorderid\", 0];\nmsg.topic = \"\";\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2570,"y":2220,"wires":[["6cd2f554.83779c"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"593e3188.2e6ff","type":"function","z":"e18c38da.82ab78","name":"reset curstop","func":"\nmsg.payload = [msg.ttpprefix+\":curstop\", 0];\nmsg.topic = \"\";\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2570,"y":2180,"wires":[["6e928d4.e6b8374"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"c0f6d1b1.5db1b","type":"function","z":"e18c38da.82ab78","name":"prepare issel 1","func":"\nmsg.payload = [msg.ttpprefix+\":issell\", \"1\"];\nmsg.topic = \"\";\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2623,"y":634,"wires":[["74ab7c83.1a99f4"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"ee0b50b4.bf43e","type":"delay","z":"e18c38da.82ab78","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"2","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":436,"y":520,"wires":[["18b1c58a.00662a"]]},{"id":"f6b19fb0.a1624","type":"debug","z":"e18c38da.82ab78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2850,"y":420,"wires":[]},{"id":"81129d1b.e1736","type":"function","z":"e18c38da.82ab78","name":"pepare busy 0","func":"\nmsg.payload = [msg.ttpprefix+\":busy\", \"0\"];\nmsg.topic = \"\";\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3760,"y":109,"wires":[["fa1247c5.56f6f8","f5b655c4.bf17c8"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"3e469775.4f8288","type":"function","z":"e18c38da.82ab78","name":"prepare order id 0","func":"\nmsg.payload = [msg.ttpprefix+\":curorderid\", \"0\"];\nmsg.topic = \"\";\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2859,"y":356,"wires":[["512acfd.1f8453"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"77bfd09a.602d9","type":"switch","z":"e18c38da.82ab78","name":"busy check","property":"busy","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"neq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1239,"y":127,"wires":[["8f6d2b6c.90e3b8"],[]]},{"id":"5a5f06f0.f83fe8","type":"function","z":"e18c38da.82ab78","name":"prepare busy 1","func":"\nmsg.payload = [msg.ttpprefix+\":busy\", \"1\"];\nmsg.topic = \"\";\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2223,"y":241,"wires":[["55c98839.0c0cd8","4bd02dbc.b43ad4"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"738808f8.c97bc8","type":"function","z":"e18c38da.82ab78","name":"get order status","func":"function parseApiError(error) {\n  if (error.body) {\n    try {\n      var resp = JSON.parse(error.body);\n      return resp.msg;\n    } catch (error) {/* pass thru */}\n  }\n  return \"Unknown error. Status code: \"+error.statsCode;\n}\n\nlet LBinance = global.get(\"gBinance\");\n\n\nlet binance = new LBinance().options({\n\tAPIKEY: \"1mUrLnaTdDiUHWQ2drxlQPnr0MqaJevIwJaqnEJFi5JIHLdTwLxTbnbMzMm5dj7i\",\n\tAPISECRET: \"exqgFmgHcb4Fr13JI6pDIpMTBXRDqzgbTelDoEikKRvzVU5KbB3F9iq9GPP2Onjn\",\n\t\"reconnect\": false\n});\n\nlet orderid = \"8200370\";\nlet moneta =  \"LINKDOWNUSDT\";\n//node.warn(binance);\nbinance.orderStatus(moneta, orderid, function (error, qjson) {\n\tif (error) {\n\t\tvar errorMsg = parseApiError(error);\n\t\tnode.error(errorMsg);\n\t\tnode.status({ fill: \"red\", shape: \"ring\", text: errorMsg });\n\t\treturn;\n\t}\n    msg.st = qjson.status;\n\tnode.send(msg);\n\n\n});\n//msg.payload = \"qjson.status\";\nreturn;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2580,"y":2060,"wires":[["70ff2ab2.df6164"]],"inputLabels":["orderid, moneta"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"70ff2ab2.df6164","type":"debug","z":"e18c38da.82ab78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"st","targetType":"msg","statusVal":"","statusType":"auto","x":2780,"y":2060,"wires":[]},{"id":"369e8c6c.9cc074","type":"inject","z":"e18c38da.82ab78","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":2370,"y":2060,"wires":[["738808f8.c97bc8"]]},{"id":"bc2329c.3bacbd8","type":"function","z":"e18c38da.82ab78","name":"Let Free!","func":"msg.busy = \"0\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1240,"y":340,"wires":[["f9c57665.84cb98"]]},{"id":"f9c57665.84cb98","type":"function","z":"e18c38da.82ab78","name":"pepare busy 0","func":"\nmsg.payload = [msg.ttpprefix+\":busy\", \"0\"];\nmsg.topic = \"\";\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1400,"y":340,"wires":[["c0b869fc.08dad8"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"8f6d2b6c.90e3b8","type":"delay","z":"e18c38da.82ab78","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"2","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":1410,"y":121,"wires":[["cb505a1a.20ffd8"]]},{"id":"54b4fc44.e47f74","type":"delay","z":"e18c38da.82ab78","name":"","pauseType":"delay","timeout":"25","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":3570,"y":109,"wires":[["81129d1b.e1736"]]},{"id":"6e3ce36c.5c768c","type":"delay","z":"e18c38da.82ab78","name":"","pauseType":"delay","timeout":"400","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":2033,"y":641,"wires":[["448c4acd.cfe9f4"]]},{"id":"fbec8182.cd1b6","type":"function","z":"e18c38da.82ab78","name":"Let Busy!","func":"msg.busy = \"1\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2204,"y":115,"wires":[["5a5f06f0.f83fe8","29d84efa.f40d82"]]},{"id":"4bd02dbc.b43ad4","type":"debug","z":"e18c38da.82ab78","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":2410,"y":200,"wires":[]},{"id":"290bb66.560de4a","type":"inject","z":"e18c38da.82ab78","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"0","payloadType":"num","x":1670,"y":1740,"wires":[["9d0eb1a8.fef8f"]]},{"id":"9d0eb1a8.fef8f","type":"rbe","z":"e18c38da.82ab78","name":"report-by-exception","func":"deadband","gap":"","start":"","inout":"out","property":"payload","x":1880,"y":1760,"wires":[["e0629700.194518"]]},{"id":"e0629700.194518","type":"debug","z":"e18c38da.82ab78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":2090,"y":1760,"wires":[]},{"id":"d5a4ad51.bbc46","type":"inject","z":"e18c38da.82ab78","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":1670,"y":1780,"wires":[["9d0eb1a8.fef8f"]]},{"id":"f7a2cd84.d2372","type":"rbe","z":"e18c38da.82ab78","name":"report-by-exception","func":"deadband","gap":"","start":"","inout":"out","property":"payload","x":1890,"y":1640,"wires":[[]]},{"id":"448c4acd.cfe9f4","type":"function","z":"e18c38da.82ab78","name":"","func":"let orderid = msg.curorderid;\nlet moneta = msg.moneta;\nlet userid = msg.userid;\n\n\nmsg.topic = \"orders-status-\" + userid + \":\" + moneta +\":\"+orderid;\nmsg.payload = [];\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2130,"y":960,"wires":[["672e33a8.9aac8c"]]},{"id":"d21fd3e3.a956c","type":"debug","z":"e18c38da.82ab78","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":2690,"y":960,"wires":[]},{"id":"813ef7b.3c97408","type":"inject","z":"e18c38da.82ab78","name":"","props":[{"p":"curorderid","v":"2274007","vt":"str"},{"p":"userid","v":"d3fmoh2rVoVNgIcpLTFZBE0jHnI2","vt":"str"},{"p":"moneta","v":"SUNUSDT","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":1940,"y":960,"wires":[["448c4acd.cfe9f4"]]},{"id":"28a625e6.2c42ca","type":"function","z":"e18c38da.82ab78","name":"","func":"msg.st = msg.payload;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2520,"y":870,"wires":[["d21fd3e3.a956c","168d1083.aa2fcf"]]},{"id":"110e8c64.659ec4","type":"switch","z":"e18c38da.82ab78","name":"check issel","property":"issell","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1150,"y":180,"wires":[["77bfd09a.602d9"]]},{"id":"f9995380.6a345","type":"http in","z":"e18c38da.82ab78","name":"","url":"/panic","method":"post","upload":false,"swaggerDoc":"","x":1470,"y":1200,"wires":[["f2605435.fd9ee8"]]},{"id":"f2605435.fd9ee8","type":"debug","z":"e18c38da.82ab78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1750,"y":1200,"wires":[]},{"id":"7a460ce4.03d714","type":"http in","z":"e18c38da.82ab78","name":"","url":"/webhook-tv","method":"post","upload":false,"swaggerDoc":"","x":610,"y":1180,"wires":[["3f59012b.f2ab4e"]]},{"id":"d0865ab1.700678","type":"debug","z":"e18c38da.82ab78","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1250,"y":1100,"wires":[]},{"id":"3f59012b.f2ab4e","type":"function","z":"e18c38da.82ab78","name":"","func":"\nif (msg.payload.command == \"START\"){\nmsg.payload = [msg.payload.bot+\"-start\", \"1\"];\nmsg.topic = \"\";}\n\nif (msg.payload.command == \"PANICSALE\"){\nmsg.payload = [msg.payload.bot+\"-panicsale\", \"1\"];\nmsg.topic = \"\";}\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1010,"y":1080,"wires":[["d0865ab1.700678","a59ad694.e65af8"]]},{"id":"b8f0523.8db09b","type":"inject","z":"e18c38da.82ab78","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":810,"y":1080,"wires":[[]]},{"id":"f8d62ead.8e7df","type":"function","z":"e18c38da.82ab78","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1870,"y":40,"wires":[["4402256f.72ecbc"]]},{"id":"4402256f.72ecbc","type":"debug","z":"e18c38da.82ab78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":2040,"y":40,"wires":[]},{"id":"7a3a1aa4.768354","type":"redis-in","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"blpop","name":"","topic":"test","obj":false,"timeout":0,"x":4590,"y":1820,"wires":[["f7720481.a6b768"]]},{"id":"1910babb.d3e735","type":"redis-in","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"psubscribe","name":"","topic":"TOPIC:*","obj":false,"timeout":0,"x":4600,"y":1600,"wires":[["2c0c2179.bcb1ee"]]},{"id":"135fb04d.73026","type":"redis-in","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"subscribe","name":"","topic":"TOPIC:OK","obj":false,"timeout":0,"x":4600,"y":1660,"wires":[["58e730d0.10957"]]},{"id":"e317dfb9.7d7d6","type":"redis-out","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"rpush","name":"","topic":"test","obj":true,"x":4590,"y":1780,"wires":[]},{"id":"7de99e6d.248ca","type":"redis-out","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"publish","name":"","topic":"TOPIC:OK","obj":true,"x":4410,"y":1680,"wires":[]},{"id":"5ddd1f18.80ccb","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"timestamp","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4570,"y":1880,"wires":[["6947d8f0.801bc8"]]},{"id":"2edf9cf.3bc1064","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"set","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4470,"y":1960,"wires":[["858eec9b.c706b"]]},{"id":"4195201e.7c0c2","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4530,"y":2000,"wires":[["1cc32d0c.3d2c23"]]},{"id":"2cedf9d2.7b13f6","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"hmset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4530,"y":2120,"wires":[["e3d6a8ff.a0fd68"]]},{"id":"7e3816a4.30a3e8","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"hgetall","name":"","topic":"myHash","params":"{}","paramsType":"json","payloadType":"json","block":false,"x":4560,"y":2180,"wires":[["1841c999.5b1966"]]},{"id":"434c360e.228778","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"sadd","name":"","topic":"mySet","params":"[\"memberA\",\"memberB\",\"memberC\"]","paramsType":"json","payloadType":"json","block":false,"x":3850,"y":2240,"wires":[["9f711677.ee0268"]]},{"id":"18b1c58a.00662a","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"GET","name":"get mybots","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":296,"y":280,"wires":[["d73e3124.bc835"]]},{"id":"23fd40d3.acb38","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"sismember","name":"","topic":"mySet","params":"[\"memberA\"]","paramsType":"json","payloadType":"json","block":false,"x":3870,"y":2300,"wires":[["349f6ec3.6b7852"]]},{"id":"2702ea82.368396","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"del","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4520,"y":2480,"wires":[["51de21f9.91dfa"]]},{"id":"4fb041e4.85159","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"GET","name":"get bot settings","topic":"msg.topic","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":683,"y":179,"wires":[["527ca317.06788c"]]},{"id":"a462101b.ddaa4","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"GET","name":"get currentprice","topic":"msg.topic","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":683,"y":359,"wires":[["b6bddfd2.4946"]]},{"id":"3db6985f.950708","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"GET","name":"get ttp:busy","topic":"msg.topic","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":673,"y":479,"wires":[["599dcfa5.d3fd7"]]},{"id":"dc3e7170.4deaa","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"GET","name":"get ttp:curorderid","topic":"msg.topic","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":693,"y":599,"wires":[["601527cc.0da2c8"]]},{"id":"fb628e8e.97a9e","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"GET","name":"get ttp:curstop","topic":"msg.topic","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":683,"y":719,"wires":[["e91cd8e4.ed5b68"]]},{"id":"c030a5a4.ddc4e8","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"GET","name":"get ttp:issell","topic":"msg.topic","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":673,"y":839,"wires":[["39efc222.4d67be"]]},{"id":"720f2b18.2e51b4","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"GET","name":"get ttp:quantity","topic":"msg.topic","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":683,"y":959,"wires":[["15f5c4bd.141afb"]]},{"id":"a139deac.acf0d","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"set","name":"set curorderid","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":3052,"y":109,"wires":[["d9d135cf.f57068"]]},{"id":"42f0d139.ff43e","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"set","name":"set curstop","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":3043,"y":156,"wires":[[]]},{"id":"f4244b00.a987b8","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"set","name":"set curorderid","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":3252,"y":310,"wires":[["d9d135cf.f57068"]]},{"id":"e306772e.1ae1f8","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"set","name":"set curstop","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":3242,"y":270,"wires":[[]]},{"id":"6e928d4.e6b8374","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"set","name":"set curstop","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":2810,"y":2180,"wires":[[]]},{"id":"6cd2f554.83779c","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"set","name":"set curorderid","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":2820,"y":2220,"wires":[[]]},{"id":"74ab7c83.1a99f4","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"set","name":"set issell 1","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":2813,"y":634,"wires":[[]]},{"id":"fa1247c5.56f6f8","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"set","name":"set busy 0","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":3950,"y":109,"wires":[[]]},{"id":"512acfd.1f8453","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"set","name":"set curorderid 0","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":3089,"y":356,"wires":[[]]},{"id":"55c98839.0c0cd8","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"set","name":"set busy 1","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":2413,"y":241,"wires":[[]]},{"id":"c0b869fc.08dad8","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"set","name":"set busy 0","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1570,"y":341,"wires":[[]]},{"id":"672e33a8.9aac8c","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"GET","name":"get order status","topic":"msg.topic","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":2300,"y":960,"wires":[["28a625e6.2c42ca"]]},{"id":"a59ad694.e65af8","type":"redis-command","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","command":"set","name":"set comand","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1190,"y":1000,"wires":[[]]},{"id":"90058663.4f0bd8","type":"redis-lua-script","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","name":"test","keyval":0,"func":"local text = \"Hello World\"\nreturn text","stored":true,"block":false,"x":4510,"y":2360,"wires":[["2bc51ced.3ff1f4"]]},{"id":"3db5b456.716e3c","type":"redis-lua-script","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","name":"test2","keyval":0,"func":"local text = \"Hello2222 World2222\"\nreturn text","stored":false,"block":false,"x":4510,"y":2420,"wires":[["89688cf4.1cf64"]]},{"id":"edcbe86d.8402b8","type":"redis-instance","z":"e18c38da.82ab78","server":"f120eab2.0a60a8","name":"","topic":"redis","location":"flow","x":4530,"y":1500,"wires":[]},{"id":"7792f18e.f49f5","type":"graphql","z":"38c422f8.b82bf6","g":"6d0bae3e.4983b8","name":"gql запрос списка ботов","graphql":"ab190c2e.90269","format":"handlebars","syntax":"mustache","template":"query {\n  bots{\n  onoff\n  id\n  busy\n  }\n}","x":910,"y":720,"wires":[["4d01ab16.cd9554"],[]]},{"id":"4d01ab16.cd9554","type":"function","z":"38c422f8.b82bf6","g":"6d0bae3e.4983b8","name":"payload = payload.bots","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = Date.parse(new Date()) / 1000;\n    let steptitle = node.name;\n//>трекер>\n\nmsg.payload = msg.payload.bots;\n\n//>трекер>\n    let end_node_time = Date.parse(new Date()) / 1000;\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration\": duration\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1170,"y":720,"wires":[["e68822f4.50329"]]},{"id":"e68822f4.50329","type":"split","z":"38c422f8.b82bf6","g":"6d0bae3e.4983b8","name":"","splt":"1","spltType":"len","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1370,"y":720,"wires":[["d42587f0.33b758"]]},{"id":"d42587f0.33b758","type":"function","z":"38c422f8.b82bf6","g":"6d0bae3e.4983b8","name":"onoff === true,  busy === false ","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = Date.parse(new Date()) / 1000;\n    let steptitle = node.name;\n//>трекер>\n\n\n\n\nif (msg.payload.onoff === true) {\n\n    if (msg.payload.busy === false) {\n        msg.payload = msg.payload.id;\n        \n//>трекер>\n    let end_node_time = Date.parse(new Date()) / 1000;\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle+\"-norm\",\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration\": duration\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill:\"green\",shape:\"dot\"});\n        return [msg, null];\n    }\n\n    else {\n\n        let id = msg.payload.id;\n        msg.payload = [];\n\n\n        var count = flow.get(id) || 0;\n        count += 1;\n\n        if (count > 12) {\n        \n            let newsetb = { \"busy\": false };\n\n            msg.payload = newsetb;\n\n            msg.headers = {};\n            msg.headers['accept'] = 'application/json';\n            msg.headers['Content-Type'] = 'application/json';\n            \n            const upd = global.get('updateSettings')(msg.payload, id);\n\n            upd.then(upd => {\n                //>трекер>\n                    let end_node_time = Date.parse(new Date()) / 1000;\n                    let duration = end_node_time - start_node_time;\n                    track.push({\n                        \"steptitle\": steptitle+\"-12\",\n                        \"start_node_time\": start_node_time,\n                        \"end_node_time\": end_node_time,\n                        \"duration\": duration\n                    });\n                    flow.set(\"track\", track);\n                //>трекер>\n                node.status({fill:\"red\",shape:\"dot\"});\n                \n                node.warn(\"reset busy:\" + id);\n\n            }).catch(error => {\n                //>трекер>\n                    let end_node_time = Date.parse(new Date()) / 1000;\n                    let duration = end_node_time - start_node_time;\n                    track.push({\n                        \"steptitle\": steptitle+\"-error update\",\n                        \"start_node_time\": start_node_time,\n                        \"end_node_time\": end_node_time,\n                        \"duration\": duration\n                    });\n                    flow.set(\"track\", track);\n                //>трекер>\n                node.status({fill:\"red\",shape:\"dot\"});\n                \n                node.error(error);\n            });\n\n        }\n\n        flow.set(id, count);\n        return [null, msg];\n\n    }\n}\n\n\n\n\n","outputs":2,"noerr":0,"initialize":"","finalize":"","x":1590,"y":720,"wires":[["536d19d6.716798"],["ab453ff0.f0607"]],"icon":"font-awesome/fa-bolt"},{"id":"eb102c0d.9fc26","type":"comment","z":"38c422f8.b82bf6","g":"6d0bae3e.4983b8","name":"Старт трека","info":"","x":170,"y":660,"wires":[]},{"id":"da9e4dd8.dda28","type":"trigger","z":"38c422f8.b82bf6","g":"6d0bae3e.4983b8","name":"","op1":"1","op2":"0","op1type":"str","op2type":"str","duration":"-250","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":520,"y":720,"wires":[["8e1f3271.c24088"]]},{"id":"4845bd6.8cefd44","type":"function","z":"38c422f8.b82bf6","name":"getPrice()","func":"const price = global.get('getPrice')(msg.payload);\n\nprice.then(price => {\n    node.warn(price);\n}).catch(error => {\n    node.error(error);\n});","outputs":"0","noerr":0,"initialize":"","finalize":"","x":3900,"y":220,"wires":[]},{"id":"5142b2ba.bc73cc","type":"inject","z":"38c422f8.b82bf6","name":"get BTCUSDT price","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"BTCUSDT","payloadType":"str","x":3670,"y":220,"wires":[["4845bd6.8cefd44"]]},{"id":"3e86454.fcee4ba","type":"function","z":"38c422f8.b82bf6","name":"getBusyStatus()","func":"const busy = global.get('getBusyStatus')(msg.payload);\n\nbusy.then(busy => {\n    node.warn(busy);\n}).catch(error => {\n    node.error(error);\n});","outputs":"0","noerr":0,"initialize":"","finalize":"","x":4060,"y":280,"wires":[]},{"id":"c7d746b7.9446c8","type":"inject","z":"38c422f8.b82bf6","name":"get 5fa1973ff1fb3f005e206671 busy status","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"5fa1973ff1fb3f005e206671","payloadType":"str","x":3740,"y":280,"wires":[["3e86454.fcee4ba"]]},{"id":"ad28bc2a.8bf1a","type":"function","z":"38c422f8.b82bf6","name":"setBusyStatus()","func":"const setbusy = global.get('setBusyStatus')(msg.payload);\n\nsetbusy.then(setbusy => {\n    node.warn(setbusy);\n}).catch(error => {\n    node.error(error);\n});","outputs":"0","noerr":0,"initialize":"","finalize":"","x":3980,"y":340,"wires":[]},{"id":"a60ccea8.42b6c","type":"inject","z":"38c422f8.b82bf6","name":"set 5fa1973ff1fb3f005e206671 busy","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"5fa1973ff1fb3f005e206671","payloadType":"str","x":3720,"y":340,"wires":[["ad28bc2a.8bf1a"]]},{"id":"c40d4752.87d458","type":"function","z":"38c422f8.b82bf6","name":"setBusyStatusFree()","func":"const busy = global.get('setBusyStatusFree')(msg.payload);\n\nbusy.then(busy => {\n    node.warn(busy);\n}).catch(error => {\n    node.error(error);\n});","outputs":"0","noerr":0,"initialize":"","finalize":"","x":4000,"y":400,"wires":[]},{"id":"aa9320b.f5d1be","type":"inject","z":"38c422f8.b82bf6","name":"set 5fa1973ff1fb3f005e206671 free","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"5fa1973ff1fb3f005e206671","payloadType":"str","x":3720,"y":400,"wires":[["c40d4752.87d458"]]},{"id":"16d8ed41.e74b83","type":"comment","z":"38c422f8.b82bf6","name":"Tests","info":"","x":3610,"y":160,"wires":[]},{"id":"d61c34b3.1152b8","type":"function","z":"38c422f8.b82bf6","name":"setBusyStatusFree()","func":"const busy = global.get('setBusyStatusFree')(msg.payload);\nmsg.id = msg.payload;\nbusy.then(busy => {\n    \n    msg.payload = \"free\"\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4580,"y":400,"wires":[["44c36c5f.4ab384"]]},{"id":"b4bc5daa.fc48a","type":"inject","z":"38c422f8.b82bf6","name":"set 5fa1973ff1fb3f005e206671 free","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"5fa1973ff1fb3f005e206671","payloadType":"str","x":4290,"y":400,"wires":[["d61c34b3.1152b8"]]},{"id":"44c36c5f.4ab384","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":4800,"y":400,"wires":[]},{"id":"acf7aa27.789568","type":"function","z":"38c422f8.b82bf6","name":"setBusyStatus()","func":"const busy = global.get('setBusyStatus')(msg.payload);\nmsg.id = msg.payload;\nbusy.then(busy => {\n    \n    msg.payload = \"busy\"\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4560,"y":340,"wires":[["f128973d.8af208"]]},{"id":"c36107b5.4a8178","type":"inject","z":"38c422f8.b82bf6","name":"set 5fa1973ff1fb3f005e206671 busy","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"5fa1973ff1fb3f005e206671","payloadType":"str","x":4290,"y":340,"wires":[["acf7aa27.789568"]]},{"id":"f128973d.8af208","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":4800,"y":340,"wires":[]},{"id":"d33f9ad1.7d5ee8","type":"function","z":"38c422f8.b82bf6","name":"getBusyStatus()","func":"const busy = global.get('getBusyStatus')(msg.payload);\nmsg.id = msg.payload;\nbusy.then(busy => {\n    \n    msg.payload = busy;\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4600,"y":280,"wires":[["914c0743.7ac478"]]},{"id":"e3f58d89.22fa2","type":"inject","z":"38c422f8.b82bf6","name":"get 5fa1973ff1fb3f005e206671 free","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"5fa1973ff1fb3f005e206671","payloadType":"str","x":4330,"y":280,"wires":[["d33f9ad1.7d5ee8"]]},{"id":"914c0743.7ac478","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":4840,"y":280,"wires":[]},{"id":"31a5bbf5.ef68a4","type":"function","z":"38c422f8.b82bf6","name":"getPrice()","func":"const price = global.get('getPrice')(msg.payload);\nmsg.id = msg.payload;\nprice.then(price => {\n    \n    msg.payload = price;\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4580,"y":220,"wires":[["1fd6bca8.2f2fe3"]]},{"id":"7dd4a226.2f874c","type":"inject","z":"38c422f8.b82bf6","name":"BTCUSDT","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"BTCUSDT","payloadType":"str","x":4250,"y":220,"wires":[["31a5bbf5.ef68a4"]]},{"id":"1fd6bca8.2f2fe3","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":4840,"y":220,"wires":[]},{"id":"1f1c473a.9219a9","type":"function","z":"38c422f8.b82bf6","name":"","func":"let newset = {\"status\":{\n  \"curenntprice\": \"555\",\n}};\n//newset = JSON.stringify(newset);\n\n\nmsg.payload = newset;\nmsg.topic = msg.botid;\nmsg.headers = {};\nmsg.headers['accept'] = 'application/json';\nmsg.headers['Content-Type'] = 'application/json';\n\nreturn msg;\n\n\n\n//node.send(Object.assign({}, msg));\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3920,"y":500,"wires":[["5ac8d203.850e3c"]]},{"id":"e0203d6c.492c8","type":"inject","z":"38c422f8.b82bf6","name":"","props":[{"p":"botid","v":"5fa4a9f6e4ef8c0024bbdcc0","vt":"str"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"5fa4a9f6e4ef8c0024bbdcc0","x":3700,"y":500,"wires":[["1f1c473a.9219a9"]]},{"id":"ecc64228.07c96","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4290,"y":500,"wires":[]},{"id":"5ac8d203.850e3c","type":"function","z":"38c422f8.b82bf6","name":"updateSettings","func":"const upd = global.get('updateSettings')(msg.payload, msg.topic);\n\nupd.then(upd => {\n    \n    msg.payload = \"updated\"\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4120,"y":500,"wires":[["ecc64228.07c96"]]},{"id":"13f2257b.01983b","type":"graphql","z":"38c422f8.b82bf6","g":"89dcb365.f1eba","name":"get bot all data","graphql":"ab190c2e.90269","format":"handlebars","syntax":"mustache","template":"query {\n  bot (id: \"{{payload}}\"){\n    id\n    settings\n    last_price\n    busy\n    floors\n    status\n    finance\n    ttp\n    zapret_na_zakup\n     keypair{\n      apikey\n      secret\n      market\n    }\n  }\n}","x":240,"y":960,"wires":[["18fc789.fac9d87"],[]]},{"id":"a445188a.34a218","type":"function","z":"38c422f8.b82bf6","g":"89dcb365.f1eba","name":"updateSettings : price, zapret_na_zakup, status","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = Date.parse(new Date()) / 1000;\n    let steptitle = node.name;\n//>трекер>\n\nmsg.bot.last_price = Number(msg.payload);\n    \nif ((msg.bot.last_price > msg.bot.status.sr_ma_big)&&(msg.bot.last_price > msg.bot.status.sr_ma_small)){\n    msg.bot.zapret_na_zakup = true;\n    msg.bot.status.rezhim = \"МА - закуп разрешен\";\n} else {\n    msg.bot.zapret_na_zakup = true;\n    msg.bot.status.rezhim = \"МА - закуп запрещён\";\n}\n\nlet newset = {\"last_price\":Number(msg.payload),\n                \"status\":msg.bot.status, \n                \"zapret_na_zakup\":msg.bot.zapret_na_zakup\n    };\n\nmsg.payload = newset;\n\nmsg.headers = {};\nmsg.headers['accept'] = 'application/json';\nmsg.headers['Content-Type'] = 'application/json';\n\nconst upd = global.get('updateSettings')(msg.payload, msg.bot.id);\n\nupd.then(upd => {\n\n    msg.payload = {\"bot\":msg.bot};\n    //>трекер>\n        let end_node_time = Date.parse(new Date()) / 1000;\n        let duration = end_node_time - start_node_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n    node.status({fill:\"red\",shape:\"dot\"});\n});\n\n//   \"zapret_na_zakup\":msg.bot.zapret_na_zakup","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1360,"y":960,"wires":[["d010274c.5b8918"]],"icon":"font-awesome/fa-bolt"},{"id":"71acd437.96b3dc","type":"switch","z":"38c422f8.b82bf6","g":"89dcb365.f1eba","name":"last_price ? current price","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"bot.last_price","vt":"msg"},{"t":"eq","v":"bot.last_price","vt":"msg"}],"checkall":"true","repair":false,"outputs":2,"x":1030,"y":960,"wires":[["a445188a.34a218"],["23a461b5.8934de"]]},{"id":"12960d0b.36ef23","type":"function","z":"38c422f8.b82bf6","g":"c0b0e6b5.5e71f","name":"updateSettings : busy=false","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = Date.parse(new Date()) / 1000;\n    let steptitle = node.name;\n//>трекер>\n\nlet newsetb = {\"busy\":false};\n\nmsg.payload = newsetb;\n\nmsg.headers = {};\nmsg.headers['accept'] = 'application/json';\nmsg.headers['Content-Type'] = 'application/json';\n\n    let idstep = msg.bot.id+\"-step\";\n    flow.set(idstep, 8);\n\nconst upd = global.get('updateSettings')(msg.payload, msg.bot.id);\n\nupd.then(upd => {\n//>трекер>\n    let end_node_time = Date.parse(new Date()) / 1000;\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration\": duration\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill:\"green\",shape:\"dot\"});    \n    msg.payload = \"updated\"\n    node.send(msg);\n\n}).catch(error => {\n    node.status({fill:\"red\",shape:\"dot\"});  \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2380,"y":720,"wires":[["3e18acb8.6ea274"]],"icon":"font-awesome/fa-bolt"},{"id":"18fc789.fac9d87","type":"function","z":"38c422f8.b82bf6","g":"89dcb365.f1eba","name":"prepare getprice","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = Date.parse(new Date()) / 1000;\n    let steptitle = node.name;\n//>трекер>\n\nlet moneta = msg.payload.bot.settings.moneta;\nmsg.bot = msg.payload.bot;\n\nmsg.payload = [];\nmsg.topic = \"prices:\" + moneta;\n    \n//>трекер>\n    let end_node_time = Date.parse(new Date()) / 1000;\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration\": duration\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill:\"green\",shape:\"dot\"});\n    \nreturn msg;\n    \n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":440,"y":960,"wires":[["79163972.5bdbe8"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"79163972.5bdbe8","type":"redis-command","z":"38c422f8.b82bf6","g":"89dcb365.f1eba","server":"f120eab2.0a60a8","command":"GET","name":"get price","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":620,"y":960,"wires":[["a9b8fcea.cf55d"]]},{"id":"3e18acb8.6ea274","type":"debug","z":"38c422f8.b82bf6","g":"c0b0e6b5.5e71f","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2450,"y":780,"wires":[]},{"id":"536d19d6.716798","type":"function","z":"38c422f8.b82bf6","g":"6d0bae3e.4983b8","name":"updateSettings : busy=true","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = Date.parse(new Date()) / 1000;\n    let steptitle = node.name;\n//>трекер>\nlet newset = {\"busy\":true};\n\nmsg.topic = msg.payload;\nmsg.payload = newset;\n\nmsg.headers = {};\nmsg.headers['accept'] = 'application/json';\nmsg.headers['Content-Type'] = 'application/json';\n\n\nconst upd = global.get('updateSettings')(msg.payload, msg.topic);\n\nupd.then(upd => {\n    \n    msg.payload = msg.topic;\n    let idstep = msg.topic+\"-step\";\n\n    \n//>трекер>\n    let end_node_time = Date.parse(new Date()) / 1000;\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration\": duration\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill:\"green\",shape:\"dot\"});\n\n    node.send(msg);\n    node.done();\n\n}).catch(error => {\n    node.status({fill:\"red\",shape:\"dot\"});\n    node.error(error);\n});\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1880,"y":720,"wires":[["9d731fd4.ec333"]],"icon":"font-awesome/fa-bolt"},{"id":"a9b8fcea.cf55d","type":"function","z":"38c422f8.b82bf6","g":"89dcb365.f1eba","name":"topic = bot.id","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = Date.parse(new Date()) / 1000;\n    let steptitle = node.name;\n//>трекер>\n\nmsg.topic = msg.bot.id\n\n//>трекер>\n    let end_node_time = Date.parse(new Date()) / 1000;\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration\": duration\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":800,"y":960,"wires":[["71acd437.96b3dc"]]},{"id":"9d731fd4.ec333","type":"link out","z":"38c422f8.b82bf6","g":"6d0bae3e.4983b8","name":"start 250","links":["34642144.ae139e"],"x":2055,"y":720,"wires":[],"icon":"font-awesome/fa-space-shuttle"},{"id":"34642144.ae139e","type":"link in","z":"38c422f8.b82bf6","g":"89dcb365.f1eba","name":"узбек 250","links":["9d731fd4.ec333","bdd26a23.d309d"],"x":115,"y":960,"wires":[["13f2257b.01983b"]],"icon":"font-awesome/fa-space-shuttle"},{"id":"618930a2.3dffb","type":"function","z":"38c422f8.b82bf6","name":"определяем этаж","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = Date.parse(new Date()) / 1000;\n    let steptitle = node.name;\n//>трекер>\n\nlet lp = msg.bot.last_price;\nlet f = msg.bot.floors;\n\n    var curfloor = f.filter(function(floor) {\n     return ((floor[1]<=lp)&&(floor[2]>lp));\n    });\n\nif (curfloor[0]) {\n   // node.warn(curfloor); //\n   //>трекер>\n        let end_node_time = Date.parse(new Date()) / 1000;\n        let duration = end_node_time - start_node_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n   \n   \n    msg.bot.status.currentfloor = curfloor[0];\n    return [msg, null];\n} \nelse\n{\n    \n     //>трекер>\n        let end_node_time = Date.parse(new Date()) / 1000;\n        let duration = end_node_time - start_node_time;\n        track.push({\n            \"steptitle\": steptitle+\"вне сетки\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    \n   node.status({fill:\"red\",shape:\"dot\"}); \n   // node.warn(\"вне сетки\"); \n    return [null,msg];\n}\n\n","outputs":2,"noerr":0,"initialize":"","finalize":"","x":430,"y":2800,"wires":[["654f08ad.d21cf8","79a93671.4908f"],["ec3bcc27.2d321"]]},{"id":"52932694.e0d918","type":"comment","z":"38c422f8.b82bf6","name":"вне сетки","info":"","x":441.4285430908203,"y":2855.714080810547,"wires":[]},{"id":"e34cab2c.f35798","type":"comment","z":"38c422f8.b82bf6","g":"89dcb365.f1eba","name":"работаем со всеми этажами","info":"","x":1480,"y":900,"wires":[]},{"id":"654f08ad.d21cf8","type":"switch","z":"38c422f8.b82bf6","name":"статус этажа","property":"bot.status.currentfloor[7]","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"eq","v":"1","vt":"str"},{"t":"eq","v":"2","vt":"str"},{"t":"eq","v":"3","vt":"str"},{"t":"eq","v":"4","vt":"str"}],"checkall":"true","repair":false,"outputs":5,"x":660,"y":2800,"wires":[["9a8d53a0.bd127"],[],["afd8e2a9.7ef34"],["4583d2f5.6234ac"],["c397e056.6b1a3"]]},{"id":"9a8d53a0.bd127","type":"switch","z":"38c422f8.b82bf6","name":"проверка запрета на закуп","property":"bot.zapret_na_zakup","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":1220,"y":2480,"wires":[["e16705a1.83df08","ed3ebb40.401b98"],["ead17618.db03e8","f053413b.f6608"]]},{"id":"d010274c.5b8918","type":"link out","z":"38c422f8.b82bf6","g":"89dcb365.f1eba","name":"передаем этажному узбеку","links":["78ca5c87.8628d4"],"x":1595,"y":960,"wires":[]},{"id":"b414ae7e.1f40d","type":"link in","z":"38c422f8.b82bf6","name":"этажный узбек","links":["ac559e43.94903","ce43fd6d.7b213","e7b2e93a.d772a8","6b66fec2.62c95","64ef31ed.e495e8"],"x":155,"y":1520,"wires":[["7a8474f8.a35f2c"]]},{"id":"ead17618.db03e8","type":"link out","z":"38c422f8.b82bf6","name":"заперещено закупать","links":["62b1f37b.6896ec","eb00b163.ba0f88"],"x":1355,"y":2520,"wires":[]},{"id":"ec3bcc27.2d321","type":"link out","z":"38c422f8.b82bf6","name":"вне сетки","links":["62b1f37b.6896ec","eb00b163.ba0f88"],"x":515,"y":2860,"wires":[]},{"id":"e545caa6.7236c8","type":"link out","z":"38c422f8.b82bf6","g":"89dcb365.f1eba","name":"цена не изменилась","links":["62b1f37b.6896ec","eb00b163.ba0f88"],"x":1595,"y":1020,"wires":[]},{"id":"fee94f7f.5f093","type":"comment","z":"38c422f8.b82bf6","name":"запрещено закупать","info":"","x":1221.4285430908203,"y":2515.714080810547,"wires":[]},{"id":"503437af.280cc8","type":"graphql","z":"38c422f8.b82bf6","g":"339f6357.48270c","name":"gql запрос списка ботов","graphql":"ab190c2e.90269","format":"handlebars","syntax":"mustache","template":"query {\n  bots{\n  onoff\n  id\n  busy\n  }\n}","x":790,"y":480,"wires":[["8deed84b.3c9898"],[]]},{"id":"8deed84b.3c9898","type":"function","z":"38c422f8.b82bf6","g":"339f6357.48270c","name":"payload = payload.bots","func":"\nmsg.payload = msg.payload.bots;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1050,"y":480,"wires":[["d4a5db44.14dd68"]]},{"id":"d4a5db44.14dd68","type":"split","z":"38c422f8.b82bf6","g":"339f6357.48270c","name":"","splt":"1","spltType":"len","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1250,"y":480,"wires":[["1cce308b.ed6fef"]]},{"id":"1cce308b.ed6fef","type":"function","z":"38c422f8.b82bf6","g":"339f6357.48270c","name":"onoff === true","func":"if (msg.payload.onoff === true){\n\n     msg.payload = msg.payload.id;\n\nreturn msg;\n}\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1400,"y":480,"wires":[["2c379b0e.e23f04"]],"icon":"font-awesome/fa-bolt"},{"id":"4a9286e5.e8f4e8","type":"trigger","z":"38c422f8.b82bf6","g":"339f6357.48270c","name":"","op1":"1","op2":"0","op1type":"str","op2type":"str","duration":"-10","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":550,"y":480,"wires":[["503437af.280cc8"]]},{"id":"29caead0.b6b606","type":"comment","z":"38c422f8.b82bf6","g":"339f6357.48270c","name":"Расчет МА","info":"","x":170,"y":420,"wires":[]},{"id":"2c379b0e.e23f04","type":"graphql","z":"38c422f8.b82bf6","g":"339f6357.48270c","name":"get bot all data","graphql":"ab190c2e.90269","format":"handlebars","syntax":"mustache","template":"query {\n  bot (id: \"{{payload}}\"){\n    id\n    settings\n    last_price\n    status\n    zapret_na_zakup\n     keypair{\n      apikey\n      secret\n      market\n    }\n  }\n}","x":1600,"y":480,"wires":[["7ecd73a6.b4458c"],[]]},{"id":"7ecd73a6.b4458c","type":"function","z":"38c422f8.b82bf6","g":"339f6357.48270c","name":"get candlestick","func":"function parseApiError(error) {\n  if (error.body) {\n    try {\n      var resp = JSON.parse(error.body);\n      return resp.msg;\n    } catch (error) {/* pass thru */}\n  }\n  return \"Unknown error. Status code: \"+error.statsCode;\n}\n\nlet LBinance = global.get('gBinance');\n//node.warn(LBinance);\nlet binance = new LBinance().options({\n\tAPIKEY: msg.payload.bot.keypair.apikey,\n\tAPISECRET: msg.payload.bot.keypair.secret,\n\t\"reconnect\": false\n});\n\nlet moneta = msg.payload.bot.settings.moneta;\nlet deep = msg.payload.bot.settings.ma2;\n\n//node.warn(binance);\n\n\n//msg.payload = \"qjson.status\";\nmsg.bot = msg.payload.bot;\n\nbinance.candlesticks(moneta, \"1m\", (error, ticks, symbol) => {\n // console.info(\"candlesticks()\", ticks);\n // let last_tick = ticks[ticks.length - 1];\n // let [time, open, high, low, close, volume, closeTime, assetVolume, trades, buyBaseVolume, buyAssetVolume, ignored] = ticks;\n  //console.info(symbol+\" last close: \"+close);\n  msg.payload = ticks;\n  \n  node.send(msg);\n  return;\n  \n}, {limit: deep});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1800,"y":480,"wires":[["5ad83996.397588"]],"inputLabels":["orderid, moneta"],"outputLabels":["status"],"icon":"font-awesome/fa-compress"},{"id":"5ad83996.397588","type":"function","z":"38c422f8.b82bf6","g":"339f6357.48270c","name":"расчет MA","func":"let candles = msg.payload;\n\n\nlet heiken = candles.map(function(tick){\n  //  node.warn(tick);\n    \n    \n    return (Number(tick[1]) + Number(tick[2]) + Number(tick[3]) + Number(tick[4]))/4;\n});\n\n\n//node.warn(heiken);\nmsg.heiken = heiken;\n\n\nlet heiken_small = heiken.slice(-msg.bot.settings.ma1);\n\n//node.warn(heiken_small);\nlet sum_all = heiken.reduce(function(sum, current) {\n  return sum + current\n});\n\nlet sum_small = heiken_small.reduce(function(sum, current) {\n  return sum + current\n});\n\nmsg.bot.status.sr_ma_big = sum_all / msg.bot.settings.ma2;\nmsg.bot.status.sr_ma_small = sum_small / msg.bot.settings.ma1;\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1970,"y":480,"wires":[["3c339a4d.3cb876"]]},{"id":"3c339a4d.3cb876","type":"function","z":"38c422f8.b82bf6","g":"339f6357.48270c","name":"update bot status","func":"\n\nlet newsetb = {\"status\":msg.bot.status};\n//newset = JSON.stringify(newset);\n//node.warn(newsetb);\n\nmsg.payload = newsetb;\n\nmsg.headers = {};\nmsg.headers['accept'] = 'application/json';\nmsg.headers['Content-Type'] = 'application/json';\n\n   // let idstep = msg.bot.id+\"-step\";\n   // flow.set(idstep, 8);\n\nconst upd = global.get('updateSettings')(msg.payload, msg.bot.id);\n\nupd.then(upd => {\n    \n    msg.payload = \"updated\"\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2150,"y":480,"wires":[["3df007b7.771648"]],"icon":"font-awesome/fa-bolt"},{"id":"e16705a1.83df08","type":"function","z":"38c422f8.b82bf6","name":"set buy order","func":"function parseApiError(error) {\n  if (error.body) {\n    try {\n      var resp = JSON.parse(error.body);\n      return resp.msg;\n    } catch (error) {/* pass thru */}\n  }\n  return \"Unknown error. Status code: \"+error.statsCode;\n}\n\nlet LBinance = global.get('gBinance');\n//node.warn(LBinance);\nlet binance = new LBinance().options({\n\tAPIKEY: msg.bot.keypair.apikey,\n\tAPISECRET: msg.bot.keypair.secret,\n\t\"reconnect\": false\n});\n\nlet moneta = msg.bot.settings.moneta;\nlet quantity = Number((Number(msg.bot.finance.depo)*Number(msg.bot.settings.ordersize)/100/msg.bot.last_price).toFixed(msg.bot.settings.digitq));\nlet price = Number((msg.bot.status.currentfloor[3]).toFixed(msg.bot.settings.digitprice));\nnode.warn(quantity);\n\n//msg.payload = \"qjson.status\";\n\n\n\n\nbinance.buy(moneta, quantity, price, {type:'LIMIT'}, (err, resp) => {\n // console.info(\"Limit Buy response\", response);\n // console.info(\"order id: \" + response.orderId);\n    if (err) {\n        var errorMsg = parseApiError(err) + \", moneta:\" + moneta;\n        node.error(errorMsg, msg);\n        node.status({fill: \"red\", shape: \"ring\", text: errorMsg});\n        node.send(msg);\n        //return [msg, null];\n    \n    }\n    if (resp) {\n        msg.orderid = resp.orderId;\n        msg.resp = resp;\n        node.status({fill: \"green\", shape: \"ring\", text: resp.orderId});\n        node.send(msg);\n       // return [null,msg];\n                \n    }\n    //node.status({}); //clear status message\n});\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1490,"y":2480,"wires":[["7c34199a.ae4948","3ff7fc13.f3a62c"]],"inputLabels":["orderid, moneta"],"outputLabels":["status"],"icon":"font-awesome/fa-compress"},{"id":"7c34199a.ae4948","type":"function","z":"38c422f8.b82bf6","name":"change floors, finance ","func":"let idstep = msg.bot.id+\"-step\";\nflow.set(idstep, \"0 - change floors, finance\");\n\n\nlet currentfloor = msg.bot.status.currentfloor\ncurrentfloor[7] = 1;\ncurrentfloor[8] = msg.resp.orderId;\ncurrentfloor[14] = msg.resp.origQty;\n\nmsg.bot.floors[currentfloor[0]-1] = currentfloor;\n\nmsg.bot.finance.baseinorders = (Number(Number(msg.bot.finance.baseinorders) + Number(msg.resp.origQty) * Number(msg.resp.price))).toFixed(msg.bot.settings.digitprice);\nmsg.bot.finance.basenal = (Number(Number(msg.bot.finance.basenal) - Number(msg.resp.origQty) * Number(msg.resp.price))).toFixed(msg.bot.settings.digitprice);\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1700,"y":2480,"wires":[["4b9e0594.e0be5c"]]},{"id":"4b9e0594.e0be5c","type":"function","z":"38c422f8.b82bf6","name":"update bot floors, finance","func":"\n\nlet newsetb = {\"floors\":msg.bot.floors, \"finance\":msg.bot.finance};\n//newset = JSON.stringify(newset);\n//node.warn(newsetb);\n\nmsg.payload = newsetb;\n\nmsg.headers = {};\nmsg.headers['accept'] = 'application/json';\nmsg.headers['Content-Type'] = 'application/json';\n\n   // let idstep = msg.bot.id+\"-step\";\n   // flow.set(idstep, 8);\n\nconst upd = global.get('updateSettings')(msg.payload, msg.bot.id);\n\nupd.then(upd => {\n    \n    msg.payload = \"updated\"\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1950,"y":2480,"wires":[["2956ac05.ff4344","7ecf7e00.a0d31"]],"icon":"font-awesome/fa-bolt"},{"id":"ab453ff0.f0607","type":"debug","z":"38c422f8.b82bf6","g":"6d0bae3e.4983b8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1670,"y":760,"wires":[]},{"id":"2956ac05.ff4344","type":"link out","z":"38c422f8.b82bf6","name":"","links":["62b1f37b.6896ec","eb00b163.ba0f88"],"x":2135,"y":2460,"wires":[]},{"id":"2fb97838.e99388","type":"link out","z":"38c422f8.b82bf6","name":"заперещено закупать","links":["62b1f37b.6896ec","eb00b163.ba0f88"],"x":2216.4285430908203,"y":2515.714080810547,"wires":[]},{"id":"623691b3.5a4c","type":"comment","z":"38c422f8.b82bf6","g":"89dcb365.f1eba","name":"определяем изменилась ли цена","info":"","x":299,"y":900,"wires":[]},{"id":"cb8cd7bb.8245b8","type":"comment","z":"38c422f8.b82bf6","name":"дежурный по этажу","info":"","x":381.4285430908203,"y":2695.714080810547,"wires":[]},{"id":"75b77b62.c812e4","type":"function","z":"38c422f8.b82bf6","name":"topic","func":"msg.topic = msg.bot.id\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1611.4285430908203,"y":2635.714080810547,"wires":[["e8d3ff71.0b342"]]},{"id":"a4f0bf29.e2039","type":"function","z":"38c422f8.b82bf6","name":"prepare get order status","func":"//msg.bot = msg.payload.bot;\n    let idstep = msg.bot.id+\"-step\";\n    flow.set(idstep, \"покупаем\");\n\nlet moneta = msg.bot.settings.moneta;\nlet orderid = msg.bot.status.currentfloor[8];\n\nmsg.payload = [];\nmsg.topic = \"orders-status-\" + msg.bot.settings.userid + \":\" + moneta + \":\" + orderid;\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1211.4285430908203,"y":2635.714080810547,"wires":[["1f74cb03.b098d5"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"1f74cb03.b098d5","type":"redis-command","z":"38c422f8.b82bf6","server":"f120eab2.0a60a8","command":"GET","name":"get order status","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1441.4285430908203,"y":2635.714080810547,"wires":[["75b77b62.c812e4"]]},{"id":"e8d3ff71.0b342","type":"switch","z":"38c422f8.b82bf6","name":"статус ордера","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"NEW","vt":"str"},{"t":"eq","v":"PARTIALLY_FILLED","vt":"str"},{"t":"eq","v":"CANCELED","vt":"str"},{"t":"eq","v":"FILLED","vt":"str"},{"t":"eq","v":"REJECTED","vt":"str"},{"t":"eq","v":"EXPIRED","vt":"str"}],"checkall":"true","repair":false,"outputs":6,"x":1801.4285430908203,"y":2635.714080810547,"wires":[["2fb97838.e99388"],["2fb97838.e99388"],["bfa40a78.696948"],[],["c5286ec6.a8b15"],["c5286ec6.a8b15"]]},{"id":"eab0e428.fcd408","type":"comment","z":"38c422f8.b82bf6","name":"NEW","info":"","x":2231.4285430908203,"y":2475.714080810547,"wires":[]},{"id":"31d94907.d5ee46","type":"comment","z":"38c422f8.b82bf6","name":"CANCELED","info":"","x":2251.4285430908203,"y":2575.714080810547,"wires":[]},{"id":"c887e0b8.f3139","type":"comment","z":"38c422f8.b82bf6","name":"FILLED","info":"","x":2231.4285430908203,"y":2715.714080810547,"wires":[]},{"id":"53825580.1576fc","type":"comment","z":"38c422f8.b82bf6","name":"REJECTED или EXPIRED","info":"","x":2291.4285430908203,"y":2895.714080810547,"wires":[]},{"id":"6dcd6fc8.44e7a","type":"comment","z":"38c422f8.b82bf6","name":"0 - Свободно","info":"","x":1151.4285430908203,"y":2435.714080810547,"wires":[]},{"id":"4eb7b103.982d3","type":"comment","z":"38c422f8.b82bf6","name":"1 - Покупаем","info":"","x":1151.4285430908203,"y":2595.714080810547,"wires":[]},{"id":"afd8e2a9.7ef34","type":"function","z":"38c422f8.b82bf6","name":"check price for sale start","func":"if (msg.bot.last_price >= msg.bot.status.currentfloor[5]){\n    msg.bot.status.currentfloor[7] = 3;\n    \n\n    return [null,msg];\n    \n} else {\n    return [msg,null];\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","x":1210,"y":2800,"wires":[["58341de1.c6a694"],["4c8c6a95.68df5c"]]},{"id":"a25fa3a.ee7886","type":"comment","z":"38c422f8.b82bf6","name":"2 - Купили. Держим","info":"","x":1181.4285430908203,"y":2755.714080810547,"wires":[]},{"id":"4b58e0d8.8011e","type":"comment","z":"38c422f8.b82bf6","name":"3 - Продаём","info":"","x":1151.4285430908203,"y":2895.714080810547,"wires":[]},{"id":"c397e056.6b1a3","type":"function","z":"38c422f8.b82bf6","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1160,"y":3080,"wires":[[]]},{"id":"6c1c2e57.86b3e","type":"comment","z":"38c422f8.b82bf6","name":"4 - Продали","info":"","x":1151.4285430908203,"y":3035.714080810547,"wires":[]},{"id":"933bc906.115c18","type":"function","z":"38c422f8.b82bf6","name":"update bot floors, finance","func":"\n\nlet newsetb = {\"floors\":msg.bot.floors, \"finance\":msg.bot.finance};\n//newset = JSON.stringify(newset);\n//node.warn(newsetb);\n\nmsg.payload = newsetb;\n\nmsg.headers = {};\nmsg.headers['accept'] = 'application/json';\nmsg.headers['Content-Type'] = 'application/json';\n\n   // let idstep = msg.bot.id+\"-step\";\n   // flow.set(idstep, 8);\n\nconst upd = global.get('updateSettings')(msg.payload, msg.bot.id);\n\nupd.then(upd => {\n    \n    msg.payload = \"updated\"\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2571.4285430908203,"y":2615.714080810547,"wires":[["abadb293.75484"]],"icon":"font-awesome/fa-bolt"},{"id":"a43ddf8b.ec7a1","type":"function","z":"38c422f8.b82bf6","name":"update bot floors, finance","func":"\n\nlet newsetb = {\"floors\":msg.bot.floors, \"finance\":msg.bot.finance};\n//newset = JSON.stringify(newset);\n//node.warn(newsetb);\n\nmsg.payload = newsetb;\n\nmsg.headers = {};\nmsg.headers['accept'] = 'application/json';\nmsg.headers['Content-Type'] = 'application/json';\n\n   // let idstep = msg.bot.id+\"-step\";\n   // flow.set(idstep, 8);\n\nconst upd = global.get('updateSettings')(msg.payload, msg.bot.id);\n\nupd.then(upd => {\n    \n    msg.payload = \"updated\"\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2571.4285430908203,"y":2755.714080810547,"wires":[["ff0bcae8.e1f978"]],"icon":"font-awesome/fa-bolt"},{"id":"1592eedd.d43391","type":"function","z":"38c422f8.b82bf6","name":"update bot floors, finance","func":"\n\nlet newsetb = {\"floors\":msg.bot.floors, \"finance\":msg.bot.finance};\n//newset = JSON.stringify(newset);\n//node.warn(newsetb);\n\nmsg.payload = newsetb;\n\nmsg.headers = {};\nmsg.headers['accept'] = 'application/json';\nmsg.headers['Content-Type'] = 'application/json';\n\n   // let idstep = msg.bot.id+\"-step\";\n   // flow.set(idstep, 8);\n\nconst upd = global.get('updateSettings')(msg.payload, msg.bot.id);\n\nupd.then(upd => {\n    \n    msg.payload = \"updated\"\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2571.4285430908203,"y":2935.714080810547,"wires":[[]],"icon":"font-awesome/fa-bolt"},{"id":"bfa40a78.696948","type":"function","z":"38c422f8.b82bf6","name":"change floors, finance ","func":"let idstep = msg.bot.id+\"-step\";\nflow.set(idstep, \"регистрируем отмену ордера\");\n    \nlet tempfin = Number(Number(msg.bot.finance.baseinorders) - Number(msg.bot.status.currentfloor[14])*Number(msg.bot.status.currentfloor[3]));\nlet tempfin2 = Number(Number(msg.bot.finance.basenal) + Number(msg.bot.status.currentfloor[14])*Number(msg.bot.status.currentfloor[3]));\n\nmsg.bot.finance.baseinorders = tempfin.toFixed(msg.bot.settings.digitprice);\nmsg.bot.finance.basenal = tempfin2.toFixed(msg.bot.settings.digitprice);\n\nif (msg.bot.finance.baseinorders == -0) {msg.bot.finance.baseinorders = 0;}\nif (msg.bot.finance.basenal == -0) {msg.bot.finance.basenal = 0;}\n\nlet currentfloor = msg.bot.status.currentfloor;\ncurrentfloor[7] = 0;\ncurrentfloor[8] = 0;\ncurrentfloor[14] = 0;\n\nmsg.bot.floors[currentfloor[0]-1] = currentfloor;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2301.4285430908203,"y":2615.714080810547,"wires":[["933bc906.115c18"]]},{"id":"2d40e9a0.c0ec26","type":"function","z":"38c422f8.b82bf6","name":"change floors, finance ","func":"let idstep = msg.bot.id+\"-step\";\nflow.set(idstep, \"регистрируем покупку\");\n    \nlet tempfin = Number(Number(msg.bot.finance.baseinorders) - Number(msg.bot.status.currentfloor[14])*Number(msg.bot.status.currentfloor[3]));\n\nlet tempfin2 = Number(Number(msg.bot.finance.quotanal) + Number(msg.bot.status.currentfloor[14]));\n\nmsg.bot.finance.baseinorders = tempfin.toFixed(msg.bot.settings.digitprice);\nmsg.bot.finance.quotanal = tempfin2.toFixed(msg.bot.settings.digitq);\n\nif (msg.bot.finance.baseinorders == -0) {msg.bot.finance.baseinorders = 0;}\nif (msg.bot.finance.basenal == -0) {msg.bot.finance.basenal = 0;}\n\nlet currentfloor = msg.bot.status.currentfloor;\ncurrentfloor[7] = 2;\n\n\nmsg.bot.floors[currentfloor[0]-1] = currentfloor;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2301.4285430908203,"y":2755.714080810547,"wires":[["a43ddf8b.ec7a1"]]},{"id":"c5286ec6.a8b15","type":"function","z":"38c422f8.b82bf6","name":"change floors, finance ","func":"let currentfloor = msg.bot.status.currentfloor\ncurrentfloor[7] = 1;\ncurrentfloor[8] = msg.resp.orderId;\ncurrentfloor[14] = msg.resp.origQty;\n\nmsg.bot.floors[currentfloor[0]-1] = currentfloor;\n\nmsg.bot.finance.baseinorders = msg.bot.finance.baseinorders + Number(msg.resp.origQty) * Number(msg.resp.price);\nmsg.bot.finance.basenal = msg.bot.finance.basenal - Number(msg.resp.origQty) * Number(msg.resp.price);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2321.4285430908203,"y":2935.714080810547,"wires":[[]]},{"id":"abadb293.75484","type":"link out","z":"38c422f8.b82bf6","name":"заперещено закупать","links":["62b1f37b.6896ec","eb00b163.ba0f88"],"x":2756.4285430908203,"y":2615.714080810547,"wires":[]},{"id":"ea3d3b55.149208","type":"http in","z":"38c422f8.b82bf6","name":"","url":"/botdel","method":"post","upload":false,"swaggerDoc":"","x":2750,"y":160,"wires":[["3df28ba1.815a34","40cd7415.3fcbe4"]]},{"id":"3df28ba1.815a34","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2850,"y":100,"wires":[]},{"id":"78ca5c87.8628d4","type":"link in","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"","links":["d010274c.5b8918"],"x":115,"y":1180,"wires":[["34f31521.2b27d2"]]},{"id":"ac559e43.94903","type":"link out","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"","links":["b414ae7e.1f40d","fb33fc0c.af5f78"],"x":975,"y":1140,"wires":[]},{"id":"160b4dd4.4f8e12","type":"switch","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"проверка запрета на закуп","property":"bot.zapret_na_zakup","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":520,"y":1180,"wires":[["5e6d0362.224584","650ece50.fb118"],["61b59ea7.10c3a","63a1b9e8.5ea0a"]]},{"id":"61b59ea7.10c3a","type":"function","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"filter all buy orders","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = Date.parse(new Date()) / 1000;\n    let steptitle = node.name;\n//>трекер>\n\nmsg.bot = msg.payload.bot;\n\n\nlet f = msg.bot.floors;\n\n var openfloors = f.filter(function(floor) {\n     return (floor[7] == 1);\n    });\n\nmsg.bot.openfoors = openfloors;\n\nif (openfloors.length > 0){\n    msg.payload = openfloors;\n    \n    //>трекер>\n        let end_node_time = Date.parse(new Date()) / 1000;\n        let duration = end_node_time - start_node_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n\n    node.status({fill:\"green\",shape:\"ring\",text:openfloors.length});\n    return [msg, null];\n    \n}\nelse{\n    \n    //>трекер>\n    let end_node_time = Date.parse(new Date()) / 1000;\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration\": duration\n    });\n    flow.set(\"track\", track);\n    //>трекер>\n\n    node.status({fill:\"blue\",shape:\"ring\",text:openfloors.length});\n    return [null, msg];\n}\n\n\n","outputs":2,"noerr":0,"initialize":"","finalize":"","x":790,"y":1220,"wires":[["415a64d7.94e364"],["230838f7.7d169"]]},{"id":"550838d7.0c4118","type":"function","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"cansel buy orders","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = Date.parse(new Date()) / 1000;\n    let steptitle = node.name;\n//>трекер>\n\nfunction parseApiError(error) {\n  if (error.body) {\n    try {\n      var resp = JSON.parse(error.body);\n      return resp.msg;\n    } catch (error) {/* pass thru */}\n  }\n  return \"Unknown error. Status code: \"+error.statsCode;\n}\n\nlet LBinance = global.get('gBinance');\n//node.warn(LBinance);\nlet binance = new LBinance().options({\n\tAPIKEY: msg.bot.keypair.apikey,\n\tAPISECRET: msg.bot.keypair.secret,\n\t\"reconnect\": false\n});\n\nlet moneta = msg.bot.settings.moneta;\nlet orderid = msg.bot.ttp.orderid;\n\n//msg.payload = \"qjson.status\";\n\n\nbinance.cancel(moneta, orderid, (err, resp) => {\n // console.info(\"Limit Buy response\", response);\n // console.info(\"order id: \" + response.orderId);\n    if (err) {\n        var errorMsg = parseApiError(err) + \", moneta:\" + moneta;\n        node.error(errorMsg, msg);\n        \n        \n        //>трекер>\n            let end_node_time = Date.parse(new Date()) / 1000;\n            let duration = end_node_time - start_node_time;\n            track.push({\n                \"steptitle\": steptitle,\n                \"start_node_time\": start_node_time,\n                \"end_node_time\": end_node_time,\n                \"duration\": duration\n            });\n            flow.set(\"track\", track);\n        //>трекер>\n        \n        \n        node.status({fill: \"red\", shape: \"ring\", text: errorMsg});\n        node.send(msg);\n        \n    \n    }\n    if (resp) {\n        msg.orderid = resp.orderId;\n        msg.resp = resp;\n        \n        //>трекер>\n            let end_node_time = Date.parse(new Date()) / 1000;\n            let duration = end_node_time - start_node_time;\n            track.push({\n                \"steptitle\": steptitle,\n                \"start_node_time\": start_node_time,\n                \"end_node_time\": end_node_time,\n                \"duration\": duration\n            });\n            flow.set(\"track\", track);\n        //>трекер>\n\n        \n        node.status({fill:\"green\", shape:\"ring\", text:resp.orderId});\n        node.send(msg);\n        \n                \n    }\n    //node.status({}); //clear status message\n});\n\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2610,"y":1160,"wires":[["f369c890.c7bf58"]]},{"id":"89848e2c.9b815","type":"function","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"update bot floors, finance","func":"\n\nlet newsetb = {\"floors\":msg.bot.floors, \"finance\":msg.bot.finance};\n//newset = JSON.stringify(newset);\n//node.warn(newsetb);\n\nmsg.payload = newsetb;\n\nmsg.headers = {};\nmsg.headers['accept'] = 'application/json';\nmsg.headers['Content-Type'] = 'application/json';\n\n   // let idstep = msg.bot.id+\"-step\";\n   // flow.set(idstep, 8);\n\nconst upd = global.get('updateSettings')(msg.payload, msg.bot.id);\n\nupd.then(upd => {\n    \n    msg.payload = \"updated\"\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3230,"y":1160,"wires":[["e7b2e93a.d772a8","d9c2af4e.ac296"]],"icon":"font-awesome/fa-bolt"},{"id":"f369c890.c7bf58","type":"function","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"change floors, finance ","func":"let idstep = msg.bot.id+\"-step\";\nflow.set(idstep, \"регистрируем отмену ордера\");\n    \nlet tempfin = Number(Number(msg.bot.finance.baseinorders) - Number(msg.payload[14])*Number(msg.payload[3]));\nlet tempfin2 = Number(Number(msg.bot.finance.basenal) + Number(msg.payload[14])*Number(msg.payload[3]));\n\nmsg.bot.finance.baseinorders = tempfin.toFixed(msg.bot.settings.digitprice);\nmsg.bot.finance.basenal = tempfin2.toFixed(msg.bot.settings.digitprice);\n\nif (msg.bot.finance.baseinorders == -0) {msg.bot.finance.baseinorders = 0;}\nif (msg.bot.finance.basenal == -0) {msg.bot.finance.basenal = 0;}\n\nlet currentfloor = msg.payload;\ncurrentfloor[7] = 0;\ncurrentfloor[8] = 0;\ncurrentfloor[14] = 0;\n\nmsg.bot.floors[currentfloor[0]-1] = currentfloor;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2840,"y":1160,"wires":[["99328f1c.3a173","b3a83312.3848e"]]},{"id":"e7b2e93a.d772a8","type":"link out","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"заперещено закупать","links":["b414ae7e.1f40d","fb33fc0c.af5f78"],"x":3395,"y":1160,"wires":[]},{"id":"99328f1c.3a173","type":"debug","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2910,"y":1220,"wires":[]},{"id":"d9c2af4e.ac296","type":"debug","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3290,"y":1220,"wires":[]},{"id":"6efa7034.90b4e","type":"split","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1310,"y":1200,"wires":[["2bde6947.f7ecae"]]},{"id":"b3a83312.3848e","type":"join","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":3030,"y":1160,"wires":[["89848e2c.9b815"]]},{"id":"ce43fd6d.7b213","type":"link out","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"","links":["b414ae7e.1f40d","fb33fc0c.af5f78"],"x":1195,"y":1280,"wires":[]},{"id":"ff0bcae8.e1f978","type":"link out","z":"38c422f8.b82bf6","name":"заперещено закупать","links":["62b1f37b.6896ec","eb00b163.ba0f88"],"x":2756.4285430908203,"y":2755.714080810547,"wires":[]},{"id":"58341de1.c6a694","type":"link out","z":"38c422f8.b82bf6","name":"купили держим","links":["62b1f37b.6896ec","eb00b163.ba0f88"],"x":1415,"y":2780,"wires":[]},{"id":"648a5444.882654","type":"comment","z":"38c422f8.b82bf6","name":"ttp","info":"","x":310,"y":3720,"wires":[]},{"id":"19ac974.7607b69","type":"function","z":"38c422f8.b82bf6","name":"set stop sell order","func":"//msg.curstop = Number(msg.bot.ttp.curstop);\n\nmsg.bot.ttp.quantity = msg.bot.ttp.quantity || 0;\n\nfunction parseApiError(error) {\n  if (error.body) {\n    try {\n      var resp = JSON.parse(error.body);\n      return resp.msg;\n    } catch (error) {/* pass thru */}\n  }\n  return \"Unknown error. Status code: \"+error.statsCode;\n}\n\nlet LBinance = global.get('gBinance');\n//node.warn(LBinance);\nlet binance = new LBinance().options({\n\tAPIKEY: msg.bot.keypair.apikey,\n\tAPISECRET: msg.bot.keypair.secret,\n\t\"reconnect\": false\n});\n\nlet moneta = msg.bot.settings.moneta;\nlet quantity = (Number(msg.bot.ttp.quantity)).toFixed(msg.bot.settings.digitq);\n\nlet priceb = (Number((msg.bot.ttp.raschstopprice - msg.bot.ttp.raschstopprice / 100 * msg.bot.settings.ofsetbottom))).toFixed(msg.bot.settings.digitprice);\nlet stopprice = (Number(msg.bot.ttp.raschstopprice)).toFixed(msg.bot.settings.digitprice);\n\n\nnode.warn(\"q:\"+quantity);\nnode.warn(\"p:\"+priceb);\nnode.warn(\"sp:\"+stopprice);\n\n binance.sell(moneta, quantity, priceb, { stopPrice: stopprice, type: \"STOP_LOSS_LIMIT\" }, function (err, resp) {\n          if (err) {\n            var errorMsg = parseApiError(err);\n            node.error(errorMsg, msg);\n            node.status({fill: \"red\", shape: \"ring\", text: errorMsg});\n            \n            \n          }\n          if (resp) {\n                        msg.bot.ttp.orderid = resp.orderId;\n                        msg.bot.ttp.curstop = stopprice;\n          }\n          node.status({}); //clear status message\n\n          \n          node.send(msg);\n          return;\n        });","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3510,"y":4180,"wires":[["80aa4384.3193d8"]],"inputLabels":["orderid, moneta"],"outputLabels":["status"],"icon":"font-awesome/fa-compress"},{"id":"64e15eaf.9f0c4","type":"switch","z":"38c422f8.b82bf6","name":"raschstopprice ? curstop","property":"bot.ttp.raschstopprice","propertyType":"msg","rules":[{"t":"gt","v":"bot.ttp.curstop","vt":"msg"},{"t":"lte","v":"bot.ttp.curstop","vt":"msg"}],"checkall":"true","repair":false,"outputs":2,"x":1850,"y":4340,"wires":[["fe3964ed.2973e8"],["42781025.7365a"]]},{"id":"80aa4384.3193d8","type":"function","z":"38c422f8.b82bf6","name":"prepare set ttp to redis","func":"\n\nlet newsetb = {\"floors\":msg.bot.floors, \"finance\":msg.bot.finance, \"ttp\":msg.bot.ttp};\n//newset = JSON.stringify(newset);\n//node.warn(newsetb);\n\nmsg.payload = newsetb;\n\nmsg.headers = {};\nmsg.headers['accept'] = 'application/json';\nmsg.headers['Content-Type'] = 'application/json';\n\n   // let idstep = msg.bot.id+\"-step\";\n   // flow.set(idstep, 8);\n\nconst upd = global.get('updateSettings')(msg.payload, msg.bot.id);\n\nupd.then(upd => {\n    \n\n    msg.payload = upd.ttp;\n    msg.topic = upd.ttp.topic;\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3740,"y":4180,"wires":[["e27e8a1a.9239d8","5a30fbd5.81ebac"]],"icon":"font-awesome/fa-bolt"},{"id":"9dfe3623.94b6c","type":"link out","z":"38c422f8.b82bf6","name":"заперещено закупать","links":["8dbb02a7.9de1a"],"x":4075,"y":4180,"wires":[]},{"id":"e27e8a1a.9239d8","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3750,"y":4140,"wires":[]},{"id":"9cde1726.3e388","type":"link out","z":"38c422f8.b82bf6","name":"заперещено закупать","links":["8dbb02a7.9de1a"],"x":1935,"y":4640,"wires":[]},{"id":"a5f99bee.f8a658","type":"function","z":"38c422f8.b82bf6","name":"cancel stopsell order if exist","func":"\nreturn msg;function parseApiError(error) {\n  if (error.body) {\n    try {\n      var resp = JSON.parse(error.body);\n      return resp.msg;\n    } catch (error) {/* pass thru */}\n  }\n  return \"Unknown error. Status code: \"+error.statsCode;\n}\n\nlet LBinance = global.get('gBinance');\n//node.warn(LBinance);\nlet binance = new LBinance().options({\n\tAPIKEY: msg.bot.keypair.apikey,\n\tAPISECRET: msg.bot.keypair.secret,\n\t\"reconnect\": false\n});\n\nlet moneta = msg.bot.settings.moneta;\nlet orderid = msg.bot.ttp.orderid;\n\n//msg.payload = \"qjson.status\";\nif (orderid > 0){\n\n    binance.cancel(moneta, orderid, (err, resp) => {\n     // console.info(\"Limit Buy response\", response);\n     // console.info(\"order id: \" + response.orderId);\n        if (err) {\n            var errorMsg = parseApiError(err) + \", moneta:\" + moneta;\n            node.error(errorMsg, msg);\n            node.status({fill: \"red\", shape: \"ring\", text: errorMsg});\n            \n            \n            \n            node.send(msg);\n            // ;\n        \n        }\n        if (resp) {\n            msg.orderid = resp.orderId;\n            msg.resp = resp;\n            node.status({fill: \"green\", shape: \"ring\", text: resp.orderId});\n            \n            \n            let tempfin = Number(Number(msg.bot.finance.baseinorders) - Number(msg.bot.status.currentfloor[14])*Number(msg.bot.status.currentfloor[3]));\n            let tempfin2 = Number(Number(msg.bot.finance.basenal) + Number(msg.bot.status.currentfloor[14])*Number(msg.bot.status.currentfloor[3]));\n            \n            msg.bot.finance.baseinorders = tempfin.toFixed(msg.bot.settings.digitprice);\n            msg.bot.finance.basenal = tempfin2.toFixed(msg.bot.settings.digitprice);\n            \n            \n            node.send(msg);\n            //return [null,msg];\n                    \n        }\n        //node.status({}); //clear status message\n    });\n} else {\n    return msg;\n}\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3240,"y":4180,"wires":[["1a74d99c.39b9ae","19ac974.7607b69"]]},{"id":"1a74d99c.39b9ae","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3310,"y":4140,"wires":[]},{"id":"6c570894.34fb88","type":"function","z":"38c422f8.b82bf6","name":"calculate stop price","func":"\nmsg.bot.last_price = Number(msg.payload);\nmsg.bot.ttp.raschstopprice = Number(Number(msg.bot.last_price - msg.bot.last_price / 100 * msg.bot.settings.ofsettop).toFixed(msg.bot.settings.digitprice));\nmsg.bot.ttp.curstop = Number(msg.bot.ttp.curstop || 0);\nmsg.bot.ttp.curorderid = Number(msg.bot.ttp.curorderid);\nmsg.bot.ttp.quantity = Number(msg.bot.ttp.quantity);\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1590,"y":4340,"wires":[["64e15eaf.9f0c4","fd3c99ac.1a869"]]},{"id":"fd3c99ac.1a869","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1630,"y":4300,"wires":[]},{"id":"5791acbc.438464","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2311.4285430908203,"y":3395.714080810547,"wires":[]},{"id":"2dd429e8.fc29be","type":"link out","z":"38c422f8.b82bf6","name":"заперещено закупать","links":["62b1f37b.6896ec","eb00b163.ba0f88"],"x":2036.4285430908203,"y":3075.714080810547,"wires":[]},{"id":"59c7fca9.251a84","type":"function","z":"38c422f8.b82bf6","name":"topic","func":"msg.topic = msg.bot.id\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1611.4285430908203,"y":2935.714080810547,"wires":[["73bb335f.8e910c"]]},{"id":"73bb335f.8e910c","type":"switch","z":"38c422f8.b82bf6","name":"статус ордера","property":"payload","propertyType":"msg","rules":[{"t":"null"},{"t":"eq","v":"NEW","vt":"str"},{"t":"eq","v":"PARTIALLY_FILLED","vt":"str"},{"t":"eq","v":"CANCELED","vt":"str"},{"t":"eq","v":"FILLED","vt":"str"},{"t":"eq","v":"REJECTED","vt":"str"},{"t":"eq","v":"EXPIRED","vt":"str"}],"checkall":"true","repair":false,"outputs":7,"x":1821.4285430908203,"y":3175.714080810547,"wires":[["2dd429e8.fc29be"],["2dd429e8.fc29be"],["2dd429e8.fc29be"],["a2e1c788.fe99b"],["26d2069a.8c7f4a"],["3c05d46c.6ed684"],["3c05d46c.6ed684"]]},{"id":"44ff20b0.033da8","type":"comment","z":"38c422f8.b82bf6","name":"NEW","info":"","x":2171.4285430908203,"y":3035.714080810547,"wires":[]},{"id":"c30450d4.7672","type":"comment","z":"38c422f8.b82bf6","name":"CANCELED","info":"","x":2071.4285430908203,"y":3135.714080810547,"wires":[]},{"id":"1d2b8df3.148562","type":"comment","z":"38c422f8.b82bf6","name":"FILLED","info":"","x":2051.4285430908203,"y":3235.714080810547,"wires":[]},{"id":"c72ec1ed.163048","type":"comment","z":"38c422f8.b82bf6","name":"REJECTED или EXPIRED","info":"","x":1831.4285430908203,"y":3355.714080810547,"wires":[]},{"id":"a8d933b5.a10878","type":"function","z":"38c422f8.b82bf6","name":"update bot floors, finance","func":"\n\nlet newsetb = {\"floors\":msg.bot.floors, \"finance\":msg.bot.finance};\n//newset = JSON.stringify(newset);\n//node.warn(newsetb);\n\nmsg.payload = newsetb;\n\nmsg.headers = {};\nmsg.headers['accept'] = 'application/json';\nmsg.headers['Content-Type'] = 'application/json';\n\n   // let idstep = msg.bot.id+\"-step\";\n   // flow.set(idstep, 8);\n\nconst upd = global.get('updateSettings')(msg.payload, msg.bot.id);\n\nupd.then(upd => {\n    \n    msg.payload = \"updated\"\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2651.4285430908203,"y":3275.714080810547,"wires":[["63519573.f7e63c","546906a8.9838d8"]],"icon":"font-awesome/fa-bolt"},{"id":"929a70e6.c1b508","type":"function","z":"38c422f8.b82bf6","name":"update bot floors, finance","func":"\n\nlet newsetb = {\"floors\":msg.bot.floors, \"finance\":msg.bot.finance};\n//newset = JSON.stringify(newset);\n//node.warn(newsetb);\n\nmsg.payload = newsetb;\n\nmsg.headers = {};\nmsg.headers['accept'] = 'application/json';\nmsg.headers['Content-Type'] = 'application/json';\n\n   // let idstep = msg.bot.id+\"-step\";\n   // flow.set(idstep, 8);\n\nconst upd = global.get('updateSettings')(msg.payload, msg.bot.id);\n\nupd.then(upd => {\n    \n    msg.payload = \"updated\"\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2111.4285430908203,"y":3395.714080810547,"wires":[[]],"icon":"font-awesome/fa-bolt"},{"id":"6f6fe048.ee9c08","type":"function","z":"38c422f8.b82bf6","d":true,"name":"change floors, finance ","func":"let idstep = msg.bot.id+\"-step\";\nflow.set(idstep, \"регистрируем продажу\");\n\nlet sellprice = \n    \nlet tempfin = Number(Number(msg.bot.finance.quotainorders) - Number(msg.bot.status.currentfloor[14]));\n\nlet tempfin2 = Number(Number(msg.bot.finance.basenal) + Number(msg.bot.status.currentfloor[14])*sellprice);\n\nmsg.bot.finance.baseinorders = tempfin.toFixed(msg.bot.settings.digitprice);\nmsg.bot.finance.quotanal = tempfin2.toFixed(msg.bot.settings.digitq);\n\nif (msg.bot.finance.quotainorders == -0) {msg.bot.finance.baseinorders = 0;}\nif (msg.bot.finance.basenal == -0) {msg.bot.finance.basenal = 0;}\n\nlet currentfloor = msg.bot.status.currentfloor;\ncurrentfloor[7] = 2;\n\n\nmsg.bot.floors[currentfloor[0]-1] = currentfloor;\n\nreturn msg;\n\n\n\n\n    \nlet tempfin = Number(Number(msg.bot.finance.quotainorders) - Number(msg.bot.status.currentfloor[14]));\nlet tempfin2 = Number(Number(msg.bot.finance.quotanal) + Number(msg.bot.status.currentfloor[14]));\n\nmsg.bot.finance.quotainorders = tempfin.toFixed(msg.bot.settings.digitprice);\nmsg.bot.finance.quotanal = tempfin2.toFixed(msg.bot.settings.digitprice);\n\nif (msg.bot.finance.quotainorders == -0) {msg.bot.finance.baseinorders = 0;}\nif (msg.bot.finance.quotanal == -0) {msg.bot.finance.basenal = 0;}\n\nlet currentfloor = msg.bot.status.currentfloor;\ncurrentfloor[11] = 0;\n\n\nmsg.bot.floors[currentfloor[0]-1] = currentfloor;\n\nreturn msg;","outputs":1,"noerr":5,"initialize":"","finalize":"","x":2381.4285430908203,"y":3275.714080810547,"wires":[["a8d933b5.a10878","2e812e84.cc6522"]]},{"id":"3c05d46c.6ed684","type":"function","z":"38c422f8.b82bf6","name":"change floors, finance ","func":"let currentfloor = msg.bot.status.currentfloor\ncurrentfloor[7] = 1;\ncurrentfloor[8] = msg.resp.orderId;\ncurrentfloor[14] = msg.resp.origQty;\n\nmsg.bot.floors[currentfloor[0]-1] = currentfloor;\n\nmsg.bot.finance.baseinorders = msg.bot.finance.baseinorders + Number(msg.resp.origQty) * Number(msg.resp.price);\nmsg.bot.finance.basenal = msg.bot.finance.basenal - Number(msg.resp.origQty) * Number(msg.resp.price);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1841.4285430908203,"y":3395.714080810547,"wires":[[]]},{"id":"a2e1c788.fe99b","type":"link out","z":"38c422f8.b82bf6","name":"заперещено закупать","links":["62b1f37b.6896ec","eb00b163.ba0f88"],"x":2036.4285430908203,"y":3175.714080810547,"wires":[]},{"id":"63519573.f7e63c","type":"link out","z":"38c422f8.b82bf6","name":"заперещено закупать","links":["62b1f37b.6896ec","eb00b163.ba0f88"],"x":2816.4285430908203,"y":3155.714080810547,"wires":[]},{"id":"2e812e84.cc6522","type":"debug","z":"38c422f8.b82bf6","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2431.4285430908203,"y":3315.714080810547,"wires":[]},{"id":"546906a8.9838d8","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2711.4285430908203,"y":3315.714080810547,"wires":[]},{"id":"45684b39.42603c","type":"redis-command","z":"38c422f8.b82bf6","server":"f120eab2.0a60a8","command":"GET","name":"get order status","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1441.4285430908203,"y":2935.714080810547,"wires":[["59c7fca9.251a84"]]},{"id":"4583d2f5.6234ac","type":"function","z":"38c422f8.b82bf6","name":"prepare get order status","func":"//msg.bot = msg.payload.bot;\n    let idstep = msg.bot.id+\"-step\";\n    flow.set(idstep, \"prepare get order status\");\n\nlet moneta = msg.bot.settings.moneta;\nlet orderid = msg.bot.ttp.curorderid;\n\nmsg.payload = [];\nmsg.topic = \"orders-status-\" + msg.bot.settings.userid + \":\" + moneta + \":\" + orderid;\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1210,"y":2940,"wires":[[]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"61515a9a.c79fc4","type":"comment","z":"38c422f8.b82bf6","name":"PARTIALLY_FILLED","info":"","x":2331.4285430908203,"y":3035.714080810547,"wires":[]},{"id":"b9d33800.c2b3b","type":"comment","z":"38c422f8.b82bf6","name":"PARTIALLY_FILLED","info":"","x":2391.4285430908203,"y":2475.714080810547,"wires":[]},{"id":"b7f15645.081678","type":"comment","z":"38c422f8.b82bf6","name":"не проработано","info":"","x":2501.4285430908203,"y":2895.714080810547,"wires":[]},{"id":"50643dea.dae064","type":"comment","z":"38c422f8.b82bf6","name":"не проработано","info":"","x":2041.4285430908203,"y":3355.714080810547,"wires":[]},{"id":"26d2069a.8c7f4a","type":"function","z":"38c422f8.b82bf6","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2161.4285430908203,"y":3275.714080810547,"wires":[[]]},{"id":"5fdfa509.325bf4","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3470,"y":780,"wires":[]},{"id":"40cd7415.3fcbe4","type":"switch","z":"38c422f8.b82bf6","name":"payload.event","property":"payload.event","propertyType":"msg","rules":[{"t":"eq","v":"entry.create","vt":"str"},{"t":"eq","v":"entry.delete","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":2950,"y":160,"wires":[["151ea5ea.e5efc2","578b7e81.f8ac68"],["cb2efd3.46939","134207f0.1d2018"]]},{"id":"151ea5ea.e5efc2","type":"debug","z":"38c422f8.b82bf6","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3130,"y":100,"wires":[]},{"id":"cb2efd3.46939","type":"debug","z":"38c422f8.b82bf6","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3110,"y":260,"wires":[]},{"id":"578b7e81.f8ac68","type":"function","z":"38c422f8.b82bf6","name":"","func":"msg.payload = msg.payload.entry.botname;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3160,"y":140,"wires":[["9167896b.0577b"]]},{"id":"134207f0.1d2018","type":"function","z":"38c422f8.b82bf6","name":"","func":"msg.payload = msg.payload.entry.botname;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3160,"y":200,"wires":[["f393e1a2.a38a68"]]},{"id":"9167896b.0577b","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3330,"y":140,"wires":[]},{"id":"f393e1a2.a38a68","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3330,"y":200,"wires":[]},{"id":"8b92a4cb.4008b","type":"redis-out","z":"38c422f8.b82bf6","server":"f120eab2.0a60a8","command":"publish","name":"","topic":"ttp","obj":true,"x":1971.4285430908203,"y":2815.714080810547,"wires":[]},{"id":"4c8c6a95.68df5c","type":"function","z":"38c422f8.b82bf6","name":"prepare data for ttp","func":"msg.payload = {\"quantity\":msg.bot.status.currentfloor[14],\"botid\":msg.bot.id, \"bot\":msg.bot}\nmsg.topic = \"\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1490,"y":2820,"wires":[["666f7c9e.05f384"]]},{"id":"bd19b9b9.ddf578","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":310,"y":3620,"wires":[]},{"id":"de5d32c1.17533","type":"redis-in","z":"38c422f8.b82bf6","server":"f120eab2.0a60a8","command":"subscribe","name":"","topic":"ttp","obj":true,"timeout":0,"x":310,"y":3660,"wires":[["bd19b9b9.ddf578"]]},{"id":"58c269d6.3c8288","type":"switch","z":"38c422f8.b82bf6","name":"","property":"payload","propertyType":"msg","rules":[{"t":"empty"},{"t":"nempty"}],"checkall":"true","repair":false,"outputs":2,"x":890,"y":3680,"wires":[["10e3ff7f.a66d31","f1bf583c.436068"],["e581e609.d28648","4810063.73d62f8"]]},{"id":"1aef3019.21c6b8","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1330,"y":3640,"wires":[]},{"id":"abfe3ac3.3de6c","type":"redis-command","z":"38c422f8.b82bf6","server":"f120eab2.0a60a8","command":"hmset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1310,"y":3680,"wires":[["1aef3019.21c6b8","28d4f2aa.ee7e16"]]},{"id":"5cf84305.fd3fd4","type":"function","z":"38c422f8.b82bf6","name":"ttp get data prepare","func":"let botname = msg.payload.bot.settings.botname;\n\n\n\nmsg.topic = \"ttp:\" + botname;\nglobal.set(msg.topic, msg.payload.bot);\nmsg.payload = [];\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":500,"y":3680,"wires":[["fa3d4c00.81544","995c03a5.47fb7"]]},{"id":"fa3d4c00.81544","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":530,"y":3640,"wires":[]},{"id":"10e3ff7f.a66d31","type":"function","z":"38c422f8.b82bf6","name":"стартуем ттп","func":"msg.bot = global.get(msg.topic);\nlet ttp = {\n            raschstopprice: 0,\n            curstop: 0,\n            curorderid: 0,\n            quantity: msg.bot.status.currentfloor[14],\n            ttpbusy: false,\n            sold: false,\n            botid: msg.bot.id\n        }\nmsg.payload = ttp;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1080,"y":3680,"wires":[["957da4a4.a4965","abfe3ac3.3de6c"]]},{"id":"957da4a4.a4965","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1110,"y":3640,"wires":[]},{"id":"e581e609.d28648","type":"function","z":"38c422f8.b82bf6","name":"дополняем действующий ттп","func":"\n\nmsg.bot = global.get(msg.topic);\nlet ttp = {\"quantity\":Number(msg.payload.quantity) + Number(msg.bot.status.currentfloor[14]),}\nmsg.payload = ttp;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1130,"y":3800,"wires":[["b3fcdc9.c3b90a","81c17fe1.6a20a"]]},{"id":"b3fcdc9.c3b90a","type":"debug","z":"38c422f8.b82bf6","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1210,"y":3760,"wires":[]},{"id":"995c03a5.47fb7","type":"function","z":"38c422f8.b82bf6","name":"get ttp from redis","func":"\n\nconst upd = global.get('ttpget')(msg.topic);\n\nupd.then(upd => {\n\n    msg.payload = upd;\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":710,"y":3680,"wires":[["58c269d6.3c8288","a1911359.dad238"]]},{"id":"81c17fe1.6a20a","type":"redis-command","z":"38c422f8.b82bf6","server":"f120eab2.0a60a8","command":"hmset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1390,"y":3800,"wires":[["6cbfc00b.9ab4e8"]]},{"id":"6cbfc00b.9ab4e8","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1410,"y":3760,"wires":[]},{"id":"cd1809b7.b357e","type":"redis-out","z":"38c422f8.b82bf6","server":"f120eab2.0a60a8","command":"publish","name":"","topic":"ttp-pilot","obj":true,"x":1880,"y":3680,"wires":[]},{"id":"28d4f2aa.ee7e16","type":"function","z":"38c422f8.b82bf6","name":"команда на старт","func":"\nmsg.payload = msg.topic;\nmsg.topic = \"\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1530,"y":3680,"wires":[["10e6c794.fc5b2","72566d53.f8c2dc"]]},{"id":"10e6c794.fc5b2","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1570,"y":3640,"wires":[]},{"id":"e72704f9.38636","type":"delay","z":"38c422f8.b82bf6","g":"6d0bae3e.4983b8","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":310,"y":720,"wires":[["da9e4dd8.dda28"]]},{"id":"7454103b.deab28","type":"delay","z":"38c422f8.b82bf6","name":"","pauseType":"random","timeout":"100","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"25","randomLast":"75","randomUnits":"seconds","drop":false,"x":500,"y":4340,"wires":[["bf9407e2.46673","f30e2199.c59b08"]]},{"id":"bd2fb377.ae9a58","type":"function","z":"38c422f8.b82bf6","name":"ttp get data prepare pilot","func":"\n\nmsg.topic = msg.payload;\n\nmsg.payload = \"\";\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":490,"y":4280,"wires":[["bf9407e2.46673","714e8b3d.3e7fac"]]},{"id":"bf9407e2.46673","type":"function","z":"38c422f8.b82bf6","name":"get ttp from redis","func":"msg.bot = global.get(msg.topic);\n\nconst upd = global.get('ttpget')(msg.topic);\n\nupd.then(upd => {\n\n    //msg.payload = upd;\n    msg.bot.ttp = upd;\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":770,"y":4280,"wires":[["dea40dd3.663d08","e09dc045.d4c49"]]},{"id":"dea40dd3.663d08","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":730,"y":4240,"wires":[]},{"id":"fa09a74b.66d4d","type":"function","z":"38c422f8.b82bf6","name":"prepare getprice","func":"  //  let idstep = msg.payload.bot.id+\"-step\";\n   // flow.set(idstep, 2);\n\n    let moneta = msg.bot.settings.moneta;\n\n    msg.bot.ttp.topic = msg.topic;\n    msg.payload = [];\n    msg.topic = \"prices:\" + moneta;\n    \n\n    \n    return msg;\n    \n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1180,"y":4340,"wires":[["72ab8cd.fc1f774","56c927c4.9e36f"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"72ab8cd.fc1f774","type":"redis-command","z":"38c422f8.b82bf6","server":"f120eab2.0a60a8","command":"GET","name":"get price","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1380,"y":4340,"wires":[["47a30b60.50a424","6c570894.34fb88"]]},{"id":"47a30b60.50a424","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1390,"y":4300,"wires":[]},{"id":"56c927c4.9e36f","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1210,"y":4300,"wires":[]},{"id":"f30e2199.c59b08","type":"delay","z":"38c422f8.b82bf6","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":890,"y":4440,"wires":[["9f90b50d.8b1378"]]},{"id":"9f90b50d.8b1378","type":"function","z":"38c422f8.b82bf6","name":"prepare change ttp on strapi","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1120,"y":4440,"wires":[["e9c97500.c25398"]]},{"id":"e9c97500.c25398","type":"function","z":"38c422f8.b82bf6","name":"change ttp on strapi","func":"\n\nlet newsetb = {\"ttp\":msg.bot.ttp};\n//newset = JSON.stringify(newset);\n//node.warn(newsetb);\n\nmsg.payload = newsetb;\n\nmsg.headers = {};\nmsg.headers['accept'] = 'application/json';\nmsg.headers['Content-Type'] = 'application/json';\n\n   // let idstep = msg.bot.id+\"-step\";\n   // flow.set(idstep, 8);\n\nconst upd = global.get('updateSettings')(msg.payload, msg.bot.id);\n\nupd.then(upd => {\n    \n    msg.payload = \"updated\"\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1380,"y":4440,"wires":[["c76c52e6.1f27d8"]],"icon":"font-awesome/fa-bolt"},{"id":"e09dc045.d4c49","type":"switch","z":"38c422f8.b82bf6","name":"is sold ?","property":"bot.ttp.sold","propertyType":"msg","rules":[{"t":"eq","v":"true","vt":"str"},{"t":"eq","v":"false","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":980,"y":4280,"wires":[["a9929810.98fd1","3a7a4e8c.230fb2"],["fa09a74b.66d4d","2856a745.247248"]]},{"id":"a9929810.98fd1","type":"function","z":"38c422f8.b82bf6","name":"ttp finish","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1160,"y":4220,"wires":[["ade150a7.859168"]]},{"id":"8dbb02a7.9de1a","type":"link in","z":"38c422f8.b82bf6","name":"ttp-pilot-in","links":["9cde1726.3e388","9dfe3623.94b6c","a33221bc.6325b8","46710d54.f2ae4c","6c55898d.9098b8","47edff0a.ea6f58"],"x":335,"y":4340,"wires":[["7454103b.deab28","779d9cd3.7f8a3c"]]},{"id":"c76c52e6.1f27d8","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1430,"y":4400,"wires":[]},{"id":"42781025.7365a","type":"function","z":"38c422f8.b82bf6","name":"prepare get order status","func":"\n\nlet moneta = msg.bot.settings.moneta;\nlet orderid = msg.bot.ttp.curorderid;\n\nmsg.payload = [];\nmsg.topic = \"orders-status-\" + msg.bot.settings.userid + \":\" + moneta + \":\" + orderid;\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1690,"y":4480,"wires":[["ba25feef.f2d2d"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"ba25feef.f2d2d","type":"redis-command","z":"38c422f8.b82bf6","server":"f120eab2.0a60a8","command":"GET","name":"get order status","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1920,"y":4480,"wires":[["717b0900.0502e8"]]},{"id":"8179e07b.cfc8a8","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2470,"y":4860,"wires":[]},{"id":"717b0900.0502e8","type":"switch","z":"38c422f8.b82bf6","name":"статус ордера","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"NEW","vt":"str"},{"t":"eq","v":"PARTIALLY_FILLED","vt":"str"},{"t":"eq","v":"CANCELED","vt":"str"},{"t":"eq","v":"FILLED","vt":"str"},{"t":"eq","v":"REJECTED","vt":"str"},{"t":"eq","v":"EXPIRED","vt":"str"}],"checkall":"true","repair":false,"outputs":6,"x":1720,"y":4740,"wires":[["9cde1726.3e388","e3dc8325.6cc7f"],["a33221bc.6325b8","64719c51.bbb0d4"],[],["89f61ffa.3d06f"],["aba0142d.67d2b"],["aba0142d.67d2b"]]},{"id":"71764859.8bacd8","type":"comment","z":"38c422f8.b82bf6","name":"NEW","info":"","x":1950,"y":4600,"wires":[]},{"id":"c28d523f.479ce","type":"comment","z":"38c422f8.b82bf6","name":"CANCELED","info":"","x":1970,"y":4700,"wires":[]},{"id":"7ebd2f54.94422","type":"comment","z":"38c422f8.b82bf6","name":"FILLED","info":"","x":1950,"y":4800,"wires":[]},{"id":"9c21498c.19eec8","type":"comment","z":"38c422f8.b82bf6","name":"REJECTED или EXPIRED","info":"","x":2010,"y":4940,"wires":[]},{"id":"a08aa56b.2b8ab","type":"function","z":"38c422f8.b82bf6","name":"update bot floors, finance","func":"\n\nlet newsetb = {\"floors\":msg.bot.floors, \"finance\":msg.bot.finance};\n//newset = JSON.stringify(newset);\n//node.warn(newsetb);\n\nmsg.payload = newsetb;\n\nmsg.headers = {};\nmsg.headers['accept'] = 'application/json';\nmsg.headers['Content-Type'] = 'application/json';\n\n   // let idstep = msg.bot.id+\"-step\";\n   // flow.set(idstep, 8);\n\nconst upd = global.get('updateSettings')(msg.payload, msg.bot.id);\n\nupd.then(upd => {\n    \n    msg.payload = \"updated\"\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2270,"y":4860,"wires":[[]],"icon":"font-awesome/fa-bolt"},{"id":"aba0142d.67d2b","type":"function","z":"38c422f8.b82bf6","name":"change floors, finance ","func":"let currentfloor = msg.bot.status.currentfloor\ncurrentfloor[7] = 1;\ncurrentfloor[8] = msg.resp.orderId;\ncurrentfloor[14] = msg.resp.origQty;\n\nmsg.bot.floors[currentfloor[0]-1] = currentfloor;\n\nmsg.bot.finance.baseinorders = msg.bot.finance.baseinorders + Number(msg.resp.origQty) * Number(msg.resp.price);\nmsg.bot.finance.basenal = msg.bot.finance.basenal - Number(msg.resp.origQty) * Number(msg.resp.price);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2020,"y":4980,"wires":[[]]},{"id":"c94231d3.bb34e8","type":"comment","z":"38c422f8.b82bf6","name":"PARTIALLY_FILLED","info":"","x":2110,"y":4600,"wires":[]},{"id":"8f213fad.708008","type":"comment","z":"38c422f8.b82bf6","name":"не проработано","info":"","x":2200,"y":4820,"wires":[]},{"id":"89f61ffa.3d06f","type":"function","z":"38c422f8.b82bf6","name":"set sold","func":"msg.bot.ttp.sold = \"true\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2060,"y":4840,"wires":[["acbc7a02.5f235","46710d54.f2ae4c"]]},{"id":"acbc7a02.5f235","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2070,"y":4800,"wires":[]},{"id":"a33221bc.6325b8","type":"link out","z":"38c422f8.b82bf6","name":"заперещено закупать","links":["8dbb02a7.9de1a"],"x":1935,"y":4740,"wires":[]},{"id":"46710d54.f2ae4c","type":"link out","z":"38c422f8.b82bf6","name":"заперещено закупать","links":["8dbb02a7.9de1a"],"x":2195,"y":4720,"wires":[]},{"id":"fab98b62.08e56","type":"switch","z":"38c422f8.b82bf6","name":"status NEW ?","property":"payload","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":2980,"y":4240,"wires":[["a5f99bee.f8a658"],["6c55898d.9098b8"]]},{"id":"6c55898d.9098b8","type":"link out","z":"38c422f8.b82bf6","name":"заперещено закупать","links":["8dbb02a7.9de1a"],"x":3115,"y":4260,"wires":[]},{"id":"8ca7f169.922b68","type":"comment","z":"38c422f8.b82bf6","name":"ситуация","info":"когда stopsell частично заполнился, но потом цена отросла и бот хочет подвинуть ордер дальше вверх. \nПроблема будет если остаток меньше минимума лота.\nСейчас такой ордер мы просто оставляем висеть до заполненности.\nМожно пока в телеграмм о таких случаях стучать, чтобы хозяин вручную разруливал, но по уму надо двигать ордер, на ходу меняя quantity с соответствующей проекцией во floors","x":3200,"y":4260,"wires":[]},{"id":"5a30fbd5.81ebac","type":"redis-command","z":"38c422f8.b82bf6","server":"f120eab2.0a60a8","command":"hmset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":3950,"y":4180,"wires":[["9dfe3623.94b6c"]]},{"id":"ade150a7.859168","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1330,"y":4220,"wires":[]},{"id":"aee7e2e6.6942c8","type":"function","z":"38c422f8.b82bf6","name":"prepare get order status","func":"\n\nlet moneta = msg.bot.settings.moneta;\nlet orderid = msg.bot.ttp.curorderid;\n\nmsg.payload = [];\nmsg.topic = \"orders-status-\" + msg.bot.settings.userid + \":\" + moneta + \":\" + orderid;\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2350,"y":4240,"wires":[["25e5f137.e9f256"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"25e5f137.e9f256","type":"redis-command","z":"38c422f8.b82bf6","server":"f120eab2.0a60a8","command":"GET","name":"get order status","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":2580,"y":4240,"wires":[["aaad8119.7b15b"]]},{"id":"aaad8119.7b15b","type":"function","z":"38c422f8.b82bf6","name":"prepare data","func":"if (msg.payload == \"NEW\") {\n    msg.payload = true;\n}\nelse {\n    msg.payload = false;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2810,"y":4240,"wires":[["fab98b62.08e56"]]},{"id":"fe3964ed.2973e8","type":"switch","z":"38c422f8.b82bf6","name":"order id > 0 ","property":"bot.ttp.curorderid","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":2090,"y":4300,"wires":[["aee7e2e6.6942c8"],["397acf32.1d7f7"]]},{"id":"397acf32.1d7f7","type":"function","z":"38c422f8.b82bf6","name":"set stop sell order","func":"//msg.curstop = Number(msg.bot.ttp.curstop);\n\nmsg.bot.ttp.quantity = msg.bot.ttp.quantity || 0;\n\nfunction parseApiError(error) {\n  if (error.body) {\n    try {\n      var resp = JSON.parse(error.body);\n      return resp.msg;\n    } catch (error) {/* pass thru */}\n  }\n  return \"Unknown error. Status code: \"+error.statsCode;\n}\n\nlet LBinance = global.get('gBinance');\n//node.warn(LBinance);\nlet binance = new LBinance().options({\n\tAPIKEY: msg.bot.keypair.apikey,\n\tAPISECRET: msg.bot.keypair.secret,\n\t\"reconnect\": false\n});\n\nlet moneta = msg.bot.settings.moneta;\nlet quantity = (Number(Number(msg.bot.status.currentfloor[14]) + Number(msg.bot.ttp.quantity))).toFixed(msg.bot.settings.digitq);\n\nlet priceb = (Number((msg.bot.ttp.raschstopprice - msg.bot.ttp.raschstopprice / 100 * msg.bot.settings.ofsetbottom))).toFixed(msg.bot.settings.digitprice);\nlet stopprice = (Number(msg.bot.ttp.raschstopprice)).toFixed(msg.bot.settings.digitprice);\n\n\nnode.warn(\"q:\"+quantity);\nnode.warn(\"p:\"+priceb);\nnode.warn(\"sp:\"+stopprice);\n\n binance.sell(moneta, quantity, priceb, { stopPrice: stopprice, type: \"STOP_LOSS_LIMIT\" }, function (err, resp) {\n          if (err) {\n            var errorMsg = parseApiError(err);\n            node.error(errorMsg, msg);\n            node.status({fill: \"red\", shape: \"ring\", text: errorMsg});\n            \n            \n          }\n          if (resp) {\n                        msg.bot.ttp.orderid = resp.orderId;\n                        msg.bot.ttp.curstop = stopprice;\n          }\n          node.status({}); //clear status message\n\n          \n          node.send(msg);\n          return;\n        });","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2230,"y":4440,"wires":[["f6ce130.8cebc7"]],"inputLabels":["orderid, moneta"],"outputLabels":["status"],"icon":"font-awesome/fa-compress"},{"id":"f6ce130.8cebc7","type":"function","z":"38c422f8.b82bf6","name":"prepare set ttp to redis","func":"\n\nlet newsetb = {\"floors\":msg.bot.floors, \"finance\":msg.bot.finance, \"ttp\":msg.bot.ttp};\n//newset = JSON.stringify(newset);\n//node.warn(newsetb);\n\nmsg.payload = newsetb;\n\nmsg.headers = {};\nmsg.headers['accept'] = 'application/json';\nmsg.headers['Content-Type'] = 'application/json';\n\n   // let idstep = msg.bot.id+\"-step\";\n   // flow.set(idstep, 8);\n\nconst upd = global.get('updateSettings')(msg.payload, msg.bot.id);\n\nupd.then(upd => {\n    \n    msg.payload = upd.ttp;\n    msg.topic = upd.ttp.topic;\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2460,"y":4440,"wires":[["ca41c360.3ffe28","9ce077b4.57df08"]],"icon":"font-awesome/fa-bolt"},{"id":"47edff0a.ea6f58","type":"link out","z":"38c422f8.b82bf6","name":"заперещено закупать","links":["8dbb02a7.9de1a"],"x":2815,"y":4420,"wires":[]},{"id":"ca41c360.3ffe28","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2470,"y":4400,"wires":[]},{"id":"9ce077b4.57df08","type":"redis-command","z":"38c422f8.b82bf6","server":"f120eab2.0a60a8","command":"hmset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":2690,"y":4420,"wires":[["47edff0a.ea6f58"]]},{"id":"10907153.2feab7","type":"function","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"канселятор topic = bot.id","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = Date.parse(new Date()) / 1000;\n    let steptitle = node.name;\n//>трекер>\n\nmsg.topic = msg.bot.id\n\n//>трекер>\n    let end_node_time = Date.parse(new Date()) / 1000;\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration\": duration\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1970,"y":1200,"wires":[["27dbb0df.4fa588","4377a687.40ea08"]]},{"id":"2bde6947.f7ecae","type":"function","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"get order status1","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = Date.parse(new Date()) / 1000;\n    let steptitle = node.name;\n//>трекер>\n\nlet moneta = msg.bot.settings.moneta;\nlet orderid = msg.payload[8];\nlet userid = msg.bot.settings.userid;\n\n\n//msg.payload = [];\n//msg.topic = \"orders-status-\" + msg.bot.settings.userid + \":\" + moneta + \":\" + orderid;\nconst getorderstatus = global.get('getorderstatus')(userid, moneta, orderid);\n\n\ngetorderstatus.then(getorderstatus => {\n    \n    \n\n    msg.payload = getorderstatus;\n//>трекер>\n    let end_node_time = Date.parse(new Date()) / 1000;\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration\": duration\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill:\"green\",shape:\"dot\"});\n\n    node.send(msg);\n    node.done();\n\n}).catch(error => {\n    node.status({fill:\"red\",shape:\"dot\"});\n    node.error(error);\n});\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1490,"y":1200,"wires":[["e7d6b6d2.32065"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"27dbb0df.4fa588","type":"debug","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2030,"y":1160,"wires":[]},{"id":"4377a687.40ea08","type":"switch","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"статус ордера","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"NEW","vt":"str"},{"t":"eq","v":"PARTIALLY_FILLED","vt":"str"},{"t":"eq","v":"CANCELED","vt":"str"},{"t":"eq","v":"FILLED","vt":"str"},{"t":"eq","v":"REJECTED","vt":"str"},{"t":"eq","v":"EXPIRED","vt":"str"},{"t":"null"}],"checkall":"true","repair":false,"outputs":7,"x":2200,"y":1200,"wires":[["550838d7.0c4118"],["64ef31ed.e495e8"],["64ef31ed.e495e8"],["64ef31ed.e495e8"],["64ef31ed.e495e8"],["64ef31ed.e495e8"],["64ef31ed.e495e8"]]},{"id":"dc26dcc0.bdbe6","type":"comment","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"NEW","info":"","x":2430,"y":1160,"wires":[]},{"id":"64ef31ed.e495e8","type":"link out","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"заперещено закупать","links":["b414ae7e.1f40d","fb33fc0c.af5f78"],"x":2395,"y":1260,"wires":[]},{"id":"c952aeaf.2136b8","type":"link out","z":"38c422f8.b82bf6","name":"купили держим","links":["62b1f37b.6896ec","eb00b163.ba0f88"],"x":1915,"y":2880,"wires":[]},{"id":"666f7c9e.05f384","type":"function","z":"38c422f8.b82bf6","name":"update bot floors, finance","func":"\n\nlet newsetb = {\"floors\":msg.bot.floors, \"finance\":msg.bot.finance};\n//newset = JSON.stringify(newset);\n//node.warn(newsetb);\n\nmsg.payload = newsetb;\n\nmsg.headers = {};\nmsg.headers['accept'] = 'application/json';\nmsg.headers['Content-Type'] = 'application/json';\n\n   // let idstep = msg.bot.id+\"-step\";\n   // flow.set(idstep, 8);\n\nconst upd = global.get('updateSettings')(msg.payload, msg.bot.id);\n\nupd.then(upd => {\n    \n    msg.payload = {\"bot\":msg.bot};\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1750,"y":2820,"wires":[["c952aeaf.2136b8","8b92a4cb.4008b"]],"icon":"font-awesome/fa-bolt"},{"id":"72566d53.f8c2dc","type":"delay","z":"38c422f8.b82bf6","name":"","pauseType":"delay","timeout":"15","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1730,"y":3680,"wires":[["cd1809b7.b357e"]]},{"id":"3ffba51f.0ade62","type":"inject","z":"38c422f8.b82bf6","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"ttp:ALPHAUSDT-1605469791","payloadType":"str","x":190,"y":4240,"wires":[["bd2fb377.ae9a58"]]},{"id":"3a7a4e8c.230fb2","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":940,"y":4200,"wires":[]},{"id":"2856a745.247248","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":970,"y":4360,"wires":[]},{"id":"2e2d6018.33d4f8","type":"function","z":"38c422f8.b82bf6","g":"6d0bae3e.4983b8","name":"stop","func":"msg.reset = true;\nmsg.payload = \"\";\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":290,"y":780,"wires":[["da9e4dd8.dda28"]]},{"id":"cf8e2d12.ded23","type":"redis-in","z":"38c422f8.b82bf6","g":"6d0bae3e.4983b8","server":"f120eab2.0a60a8","command":"subscribe","name":"","topic":"stop","obj":true,"timeout":0,"x":150,"y":780,"wires":[["2e2d6018.33d4f8"]]},{"id":"779d9cd3.7f8a3c","type":"redis-out","z":"38c422f8.b82bf6","server":"f120eab2.0a60a8","command":"publish","name":"","topic":"stop","obj":false,"x":430,"y":4440,"wires":[]},{"id":"e3dc8325.6cc7f","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2050,"y":4640,"wires":[]},{"id":"64719c51.bbb0d4","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2050,"y":4740,"wires":[]},{"id":"714e8b3d.3e7fac","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":550,"y":4240,"wires":[]},{"id":"f1bf583c.436068","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":910,"y":3620,"wires":[]},{"id":"4810063.73d62f8","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":890,"y":3740,"wires":[]},{"id":"a1911359.dad238","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":3640,"wires":[]},{"id":"f31fab3.4c5ea58","type":"comment","z":"38c422f8.b82bf6","name":"NULL","info":"","x":2051.4285430908203,"y":3035.714080810547,"wires":[]},{"id":"bb34cdfd.cf01f","type":"inject","z":"38c422f8.b82bf6","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":3600,"y":1920,"wires":[["b8f09340.eee248"]]},{"id":"b8f09340.eee248","type":"function","z":"38c422f8.b82bf6","name":"f1","func":"node.status({fill:\"green\",shape:\"ring\",text:msg.payload});\nmsg.payload = msg.payload + \"ql\";\nreturn msg;","outputs":3,"noerr":0,"initialize":"","finalize":"","x":4040,"y":1920,"wires":[["9e86c3f7.3e3468"],[],[]],"outputLabels":["qqq","www","eee"]},{"id":"b8d69f.2c77696","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":4670,"y":1920,"wires":[]},{"id":"3004b7a0.659c","type":"status","z":"38c422f8.b82bf6","name":"","scope":["b8f09340.eee248"],"x":4040,"y":2000,"wires":[["ea00a371.fbf94"]]},{"id":"ea00a371.fbf94","type":"debug","z":"38c422f8.b82bf6","name":"","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":4190,"y":2000,"wires":[]},{"id":"aaa8d68e.331fb","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3800,"y":2100,"wires":[]},{"id":"dc3ca2bc.544f88","type":"inject","z":"38c422f8.b82bf6","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":3580,"y":1060,"wires":[["25a485a.8e0ec7a","4baf433c.d3da5c"]]},{"id":"25a485a.8e0ec7a","type":"function","z":"38c422f8.b82bf6","name":"","func":"msg.payload = \"q\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3780,"y":1180,"wires":[["821b304c.c174e"]]},{"id":"cbf21da8.d49678","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4300,"y":1120,"wires":[]},{"id":"2bb185ac.27b372","type":"function","z":"38c422f8.b82bf6","name":"","func":"msg.payload = \"м\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4160,"y":1520,"wires":[["71d733f8.94a534"]]},{"id":"2fb7115.58b99ee","type":"function","z":"38c422f8.b82bf6","name":"","func":"msg.payload = \"q\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4160,"y":1600,"wires":[["5d212be8.4ed244"]]},{"id":"eae4e50.88d0398","type":"inject","z":"38c422f8.b82bf6","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"a","payloadType":"str","x":4040,"y":940,"wires":[["3b4eeea5.7a8182"]]},{"id":"1b14a050.631f9","type":"function","z":"38c422f8.b82bf6","g":"6d0bae3e.4983b8","name":"start","func":"//<трекер<\n    ////>только для стартовой ноды>\n        var track = [];\n        let start_track_time = Date.parse(new Date()) / 1000;\n        let start_node_time = start_track_time;\n        let steptitle = node.name;\n    ////>только для стартовой ноды>\n//>трекер>\n\n\n\n\n\n\n//>трекер>\n    let end_node_time = Date.parse(new Date()) / 1000;\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration\": duration\n    });\n\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({ fill: \"green\", shape: \"ring\", text: duration });\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":930,"y":780,"wires":[[]]},{"id":"23a461b5.8934de","type":"function","z":"38c422f8.b82bf6","g":"89dcb365.f1eba","name":"цена не изменилась","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = Date.parse(new Date()) / 1000;\n    let steptitle = node.name;\n//>трекер>\n\n\n//>трекер>\n    let end_node_time = Date.parse(new Date()) / 1000;\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration\": duration\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1280,"y":1020,"wires":[["e545caa6.7236c8"]]},{"id":"79227fcb.dc9d18","type":"inject","z":"38c422f8.b82bf6","g":"3a58fc05.972e0c","name":"stop","props":[{"p":"payload"},{"p":"reset","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1610,"y":100,"wires":[["9a3b7f9.5e6b8"]]},{"id":"9a3b7f9.5e6b8","type":"redis-out","z":"38c422f8.b82bf6","g":"3a58fc05.972e0c","server":"f120eab2.0a60a8","command":"publish","name":"","topic":"stop","obj":false,"x":1610,"y":140,"wires":[]},{"id":"1692a27.8368fde","type":"redis-in","z":"38c422f8.b82bf6","g":"6d0bae3e.4983b8","server":"f120eab2.0a60a8","command":"subscribe","name":"","topic":"start","obj":true,"timeout":0,"x":150,"y":720,"wires":[[]]},{"id":"e7bf2df8.cfa0a","type":"inject","z":"38c422f8.b82bf6","g":"3a58fc05.972e0c","name":"start","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1190,"y":100,"wires":[["81f7b446.8c8718"]]},{"id":"81f7b446.8c8718","type":"redis-out","z":"38c422f8.b82bf6","g":"3a58fc05.972e0c","server":"f120eab2.0a60a8","command":"publish","name":"","topic":"start","obj":false,"x":1190,"y":140,"wires":[]},{"id":"7e0a8361.60fa3c","type":"redis-in","z":"38c422f8.b82bf6","g":"339f6357.48270c","server":"f120eab2.0a60a8","command":"subscribe","name":"","topic":"stop","obj":true,"timeout":0,"x":150,"y":540,"wires":[["e7c33b5d.af48d8"]]},{"id":"e7c33b5d.af48d8","type":"function","z":"38c422f8.b82bf6","g":"339f6357.48270c","name":"stop","func":"msg.reset = true;\nmsg.payload = \"\";\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":290,"y":540,"wires":[["4a9286e5.e8f4e8"]]},{"id":"89105352.909da","type":"redis-in","z":"38c422f8.b82bf6","g":"339f6357.48270c","server":"f120eab2.0a60a8","command":"subscribe","name":"","topic":"start","obj":true,"timeout":0,"x":150,"y":480,"wires":[[]]},{"id":"ed38b6eb.ce69b","type":"delay","z":"38c422f8.b82bf6","g":"339f6357.48270c","name":"","pauseType":"delay","timeout":"50","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":310,"y":480,"wires":[["4a9286e5.e8f4e8"]]},{"id":"90df249b.c0cbf","type":"comment","z":"38c422f8.b82bf6","g":"c0b0e6b5.5e71f","name":"Финиш трека. Семафор = \"Свободно\"","info":"","x":2340,"y":660,"wires":[]},{"id":"4cbecb3c.bf7ee4","type":"inject","z":"38c422f8.b82bf6","g":"3a58fc05.972e0c","name":"start1","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1370,"y":100,"wires":[["ef77d89b.b36608"]]},{"id":"ef77d89b.b36608","type":"redis-out","z":"38c422f8.b82bf6","g":"3a58fc05.972e0c","server":"f120eab2.0a60a8","command":"publish","name":"","topic":"start1","obj":false,"x":1370,"y":140,"wires":[]},{"id":"cc1a6775.26469","type":"redis-in","z":"38c422f8.b82bf6","g":"6d0bae3e.4983b8","server":"f120eab2.0a60a8","command":"subscribe","name":"","topic":"start1","obj":true,"timeout":0,"x":790,"y":780,"wires":[["1b14a050.631f9"]]},{"id":"34f31521.2b27d2","type":"function","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"Старт канселятора","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = Date.parse(new Date()) / 1000;\n    let steptitle = node.name;\n//>трекер>\n\n\n//>трекер>\n    let end_node_time = Date.parse(new Date()) / 1000;\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration\": duration\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":260,"y":1180,"wires":[["160b4dd4.4f8e12"]]},{"id":"93c3bc16.970708","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3810,"y":1320,"wires":[]},{"id":"f8a6e470.166c58","type":"function","z":"38c422f8.b82bf6","name":"","func":"msg.payload = msg.payload.bot.floors;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3340,"y":1340,"wires":[["1509e627.76e8e2","10cdaeb9.a25311"]]},{"id":"1509e627.76e8e2","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3350,"y":1300,"wires":[]},{"id":"66b556ec.9a6f58","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3810,"y":1360,"wires":[]},{"id":"83eb55cb.4546","type":"comment","z":"38c422f8.b82bf6","g":"6d0bae3e.4983b8","name":"Семафор = \"Занято\"","info":"","x":1860,"y":680,"wires":[]},{"id":"5e6d0362.224584","type":"function","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"нет запрета на покупку","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = Date.parse(new Date()) / 1000;\n    let steptitle = node.name;\n//>трекер>\n\n\n//>трекер>\n    let end_node_time = Date.parse(new Date()) / 1000;\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration\": duration\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":810,"y":1140,"wires":[["ac559e43.94903"]]},{"id":"168e0396.d38efc","type":"catch","z":"38c422f8.b82bf6","g":"c4471f11.5e9398","name":"","scope":null,"uncaught":false,"x":1380,"y":1680,"wires":[["c971a180.2a71c8"]]},{"id":"c971a180.2a71c8","type":"debug","z":"38c422f8.b82bf6","g":"c4471f11.5e9398","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1430,"y":1720,"wires":[]},{"id":"f13d409b.6445f8","type":"inject","z":"38c422f8.b82bf6","g":"c4471f11.5e9398","name":"start1","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1230,"y":1680,"wires":[["76409bc.077dee4"]]},{"id":"76409bc.077dee4","type":"redis-out","z":"38c422f8.b82bf6","g":"c4471f11.5e9398","server":"f120eab2.0a60a8","command":"publish","name":"","topic":"start1","obj":false,"x":1230,"y":1720,"wires":[]},{"id":"3df007b7.771648","type":"debug","z":"38c422f8.b82bf6","g":"339f6357.48270c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2150,"y":540,"wires":[]},{"id":"10cdaeb9.a25311","type":"split","z":"38c422f8.b82bf6","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":3490,"y":1340,"wires":[[]]},{"id":"230838f7.7d169","type":"function","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"buy ордеров нет","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = Date.parse(new Date()) / 1000;\n    let steptitle = node.name;\n//>трекер>\n\n\n//>трекер>\n    let end_node_time = Date.parse(new Date()) / 1000;\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration\": duration\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1050,"y":1280,"wires":[["ce43fd6d.7b213"]]},{"id":"415a64d7.94e364","type":"function","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"отменяем ордера на покупку","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = Date.parse(new Date()) / 1000;\n    let steptitle = node.name;\n//>трекер>\n\n\n//>трекер>\n    let end_node_time = Date.parse(new Date()) / 1000;\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration\": duration\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1090,"y":1200,"wires":[["6efa7034.90b4e"]]},{"id":"8e1f3271.c24088","type":"function","z":"38c422f8.b82bf6","g":"6d0bae3e.4983b8","name":"start","func":"//<трекер<\n    ////>только для стартовой ноды>\n        var track = [];\n        let start_track_time = Date.parse(new Date()) / 1000;\n        let start_node_time = start_track_time;\n        let steptitle = node.name;\n    ////>только для стартовой ноды>\n//>трекер>\n\n\n\n\n\n\n//>трекер>\n    let end_node_time = Date.parse(new Date()) / 1000;\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration\": duration\n    });\n\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({ fill: \"green\", shape: \"ring\", text: duration });\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":710,"y":720,"wires":[["7792f18e.f49f5"]]},{"id":"79a93671.4908f","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":450,"y":2760,"wires":[]},{"id":"7a8474f8.a35f2c","type":"function","z":"38c422f8.b82bf6","name":"проверяем статусы открытых ордеров на всех этажах","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = Date.parse(new Date()) / 1000;\n    let steptitle = node.name;\n//>трекер>\n\n\n//>трекер>\n    let end_node_time = Date.parse(new Date()) / 1000;\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration\": duration\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":430,"y":1520,"wires":[["db4dea56.5e575","a836d292.a18c6"]]},{"id":"fb04f823.a3bdd8","type":"debug","z":"38c422f8.b82bf6","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":890,"y":1440,"wires":[]},{"id":"db4dea56.5e575","type":"function","z":"38c422f8.b82bf6","name":"filter all open orders","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = Date.parse(new Date()) / 1000;\n    let steptitle = node.name;\n//>трекер>\n\n//msg.bot = msg.payload.bot;\n\n\nlet f = msg.bot.floors;\n\n var openfloors = f.filter(function(floor) {\n     return ((floor[7] == 1) || (floor[7] == 3));\n    });\n\nmsg.bot.openfloors = openfloors;\n\nif (openfloors.length > 0){\n    msg.payload = openfloors;\n    \n    //>трекер>\n        let end_node_time = Date.parse(new Date()) / 1000;\n        let duration = end_node_time - start_node_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n\n    node.status({fill:\"green\",shape:\"ring\",text:openfloors.length});\n    return [msg, null];\n    \n}\nelse{\n    \n    //>трекер>\n    let end_node_time = Date.parse(new Date()) / 1000;\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration\": duration\n    });\n    flow.set(\"track\", track);\n    //>трекер>\n\n    node.status({fill:\"blue\",shape:\"ring\",text:openfloors.length});\n    return [null, msg];\n}\n\n\n","outputs":2,"noerr":0,"initialize":"","finalize":"","x":840,"y":1520,"wires":[["fb04f823.a3bdd8","cff1b080.040028"],["b881a645.5fdc4","355f109f.8ebbb"]]},{"id":"63a1b9e8.5ea0a","type":"debug","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":520,"y":1260,"wires":[]},{"id":"b881a645.5fdc4","type":"debug","z":"38c422f8.b82bf6","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":890,"y":1580,"wires":[]},{"id":"a836d292.a18c6","type":"debug","z":"38c422f8.b82bf6","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":590,"y":1460,"wires":[]},{"id":"cff1b080.040028","type":"split","z":"38c422f8.b82bf6","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1050,"y":1520,"wires":[["6189b11c.899fd8"]]},{"id":"6189b11c.899fd8","type":"function","z":"38c422f8.b82bf6","name":"prepare get order status","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = Date.parse(new Date()) / 1000;\n    let steptitle = node.name;\n//>трекер>\n\nlet moneta = msg.bot.settings.moneta;\nlet orderid = msg.payload[8];\n\nmsg.payload = [];\nmsg.topic = \"orders-status-\" + msg.bot.settings.userid + \":\" + moneta + \":\" + orderid;\n\n//>трекер>\n    let end_node_time = Date.parse(new Date()) / 1000;\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration\": duration\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1250,"y":1520,"wires":[["b731d6be.9f8fc8"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"b731d6be.9f8fc8","type":"redis-command","z":"38c422f8.b82bf6","server":"f120eab2.0a60a8","command":"GET","name":"get order status","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1480,"y":1520,"wires":[["e3d41428.60691"]]},{"id":"e3d41428.60691","type":"function","z":"38c422f8.b82bf6","name":"allchecker topic = bot.id","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = Date.parse(new Date()) / 1000;\n    let steptitle = node.name;\n//>трекер>\n\nmsg.topic = msg.bot.id\n\n//>трекер>\n    let end_node_time = Date.parse(new Date()) / 1000;\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration\": duration\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1710,"y":1520,"wires":[["9705d73c.6e5ca","6ce338e3.82232"]]},{"id":"9705d73c.6e5ca","type":"switch","z":"38c422f8.b82bf6","name":"статус ордера","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"NEW","vt":"str"},{"t":"eq","v":"PARTIALLY_FILLED","vt":"str"},{"t":"eq","v":"CANCELED","vt":"str"},{"t":"eq","v":"FILLED","vt":"str"},{"t":"eq","v":"REJECTED","vt":"str"},{"t":"eq","v":"EXPIRED","vt":"str"},{"t":"null"}],"checkall":"true","repair":false,"outputs":7,"x":1940,"y":1520,"wires":[["fe358c3e.8ff248"],["fe358c3e.8ff248"],["2257b76.071d6c8"],["4084a396.073304"],["fe358c3e.8ff248"],["fe358c3e.8ff248"],["c01705a8.21d418","fe358c3e.8ff248"]]},{"id":"6ce338e3.82232","type":"debug","z":"38c422f8.b82bf6","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1730,"y":1420,"wires":[]},{"id":"c01705a8.21d418","type":"debug","z":"38c422f8.b82bf6","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1930,"y":1660,"wires":[]},{"id":"19e93a09.89aee6","type":"comment","z":"38c422f8.b82bf6","name":"FILLED","info":"","x":2210,"y":1440,"wires":[]},{"id":"6012c453.cfeffc","type":"function","z":"38c422f8.b82bf6","name":"update bot floors, finance","func":"\n\nlet newsetb = {\"floors\":msg.bot.floors, \"finance\":msg.bot.finance};\n//newset = JSON.stringify(newset);\n//node.warn(newsetb);\n\nmsg.payload = newsetb;\n\nmsg.headers = {};\nmsg.headers['accept'] = 'application/json';\nmsg.headers['Content-Type'] = 'application/json';\n\n   // let idstep = msg.bot.id+\"-step\";\n   // flow.set(idstep, 8);\n\nconst upd = global.get('updateSettings')(msg.payload, msg.bot.id);\n\nupd.then(upd => {\n    \n    msg.payload = \"updated\"\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3030,"y":1460,"wires":[["5c51429d.72e104"]],"icon":"font-awesome/fa-bolt"},{"id":"4084a396.073304","type":"function","z":"38c422f8.b82bf6","name":"change floors, finance ","func":"let idstep = msg.bot.id+\"-step\";\nflow.set(idstep, \"регистрируем покупку\");\n    \nlet tempfin = Number(Number(msg.bot.finance.baseinorders) - Number(msg.bot.status.currentfloor[14])*Number(msg.bot.status.currentfloor[3]));\n\nlet tempfin2 = Number(Number(msg.bot.finance.quotanal) + Number(msg.bot.status.currentfloor[14]));\n\nmsg.bot.finance.baseinorders = tempfin.toFixed(msg.bot.settings.digitprice);\nmsg.bot.finance.quotanal = tempfin2.toFixed(msg.bot.settings.digitq);\n\nif (msg.bot.finance.baseinorders == -0) {msg.bot.finance.baseinorders = 0;}\nif (msg.bot.finance.basenal == -0) {msg.bot.finance.basenal = 0;}\n\nlet currentfloor = msg.bot.status.currentfloor;\ncurrentfloor[7] = 2;\n\n\nmsg.bot.floors[currentfloor[0]-1] = currentfloor;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2280,"y":1480,"wires":[["fe358c3e.8ff248"]]},{"id":"5c51429d.72e104","type":"link out","z":"38c422f8.b82bf6","name":"заперещено закупать","links":["3e6444c9.a2ba14"],"x":3215,"y":1460,"wires":[]},{"id":"3e6444c9.a2ba14","type":"link in","z":"38c422f8.b82bf6","name":"","links":["5c51429d.72e104","fe175d6.982952","68ae7dd9.356844","355f109f.8ebbb"],"x":295,"y":2800,"wires":[["618930a2.3dffb"]]},{"id":"fe175d6.982952","type":"link out","z":"38c422f8.b82bf6","name":"заперещено закупать","links":["3e6444c9.a2ba14"],"x":2295,"y":1620,"wires":[]},{"id":"1b8a3dc2.1cbaf2","type":"comment","z":"38c422f8.b82bf6","name":"CANCELED","info":"","x":2230,"y":1340,"wires":[]},{"id":"fc774736.1854f8","type":"function","z":"38c422f8.b82bf6","name":"update bot floors, finance","func":"\n\nlet newsetb = {\"floors\":msg.bot.floors, \"finance\":msg.bot.finance};\n//newset = JSON.stringify(newset);\n//node.warn(newsetb);\n\nmsg.payload = newsetb;\n\nmsg.headers = {};\nmsg.headers['accept'] = 'application/json';\nmsg.headers['Content-Type'] = 'application/json';\n\n   // let idstep = msg.bot.id+\"-step\";\n   // flow.set(idstep, 8);\n\nconst upd = global.get('updateSettings')(msg.payload, msg.bot.id);\n\nupd.then(upd => {\n    \n    msg.payload = \"updated\"\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2770,"y":1440,"wires":[["68ae7dd9.356844"]],"icon":"font-awesome/fa-bolt"},{"id":"2257b76.071d6c8","type":"function","z":"38c422f8.b82bf6","name":"change floors, finance ","func":"let idstep = msg.bot.id+\"-step\";\nflow.set(idstep, \"регистрируем отмену ордера\");\n    \nlet tempfin = Number(Number(msg.bot.finance.baseinorders) - Number(msg.bot.status.currentfloor[14])*Number(msg.bot.status.currentfloor[3]));\nlet tempfin2 = Number(Number(msg.bot.finance.basenal) + Number(msg.bot.status.currentfloor[14])*Number(msg.bot.status.currentfloor[3]));\n\nmsg.bot.finance.baseinorders = tempfin.toFixed(msg.bot.settings.digitprice);\nmsg.bot.finance.basenal = tempfin2.toFixed(msg.bot.settings.digitprice);\n\nif (msg.bot.finance.baseinorders == -0) {msg.bot.finance.baseinorders = 0;}\nif (msg.bot.finance.basenal == -0) {msg.bot.finance.basenal = 0;}\n\nlet currentfloor = msg.bot.status.currentfloor;\ncurrentfloor[7] = 0;\ncurrentfloor[8] = 0;\ncurrentfloor[14] = 0;\n\nmsg.bot.floors[currentfloor[0]-1] = currentfloor;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2280,"y":1380,"wires":[["fe358c3e.8ff248"]]},{"id":"68ae7dd9.356844","type":"link out","z":"38c422f8.b82bf6","name":"заперещено закупать","links":["3e6444c9.a2ba14"],"x":2975,"y":1360,"wires":[]},{"id":"355f109f.8ebbb","type":"link out","z":"38c422f8.b82bf6","name":"заперещено закупать","links":["3e6444c9.a2ba14"],"x":1015,"y":1580,"wires":[]},{"id":"3ff7fc13.f3a62c","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1560,"y":2560,"wires":[]},{"id":"fe358c3e.8ff248","type":"join","z":"38c422f8.b82bf6","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":2570,"y":1800,"wires":[["fc774736.1854f8"]]},{"id":"ed3ebb40.401b98","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1330,"y":2420,"wires":[]},{"id":"f053413b.f6608","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1250,"y":2560,"wires":[]},{"id":"7ecf7e00.a0d31","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2270,"y":2440,"wires":[]},{"id":"650ece50.fb118","type":"debug","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":550,"y":1120,"wires":[]},{"id":"4bec0d5b.469514","type":"comment","z":"38c422f8.b82bf6","g":"945a2cf3.e1d6b8","name":"Functions","info":"","x":160,"y":80,"wires":[]},{"id":"5f90666a.62c228","type":"function","z":"38c422f8.b82bf6","d":true,"g":"945a2cf3.e1d6b8","name":"updateSettings()","func":"\n\n\n","outputs":1,"noerr":0,"initialize":"// Code added here will be run once\n// whenever the node is deployed.\nlet updateSettings = function (newset = msg.payload, topic = msg.topic) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \nmsg.topic = topic;\nmsg.payload = newset;\nmsg.headers = {};\nmsg.headers['accept'] = 'application/json';\nmsg.headers['Content-Type'] = 'application/json';\n    \n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('updateSettings', updateSettings);\n\n","finalize":"","x":380,"y":140,"wires":[["5a6c84db.e2549c"]]},{"id":"52aaa619.191ba8","type":"function","z":"38c422f8.b82bf6","d":true,"g":"945a2cf3.e1d6b8","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":760,"y":140,"wires":[]},{"id":"2fe76646.8b5a0a","type":"inject","z":"38c422f8.b82bf6","g":"945a2cf3.e1d6b8","name":"botid, newset","props":[{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":200,"y":140,"wires":[["5f90666a.62c228"]]},{"id":"5a6c84db.e2549c","type":"http request","z":"38c422f8.b82bf6","d":true,"g":"945a2cf3.e1d6b8","name":"","method":"PUT","ret":"obj","paytoqs":"ignore","url":"http://strapi:1337/bots/{{{topic}}}","tls":"","persist":true,"proxy":"","authType":"","x":570,"y":140,"wires":[["52aaa619.191ba8"]]},{"id":"f29872c6.957f88","type":"inject","z":"38c422f8.b82bf6","g":"945a2cf3.e1d6b8","name":"botname","props":[{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":180,"y":180,"wires":[["abce4774.171ad8"]]},{"id":"41a863d8.9f125c","type":"function","z":"38c422f8.b82bf6","g":"945a2cf3.e1d6b8","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":720,"y":180,"wires":[]},{"id":"abce4774.171ad8","type":"function","z":"38c422f8.b82bf6","g":"945a2cf3.e1d6b8","name":"ttpget()","func":"\n\n\n","outputs":1,"noerr":0,"initialize":"\n// Code added here will be run once\n// whenever the node is deployed.\nlet ttpget = function (botname = msg.payload) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n\nmsg.topic = botname;\nmsg.payload = [];\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('ttpget', ttpget);\n","finalize":"","x":360,"y":180,"wires":[["7e390ec5.73031"]]},{"id":"7e390ec5.73031","type":"redis-command","z":"38c422f8.b82bf6","g":"945a2cf3.e1d6b8","server":"f120eab2.0a60a8","command":"hgetall","name":"","topic":"","params":"{}","paramsType":"json","payloadType":"json","block":false,"x":550,"y":180,"wires":[["41a863d8.9f125c"]]},{"id":"1c21e572.487e03","type":"redis-instance","z":"38c422f8.b82bf6","g":"945a2cf3.e1d6b8","server":"f120eab2.0a60a8","name":"","topic":"ttp","location":"flow","x":730,"y":80,"wires":[]},{"id":"4dd8ae72.bac7a8","type":"inject","z":"38c422f8.b82bf6","g":"945a2cf3.e1d6b8","name":"bot id, floor id","props":[{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":200,"y":220,"wires":[["645bd981.f21eb"]]},{"id":"645bd981.f21eb","type":"function","z":"38c422f8.b82bf6","g":"945a2cf3.e1d6b8","name":"check floor","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":370,"y":220,"wires":[[]]},{"id":"cfa961f2.56de9","type":"inject","z":"38c422f8.b82bf6","g":"945a2cf3.e1d6b8","name":"user id, moneta, order id","props":[{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":230,"y":260,"wires":[["a9c4dd18.15e2d8"]]},{"id":"a9c4dd18.15e2d8","type":"function","z":"38c422f8.b82bf6","g":"945a2cf3.e1d6b8","name":"get order status","func":"","outputs":1,"noerr":0,"initialize":"\n// Code added here will be run once\n// whenever the node is deployed.\nlet getorderstatus = function (userid = msg.payload.userid, moneta = msg.payload.moneta, orderid = msg.payload.orderid) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \nmsg.payload = [];\nmsg.topic = \"orders-status-\" + userid + \":\" + moneta + \":\" + orderid;\n\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('getorderstatus', getorderstatus);","finalize":"","x":440,"y":260,"wires":[["93e330da.07ba58"]]},{"id":"93e330da.07ba58","type":"redis-command","z":"38c422f8.b82bf6","g":"945a2cf3.e1d6b8","server":"f120eab2.0a60a8","command":"GET","name":"get order status","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":640,"y":260,"wires":[["7a1798ac.2961e"]]},{"id":"7a1798ac.2961e","type":"function","z":"38c422f8.b82bf6","g":"945a2cf3.e1d6b8","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":820,"y":260,"wires":[]},{"id":"e7d6b6d2.32065","type":"debug","z":"38c422f8.b82bf6","g":"205eec04.74c0d4","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1650,"y":1240,"wires":[]},{"id":"cecfe42a.4e6e6","type":"function","z":"38c422f8.b82bf6","g":"945a2cf3.e1d6b8","name":"getprice()","func":"","outputs":1,"noerr":0,"initialize":"\n// Code added here will be run once\n// whenever the node is deployed.\nlet getprice = function (moneta = msg.payload) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n\n    msg.topic = \"prices:\"+moneta;\n    msg.payload = [];\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('getprice', getprice);","finalize":"","x":360,"y":300,"wires":[["cedee7.bd3d7118"]]},{"id":"73a29c92.5b5454","type":"inject","z":"38c422f8.b82bf6","g":"945a2cf3.e1d6b8","name":"moneta","props":[{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":180,"y":300,"wires":[["cecfe42a.4e6e6"]]},{"id":"79993aa4.dfacbc","type":"function","z":"38c422f8.b82bf6","name":"set buy order","func":"function parseApiError(error) {\n  if (error.body) {\n    try {\n      var resp = JSON.parse(error.body);\n      return resp.msg;\n    } catch (error) {/* pass thru */}\n  }\n  return \"Unknown error. Status code: \"+error.statsCode;\n}\n\nlet LBinance = global.get('gBinance');\n//node.warn(LBinance);\nlet binance = new LBinance().options({\n\tAPIKEY: \"m0dqmIilej2JPuK6vTzNGPMSc0N6pCHCCA0L5Jtes15gWIDteQ23mlrqCxJjSXOb\",\n\tAPISECRET: \"AI4qXclwJWQcBdkNZdGDAB3wVdiJMEwc9OBp54XxFECGjZRHL96Kcv0siBaPC5Kh\",\n\t\"reconnect\": false,\n    'useServerTime': true,\n    \n});\n\n\n//'options': {\n//        'adjustForTimeDifference': true,\n//        'verbose': true, // if needed, not mandatory\n//        'recvWindow': 10000000, // not really needed\n//    }\n\n \n\n\nlet moneta = \"ALPHAUSDT\";\nlet quantity = Number(100);\nlet price = Number(0.137);\nnode.warn(quantity);\nnode.warn(moneta);\nnode.warn(price);\n//msg.payload = \"qjson.status\";\n\nbinance.buy(moneta, quantity, price, {type:'LIMIT'}, (err, resp) => {\n    if (resp) {\n        msg.orderid = resp.orderId;\n        msg.resp = resp.orderId;\n        msg.payload = resp.orderId;\n        node.status({fill: \"green\", shape: \"ring\", text: resp.orderId});\n        node.send(msg);\n       // return [null,msg];\n    }\n    if (err) {\n        var errorMsg = parseApiError(err) + \", moneta:\" + moneta;\n        node.error(errorMsg, msg);\n        node.warn(err);\n        node.status({fill: \"red\", shape: \"ring\", text: errorMsg});\n        node.send(msg);\n        //return [msg, null];\n    }\n    //node.status({}); //clear status message\n});\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1190,"y":2140,"wires":[["22d68da.a1e6b72"]],"inputLabels":["orderid, moneta"],"outputLabels":["status"],"icon":"font-awesome/fa-compress"},{"id":"22d68da.a1e6b72","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1440,"y":2140,"wires":[]},{"id":"82cda584.ee441","type":"inject","z":"38c422f8.b82bf6","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":960,"y":2140,"wires":[["79993aa4.dfacbc"]]},{"id":"5f7b2c5a.9d3d7c","type":"telegrambot-command","z":"38c422f8.b82bf6","d":true,"name":"","bot":"848f142.6165868","command":"/ee","commandType":"str","commandCase":false,"x":3690,"y":1580,"wires":[["2214cec4.51c6ca"]]},{"id":"2214cec4.51c6ca","type":"telegrambot-switch","z":"38c422f8.b82bf6","d":true,"name":"","bot":"848f142.6165868","chatId":"454883204","question":"Продолжаем?","answers":["Да","Нет"],"outputs":2,"autoAnswerCallback":true,"timeoutValue":"","timeoutUnits":"","x":3970,"y":1560,"wires":[["2bb185ac.27b372"],["2fb7115.58b99ee"]]},{"id":"4baf433c.d3da5c","type":"telegrambot-notify","z":"38c422f8.b82bf6","d":true,"name":"","bot":"848f142.6165868","chatId":"454883204","message":"","parseMode":"","x":3860,"y":1060,"wires":[]},{"id":"821b304c.c174e","type":"telegrambot-notify","z":"38c422f8.b82bf6","d":true,"name":"","bot":"848f142.6165868","chatId":"454883204","message":"","parseMode":"","x":3960,"y":1140,"wires":[]},{"id":"71d733f8.94a534","type":"telegrambot-notify","z":"38c422f8.b82bf6","d":true,"name":"","bot":"848f142.6165868","chatId":"454883204","message":"","parseMode":"","x":4380,"y":1500,"wires":[]},{"id":"5d212be8.4ed244","type":"telegrambot-notify","z":"38c422f8.b82bf6","d":true,"name":"","bot":"848f142.6165868","chatId":"454883204","message":"","parseMode":"","x":4360,"y":1600,"wires":[]},{"id":"3b4eeea5.7a8182","type":"telegrambot-payload","z":"38c422f8.b82bf6","d":true,"name":"","bot":"848f142.6165868","chatId":"454883204","sendMethod":"sendChatAction","payload":"","x":4240,"y":1040,"wires":[["cbf21da8.d49678"]]},{"id":"b11492ad.95df","type":"flow-asserter in","z":"38c422f8.b82bf6","name":"","testcases":[{"testId":0,"input":"a","inputType":"str","operator":"eq","assert":"aq","assertType":"str"}],"onlyfail":true,"flowasserterout":"9e86c3f7.3e3468","x":3780,"y":1960,"wires":[["b8f09340.eee248"],["aaa8d68e.331fb"]]},{"id":"9e86c3f7.3e3468","type":"flow-asserter out","z":"38c422f8.b82bf6","name":"","x":4370,"y":1920,"wires":[["b8d69f.2c77696"]]},{"id":"3a977adc.3407ce","type":"filter","z":"38c422f8.b82bf6","name":"","property":"payload[7]","propertyType":"msg","asArray":false,"itemProperty":"","itemPropertyType":"item","rules":[{"t":"eq","v":"1","vt":"num","output":1},{"t":"null","output":2}],"checkall":"true","outputs":2,"x":3630,"y":1340,"wires":[["93c3bc16.970708"],["66b556ec.9a6f58"]]},{"id":"8295ad7c.f2478","type":"inject","z":"38c422f8.b82bf6","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":930,"y":1920,"wires":[["fe4ae18a.e1e7e8"]]},{"id":"bc345a7e.9957a","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1420,"y":1920,"wires":[]},{"id":"fe4ae18a.e1e7e8","type":"function","z":"38c422f8.b82bf6","name":"","func":"msg.payload = new Date();\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1170,"y":1920,"wires":[["bc345a7e.9957a"]]},{"id":"57f19e7e.80bda8","type":"function","z":"38c422f8.b82bf6","name":"prepare getprice","func":"\n//let moneta = msg.payload.bot.settings.moneta;\n//msg.bot = msg.payload.bot;\n\nmoneta= msg.payload;\n\nmsg.payload = [];\nmsg.topic = \"prices:\" + moneta;\n    \n\nnode.status({fill:\"green\",shape:\"dot\"});\n    \nreturn msg;\n    \n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1020,"y":2000,"wires":[["6abc1431.054344"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"6abc1431.054344","type":"redis-command","z":"38c422f8.b82bf6","server":"f120eab2.0a60a8","command":"GET","name":"get price","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1220,"y":2000,"wires":[["5bb7d1e3.a1b68"]]},{"id":"5bb7d1e3.a1b68","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1390,"y":2000,"wires":[]},{"id":"77ee5008.3a0d68","type":"inject","z":"38c422f8.b82bf6","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"BTCUSDT","payloadType":"str","x":820,"y":2000,"wires":[["57f19e7e.80bda8"]]},{"id":"34e1566a.fe282a","type":"function","z":"5df15275.2888ec","name":"set buy order","func":"function parseApiError(error) {\n  if (error.body) {\n    try {\n      var resp = JSON.parse(error.body);\n      return resp.msg;\n    } catch (error) {/* pass thru */}\n  }\n  return \"Unknown error. Status code: \"+error.statsCode;\n}\n\nlet LBinance = global.get('gBinance');\n//node.warn(LBinance);\nlet binance = new LBinance().options({\n\tAPIKEY: \"m0dqmIilej2JPuK6vTzNGPMSc0N6pCHCCA0L5Jtes15gWIDteQ23mlrqCxJjSXOb\",\n\tAPISECRET: \"AI4qXclwJWQcBdkNZdGDAB3wVdiJMEwc9OBp54XxFECGjZRHL96Kcv0siBaPC5Kh\",\n\t\"reconnect\": false,\n    'useServerTime': true,\n    \n});\n\n\n//'options': {\n//        'adjustForTimeDifference': true,\n//        'verbose': true, // if needed, not mandatory\n//        'recvWindow': 10000000, // not really needed\n//    }\n\n \n\n\nlet moneta = \"ALPHAUSDT\";\nlet quantity = Number(100);\nlet price = Number(0.137);\nnode.warn(quantity);\nnode.warn(moneta);\nnode.warn(price);\n//msg.payload = \"qjson.status\";\n\nbinance.buy(moneta, quantity, price, {type:'LIMIT'}, (err, resp) => {\n    if (resp) {\n        msg.orderid = resp.orderId;\n        msg.resp = resp.orderId;\n        msg.payload = resp.orderId;\n        node.status({fill: \"green\", shape: \"ring\", text: resp.orderId});\n        node.send(msg);\n       // return [null,msg];\n    }\n    if (err) {\n        var errorMsg = parseApiError(err) + \", moneta:\" + moneta;\n        node.error(errorMsg, msg);\n        node.warn(err);\n        node.status({fill: \"red\", shape: \"ring\", text: errorMsg});\n        node.send(msg);\n        //return [msg, null];\n    }\n    //node.status({}); //clear status message\n});\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4130,"y":2940,"wires":[["2ec21dae.6f5322"]],"inputLabels":["orderid, moneta"],"outputLabels":["status"],"icon":"font-awesome/fa-compress"},{"id":"2ec21dae.6f5322","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4380,"y":2940,"wires":[]},{"id":"668fe2df.5f9904","type":"inject","z":"5df15275.2888ec","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":3900,"y":2940,"wires":[["34e1566a.fe282a"]]},{"id":"27518c71.378094","type":"inject","z":"5df15275.2888ec","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":3900,"y":2780,"wires":[["20c4bf6b.e3b69"]]},{"id":"6729f2a9.4470b4","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":4390,"y":2780,"wires":[]},{"id":"20c4bf6b.e3b69","type":"function","z":"5df15275.2888ec","name":"current time","func":"msg.payload = new Date();\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4110,"y":2780,"wires":[["6729f2a9.4470b4"]]},{"id":"540d66e2.52f558","type":"function","z":"5df15275.2888ec","name":"prepare getprice","func":"\n//let moneta = msg.payload.bot.settings.moneta;\n//msg.bot = msg.payload.bot;\n\nmoneta= msg.payload;\n\nmsg.payload = [];\nmsg.topic = \"prices:\" + moneta;\n    \n\nnode.status({fill:\"green\",shape:\"dot\"});\n    \nreturn msg;\n    \n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4100,"y":2860,"wires":[["90c5df5.f6159a"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"90c5df5.f6159a","type":"redis-command","z":"5df15275.2888ec","server":"f120eab2.0a60a8","command":"GET","name":"get price","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4300,"y":2860,"wires":[["4f02ed0f.f40ee4"]]},{"id":"4f02ed0f.f40ee4","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":4410,"y":2780,"wires":[]},{"id":"509f1931.8d0b28","type":"inject","z":"5df15275.2888ec","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"BTCUSDT","payloadType":"str","x":3900,"y":2860,"wires":[["540d66e2.52f558"]]},{"id":"cedee7.bd3d7118","type":"redis-command","z":"38c422f8.b82bf6","g":"945a2cf3.e1d6b8","server":"f120eab2.0a60a8","command":"GET","name":"get price","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":520,"y":300,"wires":[["829d56ef.f0827"]]},{"id":"829d56ef.f0827","type":"function","z":"38c422f8.b82bf6","g":"945a2cf3.e1d6b8","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":680,"y":300,"wires":[]},{"id":"6a077525.6f310c","type":"inject","z":"38c422f8.b82bf6","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"BTCUSDT","payloadType":"str","x":280,"y":1820,"wires":[["3c8f0770.75854"]]},{"id":"3c8f0770.75854","type":"function","z":"38c422f8.b82bf6","name":"getprice","func":"\nlet moneta = msg.payload;\n\nconst gp = global.get('getprice')(moneta);\n\ngp.then(gp => {\n    \n    msg.payload = gp;\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":480,"y":1820,"wires":[["83e90d1d.39801"]]},{"id":"83e90d1d.39801","type":"debug","z":"38c422f8.b82bf6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":680,"y":1820,"wires":[]},{"id":"8c51dfe6.41bf1","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"getprice()","func":"","outputs":1,"noerr":0,"initialize":"\n// Code added here will be run once\n// whenever the node is deployed.\nlet getprice = function (moneta = msg.payload) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n\n    msg.topic = \"prices:\"+moneta;\n    msg.payload = [];\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('getprice', getprice);","finalize":"","x":1080,"y":140,"wires":[["9d5e1703.2251f8"]]},{"id":"456373bf.34e8d4","type":"inject","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"moneta","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":900,"y":140,"wires":[["8c51dfe6.41bf1"]]},{"id":"9d5e1703.2251f8","type":"redis-command","z":"5df15275.2888ec","g":"c625f482.ef7058","server":"f120eab2.0a60a8","command":"GET","name":"get price","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1240,"y":140,"wires":[["88d1f442.5d291"]]},{"id":"88d1f442.5d291","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":1460,"y":140,"wires":[]},{"id":"fdc8dc79.4afd5","type":"inject","z":"5df15275.2888ec","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"BTCUSDT","payloadType":"str","x":3780,"y":2480,"wires":[["7bb4ae52.b1d468"]]},{"id":"7bb4ae52.b1d468","type":"function","z":"5df15275.2888ec","name":"getprice","func":"\nlet moneta = msg.payload;\n\nconst gp = global.get('getprice')(moneta);\n\ngp.then(gp => {\n    \n    msg.payload = gp;\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3980,"y":2480,"wires":[["42a69b7a.7442d4"]]},{"id":"42a69b7a.7442d4","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4180,"y":2480,"wires":[]},{"id":"506a8391.c574dc","type":"http in","z":"5df15275.2888ec","g":"93990b56.ce7428","name":"","url":"/botcreate","method":"post","upload":false,"swaggerDoc":"","x":4020,"y":620,"wires":[["5331f2f3.26e314","b876d5aa.b5314","1180bcc7.96539b","74dd9f83.8b4a38","890bff65.ae92a","c18bfab4.a6c398","634b7ee.4a33b8","5c218091.24dc2","8a90f52f.5e82b8"]]},{"id":"31e84ef9.15d452","type":"redis-command","z":"5df15275.2888ec","g":"93990b56.ce7428","server":"f120eab2.0a60a8","command":"hmset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4510,"y":620,"wires":[[]]},{"id":"5331f2f3.26e314","type":"function","z":"5df15275.2888ec","g":"93990b56.ce7428","name":"prepare data for create bot","func":"msg.topic = msg.payload.user_id_from_google+\"-bots:\"+msg.payload.botname+\":data\";\nlet botdata = {\"finance\":msg.payload.finance,\"floors\":msg.payload.floors,\"sales\":msg.payload.sales};\nmsg.payload = botdata;\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4280,"y":620,"wires":[["31e84ef9.15d452"]]},{"id":"50198026.187798","type":"function","z":"5df15275.2888ec","name":"register guid","func":"let guid = msg.payload;\nglobal.set('guid',guid);\n\nlet botlistname = guid+\"-botlist\";\nglobal.set('guid',guid);\nglobal.set(botlistname,[]);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":490,"y":60,"wires":[[]]},{"id":"c866516d.ec8d7","type":"inject","z":"5df15275.2888ec","name":"d3fmoh2rVoVNgIcpLTFZBE0jHnI2","props":[{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"d3fmoh2rVoVNgIcpLTFZBE0jHnI2","payloadType":"str","x":220,"y":60,"wires":[["50198026.187798"]]},{"id":"bca0f523.f10a5","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"getbot_status()","func":"","outputs":1,"noerr":0,"initialize":"let guid = global.get('guid');\n\n\n\nlet getbot_status = function (botname = msg.payload) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n\n    msg.topic = guid+\"-bots:\"+botname+\":status\";\n    msg.payload = [];\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('getbot_status', getbot_status);","finalize":"","x":320,"y":200,"wires":[["d5710ed3.1f0ed8"]]},{"id":"9929a915.a7192","type":"inject","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"botname","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":140,"y":200,"wires":[["bca0f523.f10a5"]]},{"id":"84fc47b3.40a288","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":700,"y":200,"wires":[]},{"id":"338b53fe.bad3b4","type":"inject","z":"5df15275.2888ec","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"BNBUSDT-1606062710","payloadType":"str","x":3800,"y":2380,"wires":[["984c0eb9.874e48"]]},{"id":"984c0eb9.874e48","type":"function","z":"5df15275.2888ec","name":"getbot","func":"\nlet botname = msg.payload;\n\nconst gb = global.get('getbot_status')(botname);\n\ngb.then(gb => {\n    \n    msg.payload = gb;\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4050,"y":2380,"wires":[["625fa757.6ddd8","f509bf72.00e618"]]},{"id":"625fa757.6ddd8","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4260,"y":2380,"wires":[]},{"id":"72938161.c1d328","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"getbotlist()","func":"","outputs":1,"noerr":0,"initialize":"\n// Code added here will be run once\n// whenever the node is deployed.\nlet getbotlist = function (guid = msg.payload) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n\n    msg.topic = guid+\"-botlist\";\n    msg.payload = [];\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('getbotlist', getbotlist);","finalize":"","x":290,"y":140,"wires":[["2e79e684.725d42"]]},{"id":"39200d24.d193aa","type":"inject","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"guid","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":130,"y":140,"wires":[["72938161.c1d328"]]},{"id":"2e79e684.725d42","type":"redis-command","z":"5df15275.2888ec","g":"c625f482.ef7058","server":"f120eab2.0a60a8","command":"GET","name":"get botlist","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":460,"y":140,"wires":[["6d61a71c.3be1e"]]},{"id":"6d61a71c.3be1e","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":620,"y":140,"wires":[]},{"id":"1aa4adeb.16a03a","type":"inject","z":"5df15275.2888ec","name":"d3fmoh2rVoVNgIcpLTFZBE0jHnI2","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"d3fmoh2rVoVNgIcpLTFZBE0jHnI2","payloadType":"str","x":3860,"y":2560,"wires":[["a7ab24c2.b685e8"]]},{"id":"a7ab24c2.b685e8","type":"function","z":"5df15275.2888ec","name":"getbotlist","func":"\nlet guid = msg.payload;\n\nconst gbl = global.get('getbotlist')(guid);\n\ngbl.then(gbl => {\n    \n    msg.payload = gbl;\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4080,"y":2560,"wires":[["d8a96fea.e8a12"]]},{"id":"d8a96fea.e8a12","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4250,"y":2560,"wires":[]},{"id":"b876d5aa.b5314","type":"function","z":"5df15275.2888ec","g":"93990b56.ce7428","name":"prepare for get botlist","func":"msg.botlistname = msg.payload.user_id_from_google+\"-botlist\";\nmsg.botname = msg.payload.botname;\nmsg.payload = msg.payload.user_id_from_google;\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4260,"y":680,"wires":[["193726e9.3199d9"]]},{"id":"193726e9.3199d9","type":"function","z":"5df15275.2888ec","g":"93990b56.ce7428","name":"getbotlist","func":"\nlet guid = msg.payload;\n\nconst gbl = global.get('getbotlist')(guid);\n\ngbl.then(gbl => {\n    \n    msg.payload = JSON.parse(gbl);\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n    node.status({fill:\"red\",shape:\"dot\"});\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4460,"y":680,"wires":[["c1a0c26f.ded73"]]},{"id":"c1a0c26f.ded73","type":"function","z":"5df15275.2888ec","g":"93990b56.ce7428","name":"prepare for add botlist","func":"msg.topic = msg.botlistname;\n\nlet newbotlist = [];\nif (msg.payload == null) {\n    newbotlist = [msg.botname];\n} else {\n    let oldbotlist = msg.payload;\n    newbotlist = [...oldbotlist,msg.botname];\n    }\n\nmsg.payload = JSON.stringify(newbotlist);\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4660,"y":680,"wires":[["7c1162f3.2e02bc"]]},{"id":"7c1162f3.2e02bc","type":"redis-command","z":"5df15275.2888ec","g":"93990b56.ce7428","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4870,"y":680,"wires":[[]]},{"id":"1180bcc7.96539b","type":"http response","z":"5df15275.2888ec","g":"93990b56.ce7428","name":"","statusCode":"200","headers":{},"x":4040,"y":680,"wires":[]},{"id":"754f373f.b15518","type":"trigger","z":"5df15275.2888ec","g":"c2109678.33bc38","name":"","op1":"1","op2":"0","op1type":"str","op2type":"str","duration":"-10","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":510,"y":940,"wires":[["8f2b992a.2a5888"]]},{"id":"444e001d.21432","type":"comment","z":"5df15275.2888ec","g":"c2109678.33bc38","name":"Расчет МА","info":"","x":130,"y":880,"wires":[]},{"id":"5d94f71d.d3668","type":"redis-in","z":"5df15275.2888ec","g":"c2109678.33bc38","server":"f120eab2.0a60a8","command":"subscribe","name":"","topic":"stop","obj":true,"timeout":0,"x":110,"y":1000,"wires":[["edea6dff.e44"]]},{"id":"edea6dff.e44","type":"function","z":"5df15275.2888ec","g":"c2109678.33bc38","name":"stop","func":"msg.reset = true;\nmsg.payload = \"\";\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":250,"y":1000,"wires":[["754f373f.b15518"]]},{"id":"1e4c98d9.ba7367","type":"redis-in","z":"5df15275.2888ec","g":"c2109678.33bc38","server":"f120eab2.0a60a8","command":"subscribe","name":"","topic":"start","obj":true,"timeout":0,"x":110,"y":940,"wires":[["c982d578.5cca4"]]},{"id":"c982d578.5cca4","type":"delay","z":"5df15275.2888ec","g":"c2109678.33bc38","name":"","pauseType":"delay","timeout":"50","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":270,"y":940,"wires":[["754f373f.b15518"]]},{"id":"eda0b98c.624f38","type":"inject","z":"5df15275.2888ec","g":"74a41043.26c49","name":" stop","props":[{"p":"payload"},{"p":"reset","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":590,"y":2660,"wires":[["dda68ce4.be4548"]]},{"id":"dda68ce4.be4548","type":"redis-out","z":"5df15275.2888ec","g":"74a41043.26c49","server":"f120eab2.0a60a8","command":"publish","name":"","topic":"stop","obj":false,"x":590,"y":2700,"wires":[]},{"id":"33a98cf6.520fbc","type":"inject","z":"5df15275.2888ec","g":"74a41043.26c49","name":"start","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":170,"y":2660,"wires":[["cd451268.3a6058"]]},{"id":"cd451268.3a6058","type":"redis-out","z":"5df15275.2888ec","g":"74a41043.26c49","server":"f120eab2.0a60a8","command":"publish","name":"","topic":"start","obj":false,"x":170,"y":2700,"wires":[]},{"id":"14fd3fa0.82928","type":"inject","z":"5df15275.2888ec","g":"74a41043.26c49","name":"start1","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":350,"y":2660,"wires":[["7cd3ed75.b496ac"]]},{"id":"7cd3ed75.b496ac","type":"redis-out","z":"5df15275.2888ec","g":"74a41043.26c49","server":"f120eab2.0a60a8","command":"publish","name":"","topic":"start1","obj":false,"x":350,"y":2700,"wires":[]},{"id":"c3e2eace.6fef4","type":"comment","z":"5df15275.2888ec","g":"8fac538c.5d4a48","name":"Старт трека","info":"","x":130,"y":1120,"wires":[]},{"id":"f88e6307.876b78","type":"trigger","z":"5df15275.2888ec","g":"8fac538c.5d4a48","name":"","op1":"1","op2":"0","op1type":"str","op2type":"str","duration":"-250","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":480,"y":1180,"wires":[["d43a0074.4523c"]]},{"id":"3e3a1491.e31a74","type":"delay","z":"5df15275.2888ec","g":"8fac538c.5d4a48","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":270,"y":1180,"wires":[["f88e6307.876b78"]]},{"id":"fb84e297.7e169","type":"function","z":"5df15275.2888ec","g":"8fac538c.5d4a48","name":"stop","func":"msg.reset = true;\nmsg.payload = \"\";\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":250,"y":1240,"wires":[["f88e6307.876b78"]]},{"id":"8275986.8fc5d68","type":"redis-in","z":"5df15275.2888ec","g":"8fac538c.5d4a48","server":"f120eab2.0a60a8","command":"subscribe","name":"","topic":"stop","obj":true,"timeout":0,"x":110,"y":1240,"wires":[["fb84e297.7e169"]]},{"id":"97442da1.47403","type":"function","z":"5df15275.2888ec","g":"8fac538c.5d4a48","name":"start","func":"//<трекер<\n    ////>только для стартовой ноды>\n        var track = [];\n        let start_track_time = new Date().getTime();\n        let start_node_time = start_track_time;\n        let steptitle = node.name;\n    ////>только для стартовой ноды>\n//>трекер>\n\n\n\nmsg.payload = global.get('guid');\n\n\n//>трекер>\n    let end_node_time = new Date().getTime();\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration_node\": duration,\n        \"duration_step\": 0\n    });\n\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({ fill: \"green\", shape: \"ring\", text: duration });\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":670,"y":1120,"wires":[["d6651eda.7b83"]]},{"id":"c0dcb78d.280fb","type":"redis-in","z":"5df15275.2888ec","g":"8fac538c.5d4a48","server":"f120eab2.0a60a8","command":"subscribe","name":"","topic":"start","obj":true,"timeout":0,"x":110,"y":1180,"wires":[["3e3a1491.e31a74"]]},{"id":"da741b09.f3974","type":"redis-in","z":"5df15275.2888ec","g":"8fac538c.5d4a48","server":"f120eab2.0a60a8","command":"subscribe","name":"","topic":"start1","obj":true,"timeout":0,"x":530,"y":1120,"wires":[["97442da1.47403"]]},{"id":"3201780f.c931f","type":"comment","z":"5df15275.2888ec","g":"8fac538c.5d4a48","name":"Семафор = \"Занято\"","info":"","x":2000,"y":1100,"wires":[]},{"id":"d43a0074.4523c","type":"function","z":"5df15275.2888ec","g":"8fac538c.5d4a48","name":"start","func":"//<трекер<\n    ////>только для стартовой ноды>\n        var track = [];\n        let start_track_time = new Date().getTime();\n        let start_node_time = start_track_time;\n        let steptitle = node.name;\n    ////>только для стартовой ноды>\n//>трекер>\n\n\n\nmsg.payload = global.get('guid');\n\n\n//>трекер>\n    let end_node_time = new Date().getTime();\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration_node\": duration,\n        \"duration_step\": 0\n    });\n\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({ fill: \"green\", shape: \"ring\", text: duration });\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":670,"y":1180,"wires":[["d6651eda.7b83"]]},{"id":"133c3e4a.687a62","type":"debug","z":"5df15275.2888ec","g":"3e767551.3d299a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2550,"y":1220,"wires":[]},{"id":"a7ef7b74.1301e8","type":"comment","z":"5df15275.2888ec","g":"3e767551.3d299a","name":"Финиш трека. Семафор = \"Свободно\"","info":"","x":2520,"y":1100,"wires":[]},{"id":"90d93514.efa9e8","type":"redis-in","z":"5df15275.2888ec","g":"c2109678.33bc38","server":"f120eab2.0a60a8","command":"subscribe","name":"","topic":"start1","obj":true,"timeout":0,"x":550,"y":1000,"wires":[["24812b74.9bc644"]]},{"id":"f509bf72.00e618","type":"json","z":"5df15275.2888ec","name":"","property":"payload","action":"obj","pretty":false,"x":4270,"y":2340,"wires":[["b0bce207.3e7de8"]]},{"id":"b0bce207.3e7de8","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4410,"y":2360,"wires":[]},{"id":"7b1b57ca.c72288","type":"function","z":"5df15275.2888ec","name":"register keypar","func":"let key = msg.key;\nlet secret = msg.secret\nglobal.set('key',key);\nglobal.set('secret',secret);\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":880,"y":60,"wires":[[]]},{"id":"36430d18.7c1cea","type":"inject","z":"5df15275.2888ec","name":"my keypair","props":[{"p":"key","v":"m0dqmIilej2JPuK6vTzNGPMSc0N6pCHCCA0L5Jtes15gWIDteQ23mlrqCxJjSXOb","vt":"str"},{"p":"secret","v":"AI4qXclwJWQcBdkNZdGDAB3wVdiJMEwc9OBp54XxFECGjZRHL96Kcv0siBaPC5Kh","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":690,"y":60,"wires":[["7b1b57ca.c72288"]]},{"id":"7ee8ada7.9818bc","type":"catch","z":"5df15275.2888ec","d":true,"g":"bc481bc2.f1ae08","name":"","scope":null,"uncaught":false,"x":2640,"y":1360,"wires":[["e0440623.2ec6e"]]},{"id":"e0440623.2ec6e","type":"debug","z":"5df15275.2888ec","g":"bc481bc2.f1ae08","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2890,"y":1360,"wires":[]},{"id":"cba3e711.97d4a8","type":"inject","z":"5df15275.2888ec","g":"bc481bc2.f1ae08","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"5fb1865f2798e90177ca1e60","payloadType":"str","x":2650,"y":1540,"wires":[["c23f0bc3.badbc"]]},{"id":"c23f0bc3.badbc","type":"graphql","z":"5df15275.2888ec","g":"bc481bc2.f1ae08","name":"get bot all data","graphql":"ab190c2e.90269","format":"handlebars","syntax":"mustache","template":"query {\n  bot (id: \"{{payload}}\"){\n    id\n    settings\n    sales\n    floors\n    status\n    finance\n    ttp\n    start_set\n\n  }\n}","x":2810,"y":1540,"wires":[["b0b01bc4.45a1e8"],[]]},{"id":"6eb4d4b9.112f6c","type":"debug","z":"5df15275.2888ec","g":"bc481bc2.f1ae08","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3230,"y":1540,"wires":[]},{"id":"b0b01bc4.45a1e8","type":"function","z":"5df15275.2888ec","g":"bc481bc2.f1ae08","name":"reset to start_settings","func":"let id = msg.payload.bot.id;\nlet newsetb = {\n    \"settings\":msg.payload.bot.start_set.settings,\n    \"sales\":msg.payload.bot.start_set.sales,\n    \"floors\":msg.payload.bot.start_set.floors,\n    \"status\":msg.payload.bot.start_set.status,\n    \"finance\":msg.payload.bot.start_set.finance,\n    \"ttp\":msg.payload.bot.start_set.ttp\n};\n//newset = JSON.stringify(newset);\n//node.warn(newsetb);\n\nmsg.payload = newsetb;\n\nmsg.headers = {};\nmsg.headers['accept'] = 'application/json';\nmsg.headers['Content-Type'] = 'application/json';\n\n\n\nconst upd = global.get('updateSettings')(msg.payload, id);\n\nupd.then(upd => {\n    \n    msg.payload = \"updated\"\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3040,"y":1540,"wires":[["6eb4d4b9.112f6c"]],"icon":"font-awesome/fa-bolt"},{"id":"a359f524.2e00e8","type":"function","z":"5df15275.2888ec","g":"bc481bc2.f1ae08","name":"get flow.track","func":"\n//<трекер<\nlet track = flow.get(\"track\");\nlet start_node_time = Date.parse(new Date())/1000;\nlet steptitle = node.name;\n//>трекер>\n\nmsg.payload = track;\n\n//<трекер< \n //   let end_node_time = Date.parse(new Date())/1000;\n //   let duration = end_node_time-start_node_time;\n //   track.push([steptitle,start_node_time,end_node_time,duration]);\n //   msg.track = track;\n //   flow.set(\"track\", track);\n//>трекер>\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2840,"y":1480,"wires":[["a0142b1a.f25d9","941fc9d2.76b05"]]},{"id":"cf20b67b.cbc6e","type":"inject","z":"5df15275.2888ec","g":"bc481bc2.f1ae08","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":2540,"y":1420,"wires":[["a359f524.2e00e8"]]},{"id":"a0142b1a.f25d9","type":"debug","z":"5df15275.2888ec","g":"bc481bc2.f1ae08","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3010,"y":1440,"wires":[]},{"id":"941fc9d2.76b05","type":"ui_table","z":"5df15275.2888ec","g":"bc481bc2.f1ae08","group":"a328c3be.7f91c8","name":"","order":2,"width":"14","height":"9","columns":[{"field":"steptitle","title":"steptitle","width":"","align":"left","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"duration_node","title":"duration_node","width":"","align":"left","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"duration_step","title":"duration_step","width":"","align":"left","formatter":"plaintext","formatterParams":{"target":"_blank"}}],"outputs":0,"cts":false,"x":3010,"y":1480,"wires":[]},{"id":"8040b017.7a26f8","type":"comment","z":"5df15275.2888ec","g":"bc481bc2.f1ae08","name":"Отладка","info":"","x":3210,"y":1380,"wires":[]},{"id":"189b2b68.7c485d","type":"delay","z":"5df15275.2888ec","g":"bc481bc2.f1ae08","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":2430,"y":1480,"wires":[["a359f524.2e00e8"]]},{"id":"842e37da.0d09","type":"redis-in","z":"5df15275.2888ec","g":"bc481bc2.f1ae08","server":"f120eab2.0a60a8","command":"subscribe","name":"","topic":"start1","obj":true,"timeout":0,"x":2290,"y":1480,"wires":[["189b2b68.7c485d"]]},{"id":"74dd9f83.8b4a38","type":"function","z":"5df15275.2888ec","g":"93990b56.ce7428","name":"prepare for add bot status","func":"msg.topic = msg.payload.user_id_from_google+\"-bots:\"+msg.payload.botname+\":status\";\nmsg.payload.status.updated = new Date().getTime();\nmsg.payload = msg.payload.status;\n\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4270,"y":740,"wires":[["1ee92671.77db3a"]]},{"id":"1ee92671.77db3a","type":"redis-command","z":"5df15275.2888ec","g":"93990b56.ce7428","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4490,"y":740,"wires":[[]]},{"id":"890bff65.ae92a","type":"function","z":"5df15275.2888ec","g":"93990b56.ce7428","name":"prepare for add bot settings","func":"msg.topic = msg.payload.user_id_from_google+\"-bots:\"+msg.payload.botname+\":settings\";\n\nmsg.payload = msg.payload.settings;\n\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4280,"y":800,"wires":[["7be2e3c6.f4f0dc"]]},{"id":"7be2e3c6.f4f0dc","type":"redis-command","z":"5df15275.2888ec","g":"93990b56.ce7428","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4510,"y":800,"wires":[[]]},{"id":"c18bfab4.a6c398","type":"function","z":"5df15275.2888ec","g":"93990b56.ce7428","name":"prepare for add bot ttp","func":"msg.topic = msg.payload.user_id_from_google+\"-bots:\"+msg.payload.botname+\":ttp\";\n\nmsg.payload = msg.payload.ttp;\n\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4260,"y":860,"wires":[["4a2da56.007bbdc"]]},{"id":"4a2da56.007bbdc","type":"redis-command","z":"5df15275.2888ec","g":"93990b56.ce7428","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4470,"y":860,"wires":[[]]},{"id":"634b7ee.4a33b8","type":"function","z":"5df15275.2888ec","g":"93990b56.ce7428","name":"prepare for add bot onoff","func":"msg.topic = msg.payload.user_id_from_google+\"-bots:\"+msg.payload.botname+\":onoff\";\n\nmsg.payload = JSON.stringify(msg.payload.onoff);\n\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4270,"y":920,"wires":[["a2076fe3.e1e4c8"]]},{"id":"a2076fe3.e1e4c8","type":"redis-command","z":"5df15275.2888ec","g":"93990b56.ce7428","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4470,"y":920,"wires":[[]]},{"id":"d5710ed3.1f0ed8","type":"redis-command","z":"5df15275.2888ec","g":"c625f482.ef7058","server":"f120eab2.0a60a8","command":"GET","name":"get bot status","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":520,"y":200,"wires":[["84fc47b3.40a288"]]},{"id":"82c581f1.3d7b2","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"getbot_settings()","func":"","outputs":1,"noerr":0,"initialize":"let guid = global.get('guid');\n\n\nlet getbot_settings = function (botname = msg.payload) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n\n    msg.topic = guid+\"-bots:\"+botname+\":settings\";\n    msg.payload = [];\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('getbot_settings', getbot_settings);","finalize":"","x":330,"y":260,"wires":[["de421236.7ddad8"]]},{"id":"4e808ea9.9699f8","type":"inject","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"botname","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":140,"y":260,"wires":[["82c581f1.3d7b2"]]},{"id":"c996e15f.6cd09","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":720,"y":260,"wires":[]},{"id":"de421236.7ddad8","type":"redis-command","z":"5df15275.2888ec","g":"c625f482.ef7058","server":"f120eab2.0a60a8","command":"GET","name":"get bot settings","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":540,"y":260,"wires":[["c996e15f.6cd09"]]},{"id":"5c218091.24dc2","type":"function","z":"5df15275.2888ec","g":"93990b56.ce7428","name":"prepare for add bot busy","func":"msg.topic = msg.payload.user_id_from_google+\"-bots:\"+msg.payload.botname+\":busy\";\n\nmsg.payload = JSON.stringify(msg.payload.busy);\n\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4270,"y":980,"wires":[["d9152924.0b6fa"]]},{"id":"d9152924.0b6fa","type":"redis-command","z":"5df15275.2888ec","g":"93990b56.ce7428","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4490,"y":980,"wires":[[]]},{"id":"3ea27905.a93e8e","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"getbot_ttp()","func":"","outputs":1,"noerr":0,"initialize":"let guid = global.get('guid');\n\n\nlet getbot_ttp = function (botname = msg.payload) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n\n    msg.topic = guid+\"-bots:\"+botname+\":ttp\";\n    msg.payload = [];\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('getbot_ttp', getbot_ttp);","finalize":"","x":310,"y":320,"wires":[["dc63781f.d7f54"]]},{"id":"c419c89c.c82b7","type":"inject","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"botname","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":140,"y":320,"wires":[["3ea27905.a93e8e"]]},{"id":"ee122abb.ffdf2","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":680,"y":320,"wires":[]},{"id":"dc63781f.d7f54","type":"redis-command","z":"5df15275.2888ec","g":"c625f482.ef7058","server":"f120eab2.0a60a8","command":"GET","name":"get bot ttp","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":490,"y":320,"wires":[["ee122abb.ffdf2"]]},{"id":"e12b76fa.94dc68","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"getbot_onoff()","func":"","outputs":1,"noerr":0,"initialize":"let guid = global.get('guid');\n\n\nlet getbot_onoff = function (botname = msg.payload) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n\n    msg.topic = guid+\"-bots:\"+botname+\":onoff\";\n    msg.payload = [];\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('getbot_onoff', getbot_onoff);","finalize":"","x":320,"y":380,"wires":[["225135a2.08288a"]]},{"id":"e1b6a373.027e3","type":"inject","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"botname","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":140,"y":380,"wires":[["e12b76fa.94dc68"]]},{"id":"be80ac0a.3fcc6","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":700,"y":380,"wires":[]},{"id":"225135a2.08288a","type":"redis-command","z":"5df15275.2888ec","g":"c625f482.ef7058","server":"f120eab2.0a60a8","command":"GET","name":"get bot onoff","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":510,"y":380,"wires":[["be80ac0a.3fcc6"]]},{"id":"32fd021f.9c3646","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"getbot_busy()","func":"","outputs":1,"noerr":0,"initialize":"let guid = global.get('guid');\n\n\nlet getbot_busy = function (botname = msg.payload) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n\n    msg.topic = guid+\"-bots:\"+botname+\":busy\";\n    msg.payload = [];\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('getbot_busy', getbot_busy);","finalize":"","x":320,"y":440,"wires":[["5a0e3510.93269c"]]},{"id":"dce2a78c.7fb6c","type":"inject","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"botname","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":140,"y":440,"wires":[["32fd021f.9c3646"]]},{"id":"22c83041.c57288","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":700,"y":440,"wires":[]},{"id":"5a0e3510.93269c","type":"redis-command","z":"5df15275.2888ec","g":"c625f482.ef7058","server":"f120eab2.0a60a8","command":"GET","name":"get bot busy","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":510,"y":440,"wires":[["22c83041.c57288"]]},{"id":"274d4375.725ad4","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"setbotlist()","func":"","outputs":1,"noerr":0,"initialize":"\n// Code added here will be run once\n// whenever the node is deployed.\nlet setbotlist = function (guid = msg.payload.guid, botlist = msg.payload.botlist) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n\n    msg.topic = guid+\"-botlist\";\n    msg.payload = botlist;\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('setbotlist', setbotlist);","finalize":"","x":1090,"y":200,"wires":[["ba3e6008.7e12f8"]]},{"id":"dfdf853a.fea128","type":"inject","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"guid, botlist","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":910,"y":200,"wires":[["274d4375.725ad4"]]},{"id":"fc027fe9.e8d708","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":1420,"y":200,"wires":[]},{"id":"ba3e6008.7e12f8","type":"redis-command","z":"5df15275.2888ec","g":"c625f482.ef7058","server":"f120eab2.0a60a8","command":"getset","name":"set botlist","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1260,"y":200,"wires":[["fc027fe9.e8d708"]]},{"id":"3c92a9f.7208756","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"setbot_status()","func":"","outputs":1,"noerr":0,"initialize":"\nlet setbot_status = function (botname = msg.topic, status = msg.payload) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n\n    msg.topic = botname;\n    msg.payload = status;\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('setbot_status', setbot_status);","finalize":"","x":1120,"y":260,"wires":[["3b3eb9c4.74e1ce"]]},{"id":"1bdf10d4.260a9f","type":"inject","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"botname, status","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":920,"y":260,"wires":[["3c92a9f.7208756"]]},{"id":"4a190c44.e49f5c","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":1500,"y":260,"wires":[]},{"id":"3b3eb9c4.74e1ce","type":"redis-command","z":"5df15275.2888ec","g":"c625f482.ef7058","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1310,"y":260,"wires":[["4a190c44.e49f5c"]]},{"id":"2508abe7.d6a684","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"setbot_busy()","func":"","outputs":1,"noerr":0,"initialize":"let guid = global.get('guid');\n\nlet setbot_busy = function (botname = msg.topic) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n     msg.topic = guid+\"-bots:\"+botname+\":busy\";\n    msg.payload = \"true\";\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('setbot_busy', setbot_busy);","finalize":"","x":320,"y":500,"wires":[["38fe7af7.4b2106"]]},{"id":"f728a67.fc3a3d8","type":"inject","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"botname","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":140,"y":500,"wires":[["2508abe7.d6a684"]]},{"id":"fd75bbec.1aee88","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":700,"y":500,"wires":[]},{"id":"38fe7af7.4b2106","type":"redis-command","z":"5df15275.2888ec","g":"c625f482.ef7058","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":510,"y":500,"wires":[["fd75bbec.1aee88"]]},{"id":"c458d7d.41524a8","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"setbot_free()","func":"","outputs":1,"noerr":0,"initialize":"let guid = global.get('guid');\n\nlet setbot_free = function (botname = msg.topic) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n    msg.topic = guid+\"-bots:\"+botname+\":busy\";\n    msg.payload = \"false\";\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('setbot_free', setbot_free);","finalize":"","x":310,"y":560,"wires":[["1ecd91cb.e68c46"]]},{"id":"c9147459.15de58","type":"inject","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"botname","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":140,"y":560,"wires":[["c458d7d.41524a8"]]},{"id":"b9afe11.e8147a","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":700,"y":560,"wires":[]},{"id":"1ecd91cb.e68c46","type":"redis-command","z":"5df15275.2888ec","g":"c625f482.ef7058","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":510,"y":560,"wires":[["b9afe11.e8147a"]]},{"id":"d6651eda.7b83","type":"function","z":"5df15275.2888ec","g":"8fac538c.5d4a48","name":"getbotlist","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[0];\n\n    let last_node_end_time = laststep.end_node_time;\n\n//>трекер>\n\nlet guid = msg.payload;\n\nconst gbl = global.get('getbotlist')(guid);\n\ngbl.then(gbl => {\n    \n    msg.payload = gbl;\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"});\n    \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":820,"y":1180,"wires":[["dfa11988.0cfa6","bec7265d.ad8278"]]},{"id":"dfa11988.0cfa6","type":"json","z":"5df15275.2888ec","g":"8fac538c.5d4a48","name":"","property":"payload","action":"obj","pretty":false,"x":970,"y":1180,"wires":[["9a76b6bf.1016d"]]},{"id":"9a76b6bf.1016d","type":"split","z":"5df15275.2888ec","g":"8fac538c.5d4a48","name":"","splt":"1","spltType":"len","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1110,"y":1180,"wires":[["fe2a6027.b22b48","3b6f26a5.932aba"]]},{"id":"fe2a6027.b22b48","type":"function","z":"5df15275.2888ec","g":"8fac538c.5d4a48","name":"getbot_onoff","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nlet botname = msg.payload;\nmsg.botname = botname;\n\nconst gb = global.get('getbot_onoff')(botname);\n\ngb.then(gb => {\n    \n    msg.payload = JSON.parse(gb);\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    \n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"});\n    \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1250,"y":1180,"wires":[["4bd2ed9.fa5d114","aa865712.dd6a08"]]},{"id":"4bd2ed9.fa5d114","type":"filter","z":"5df15275.2888ec","g":"8fac538c.5d4a48","name":"filter off","property":"payload","propertyType":"msg","asArray":false,"itemProperty":"","itemPropertyType":"item","rules":[{"t":"true","output":1}],"checkall":"true","outputs":1,"x":1420,"y":1180,"wires":[["a790f90b.998d8"]]},{"id":"a790f90b.998d8","type":"function","z":"5df15275.2888ec","g":"8fac538c.5d4a48","name":"getbot_busy","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nconst gb = global.get('getbot_busy')(msg.botname);\n\ngb.then(gb => {\n    \n    msg.payload = JSON.parse(gb);\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    \n    \n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"});\n    \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1590,"y":1180,"wires":[["b080e3fb.60616"]]},{"id":"b080e3fb.60616","type":"function","z":"5df15275.2888ec","g":"8fac538c.5d4a48","name":"busy === false ","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nif (msg.payload === false) {\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    \n    return [msg, null];\n}\n\nelse {\n\n    let id = msg.botname;\n    msg.payload = [];\n\n    var count = flow.get(id) || 0;\n    count += 1;\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"blue\",shape:\"dot\"});\n\n\n    if (count > 4) {\n        const upd = global.get('setbot_free')(id);\n\n        upd.then(upd => {\n            \n            //>трекер>\n                let end_node_time = new Date().getTime();\n                let duration = end_node_time - start_node_time;\n                let duration_step = end_node_time - last_node_end_time;\n                track.push({\n                    \"steptitle\": steptitle+\"-reset\",\n                    \"start_node_time\": start_node_time,\n                    \"end_node_time\": end_node_time,\n                    \"duration\": duration,\n                    \"duration_step\": duration_step,\n                });\n                flow.set(\"track\", track);\n            //>трекер>\n            node.status({fill:\"red\",shape:\"dot\"});\n            \n            flow.set(id, 0);\n            node.warn(\"reset busy:\" + id);\n\n        }).catch(error => {\n            node.error(error);\n        });\n\n    }\n    flow.set(id, count);\n    return [null, msg];\n}\n\n\n\n\n\n","outputs":2,"noerr":0,"initialize":"","finalize":"","x":1780,"y":1180,"wires":[["cec096cd.d93358"],["5bbb44fa.ec4574"]],"icon":"font-awesome/fa-bolt"},{"id":"40175d8a.67b97c","type":"link out","z":"5df15275.2888ec","name":"","links":["8ada0320.0af298"],"x":2175,"y":1120,"wires":[]},{"id":"8ada0320.0af298","type":"link in","z":"5df15275.2888ec","name":"","links":["40175d8a.67b97c","7e6df2c2.aa43bc"],"x":135,"y":1560,"wires":[["95a19c1d.39bae","af44b4f3.4b59e8"]]},{"id":"14ffa955.ed6edf","type":"link out","z":"5df15275.2888ec","name":"","links":["256455f.6de7caa","373cb204.5f5efe"],"x":1755,"y":1560,"wires":[]},{"id":"9f82a757.25f3d","type":"function","z":"5df15275.2888ec","g":"3e767551.3d299a","name":"setbot_free","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n    \n    let firststep = track[0];\n    let first_node_start_time = firststep.start_node_time;\n    \n    let duration_track = last_node_end_time - first_node_start_time;\n//>трекер>\n\nconst upd = global.get('setbot_free')(msg.botname);\n\nupd.then(upd => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_track //только для финишной ноды\n        });\n        flow.set(\"track\", track);\n        \n        flow.set(msg.botname, 0);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    \n    node.send(msg);\n\n}).catch(error => {\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"});\n\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2530,"y":1160,"wires":[["133c3e4a.687a62","51b45a57.49dad4","a359f524.2e00e8"]],"icon":"font-awesome/fa-bolt"},{"id":"bec7265d.ad8278","type":"debug","z":"5df15275.2888ec","g":"8fac538c.5d4a48","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":910,"y":1120,"wires":[]},{"id":"cec096cd.d93358","type":"function","z":"5df15275.2888ec","g":"8fac538c.5d4a48","name":"setbot_busy","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nconst upd = global.get('setbot_busy')(msg.botname);\n\nupd.then(upd => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    \n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"});\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1990,"y":1180,"wires":[["40175d8a.67b97c","be118eed.3c8348"]],"icon":"font-awesome/fa-bolt"},{"id":"be118eed.3c8348","type":"debug","z":"5df15275.2888ec","g":"8fac538c.5d4a48","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2010,"y":1140,"wires":[]},{"id":"5bbb44fa.ec4574","type":"debug","z":"5df15275.2888ec","g":"8fac538c.5d4a48","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1870,"y":1240,"wires":[]},{"id":"fde6293c.43f6a","type":"function","z":"5df15275.2888ec","name":"setbot_free","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = Date.parse(new Date()) / 1000;\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n    node.warn(last_node_end_time);\n//>трекер>\n\nconst upd = global.get('setbot_free')(msg.botname);\n\nupd.then(upd => {\n\n    //>трекер>\n        let end_node_time = Date.parse(new Date()) / 1000;\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    \n    node.send(msg);\n\n}).catch(error => {\n    //>трекер>\n        let end_node_time = Date.parse(new Date()) / 1000;\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"});\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4670,"y":2140,"wires":[["a9a43381.7fb07"]],"icon":"font-awesome/fa-bolt"},{"id":"6424a7a9.fde1e","type":"inject","z":"5df15275.2888ec","name":"","props":[{"p":"botname","v":"BNBUSDT-1606088829","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":4440,"y":2480,"wires":[["fde6293c.43f6a"]]},{"id":"a9a43381.7fb07","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4860,"y":2140,"wires":[]},{"id":"51b45a57.49dad4","type":"function","z":"5df15275.2888ec","name":"duration","func":"\nlet track = flow.get(\"track\");\n\nlet laststep = track[track.length-1];\nlet firststep = track[0];\nlet last_node_end_time = laststep.end_node_time;\nlet first_node_start_time = firststep.start_node_time;\n\nlet duration = last_node_end_time - first_node_start_time;\n//node.warn(duration);\nmsg.payload = duration;\n    \nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2800,"y":1160,"wires":[["51350500.94f214","1d3cd462.fdc43c"]]},{"id":"51350500.94f214","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":2970,"y":1200,"wires":[]},{"id":"1d3cd462.fdc43c","type":"ui_chart","z":"5df15275.2888ec","name":"","group":"a328c3be.7f91c8","order":0,"width":"14","height":"4","label":"chart1","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"cubic","nodata":"","dot":true,"ymin":"","ymax":"","removeOlder":"10","removeOlderPoints":"40","removeOlderUnit":"1","cutout":0,"useOneColor":false,"useUTC":true,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9a244f","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":2950,"y":1160,"wires":[[]]},{"id":"24812b74.9bc644","type":"function","z":"5df15275.2888ec","g":"c2109678.33bc38","name":"start MA calc","func":"//<трекер<\n    ////>только для стартовой ноды>\n        var track = [];\n        let start_track_time = new Date().getTime();\n        let start_node_time = start_track_time;\n        let steptitle = node.name;\n    ////>только для стартовой ноды>\n//>трекер>\n\n\n\nmsg.payload = global.get('guid');\n\n\n//>трекер>\n    let end_node_time = new Date().getTime();\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration_node\": duration,\n        \"duration_step\": 0\n    });\n\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({ fill: \"green\", shape: \"ring\", text: duration });\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":710,"y":1000,"wires":[["54724e9d.5a21d8"]]},{"id":"54724e9d.5a21d8","type":"function","z":"5df15275.2888ec","g":"c2109678.33bc38","name":"getbotlist","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[0];\n\n    let last_node_end_time = laststep.end_node_time;\n\n//>трекер>\n\nlet guid = msg.payload;\n\nconst gbl = global.get('getbotlist')(guid);\n\ngbl.then(gbl => {\n    \n    msg.payload = gbl;\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"});\n    \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":880,"y":940,"wires":[["5beb39ef.f84b7"]]},{"id":"5beb39ef.f84b7","type":"json","z":"5df15275.2888ec","g":"c2109678.33bc38","name":"","property":"payload","action":"obj","pretty":false,"x":1030,"y":940,"wires":[["a707b53d.3343e"]]},{"id":"a707b53d.3343e","type":"split","z":"5df15275.2888ec","g":"c2109678.33bc38","name":"","splt":"1","spltType":"len","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1170,"y":940,"wires":[["2ac45d8.4ea1022"]]},{"id":"2ac45d8.4ea1022","type":"function","z":"5df15275.2888ec","g":"c2109678.33bc38","name":"getbot_onoff","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nlet botname = msg.payload;\nmsg.botname = botname;\n\nconst gb = global.get('getbot_onoff')(botname);\n\ngb.then(gb => {\n    \n    msg.payload = JSON.parse(gb);\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    \n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"});\n    \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1310,"y":940,"wires":[["fe43ccbb.7a083"]]},{"id":"fe43ccbb.7a083","type":"filter","z":"5df15275.2888ec","g":"c2109678.33bc38","name":"filter off","property":"payload","propertyType":"msg","asArray":false,"itemProperty":"","itemPropertyType":"item","rules":[{"t":"true","output":1}],"checkall":"true","outputs":1,"x":1480,"y":940,"wires":[["b72aec1b.3ff6d"]]},{"id":"8f2b992a.2a5888","type":"function","z":"5df15275.2888ec","g":"c2109678.33bc38","name":"start MA calc","func":"//<трекер<\n    ////>только для стартовой ноды>\n        var track = [];\n        let start_track_time = new Date().getTime();\n        let start_node_time = start_track_time;\n        let steptitle = node.name;\n    ////>только для стартовой ноды>\n//>трекер>\n\n\n\nmsg.payload = global.get('guid');\n\n\n//>трекер>\n    let end_node_time = new Date().getTime();\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration_node\": duration,\n        \"duration_step\": 0\n    });\n\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({ fill: \"green\", shape: \"ring\", text: duration });\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":710,"y":940,"wires":[["54724e9d.5a21d8"]]},{"id":"3d3d989e.3a00f","type":"function","z":"5df15275.2888ec","g":"c2109678.33bc38","name":"get candlestick","func":"function parseApiError(error) {\n  if (error.body) {\n    try {\n      var resp = JSON.parse(error.body);\n      return resp.msg;\n    } catch (error) {/* pass thru */}\n  }\n  return \"Unknown error. Status code: \"+error.statsCode;\n}\n\nlet LBinance = global.get('gBinance');\nlet key = global.get('key');\nlet secret = global.get('secret');\n\nlet binance = new LBinance().options({\n\tAPIKEY: key,\n\tAPISECRET: secret,\n\t\"reconnect\": false\n});\n\nlet moneta = msg.bot.settings.moneta;\nlet deep = Number(msg.bot.settings.ma2);\n\n//node.warn(binance);\n\n\n//msg.payload = \"qjson.status\";\n\n\nbinance.candlesticks(moneta, \"1m\", (error, ticks, symbol) => {\n // console.info(\"candlesticks()\", ticks);\n // let last_tick = ticks[ticks.length - 1];\n // let [time, open, high, low, close, volume, closeTime, assetVolume, trades, buyBaseVolume, buyAssetVolume, ignored] = ticks;\n  //console.info(symbol+\" last close: \"+close);\n  msg.payload = ticks;\n  \n  node.send(msg);\n  return;\n  \n}, {limit: deep});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2100,"y":940,"wires":[["a2a98d92.7d7ac8","11f5815b.2198c7"]],"inputLabels":["orderid, moneta"],"outputLabels":["status"],"icon":"font-awesome/fa-compress"},{"id":"a2a98d92.7d7ac8","type":"function","z":"5df15275.2888ec","g":"c2109678.33bc38","name":"расчет MA","func":"let candles = msg.payload;\n\n\nlet heiken = candles.map(function(tick){\n  //  node.warn(tick);\n    \n    \n    return (Number(tick[1]) + Number(tick[2]) + Number(tick[3]) + Number(tick[4]))/4;\n});\n\n\n//node.warn(heiken);\nmsg.heiken = heiken;\n\n\nlet heiken_small = heiken.slice(-msg.bot.settings.ma1);\n\n//node.warn(heiken_small);\nlet sum_all = heiken.reduce(function(sum, current) {\n  return sum + current\n});\n\nlet sum_small = heiken_small.reduce(function(sum, current) {\n  return sum + current\n});\n\nmsg.bot.status.sr_ma_big = sum_all / msg.bot.settings.ma2;\nmsg.bot.status.sr_ma_small = sum_small / msg.bot.settings.ma1;\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2290,"y":940,"wires":[["2ffac69a.1af06a"]]},{"id":"2ffac69a.1af06a","type":"function","z":"5df15275.2888ec","g":"c2109678.33bc38","name":"prepare update bot status","func":"msg.topic = msg.bot.settings.userid+\"-bots:\"+msg.bot.settings.botname+\":status\";\n\nmsg.payload = JSON.stringify(msg.bot.status);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2510,"y":940,"wires":[["f00f32f3.dec218"]],"icon":"font-awesome/fa-bolt"},{"id":"b72aec1b.3ff6d","type":"function","z":"5df15275.2888ec","g":"c2109678.33bc38","name":"getbot_settings","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nlet bot = {};\nmsg.bot = bot;\nconst gb = global.get('getbot_settings')(msg.botname);\n\ngb.then(gb => {\n    \n    msg.bot.settings = JSON.parse(gb);\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1660,"y":940,"wires":[["36be307e.92e14"]]},{"id":"36be307e.92e14","type":"function","z":"5df15275.2888ec","g":"c2109678.33bc38","name":"getbot_status","func":"\nconst gb = global.get('getbot_status')(msg.botname);\n\ngb.then(gb => {\n\n\n    msg.bot.status = JSON.parse(gb);\n //   msg.bot.status = JSON.parse(gb);\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1880,"y":940,"wires":[["3d3d989e.3a00f"]]},{"id":"f00f32f3.dec218","type":"function","z":"5df15275.2888ec","g":"c2109678.33bc38","name":"setbot_status","func":"\nconst upd = global.get('setbot_status')(msg.topic, msg.payload);\n\nupd.then(upd => {\n\n    msg.payload = \"updated\"\n    node.send(msg);\n\n}).catch(error => {\n    node.status({fill:\"red\",shape:\"dot\"});  \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2760,"y":940,"wires":[["cac10d2c.dddd8"]],"icon":"font-awesome/fa-bolt"},{"id":"a911e390.b5d95","type":"function","z":"5df15275.2888ec","name":"getprice","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nlet moneta = msg.bot.settings.moneta;\n\nconst gp = global.get('getprice')(moneta);\n\ngp.then(gp => {\n    \n    msg.bot.status.currentprice = gp;\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"});\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":660,"y":1560,"wires":[["cb37028d.66ec4"]]},{"id":"cb37028d.66ec4","type":"function","z":"5df15275.2888ec","name":"prepare update bot status","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nmsg.topic = msg.bot.settings.userid+\"-bots:\"+msg.bot.settings.botname+\":status\";\n\nmsg.payload = JSON.stringify(msg.bot.status);\n\n//>трекер>\n    let end_node_time = new Date().getTime();\n    let duration = end_node_time - start_node_time;\n    let duration_step = end_node_time - last_node_end_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration_node\": duration,\n        \"duration_step\": duration_step\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":870,"y":1560,"wires":[["302b86fd.feef2a"]],"icon":"font-awesome/fa-bolt"},{"id":"e44e5a97.f491b","type":"function","z":"5df15275.2888ec","name":"setbot_status","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    \n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nmsg.topic = msg.bot.settings.userid+\"-bots:\"+msg.bot.settings.botname+\":status\";\nmsg.bot.status.updated = new Date().getTime();\nmsg.payload = JSON.stringify(msg.bot.status);\nconst upd = global.get('setbot_status')(msg.topic, msg.payload);\n\n\nupd.then(upd => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"}); \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1340,"y":1560,"wires":[["8228371e.8b4288","c6daab76.cf51c8"]],"icon":"font-awesome/fa-bolt"},{"id":"95a19c1d.39bae","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":250,"y":1620,"wires":[]},{"id":"af44b4f3.4b59e8","type":"function","z":"5df15275.2888ec","name":"getbot_settings","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nlet bot = {};\nmsg.bot = bot;\nconst gb = global.get('getbot_settings')(msg.botname);\n\ngb.then(gb => {\n    \n    msg.bot.settings = JSON.parse(gb);\n    \n        //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    \n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"});\n    \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":280,"y":1560,"wires":[["48cf55ef.7a86ec"]]},{"id":"48cf55ef.7a86ec","type":"function","z":"5df15275.2888ec","name":"getbot_status","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nconst gb = global.get('getbot_status')(msg.botname);\n\ngb.then(gb => {\n    msg.bot.status = JSON.parse(gb);\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n\n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"});\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":480,"y":1560,"wires":[["a911e390.b5d95"]]},{"id":"e34a5b68.726ec8","type":"link in","z":"5df15275.2888ec","name":"","links":["1d363e0d.ecfda2","12ffe7f.e8dc818","5c79e5db.ac8dbc","e7a3546e.921a88","95441edd.0d929","6754e914.7614e8","ddabea75.dd1088","753a36de.b9e428","e8c8331e.e7793","b8ba1292.37024","22a97a04.318866","680cfedc.4fcef","94225cb4.7b0ac","c51d3999.c7a808","c0331d12.6a72c","b4a0f6b3.fffbc8","8f71fdf8.2081f"],"x":2315,"y":1120,"wires":[["9f82a757.25f3d"]]},{"id":"9cbb75e6.0f4498","type":"http in","z":"5df15275.2888ec","g":"154b2e1c.6272e2","name":"","url":"/botslist","method":"get","upload":false,"swaggerDoc":"","x":4110,"y":1160,"wires":[["d2e4b8ad.2f61c8"]]},{"id":"6f87fcb7.9335e4","type":"http response","z":"5df15275.2888ec","g":"154b2e1c.6272e2","name":"","statusCode":"200","headers":{},"x":4880,"y":1160,"wires":[]},{"id":"d2e4b8ad.2f61c8","type":"function","z":"5df15275.2888ec","g":"154b2e1c.6272e2","name":"getbotlist","func":"\n\nlet guid = global.get('guid');\n\nconst gbl = global.get('getbotlist')(guid);\n\ngbl.then(gbl => {\n    \n    msg.payload = JSON.parse(gbl);\n    \n\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n    \n\n    node.status({fill:\"red\",shape:\"dot\"});\n    \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4280,"y":1160,"wires":[["80d7c6d0.cd5e08"]]},{"id":"f0503628.d8df98","type":"function","z":"5df15275.2888ec","g":"154b2e1c.6272e2","name":"","func":"let guid = global.get('guid');\nmsg.payload = [true, msg.payload, 0, 0, 0, 0, 0, 0, guid];\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4580,"y":1160,"wires":[["712f8721.08ce18"]]},{"id":"80d7c6d0.cd5e08","type":"split","z":"5df15275.2888ec","g":"154b2e1c.6272e2","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":4430,"y":1160,"wires":[["f0503628.d8df98"]]},{"id":"712f8721.08ce18","type":"join","z":"5df15275.2888ec","g":"154b2e1c.6272e2","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":4730,"y":1160,"wires":[["6f87fcb7.9335e4"]]},{"id":"1a05e8c0.3a30d7","type":"http in","z":"5df15275.2888ec","g":"9234522a.3a33c","name":"","url":"/bot_full","method":"post","upload":false,"swaggerDoc":"","x":3930,"y":1280,"wires":[["192054d1.4fe29b"]]},{"id":"239253ed.cd5e7c","type":"function","z":"5df15275.2888ec","g":"9234522a.3a33c","name":"getbot_status","func":"\nlet botname = msg.payload.botname;\n\nconst gb = global.get('getbot_status')(botname);\n\ngb.then(gb => {\n    \n    msg.bot.status = JSON.parse(gb);\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4340,"y":1280,"wires":[["c94a0180.3474a","cefaef13.fdbe38"]]},{"id":"13685612.fa676a","type":"http response","z":"5df15275.2888ec","g":"9234522a.3a33c","name":"","statusCode":"200","headers":{},"x":4880,"y":1280,"wires":[]},{"id":"d577802f.1b12c","type":"redis-command","z":"5df15275.2888ec","server":"f120eab2.0a60a8","command":"AUTH","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":2370,"y":300,"wires":[["6182b5a9.c0565c"]]},{"id":"98f37d3.dcbc68","type":"inject","z":"5df15275.2888ec","name":"123QWEvisorTi31!QAZ3ws","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"123QWEvisorTi31!QAZ3ws","payloadType":"str","x":1970,"y":300,"wires":[["d577802f.1b12c"]]},{"id":"192054d1.4fe29b","type":"function","z":"5df15275.2888ec","g":"9234522a.3a33c","name":"getbot_settings","func":"\n\nlet bot = {};\nmsg.bot = bot;\nconst gb = global.get('getbot_settings')(msg.payload.botname);\n\ngb.then(gb => {\n    \n    msg.bot.settings = JSON.parse(gb);\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4140,"y":1280,"wires":[["239253ed.cd5e7c"]]},{"id":"4c5eb819.338738","type":"function","z":"5df15275.2888ec","g":"9234522a.3a33c","name":"prepare data","func":"msg.payload = msg.bot;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4710,"y":1280,"wires":[["13685612.fa676a"]]},{"id":"9d4b21de.c6e79","type":"comment","z":"5df15275.2888ec","name":"1 - Покупаем","info":"","x":970,"y":2020,"wires":[]},{"id":"29bba474.1311bc","type":"comment","z":"5df15275.2888ec","name":"2 - Купили. Держим","info":"","x":1000,"y":2380,"wires":[]},{"id":"164e36c.27147c9","type":"comment","z":"5df15275.2888ec","name":"3 - Продаём","info":"","x":970,"y":2620,"wires":[]},{"id":"59e2c8e3.215458","type":"function","z":"5df15275.2888ec","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":960,"y":2800,"wires":[[]]},{"id":"2d408eec.5fd1d2","type":"comment","z":"5df15275.2888ec","name":"4 - Продали","info":"","x":970,"y":2760,"wires":[]},{"id":"91ce6bcb.4660c8","type":"switch","z":"5df15275.2888ec","name":"статус этажа","property":"bot.currentfloor[7]","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"eq","v":"1","vt":"str"},{"t":"eq","v":"2","vt":"str"},{"t":"eq","v":"3","vt":"str"},{"t":"eq","v":"4","vt":"str"}],"checkall":"true","repair":false,"outputs":5,"x":680,"y":2120,"wires":[["c1205a7a.e64a88"],["f9171818.a77228","8cb56aa3.a4d61"],["d4b164b1.ec0c48","8b633602.aac0d8"],["c51d3999.c7a808","3ca95c2c.4bc654"],["59e2c8e3.215458"]]},{"id":"b90cf80b.4b7998","type":"function","z":"5df15275.2888ec","name":"определяем этаж","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nlet lp = Number(msg.bot.status.currentprice);\nlet f = msg.bot.floors;\n\n    var curfloor = f.filter(function(floor) {\n     return ((floor[1]<=lp)&&(floor[2]>lp));\n    });\n\nif (curfloor[0]) {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n   \n   \n    msg.bot.currentfloor = curfloor[0];\n    msg.bot.status.currentfloor = curfloor[0][0];\n    return [msg, null];\n} \nelse\n{\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-outgrid\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"blue\",shape:\"dot\"});\n   // node.warn(\"вне сетки\"); \n    return [null,msg];\n}\n\n","outputs":2,"noerr":0,"initialize":"","finalize":"","x":250,"y":2120,"wires":[["dc892fe8.bac79","4a02d190.e7d87"],[]]},{"id":"dc892fe8.bac79","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":310,"y":2060,"wires":[]},{"id":"4fd5ae55.50c0d","type":"comment","z":"5df15275.2888ec","name":"вне сетки","info":"","x":440,"y":2360,"wires":[]},{"id":"d0445e86.60e8a","type":"comment","z":"5df15275.2888ec","name":"дежурный по этажу","info":"","x":240,"y":1920,"wires":[]},{"id":"c3c68186.76c01","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"getbot_data()","func":"","outputs":1,"noerr":0,"initialize":"let guid = global.get('guid');\n\n\n\nlet getbot_data = function (botname = msg.payload) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n\n    msg.topic = guid+\"-bots:\"+botname+\":data\";\n    msg.payload = [];\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('getbot_data', getbot_data);","finalize":"","x":1070,"y":500,"wires":[["bcbb540b.558ae8"]]},{"id":"229ee0ff.22e48","type":"inject","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"botname","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":900,"y":500,"wires":[["c3c68186.76c01"]]},{"id":"e47a380a.5fd968","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":1460,"y":500,"wires":[]},{"id":"fe0a5fc8.c442f","type":"function","z":"5df15275.2888ec","g":"5b21035.9c9f6fc","name":"getbot_start_set","func":"\nlet botname = msg.payload.botname;\n\nconst gb = global.get('getbot_start_set')(botname);\n\ngb.then(gb => {\n\n    msg.payload = gb;\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4420,"y":1580,"wires":[["ac588a65.521198"]]},{"id":"bcbb540b.558ae8","type":"redis-command","z":"5df15275.2888ec","g":"c625f482.ef7058","server":"f120eab2.0a60a8","command":"hgetall","name":"","topic":"","params":"{}","paramsType":"json","payloadType":"json","block":false,"x":1250,"y":500,"wires":[["e47a380a.5fd968"]]},{"id":"8228371e.8b4288","type":"function","z":"5df15275.2888ec","name":"getbot_data","func":"\nlet botname = msg.botname;\n\nconst gb = global.get('getbot_data')(botname);\n\ngb.then(gb => {\n    //node.warn(gb);\n    let bot = {...msg.bot,\n        \"floors\":JSON.parse(gb.floors),\n        \"finance\":JSON.parse(gb.finance),\n        \"sales\":JSON.parse(gb.sales)\n    };\n    msg.bot = bot;\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1530,"y":1560,"wires":[["f46e3c05.ef292","14ffa955.ed6edf"]]},{"id":"f46e3c05.ef292","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1750,"y":1660,"wires":[]},{"id":"373cb204.5f5efe","type":"link in","z":"5df15275.2888ec","name":"","links":["14ffa955.ed6edf"],"x":95,"y":2120,"wires":[["be39e216.8776b","b90cf80b.4b7998"]]},{"id":"be39e216.8776b","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":170,"y":2220,"wires":[]},{"id":"c1205a7a.e64a88","type":"switch","z":"5df15275.2888ec","name":"проверка запрета на закуп","property":"bot.zapret_na_zakup","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":1020,"y":1900,"wires":[["498e9341.48da0c","fefaf8d6.ad5958"],["1d363e0d.ecfda2","915da6cf.825428"]]},{"id":"a0d89c52.2ec2b","type":"comment","z":"5df15275.2888ec","name":"запрещено закупать","info":"","x":1320,"y":1920,"wires":[]},{"id":"498e9341.48da0c","type":"function","z":"5df15275.2888ec","name":"set buy order","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nfunction parseApiError(error) {\n  if (error.body) {\n    try {\n      var resp = JSON.parse(error.body);\n      return resp.msg;\n    } catch (error) {/* pass thru */}\n  }\n  return \"Unknown error. Status code: \"+error.statsCode;\n}\n\nlet LBinance = global.get('gBinance');\n//node.warn(LBinance);\nlet key = global.get('key');\nlet secret = global.get('secret');\n\n\nlet binance = new LBinance().options({\n\tAPIKEY: key,\n\tAPISECRET: secret,\n\tuseServerTime: true,\n\tadjustForTimeDifference: true \n});\n\n\n\n\nlet moneta = msg.bot.settings.moneta;\nlet quantity = Number((Number(msg.bot.finance.depo)*Number(msg.bot.settings.ordersize)/100/msg.bot.status.currentprice).toFixed(msg.bot.settings.digitq));\nlet price = Number((msg.bot.currentfloor[3]).toFixed(msg.bot.settings.digitprice));\nnode.warn(\"set buy order \"+quantity);\n\n\n\n\nbinance.useServerTime(function() {\n    binance.buy(moneta, quantity, price, {type:'LIMIT'}, (err, resp) => {\n // console.info(\"Limit Buy response\", response);\n // console.info(\"order id: \" + response.orderId);\n    if (err) {\n        var errorMsg = parseApiError(err) + \", moneta:\" + moneta;\n        node.error(errorMsg, msg);\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": err\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n        node.status({fill: \"red\", shape: \"ring\", text: errorMsg});\n        \n        node.send(msg);\n        //return [msg, null];\n    \n    }\n    if (resp) {\n        msg.orderid = resp.orderId;\n        msg.resp = resp;\n        node.status({fill: \"green\", shape: \"ring\", text: resp.orderId});\n        \n        \n            //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill: \"green\", shape: \"ring\", text: resp.orderId});\n        \n        node.send(msg);\n       // return [null,msg];\n                \n    }\n    //node.status({}); //clear status message\n});\n\t\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1310,"y":1860,"wires":[["f7313a3c.d751e8","9dd3d4e2.3685e8"]],"inputLabels":["orderid, moneta"],"outputLabels":["status"],"icon":"font-awesome/fa-compress"},{"id":"f7313a3c.d751e8","type":"function","z":"5df15275.2888ec","name":"change floors, finance ","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nlet currentfloor = msg.bot.currentfloor;\ncurrentfloor[7] = 1;\ncurrentfloor[8] = msg.resp.orderId;\ncurrentfloor[14] = msg.resp.origQty;\n\nmsg.bot.floors[currentfloor[0]-1] = currentfloor;\n\nmsg.bot.finance.baseinorders = (Number(Number(msg.bot.finance.baseinorders) + Number(msg.resp.origQty) * Number(msg.resp.price))).toFixed(msg.bot.settings.digitprice);\nmsg.bot.finance.basenal = (Number(Number(msg.bot.finance.basenal) - Number(msg.resp.origQty) * Number(msg.resp.price))).toFixed(msg.bot.settings.digitprice);\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: currentfloor[0]});\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1520,"y":1860,"wires":[["3c3da305.c86c8c"]]},{"id":"3c3da305.c86c8c","type":"function","z":"5df15275.2888ec","name":"update bot floors, finance","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nlet volname = msg.bot.settings.userid+\"-bots:\"+msg.botname+\":data\";\nlet botdata = {\n    \"finance\":JSON.stringify(msg.bot.finance),\n    \"floors\":JSON.stringify(msg.bot.floors),\n    \"sales\":JSON.stringify(msg.bot.sales)\n    \n};\n\nconst upd = global.get('setbot_data')(volname, botdata);\n\nupd.then(upd => {\n    \n    msg.payload = upd;\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill: \"green\", shape: \"ring\"});\n    \n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill: \"red\", shape: \"ring\", text: \"error\"});\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1770,"y":1860,"wires":[["12ffe7f.e8dc818"]],"icon":"font-awesome/fa-bolt"},{"id":"d46ce170.d1325","type":"comment","z":"5df15275.2888ec","name":"0 - Свободно","info":"","x":970,"y":1860,"wires":[]},{"id":"24cf66df.38462a","type":"comment","z":"5df15275.2888ec","name":"PARTIALLY_FILLED","info":"","x":2290,"y":2400,"wires":[]},{"id":"12ffe7f.e8dc818","type":"link out","z":"5df15275.2888ec","name":"","links":["e34a5b68.726ec8","e3e1e22a.f958b"],"x":1935,"y":1860,"wires":[]},{"id":"1d363e0d.ecfda2","type":"link out","z":"5df15275.2888ec","name":"","links":["e34a5b68.726ec8","e3e1e22a.f958b"],"x":1455,"y":1920,"wires":[]},{"id":"302b86fd.feef2a","type":"function","z":"5df15275.2888ec","name":"MA zapret calculate","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nif ((msg.bot.status.currentprice > msg.bot.status.sr_ma_big)&&(msg.bot.status.currentprice > msg.bot.status.sr_ma_small)){\n    msg.bot.zapret_na_zakup = false;\n    msg.bot.status.rezhim = \"МА - закуп разрешен\";\n} else {\n    msg.bot.zapret_na_zakup = true;\n    msg.bot.status.rezhim = \"МА - закуп запрещён\";\n}\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    \nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1120,"y":1560,"wires":[["e44e5a97.f491b"]]},{"id":"6115d0a9.4e59f","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"setbot_data()","func":"","outputs":1,"noerr":0,"initialize":"let guid = global.get('guid');\n\n\nlet setbot_data = function (volname = msg.topic, data = msg.payload) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n\n    msg.topic = volname;\n    msg.payload = data;\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('setbot_data', setbot_data);","finalize":"","x":1070,"y":320,"wires":[["1fd9091b.b7c747"]]},{"id":"695f8ecb.2536a","type":"inject","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"botname","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":900,"y":320,"wires":[["6115d0a9.4e59f"]]},{"id":"63dd941.f161b6c","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":1460,"y":320,"wires":[]},{"id":"1fd9091b.b7c747","type":"redis-command","z":"5df15275.2888ec","g":"c625f482.ef7058","server":"f120eab2.0a60a8","command":"hmset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1250,"y":320,"wires":[["63dd941.f161b6c"]]},{"id":"c94a0180.3474a","type":"function","z":"5df15275.2888ec","g":"9234522a.3a33c","name":"getbot_data","func":"\nlet botname = msg.bot.settings.botname;\n\nconst gb = global.get('getbot_data')(botname);\n\ngb.then(gb => {\n    //node.warn(gb);\n    let bot = {...msg.bot,\n        \"floors\":JSON.parse(gb.floors),\n        \"finance\":JSON.parse(gb.finance),\n        \"sales\":JSON.parse(gb.sales)\n    };\n    msg.bot = bot;\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4530,"y":1280,"wires":[["4c5eb819.338738"]]},{"id":"7ddb53c7.3bb5bc","type":"function","z":"5df15275.2888ec","name":"","func":"msg.topic = \"jurnal\";\nmsg.payload = flow.get(\"track\");\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3660,"y":2180,"wires":[["5ec57567.e09b8c"]]},{"id":"8eb1f45.b108d08","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4170,"y":2480,"wires":[]},{"id":"f01cd92b.fcdc68","type":"inject","z":"5df15275.2888ec","name":"","props":[{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"\"jurnal\"","x":3690,"y":2460,"wires":[["8b8766ab.625aa8","1dd9dcaa.3f7493"]]},{"id":"f2127320.046ec","type":"function","z":"5df15275.2888ec","name":"","func":"msg.payload = JSON.parse(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4050,"y":2400,"wires":[["8eb1f45.b108d08"]]},{"id":"4b069157.19693","type":"redis-command","z":"5df15275.2888ec","server":"f120eab2.0a60a8","command":"sadd","name":"","topic":"","params":"","paramsType":"json","payloadType":"json","block":false,"x":3850,"y":2120,"wires":[["907c34e5.1e9808"]]},{"id":"5ec57567.e09b8c","type":"join","z":"5df15275.2888ec","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":3790,"y":2060,"wires":[["4b069157.19693"]]},{"id":"907c34e5.1e9808","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3970,"y":2180,"wires":[]},{"id":"8b8766ab.625aa8","type":"function","z":"5df15275.2888ec","name":"prepare getprice","func":"\nmsg.topic = [];\nmsg.payload = \"jurnal\";\n    \n\nnode.status({fill:\"green\",shape:\"dot\"});\n    \nreturn msg;\n    \n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3840,"y":2400,"wires":[[]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"601248c1.6a3f58","type":"redis-command","z":"5df15275.2888ec","server":"f120eab2.0a60a8","command":"GET","name":"get price","topic":"msg.topic","params":"","paramsType":"json","payloadType":"json","block":false,"x":3920,"y":2300,"wires":[["6771d2a6.edcd3c"]]},{"id":"6771d2a6.edcd3c","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":4090,"y":2300,"wires":[]},{"id":"b6ece763.681068","type":"inject","z":"5df15275.2888ec","name":"","props":[{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"jurnal","x":3850,"y":2320,"wires":[["601248c1.6a3f58"]]},{"id":"1dd9dcaa.3f7493","type":"redis-command","z":"5df15275.2888ec","server":"f120eab2.0a60a8","command":"hgetall","name":"","topic":"","params":"{}","paramsType":"json","payloadType":"json","block":false,"x":3930,"y":2460,"wires":[["f2127320.046ec"]]},{"id":"8a90f52f.5e82b8","type":"function","z":"5df15275.2888ec","g":"93990b56.ce7428","name":"prepare for start_set","func":"msg.topic = msg.payload.user_id_from_google+\"-bots:\"+msg.payload.botname+\":start_set\";\n\nmsg.payload = msg.payload.start_set;\n\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4260,"y":1040,"wires":[["b9301109.6d837"]]},{"id":"b9301109.6d837","type":"redis-command","z":"5df15275.2888ec","g":"93990b56.ce7428","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4490,"y":1040,"wires":[[]]},{"id":"1da56dc9.817ee2","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"getbot_start_set()","func":"","outputs":1,"noerr":0,"initialize":"let guid = global.get('guid');\n\n\nlet getbot_start_set = function (botname = msg.payload) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n\n    msg.topic = guid+\"-bots:\"+botname+\":start_set\";\n    msg.payload = [];\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('getbot_start_set', getbot_start_set);","finalize":"","x":1090,"y":560,"wires":[["c83cd378.b93ca"]]},{"id":"4af43326.f9b1bc","type":"inject","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"botname","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":900,"y":560,"wires":[["1da56dc9.817ee2"]]},{"id":"3e8866d4.739e9a","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":1500,"y":560,"wires":[]},{"id":"c83cd378.b93ca","type":"redis-command","z":"5df15275.2888ec","g":"c625f482.ef7058","server":"f120eab2.0a60a8","command":"GET","name":"get bot starts_set","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1310,"y":560,"wires":[["3e8866d4.739e9a"]]},{"id":"50d2f56d.d89b5c","type":"redis-command","z":"5df15275.2888ec","g":"5b21035.9c9f6fc","server":"f120eab2.0a60a8","command":"hmset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4690,"y":1640,"wires":[[]]},{"id":"24e3759c.ccab7a","type":"function","z":"5df15275.2888ec","g":"5b21035.9c9f6fc","name":"prepare data for create bot","func":"msg.topic = msg.payload.settings.userid+\"-bots:\"+msg.payload.settings.botname+\":data\";\n\nlet botdata = {\n    \"finance\":JSON.stringify(msg.payload.finance),\n    \"floors\":JSON.stringify(msg.payload.floors),\n    \"sales\":JSON.stringify(msg.payload.sales)\n    \n};\nmsg.payload = botdata;\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4460,"y":1640,"wires":[["50d2f56d.d89b5c"]]},{"id":"493967b2.355f88","type":"function","z":"5df15275.2888ec","g":"5b21035.9c9f6fc","name":"prepare for add bot status","func":"msg.topic = msg.payload.settings.userid+\"-bots:\"+msg.payload.settings.botname+\":status\";\nmsg.payload.status.updated = new Date().getTime();\nmsg.payload = JSON.stringify(msg.payload.status);\n\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4450,"y":1700,"wires":[["a77ec084.8fffe"]]},{"id":"a77ec084.8fffe","type":"redis-command","z":"5df15275.2888ec","g":"5b21035.9c9f6fc","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4670,"y":1700,"wires":[[]]},{"id":"81b674e0.619348","type":"function","z":"5df15275.2888ec","g":"5b21035.9c9f6fc","name":"prepare for add bot settings","func":"msg.topic = msg.payload.settings.userid+\"-bots:\"+msg.payload.settings.botname+\":settings\";\n\nmsg.payload = JSON.stringify(msg.payload.settings);\n\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4460,"y":1760,"wires":[["c192b5ce.f292e8"]]},{"id":"c192b5ce.f292e8","type":"redis-command","z":"5df15275.2888ec","g":"5b21035.9c9f6fc","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4690,"y":1760,"wires":[[]]},{"id":"f5e48d6b.8af42","type":"function","z":"5df15275.2888ec","g":"5b21035.9c9f6fc","name":"prepare for add bot ttp","func":"msg.topic = msg.payload.settings.userid+\"-bots:\"+msg.payload.settings.botname+\":ttp\";\n\nmsg.payload = JSON.stringify(msg.payload.ttp);\n\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4440,"y":1820,"wires":[["9c3f6550.f65078"]]},{"id":"9c3f6550.f65078","type":"redis-command","z":"5df15275.2888ec","g":"5b21035.9c9f6fc","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4650,"y":1820,"wires":[[]]},{"id":"534028b7.335048","type":"function","z":"5df15275.2888ec","g":"5b21035.9c9f6fc","name":"prepare for add bot busy","func":"msg.topic = msg.payload.settings.userid+\"-bots:\"+msg.payload.settings.botname+\":busy\";\n\nmsg.payload = \"false\";\n\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4450,"y":1880,"wires":[["d3e6b44f.196458"]]},{"id":"d3e6b44f.196458","type":"redis-command","z":"5df15275.2888ec","g":"5b21035.9c9f6fc","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4670,"y":1880,"wires":[[]]},{"id":"ac588a65.521198","type":"json","z":"5df15275.2888ec","g":"5b21035.9c9f6fc","name":"","property":"payload","action":"","pretty":false,"x":4590,"y":1580,"wires":[["24e3759c.ccab7a","493967b2.355f88","81b674e0.619348","f5e48d6b.8af42","534028b7.335048","49b11422.104a8c","7417b1f3.5548"]]},{"id":"496429d7.3e65b8","type":"http in","z":"5df15275.2888ec","g":"5b21035.9c9f6fc","name":"","url":"/bot_reset","method":"post","upload":false,"swaggerDoc":"","x":4200,"y":1580,"wires":[["daa3ab85.3e3f08","fe0a5fc8.c442f"]]},{"id":"daa3ab85.3e3f08","type":"http response","z":"5df15275.2888ec","g":"5b21035.9c9f6fc","name":"","statusCode":"200","headers":{},"x":4220,"y":1640,"wires":[]},{"id":"839251af.05aeb","type":"inject","z":"5df15275.2888ec","g":"5b21035.9c9f6fc","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"LINKDOWNUSDT-1626469485","payloadType":"str","x":4270,"y":1520,"wires":[["fe0a5fc8.c442f"]]},{"id":"f9171818.a77228","type":"switch","z":"5df15275.2888ec","name":"проверка запрета на закуп","property":"bot.zapret_na_zakup","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":1020,"y":2060,"wires":[["b55cd864.198818"],["9495114e.60fe3"]]},{"id":"c6daab76.cf51c8","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1500,"y":1680,"wires":[]},{"id":"599bb04c.9368d","type":"function","z":"5df15275.2888ec","name":"change floors, finance ","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n node.warn(\"cancel order \"+msg.bot.currentfloor[14]);     \nlet tempfin = Number(Number(msg.bot.finance.baseinorders) - Number(msg.bot.currentfloor[14])*Number(msg.bot.currentfloor[3]));\nlet tempfin2 = Number(Number(msg.bot.finance.basenal) + Number(msg.bot.currentfloor[14])*Number(msg.bot.currentfloor[3]));\n\nmsg.bot.finance.baseinorders = tempfin.toFixed(msg.bot.settings.digitprice);\nmsg.bot.finance.basenal = tempfin2.toFixed(msg.bot.settings.digitprice);\n\nif (msg.bot.finance.baseinorders == -0) {msg.bot.finance.baseinorders = 0;}\nif (msg.bot.finance.basenal == -0) {msg.bot.finance.basenal = 0;}\n\nlet currentfloor = msg.bot.currentfloor;\ncurrentfloor[7] = 0;\ncurrentfloor[8] = 0;\ncurrentfloor[14] = 0;\n\nmsg.bot.floors[currentfloor[0]-1] = currentfloor;\n\n//>трекер>\n    let end_node_time = new Date().getTime();\n    let duration = end_node_time - start_node_time;\n    let duration_step = end_node_time - last_node_end_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration_node\": duration,\n        \"duration_step\": duration_step\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: start_node_time});\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2620,"y":2260,"wires":[["a135ebf2.c63d48"]]},{"id":"7a67833a.3758dc","type":"function","z":"5df15275.2888ec","name":"cansel buy orders","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nfunction parseApiError(error) {\n  if (error.body) {\n    try {\n      var resp = JSON.parse(error.body);\n      return resp.msg;\n    } catch (error) {/* pass thru */}\n  }\n  return \"Unknown error. Status code: \"+error.statsCode;\n}\n\nlet LBinance = global.get('gBinance');\n//node.warn(LBinance);\nlet key = global.get('key');\nlet secret = global.get('secret');\n\nlet binance = new LBinance().options({\n\tAPIKEY: key,\n\tAPISECRET: secret,\n\treconnect: false,\n\tuseServerTime: true\n});\n\nlet moneta = msg.bot.settings.moneta;\nlet orderid = msg.bot.currentfloor[8];\n\n//msg.payload = \"qjson.status\";\n\nbinance.useServerTime(function() {\nbinance.cancel(moneta, orderid, (err, resp) => {\n // console.info(\"Limit Buy response\", response);\n // console.info(\"order id: \" + response.orderId);\n    if (err) {\n        var errorMsg = parseApiError(err) + \", moneta:\" + moneta;\n        node.error(errorMsg, msg);\n        \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n\n    node.status({fill: \"red\", shape: \"ring\", text: errorMsg});\n    node.send(msg);\n        \n    \n    }\n    if (resp) {\n        msg.orderid = resp.orderId;\n        msg.resp = resp;\n        \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill: \"green\", shape: \"ring\", text: start_node_time});\n    node.send(msg);\n        \n    }\n    //node.status({}); //clear status message\n})});\n\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2390,"y":2220,"wires":[["599bb04c.9368d"]]},{"id":"acc188d3.58d138","type":"comment","z":"5df15275.2888ec","name":"NEW","info":"","x":2210,"y":2220,"wires":[]},{"id":"ef979c72.74622","type":"switch","z":"5df15275.2888ec","name":"статус ордера","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"NEW","vt":"str"},{"t":"eq","v":"PARTIALLY_FILLED","vt":"str"},{"t":"eq","v":"CANCELED","vt":"str"},{"t":"eq","v":"FILLED","vt":"str"},{"t":"eq","v":"REJECTED","vt":"str"},{"t":"eq","v":"EXPIRED","vt":"str"},{"t":"null"}],"checkall":"true","repair":false,"outputs":7,"x":1960,"y":2300,"wires":[["7a67833a.3758dc"],["e8c8331e.e7793"],["599bb04c.9368d"],["509e478f.306ba8"],["82e76eec.4698f","c0331d12.6a72c"],["82e76eec.4698f","c0331d12.6a72c"],["82e76eec.4698f","c0331d12.6a72c"]]},{"id":"9495114e.60fe3","type":"function","z":"5df15275.2888ec","name":"prepare get order status","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nlet moneta = msg.bot.settings.moneta;\nlet orderid = msg.bot.currentfloor[8];\n\nmsg.payload = [];\nmsg.topic = \"orders-status-\" + msg.bot.settings.userid + \":\" + moneta + \":\" + orderid;\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: orderid});\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1530,"y":2300,"wires":[["ad7fdd13.f562b"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"ad7fdd13.f562b","type":"redis-command","z":"5df15275.2888ec","server":"f120eab2.0a60a8","command":"GET","name":"get order status","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1760,"y":2300,"wires":[["ef979c72.74622"]]},{"id":"e7a3546e.921a88","type":"link out","z":"5df15275.2888ec","name":"","links":["e34a5b68.726ec8","e3e1e22a.f958b"],"x":3035,"y":2260,"wires":[]},{"id":"a135ebf2.c63d48","type":"function","z":"5df15275.2888ec","name":"update bot floors, finance","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nlet volname = msg.bot.settings.userid+\"-bots:\"+msg.botname+\":data\";\nlet botdata = {\n    \"finance\":JSON.stringify(msg.bot.finance),\n    \"floors\":JSON.stringify(msg.bot.floors),\n    \"sales\":JSON.stringify(msg.bot.sales)\n    \n};\n\nconst upd = global.get('setbot_data')(volname, botdata);\n\nupd.then(upd => {\n    \n    msg.payload = upd;\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: start_node_time});\n    \n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill: \"red\", shape: \"ring\", text: error});\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2870,"y":2260,"wires":[["e7a3546e.921a88"]],"icon":"font-awesome/fa-bolt"},{"id":"82e76eec.4698f","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2210,"y":2460,"wires":[]},{"id":"915da6cf.825428","type":"function","z":"5df15275.2888ec","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1530,"y":1920,"wires":[[]]},{"id":"d7f4906a.c1a83","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1550,"y":2580,"wires":[]},{"id":"5f69a953.e18b28","type":"comment","z":"5df15275.2888ec","name":"FILLED","info":"","x":2210,"y":2340,"wires":[]},{"id":"bc089647.c26d98","type":"comment","z":"5df15275.2888ec","name":"CANCELED","info":"","x":2230,"y":2280,"wires":[]},{"id":"509e478f.306ba8","type":"function","z":"5df15275.2888ec","name":"change floors, finance ","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nnode.warn(\"filled order \"+msg.bot.currentfloor[14]);      \nlet tempfin = Number(Number(msg.bot.finance.baseinorders) - Number(msg.bot.currentfloor[14])*Number(msg.bot.currentfloor[3]));\n\nlet tempfin2 = Number(Number(msg.bot.finance.quotanal) + Number(msg.bot.currentfloor[14]));\n\nmsg.bot.finance.baseinorders = tempfin.toFixed(msg.bot.settings.digitprice);\nmsg.bot.finance.quotanal = tempfin2.toFixed(msg.bot.settings.digitq);\n\nif (msg.bot.finance.baseinorders == -0) {msg.bot.finance.baseinorders = 0;}\nif (msg.bot.finance.basenal == -0) {msg.bot.finance.basenal = 0;}\n\nlet currentfloor = msg.bot.currentfloor;\ncurrentfloor[7] = 2;\n\n\nmsg.bot.floors[currentfloor[0]-1] = currentfloor;\n\n//>трекер>\n    let end_node_time = new Date().getTime();\n    let duration = end_node_time - start_node_time;\n    let duration_step = end_node_time - last_node_end_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration_node\": duration,\n        \"duration_step\": duration_step\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: start_node_time});\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2400,"y":2340,"wires":[["57e6a67e.1f8ae8"]]},{"id":"57e6a67e.1f8ae8","type":"function","z":"5df15275.2888ec","name":"update bot floors, finance","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nlet volname = msg.bot.settings.userid+\"-bots:\"+msg.botname+\":data\";\nlet botdata = {\n    \"finance\":JSON.stringify(msg.bot.finance),\n    \"floors\":JSON.stringify(msg.bot.floors),\n    \"sales\":JSON.stringify(msg.bot.sales)\n    \n};\n\nconst upd = global.get('setbot_data')(volname, botdata);\n\nupd.then(upd => {\n    \n    msg.payload = upd;\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill: \"green\", shape: \"ring\", text: start_node_time});\n    \n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill: \"red\", shape: \"ring\", text: \"error\"});\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2650,"y":2340,"wires":[["95441edd.0d929"]],"icon":"font-awesome/fa-bolt"},{"id":"95441edd.0d929","type":"link out","z":"5df15275.2888ec","name":"","links":["e34a5b68.726ec8","e3e1e22a.f958b"],"x":2815,"y":2340,"wires":[]},{"id":"b603cdb8.70c35","type":"function","z":"5df15275.2888ec","name":"change floors, finance ","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n node.warn(\"cancel order \"+msg.bot.currentfloor[14]);   \nlet tempfin = Number(Number(msg.bot.finance.baseinorders) - Number(msg.bot.currentfloor[14])*Number(msg.bot.currentfloor[3]));\nlet tempfin2 = Number(Number(msg.bot.finance.basenal) + Number(msg.bot.currentfloor[14])*Number(msg.bot.currentfloor[3]));\n\nmsg.bot.finance.baseinorders = tempfin.toFixed(msg.bot.settings.digitprice);\nmsg.bot.finance.basenal = tempfin2.toFixed(msg.bot.settings.digitprice);\n\nif (msg.bot.finance.baseinorders == -0) {msg.bot.finance.baseinorders = 0;}\nif (msg.bot.finance.basenal == -0) {msg.bot.finance.basenal = 0;}\n\nlet currentfloor = msg.bot.currentfloor;\ncurrentfloor[7] = 0;\ncurrentfloor[8] = 0;\ncurrentfloor[14] = 0;\n\nmsg.bot.floors[currentfloor[0]-1] = currentfloor;\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: start_node_time});\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2420,"y":2000,"wires":[["1ff82a47.746756"]]},{"id":"2eb7dc6.f57b024","type":"comment","z":"5df15275.2888ec","name":"NEW","info":"","x":2250,"y":1940,"wires":[]},{"id":"865095a3.2a59f8","type":"switch","z":"5df15275.2888ec","name":"статус ордера","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"NEW","vt":"str"},{"t":"eq","v":"PARTIALLY_FILLED","vt":"str"},{"t":"eq","v":"CANCELED","vt":"str"},{"t":"eq","v":"FILLED","vt":"str"},{"t":"eq","v":"REJECTED","vt":"str"},{"t":"eq","v":"EXPIRED","vt":"str"},{"t":"null"}],"checkall":"true","repair":false,"outputs":7,"x":1960,"y":2040,"wires":[["753a36de.b9e428"],["753a36de.b9e428"],["b603cdb8.70c35"],["a488d768.190e48","a3a3ff62.74a51"],["509b2051.1f238"],["509b2051.1f238"],["753a36de.b9e428"]]},{"id":"b55cd864.198818","type":"function","z":"5df15275.2888ec","name":"prepare get order status","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nlet moneta = msg.bot.settings.moneta;\nlet orderid = msg.bot.currentfloor[8];\n\nmsg.payload = [];\nmsg.topic = \"orders-status-\" + msg.bot.settings.userid + \":\" + moneta + \":\" + orderid;\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: orderid});\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1530,"y":2040,"wires":[["5be6f2d2.79667c"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"5be6f2d2.79667c","type":"redis-command","z":"5df15275.2888ec","server":"f120eab2.0a60a8","command":"GET","name":"get order status","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1760,"y":2040,"wires":[["865095a3.2a59f8"]]},{"id":"6754e914.7614e8","type":"link out","z":"5df15275.2888ec","name":"","links":["e34a5b68.726ec8","e3e1e22a.f958b"],"x":2835,"y":2000,"wires":[]},{"id":"1ff82a47.746756","type":"function","z":"5df15275.2888ec","name":"update bot floors, finance","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nlet volname = msg.bot.settings.userid+\"-bots:\"+msg.botname+\":data\";\nlet botdata = {\n    \"finance\":JSON.stringify(msg.bot.finance),\n    \"floors\":JSON.stringify(msg.bot.floors),\n    \"sales\":JSON.stringify(msg.bot.sales)\n    \n};\n\nconst upd = global.get('setbot_data')(volname, botdata);\n\nupd.then(upd => {\n    \n    msg.payload = upd;\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: start_node_time});\n    \n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill: \"red\", shape: \"ring\", text: \"error\"});\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2670,"y":2000,"wires":[["6754e914.7614e8"]],"icon":"font-awesome/fa-bolt"},{"id":"509b2051.1f238","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2210,"y":2140,"wires":[]},{"id":"b2c855fb.a42838","type":"comment","z":"5df15275.2888ec","name":"FILLED","info":"","x":2210,"y":2060,"wires":[]},{"id":"a59e428f.f4ee","type":"comment","z":"5df15275.2888ec","name":"CANCELED","info":"","x":2230,"y":2000,"wires":[]},{"id":"a488d768.190e48","type":"function","z":"5df15275.2888ec","name":"change floors, finance ","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n node.warn(\"filled order \"+msg.bot.currentfloor[14]);     \nlet tempfin = Number(Number(msg.bot.finance.baseinorders) - Number(msg.bot.currentfloor[14])*Number(msg.bot.currentfloor[3]));\n\nlet tempfin2 = Number(Number(msg.bot.finance.quotanal) + Number(msg.bot.currentfloor[14]));\n\nmsg.bot.finance.baseinorders = tempfin.toFixed(msg.bot.settings.digitprice);\nmsg.bot.finance.quotanal = tempfin2.toFixed(msg.bot.settings.digitq);\n\nif (msg.bot.finance.baseinorders == -0) {msg.bot.finance.baseinorders = 0;}\nif (msg.bot.finance.basenal == -0) {msg.bot.finance.basenal = 0;}\n\nlet currentfloor = msg.bot.currentfloor;\ncurrentfloor[7] = 2;\ncurrentfloor[10] =  Number(msg.bot.currentfloor[14])*Number(msg.bot.currentfloor[3]);\n\n\nmsg.bot.floors[currentfloor[0]-1] = currentfloor;\n\n\n//>трекер>\n    let end_node_time = new Date().getTime();\n    let duration = end_node_time - start_node_time;\n    let duration_step = end_node_time - last_node_end_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration_node\": duration,\n        \"duration_step\": duration_step\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: start_node_time});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2420,"y":2080,"wires":[["43fe1086.8d0d8"]]},{"id":"43fe1086.8d0d8","type":"function","z":"5df15275.2888ec","name":"update bot floors, finance","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nlet volname = msg.bot.settings.userid+\"-bots:\"+msg.botname+\":data\";\nlet botdata = {\n    \"finance\":JSON.stringify(msg.bot.finance),\n    \"floors\":JSON.stringify(msg.bot.floors),\n    \"sales\":JSON.stringify(msg.bot.sales)\n    \n};\n\nconst upd = global.get('setbot_data')(volname, botdata);\n\nupd.then(upd => {\n    \n    msg.payload = upd;\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: start_node_time});\n    \n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill: \"red\", shape: \"ring\", text: \"error\"});\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2670,"y":2080,"wires":[["ddabea75.dd1088"]],"icon":"font-awesome/fa-bolt"},{"id":"ddabea75.dd1088","type":"link out","z":"5df15275.2888ec","name":"","links":["e34a5b68.726ec8","e3e1e22a.f958b"],"x":2835,"y":2080,"wires":[]},{"id":"753a36de.b9e428","type":"link out","z":"5df15275.2888ec","name":"","links":["e34a5b68.726ec8","e3e1e22a.f958b"],"x":2175,"y":1940,"wires":[]},{"id":"e8c8331e.e7793","type":"link out","z":"5df15275.2888ec","name":"","links":["e34a5b68.726ec8","e3e1e22a.f958b"],"x":2175,"y":2400,"wires":[]},{"id":"adadc5c1.82cee8","type":"comment","z":"5df15275.2888ec","name":"PARTIALLY_FILLED","info":"","x":2410,"y":1940,"wires":[]},{"id":"a5cb775c.f42b28","type":"comment","z":"5df15275.2888ec","name":"null","info":"","x":2570,"y":1940,"wires":[]},{"id":"d4b164b1.ec0c48","type":"function","z":"5df15275.2888ec","name":"check price for sale start","func":"if (msg.bot.status.currentprice >= msg.bot.currentfloor[5]){\n    msg.bot.currentfloor[7] = 3;\n    \n\n    return [null,msg];\n    \n} else {\n    return [msg,null];\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","x":1410,"y":2700,"wires":[["22a97a04.318866","d7f4906a.c1a83","35d0c017.d03ff"],["dae08b18.1d07a8","adf2a298.2e768"]]},{"id":"22a97a04.318866","type":"link out","z":"5df15275.2888ec","name":"","links":["e34a5b68.726ec8","e3e1e22a.f958b"],"x":1595,"y":2660,"wires":[]},{"id":"680cfedc.4fcef","type":"link out","z":"5df15275.2888ec","name":"","links":["e34a5b68.726ec8","e3e1e22a.f958b"],"x":3575,"y":2780,"wires":[]},{"id":"dae08b18.1d07a8","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1530,"y":2840,"wires":[]},{"id":"f785532.0ffbcb","type":"function","z":"5df15275.2888ec","name":"getbot_ttp","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nconst gb = global.get('getbot_ttp')(msg.botname);\n\ngb.then(gb => {\n    msg.bot.ttp = JSON.parse(gb);\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: start_node_time});\n\n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill: \"red\", shape: \"ring\", text: \"error\"});\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2470,"y":2800,"wires":[["156f30b7.c5107f","7929bc2f.6b5c84"]]},{"id":"156f30b7.c5107f","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2470,"y":2920,"wires":[]},{"id":"4a02d190.e7d87","type":"function","z":"5df15275.2888ec","name":"setbot_status","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    \n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nmsg.topic = msg.bot.settings.userid+\"-bots:\"+msg.bot.settings.botname+\":status\";\nmsg.bot.status.updated = new Date().getTime();\nmsg.payload = JSON.stringify(msg.bot.status);\nconst upd = global.get('setbot_status')(msg.topic, msg.payload);\n\n\nupd.then(upd => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"}); \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":480,"y":2120,"wires":[["91ce6bcb.4660c8"]],"icon":"font-awesome/fa-bolt"},{"id":"72e2e748.efabf8","type":"function","z":"5df15275.2888ec","name":"change floors, finance, ttp","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nnode.warn(\"start ttp on floor \"+msg.bot.currentfloor[0]);     \n\nlet tempfin = Number(Number(msg.bot.finance.quotainorders) + Number(msg.bot.currentfloor[14]));\n\nlet tempfin2 = Number(Number(msg.bot.finance.quotanal) - Number(msg.bot.currentfloor[14]));\n\nmsg.bot.finance.quotainorders = tempfin.toFixed(msg.bot.settings.digitprice);\nmsg.bot.finance.quotanal = tempfin2.toFixed(msg.bot.settings.digitq);\n\nif (msg.bot.finance.baseinorders == -0) {msg.bot.finance.baseinorders = 0;}\nif (msg.bot.finance.basenal == -0) {msg.bot.finance.basenal = 0;}\n\nlet currentfloor = msg.bot.currentfloor;\ncurrentfloor[7] = 3;\n\n\nmsg.bot.floors[currentfloor[0]-1] = currentfloor;\n\nmsg.bot.ttp.quantity = msg.bot.ttp.quantity + Number(msg.bot.currentfloor[14]);\n\n//>трекер>\n    let end_node_time = new Date().getTime();\n    let duration = end_node_time - start_node_time;\n    let duration_step = end_node_time - last_node_end_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration_node\": duration,\n        \"duration_step\": duration_step\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: start_node_time});\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2970,"y":2780,"wires":[["fc83d80a.0a0f38"]]},{"id":"e2a75296.e2b2b","type":"function","z":"5df15275.2888ec","name":"setbot_data","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nlet volname = msg.bot.settings.userid+\"-bots:\"+msg.botname+\":data\";\nlet botdata = {\n    \"finance\":JSON.stringify(msg.bot.finance),\n    \"floors\":JSON.stringify(msg.bot.floors),\n    \"sales\":JSON.stringify(msg.bot.sales)\n    \n};\n\nconst upd = global.get('setbot_data')(volname, botdata);\n\nupd.then(upd => {\n    \n    msg.payload = upd;\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill: \"green\", shape: \"ring\", text: start_node_time});\n    \n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill: \"red\", shape: \"ring\", text: \"error\"});\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3350,"y":2780,"wires":[["680cfedc.4fcef","b0495ebf.bb0c9"]],"icon":"font-awesome/fa-bolt"},{"id":"7929bc2f.6b5c84","type":"switch","z":"5df15275.2888ec","name":"quantity > 0 ?","property":"bot.ttp.quantity","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"gt","v":"0","vt":"num"}],"checkall":"false","repair":false,"outputs":2,"x":2700,"y":2800,"wires":[["f97f8135.0a62d","72e2e748.efabf8"],["a545df6f.6fdf9","1157f5ba.ba8ada"]]},{"id":"f97f8135.0a62d","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2910,"y":2720,"wires":[]},{"id":"a545df6f.6fdf9","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2910,"y":2920,"wires":[]},{"id":"1c93e1af.eeda9e","type":"redis-out","z":"5df15275.2888ec","server":"f120eab2.0a60a8","command":"publish","name":"","topic":"ttp-pilot","obj":true,"x":3620,"y":2720,"wires":[]},{"id":"3eef8d0b.468082","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"setbot_ttp()","func":"","outputs":1,"noerr":0,"initialize":"\nlet setbot_ttp = function (botname = msg.topic, ttp = msg.payload) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n\n    msg.topic = botname;\n    msg.payload = ttp;\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('setbot_ttp', setbot_ttp);","finalize":"","x":1110,"y":440,"wires":[["e0daded4.e68d9"]]},{"id":"5799f4ed.f46bec","type":"inject","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"botname, ttp","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":910,"y":440,"wires":[["3eef8d0b.468082"]]},{"id":"dd20db68.d00b68","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":1500,"y":440,"wires":[]},{"id":"e0daded4.e68d9","type":"redis-command","z":"5df15275.2888ec","g":"c625f482.ef7058","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1310,"y":440,"wires":[["dd20db68.d00b68"]]},{"id":"fc83d80a.0a0f38","type":"function","z":"5df15275.2888ec","name":"setbot_ttp","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    \n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nmsg.topic = msg.bot.settings.userid+\"-bots:\"+msg.bot.settings.botname+\":ttp\";\n\nmsg.payload = JSON.stringify(msg.bot.ttp);\nconst upd = global.get('setbot_ttp')(msg.topic, msg.payload);\n\n\nupd.then(upd => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"}); \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3180,"y":2780,"wires":[["e2a75296.e2b2b"]],"icon":"font-awesome/fa-bolt"},{"id":"94225cb4.7b0ac","type":"link out","z":"5df15275.2888ec","name":"","links":["e34a5b68.726ec8","e3e1e22a.f958b"],"x":3575,"y":2860,"wires":[]},{"id":"1157f5ba.ba8ada","type":"function","z":"5df15275.2888ec","name":"change floors, finance, ttp","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nnode.warn(\"start ttp on floor \"+msg.bot.currentfloor[0]);     \n\nlet tempfin = Number(Number(msg.bot.finance.quotainorders) + Number(msg.bot.currentfloor[14]));\n\nlet tempfin2 = Number(Number(msg.bot.finance.quotanal) - Number(msg.bot.currentfloor[14]));\n\nmsg.bot.finance.quotainorders = tempfin.toFixed(msg.bot.settings.digitprice);\nmsg.bot.finance.quotanal = tempfin2.toFixed(msg.bot.settings.digitq);\n\nif (msg.bot.finance.baseinorders == -0) {msg.bot.finance.baseinorders = 0;}\nif (msg.bot.finance.basenal == -0) {msg.bot.finance.basenal = 0;}\n\nlet currentfloor = msg.bot.currentfloor;\ncurrentfloor[7] = 3;\n\n\nmsg.bot.floors[currentfloor[0]-1] = currentfloor;\n\nmsg.bot.ttp.quantity = msg.bot.ttp.quantity + Number(msg.bot.currentfloor[14]);\n\n//>трекер>\n    let end_node_time = new Date().getTime();\n    let duration = end_node_time - start_node_time;\n    let duration_step = end_node_time - last_node_end_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration_node\": duration,\n        \"duration_step\": duration_step\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: start_node_time});\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2970,"y":2860,"wires":[["13d8552b.e8232b"]]},{"id":"97f21e25.77f9","type":"function","z":"5df15275.2888ec","name":"setbot_data","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nlet volname = msg.bot.settings.userid+\"-bots:\"+msg.botname+\":data\";\nlet botdata = {\n    \"finance\":JSON.stringify(msg.bot.finance),\n    \"floors\":JSON.stringify(msg.bot.floors),\n    \"sales\":JSON.stringify(msg.bot.sales)\n    \n};\n\nconst upd = global.get('setbot_data')(volname, botdata);\n\nupd.then(upd => {\n    \n    msg.payload = upd;\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill: \"green\", shape: \"ring\", text: start_node_time});\n    \n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill: \"red\", shape: \"ring\", text: \"error\"});\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3350,"y":2860,"wires":[["94225cb4.7b0ac"]],"icon":"font-awesome/fa-bolt"},{"id":"13d8552b.e8232b","type":"function","z":"5df15275.2888ec","name":"setbot_ttp","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    \n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nmsg.topic = msg.bot.settings.userid+\"-bots:\"+msg.bot.settings.botname+\":ttp\";\n\nmsg.payload = JSON.stringify(msg.bot.ttp);\nconst upd = global.get('setbot_ttp')(msg.topic, msg.payload);\n\n\nupd.then(upd => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"}); \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3180,"y":2860,"wires":[["97f21e25.77f9"]],"icon":"font-awesome/fa-bolt"},{"id":"c51d3999.c7a808","type":"link out","z":"5df15275.2888ec","name":"","links":["e34a5b68.726ec8","e3e1e22a.f958b"],"x":1075,"y":2700,"wires":[]},{"id":"3ca95c2c.4bc654","type":"function","z":"5df15275.2888ec","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1090,"y":2620,"wires":[[]]},{"id":"8b633602.aac0d8","type":"function","z":"5df15275.2888ec","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1150,"y":2380,"wires":[[]]},{"id":"b0495ebf.bb0c9","type":"function","z":"5df15275.2888ec","name":"команда на старт","func":"\nmsg.payload = {\"bot\":msg.bot};\nmsg.topic = \"\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3470,"y":2660,"wires":[["5a21956f.0a3dac","1c93e1af.eeda9e"]]},{"id":"35d0c017.d03ff","type":"function","z":"5df15275.2888ec","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1710,"y":2580,"wires":[[]]},{"id":"aa865712.dd6a08","type":"debug","z":"5df15275.2888ec","g":"8fac538c.5d4a48","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1350,"y":1100,"wires":[]},{"id":"3b6f26a5.932aba","type":"debug","z":"5df15275.2888ec","g":"8fac538c.5d4a48","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1210,"y":1100,"wires":[]},{"id":"cefaef13.fdbe38","type":"debug","z":"5df15275.2888ec","g":"9234522a.3a33c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4470,"y":1380,"wires":[]},{"id":"8cb56aa3.a4d61","type":"function","z":"5df15275.2888ec","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1110,"y":2000,"wires":[[]]},{"id":"294d5d95.011cc2","type":"trigger","z":"5df15275.2888ec","name":"","op1":"1","op2":"0","op1type":"str","op2type":"str","duration":"-200","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":740,"y":3240,"wires":[["62651732.3226"]]},{"id":"c36ca6a8.9f843","type":"delay","z":"5df15275.2888ec","name":"","pauseType":"delay","timeout":"10","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":530,"y":3240,"wires":[["294d5d95.011cc2"]]},{"id":"6fc4c6e7.21c5f","type":"function","z":"5df15275.2888ec","name":"stop","func":"msg.reset = true;\nmsg.payload = \"\";\nmsg.topic = \"\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":510,"y":3300,"wires":[["294d5d95.011cc2","52d3da5.b1dbaa4"]]},{"id":"edfd9789.f09838","type":"redis-in","z":"5df15275.2888ec","server":"f120eab2.0a60a8","command":"subscribe","name":"","topic":"ttp-stop","obj":true,"timeout":0,"x":170,"y":3300,"wires":[["6fc4c6e7.21c5f","5f8da53c.1cd85c"]]},{"id":"30acf010.0f83d8","type":"comment","z":"5df15275.2888ec","name":"Семафор = \"Занято\"","info":"","x":1360,"y":3160,"wires":[]},{"id":"d8ce7d1.15ff7","type":"function","z":"5df15275.2888ec","name":"busy === false ","func":"\n\nif (msg.bot.ttp.ttpbusy == false) {\n\n    node.status({fill:\"green\",shape:\"dot\"});\n    \n    return [msg, null];\n}\n\nelse {\n\n    let id = msg.bot.settings.botname+\"-ttp\";\n    msg.payload = [];\n\n    var count = flow.get(id) || 0;\n    count += 1;\n\n\n    node.status({fill:\"blue\",shape:\"dot\"});\n\n\n    if (count > 10) {\n        \n        \n        msg.topic = msg.bot.settings.userid+\"-bots:\"+msg.bot.settings.botname+\":ttp\";\n        msg.bot.ttp.ttpbusy = false;\n        msg.payload = JSON.stringify(msg.bot.ttp);\n        const upd = global.get('setbot_ttp')(msg.topic, msg.payload);\n        \n        \n        upd.then(upd => {\n        \n            flow.set(id, 0);\n           \n            node.warn(\"reset busy ttp:\" + id);\n            node.status({fill:\"green\",shape:\"dot\"});\n            node.send(msg);\n        \n        }).catch(error => {\n        \n            node.status({fill:\"red\",shape:\"dot\"}); \n            node.error(error);\n        });\n\n    }\n    flow.set(id, count);\n    return [null, msg];\n}\n\n\n\n\n\n","outputs":2,"noerr":0,"initialize":"","finalize":"","x":1140,"y":3240,"wires":[["4c9e1e77.0c26f8","7aa3252e.c30aec"],["e98fc2d8.a9c1d8"]],"icon":"font-awesome/fa-bolt"},{"id":"4c9e1e77.0c26f8","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1370,"y":3200,"wires":[]},{"id":"e98fc2d8.a9c1d8","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1230,"y":3300,"wires":[]},{"id":"5175b9b9.500208","type":"redis-in","z":"5df15275.2888ec","server":"f120eab2.0a60a8","command":"subscribe","name":"","topic":"ttp-pilot","obj":true,"timeout":0,"x":170,"y":3240,"wires":[["f1e8ffca.319c1"]]},{"id":"f1e8ffca.319c1","type":"function","z":"5df15275.2888ec","name":"start ttp","func":"//<трекер<\n    ////>только для стартовой ноды>\n        var track = [];\n        let start_track_time = new Date().getTime();\n        let start_node_time = start_track_time;\n        let steptitle = node.name;\n    ////>только для стартовой ноды>\n//>трекер>\n\n\n\nmsg.bot=msg.payload.bot\nmsg.payload = [];\n\n\n//>трекер>\n    let end_node_time = new Date().getTime();\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration_node\": duration,\n        \"duration_step\": 0\n    });\n\n    flow.set(\"track_ttp\", track);\n//>трекер>\nnode.status({ fill: \"green\", shape: \"ring\", text: duration });\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":320,"y":3240,"wires":[["c36ca6a8.9f843","8e8783eb.9932a8"]]},{"id":"d27e4307.e0bf58","type":"function","z":"5df15275.2888ec","name":"","func":"let bot = {\"settings\":{\"botname\":\"BNBUSDT-1623875864\",\"isrunning\":false,\"handyzapretnazakup\":false,\"comment\":null,\"quotacoin\":\"BNB\",\"basecoin\":\"USDT\",\"moneta\":\"BNBUSDT\",\"digitq\":\"4\",\"digitprice\":\"2\",\"minprice\":\"300\",\"maxprice\":\"400\",\"profitproc\":\"0.3\",\"ordersize\":\"12\",\"ofsetbottom\":\"0.05\",\"ofsettop\":\"0.05\",\"ma1\":3,\"ma2\":30,\"maxpriceforzakup\":null,\"minpriceforzakup\":null,\"userid\":\"d3fmoh2rVoVNgIcpLTFZBE0jHnI2\"},\"status\":{\"currentprice\":\"352.61000000\",\"lastprice\":-1,\"currentfloor\":30,\"lastfloor\":-1,\"sr_ma_big\":350.94441666666677,\"sr_ma_small\":352.2633333333333,\"rezhim\":\"МА - закуп разрешен\",\"updated\":1623879597136},\"zapret_na_zakup\":false,\"floors\":[[1,300,301.65,300.15,300.59999999999997,300.74999999999994,301.5,0,0,0,0,0,0,0,0],[2,301.65,303.30907499999995,301.800825,302.25329999999997,302.40412499999996,303.15824999999995,0,0,0,0,0,0,0,0],[3,303.30907499999995,304.9772749124999,303.46072953749996,303.91569315,304.0673476875,304.82562037499997,0,0,0,0,0,0,0,0],[4,304.9772749124999,306.65464992451865,305.1297635499562,305.58722946232496,305.7397180997812,306.50216128706245,0,0,0,0,0,0,0,0],[5,306.65464992451865,308.3412504991035,306.8079772494809,307.2679592243677,307.42128654933,308.18792317414125,0,0,0,0,0,0,0,0],[6,308.3412504991035,310.0371273768486,308.4954211243531,308.9579330001017,309.11210362535127,309.882956751599,0,0,0,0,0,0,0,0],[7,310.0371273768486,311.7423315774213,310.19214594053705,310.65720163160233,310.81222019529076,311.58731301373285,0,0,0,0,0,0,0,0],[8,311.7423315774213,313.4569144010971,311.89820274321,312.3658162405761,312.52168740636483,313.3010432353084,0,0,0,0,0,0,0,0],[9,313.4569144010971,315.18092743030314,313.6136428582976,314.08382822989927,314.2405566870998,315.02419897310256,0,0,0,0,0,0,0,0],[10,315.18092743030314,316.9144225311698,315.3385178940183,315.81128928516375,315.9688797488789,316.7568320674547,0,0,0,0,0,0,0,0],[11,316.9144225311698,318.65745185509127,317.0728797424354,317.5482513762322,317.7067085874978,318.49899464382565,0,0,0,0,0,0,0,0],[12,318.65745185509127,320.4100678402943,318.8167805810188,319.2947667588014,319.45409548472895,320.2507391143667,0,0,0,0,0,0,0,0],[13,320.4100678402943,322.1723232134159,320.5702728742144,321.0508879759749,321.211093009895,322.01211817949576,0,0,0,0,0,0,0,0],[14,322.1723232134159,323.9442709910897,322.3334093750226,322.8166678598427,322.9777540214494,323.783184829483,0,0,0,0,0,0,0,0],[15,323.9442709910897,325.7259644815407,324.10624312658524,324.5921595330719,324.7541316685674,325.56399234604515,0,0,0,0,0,0,0,0],[16,325.7259644815407,327.5174572861892,325.88882746378147,326.37741641050377,326.54027939274454,327.3545943039484,0,0,0,0,0,0,0,0],[17,327.5174572861892,329.31880330126324,327.6812160148323,328.17249220076155,328.3362509294046,329.1550445726201,0,0,0,0,0,0,0,0],[18,329.31880330126324,331.13005671942017,329.48346270291387,329.97744090786574,330.14210030951637,330.96539731776954,0,0,0,0,0,0,0,0],[19,331.13005671942017,332.95127203137696,331.2956217477799,331.792316832859,331.9578818612187,332.78570700301725,0,0,0,0,0,0,0,0],[20,332.95127203137696,334.7825040275495,333.1177476673926,333.61717457543966,333.7836502114553,334.6160283915338,0,0,0,0,0,0,0,0],[21,334.7825040275495,336.62380779970107,334.9498952795633,335.4520690356046,335.6194602876184,336.45641654768724,0,0,0,0,0,0,0,0],[22,336.62380779970107,338.4752387425994,336.7921197036009,337.29705541530046,337.4653673192003,338.30692683869955,0,0,0,0,0,0,0,0],[23,338.4752387425994,340.3368525556837,338.6444763619707,339.1521892200846,339.3214268394559,340.1676149363124,0,0,0,0,0,0,0,0],[24,340.3368525556837,342.20870524474,340.50702098196155,341.0175262607951,341.1876946870729,342.03853681846215,0,0,0,0,0,0,0,0],[25,342.20870524474,344.09085312358604,342.37980959736234,342.89312265522943,343.0642270078518,343.9197487709637,0,0,0,0,0,0,0,0],[26,344.09085312358604,345.9833528157658,344.26289855014784,344.7790348298332,344.951080256395,345.811307389204,0,0,0,0,0,0,0,0],[27,345.9833528157658,347.8862612562525,346.1563444921737,346.67531952139734,346.84831119780523,347.7132695798446,0,0,0,0,0,0,0,0],[28,347.8862612562525,349.7996356931619,348.0602043868806,348.582033778765,348.7559769093931,349.62569256253374,0,0,0,0,0,0,0,0],[29,349.7996356931619,351.7235336894743,349.9745355110085,350.4992349645483,350.6741347823949,351.54863387162777,1,2485867244,0,0,0,0,0,\"0.04100000\"],[30,351.7235336894743,353.65801312476646,351.89939545631904,352.42698075685325,352.602842523698,353.4821513579217,3,2485869227,0,0,0,0,0,\"0.04090000\"],[31,353.65801312476646,355.6031321969527,353.83484213132886,354.365329151016,354.5421581575784,355.4263031903903,0,0,0,0,0,0,0,0],[32,355.6031321969527,357.5589494240359,355.78093376305117,356.3143384613466,356.4921400274451,357.38114785793744,0,0,0,0,0,0,0,0],[33,357.5589494240359,359.52552364586813,357.73772889874795,358.274067322884,358.452846797596,359.3467441711561,0,0,0,0,0,0,0,0],[34,359.52552364586813,361.5029140259204,359.70528640769106,360.24457469315985,360.4243374549828,361.3231512640975,0,0,0,0,0,0,0,0],[35,361.5029140259204,363.491180053063,361.68366548293335,362.22591985397224,362.4066713109852,363.31042859605,0,0,0,0,0,0,0,0],[36,363.491180053063,365.49038154335483,363.6729256430895,364.2181624131691,364.39990800319566,365.3086359533283,0,0,0,0,0,0,0,0],[37,365.49038154335483,367.5005786418433,365.6731267341265,366.22136230644156,366.40410749721326,367.31783345107164,0,0,0,0,0,0,0,0],[38,367.5005786418433,369.5218318243734,367.6843289311642,368.235579799127,368.4193300884479,369.3380815350525,0,0,0,0,0,0,0,0],[39,369.5218318243734,371.5542018994075,369.7065927402856,370.2608754880222,370.4456364039344,371.3694409834953,0,0,0,0,0,0,0,0],[40,371.5542018994075,373.5977500098542,371.73997900035715,372.29731030320625,372.4830874041559,373.4119729089045,0,0,0,0,0,0,0,0],[41,373.5977500098542,375.6525376349084,373.78454888485913,374.3449455098739,374.53174438487883,375.4657387599035,0,0,0,0,0,0,0,0],[42,375.6525376349084,377.71862659190043,375.84036390372586,376.4038427101782,376.59166897899564,377.53080032308293,0,0,0,0,0,0,0,0],[43,377.71862659190043,379.7960790381559,377.9074859051964,378.47406384508423,378.6629231583802,379.60721972485993,0,0,0,0,0,0,0,0],[44,379.7960790381559,381.8849574728657,379.98597707767493,380.55567119623214,380.7455692357512,381.6950594333466,0,0,0,0,0,0,0,0],[45,381.8849574728657,383.9853247389665,382.07589995160214,382.64872738781145,382.83966986654787,383.79438226023,0,0,0,0,0,0,0,0],[46,383.9853247389665,386.0972440250308,384.177317401336,384.7532953884444,384.94528805081393,385.9052513626613,0,0,0,0,0,0,0,0],[47,386.0972440250308,388.22077886716846,386.2902926470433,386.86943851308087,387.06248713509336,388.02773024515596,0,0,0,0,0,0,0,0],[48,388.22077886716846,390.3559931509379,388.41488925660207,388.9972204249028,389.1913308143364,390.16188276150433,0,0,0,0,0,0,0,0],[49,390.3559931509379,392.502951113268,390.55117114751334,391.13670513723974,391.3318831338152,392.30777311669254,0,0,0,0,0,0,0,0],[50,392.502951113268,394.661717344391,392.6992025888246,393.2879570154945,393.4842084910511,394.4654658688343,0,0,0,0,0,0,0,0],[51,394.661717344391,396.83235678978514,394.8590482030632,395.4510407790798,395.648371637752,396.635025931113,0,0,0,0,0,0,0,0],[52,396.83235678978514,399.01493475212897,397.03077296818003,397.6260215033647,397.8244376817596,398.8165185737341,0,0,0,0,0,0,0,0],[53,399.01493475212897,401.2095168932657,399.21444221950503,399.8129646216332,400.0124720890093,401.0100094258896,0,0,0,0,0,0,0,0]],\"finance\":{\"startdepo\":\"120\",\"depo\":\"120\",\"quotanal\":\"0.0000\",\"quotainorders\":\"0.04\",\"basenal\":\"91.26\",\"baseinorders\":\"14.35\",\"profittoday\":0},\"sales\":{\"today\":[],\"days\":[],\"all\":[]},\"currentfloor\":[30,351.7235336894743,353.65801312476646,351.89939545631904,352.42698075685325,352.602842523698,353.4821513579217,3,2485869227,0,0,0,0,0,\"0.04090000\"],\"ttp\":{\"raschstopprice\":0,\"curstop\":0,\"curorderid\":0,\"quantity\":0.0409,\"ttpbusy\":false,\"sold\":false}};\nmsg.payload.bot = bot;\nmsg.bot = bot;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":180,"y":3120,"wires":[["f1e8ffca.319c1"]]},{"id":"1165917.3c751ef","type":"inject","z":"5df15275.2888ec","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":140,"y":3060,"wires":[["d27e4307.e0bf58"]]},{"id":"e236519.ebcd2b","type":"inject","z":"5df15275.2888ec","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":500,"y":3400,"wires":[["6fc4c6e7.21c5f"]]},{"id":"8e8783eb.9932a8","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":390,"y":3100,"wires":[]},{"id":"7aa3252e.c30aec","type":"function","z":"5df15275.2888ec","name":"setbot_ttp_busy","func":"\nmsg.topic = msg.bot.settings.userid+\"-bots:\"+msg.bot.settings.botname+\":ttp\";\nmsg.bot.ttp.ttpbusy = true;\nmsg.payload = JSON.stringify(msg.bot.ttp);\nconst upd = global.get('setbot_ttp')(msg.topic, msg.payload);\n\n\nupd.then(upd => {\n\n   \n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n\n    \n    node.status({fill:\"red\",shape:\"dot\"}); \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1360,"y":3240,"wires":[["f690c3ac.0028f8"]],"icon":"font-awesome/fa-bolt"},{"id":"fa6bf889.5a7bb8","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":210,"y":3940,"wires":[]},{"id":"82403975.6e94f8","type":"function","z":"5df15275.2888ec","name":"setbot_ttp_free","func":"\nmsg.topic = msg.bot.settings.userid+\"-bots:\"+msg.bot.settings.botname+\":ttp\";\nmsg.bot.ttp.ttpbusy = false;\nmsg.payload = JSON.stringify(msg.bot.ttp);\nconst upd = global.get('setbot_ttp')(msg.topic, msg.payload);\n\n\nupd.then(upd => {\n\n   \n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n\n    \n    node.status({fill:\"red\",shape:\"dot\"}); \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1740,"y":3060,"wires":[[]],"icon":"font-awesome/fa-bolt"},{"id":"62651732.3226","type":"function","z":"5df15275.2888ec","name":"getbot_ttp","func":"\nconst gb = global.get('getbot_ttp')(msg.bot.settings.botname);\n\ngb.then(gb => {\n    msg.bot.ttp = JSON.parse(gb);\n    \nnode.status({fill: \"green\", shape: \"ring\"});\n\n    node.send(msg);\n\n}).catch(error => {\n    \n    \n    node.status({fill: \"red\", shape: \"ring\", text: \"error\"});\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":950,"y":3240,"wires":[["d8ce7d1.15ff7","9c1d60bc.9c10a"]]},{"id":"21fd6400.791a5c","type":"function","z":"5df15275.2888ec","name":"getprice","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nlet moneta = msg.bot.settings.moneta;\n\nconst gp = global.get('getprice')(moneta);\n\ngp.then(gp => {\n    \n    msg.bot.status.currentprice = gp;\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"});\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":400,"y":3860,"wires":[["a5b7e74f.3c0f3","d8447c26.bb4dc8"]]},{"id":"a5b7e74f.3c0f3","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":390,"y":3920,"wires":[]},{"id":"fc85758d.8d2df","type":"comment","z":"5df15275.2888ec","name":"ситуация","info":"когда stopsell частично заполнился, но потом цена отросла и бот хочет подвинуть ордер дальше вверх. \nПроблема будет если остаток меньше минимума лота.\nСейчас такой ордер мы просто оставляем висеть до заполненности.\nМожно пока в телеграмм о таких случаях стучать, чтобы хозяин вручную разруливал, но по уму надо двигать ордер, на ходу меняя quantity с соответствующей проекцией во floors","x":2200,"y":3760,"wires":[]},{"id":"d8447c26.bb4dc8","type":"function","z":"5df15275.2888ec","name":"calculate stop price","func":"\nlet currentprice = Number(msg.bot.status.currentprice);\nmsg.bot.ttp.raschstopprice = Number(Number(currentprice - currentprice / 100 * msg.bot.settings.ofsettop).toFixed(msg.bot.settings.digitprice));\nmsg.bot.ttp.curstop = Number(msg.bot.ttp.curstop || 0);\nmsg.bot.ttp.curorderid = Number(msg.bot.ttp.curorderid);\nmsg.bot.ttp.quantity = Number(msg.bot.ttp.quantity);\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":590,"y":3860,"wires":[["a722e8db.2c325","26027bc2.33c794"]]},{"id":"a722e8db.2c325","type":"switch","z":"5df15275.2888ec","name":"raschstopprice ? curstop","property":"bot.ttp.raschstopprice","propertyType":"msg","rules":[{"t":"gt","v":"bot.ttp.curstop","vt":"msg"},{"t":"lte","v":"bot.ttp.curstop","vt":"msg"}],"checkall":"true","repair":false,"outputs":2,"x":830,"y":3860,"wires":[["f1698912.6340a8","1c171f80.1804b9","8847d1d6.5d69e"],["be946091.5d45f8","cd12e545.316a28","3239545c.3e2e34"]]},{"id":"f1698912.6340a8","type":"switch","z":"5df15275.2888ec","name":"order id > 0 ","property":"bot.ttp.curorderid","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1110,"y":3780,"wires":[["c2d48d0d.bbc81","4287fbb4.86f9e4"],["a43159c7.39907","65afe27.430071c"]]},{"id":"be946091.5d45f8","type":"function","z":"5df15275.2888ec","name":"prepare get ttp order status","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nlet moneta = msg.bot.settings.moneta;\nlet orderid = msg.bot.ttp.curorderid;\n\nmsg.payload = [];\nmsg.topic = \"orders-status-\" + msg.bot.settings.userid + \":\" + moneta + \":\" + orderid;\n\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: orderid});\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1160,"y":4140,"wires":[["d4366464.6e9bb"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"d4366464.6e9bb","type":"redis-command","z":"5df15275.2888ec","server":"f120eab2.0a60a8","command":"GET","name":"get order status","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1400,"y":4140,"wires":[["99a8c35e.da191","b8d94599.8e5b7"]]},{"id":"99a8c35e.da191","type":"switch","z":"5df15275.2888ec","name":"статус ордера","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"NEW","vt":"str"},{"t":"eq","v":"PARTIALLY_FILLED","vt":"str"},{"t":"eq","v":"CANCELED","vt":"str"},{"t":"eq","v":"FILLED","vt":"str"},{"t":"eq","v":"REJECTED","vt":"str"},{"t":"eq","v":"EXPIRED","vt":"str"}],"checkall":"true","repair":false,"outputs":6,"x":1620,"y":4140,"wires":[["1abd2f20.e65061","7b5bb07a.3966c8","2343abca.a6e05c"],["f99e723c.db2d7","2343abca.a6e05c"],["a527c2ac.97582","f7b6dbb5.36b318","4d0eee3f.645d18"],["3be7b05c.965fc8","c21ed480.50cd28"],["9c45c5de.720128","ba137d19.a93268","ab47cdd8.3462a8"],["9c45c5de.720128","ba137d19.a93268"]]},{"id":"91d80510.dfa2b","type":"comment","z":"5df15275.2888ec","name":"NEW","info":"","x":1850,"y":4000,"wires":[]},{"id":"eb56ec34.5e2418","type":"comment","z":"5df15275.2888ec","name":"CANCELED","info":"","x":2070,"y":4140,"wires":[]},{"id":"c2454f15.39dea8","type":"comment","z":"5df15275.2888ec","name":"FILLED","info":"","x":1850,"y":4200,"wires":[]},{"id":"ebf8abe7.34ee4","type":"comment","z":"5df15275.2888ec","name":"REJECTED или EXPIRED","info":"","x":1910,"y":4340,"wires":[]},{"id":"b4663fc9.774b9","type":"comment","z":"5df15275.2888ec","name":"PARTIALLY_FILLED","info":"","x":2010,"y":4000,"wires":[]},{"id":"3be7b05c.965fc8","type":"function","z":"5df15275.2888ec","name":"set sold","func":"msg.bot.ttp.sold = true;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2040,"y":4200,"wires":[["844a5c76.d26658","28f62589.1de13a","d9d63754.4e87c8"]]},{"id":"844a5c76.d26658","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2210,"y":4240,"wires":[]},{"id":"a527c2ac.97582","type":"link out","z":"5df15275.2888ec","name":"заперещено закупать","links":["47e3fbaf.e02fb4","ab5cef16.762b3","fd4caf2b.2d9e58"],"x":2175,"y":4120,"wires":[]},{"id":"6da07a32.a830d4","type":"link out","z":"5df15275.2888ec","name":"заперещено закупать","links":["47e3fbaf.e02fb4","ab5cef16.762b3","fd4caf2b.2d9e58"],"x":3295,"y":4080,"wires":[]},{"id":"1abd2f20.e65061","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1850,"y":3920,"wires":[]},{"id":"c21ed480.50cd28","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2030,"y":4260,"wires":[]},{"id":"c2d48d0d.bbc81","type":"function","z":"5df15275.2888ec","name":"prepare get ttp order status","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nlet moneta = msg.bot.settings.moneta;\nlet orderid = msg.bot.ttp.curorderid;\n\nmsg.payload = [];\nmsg.topic = \"orders-status-\" + msg.bot.settings.userid + \":\" + moneta + \":\" + orderid;\n\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: orderid});\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1360,"y":3720,"wires":[["4af265e4.0d1a3c"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"4af265e4.0d1a3c","type":"redis-command","z":"5df15275.2888ec","server":"f120eab2.0a60a8","command":"GET","name":"get order status","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1580,"y":3720,"wires":[["d7809508.8035a","ea81bdbd.c8cb8"]]},{"id":"8a478854.63a198","type":"switch","z":"5df15275.2888ec","name":"status NEW ?","property":"payload","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":1940,"y":3720,"wires":[["e68beec2.286ec8"],["ebb62d38.7c53c8","8a3bbe0b.219b9"]]},{"id":"d7809508.8035a","type":"function","z":"5df15275.2888ec","name":"prepare data","func":"if (msg.payload == \"NEW\") {\n    msg.payload = true;\n}\nelse {\n    msg.payload = false;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1770,"y":3720,"wires":[["8a478854.63a198","9d3988d2.118d58"]]},{"id":"26e2daab.54b4f6","type":"function","z":"5df15275.2888ec","name":"set stop sell order","func":"//msg.curstop = Number(msg.bot.ttp.curstop);\n\nmsg.bot.ttp.quantity = msg.bot.ttp.quantity || 0;\n\nfunction parseApiError(error) {\n  if (error.body) {\n    try {\n      var resp = JSON.parse(error.body);\n      return resp.msg;\n    } catch (error) {/* pass thru */}\n  }\n  return \"Unknown error. Status code: \"+error.statsCode;\n}\n\nlet LBinance = global.get('gBinance');\n//node.warn(LBinance);\nlet key = global.get('key');\nlet secret = global.get('secret');\n\nlet binance = new LBinance().options({\n\tAPIKEY: key,\n\tAPISECRET: secret,\n\treconnect: false,\n\tuseServerTime: true\n});\n\nlet moneta = msg.bot.settings.moneta;\nlet quantity = (Number(msg.bot.ttp.quantity)).toFixed(msg.bot.settings.digitq);\n\nlet priceb = (Number((msg.bot.ttp.raschstopprice - msg.bot.ttp.raschstopprice / 100 * msg.bot.settings.ofsetbottom))).toFixed(msg.bot.settings.digitprice);\nlet stopprice = (Number(msg.bot.ttp.raschstopprice)).toFixed(msg.bot.settings.digitprice);\n\n\nnode.warn(\"q:\"+quantity);\nnode.warn(\"p:\"+priceb);\nnode.warn(\"sp:\"+stopprice);\nbinance.useServerTime(function() {\n binance.sell(moneta, quantity, priceb, { stopPrice: stopprice, type: \"STOP_LOSS_LIMIT\" }, function (err, resp) {\n          if (err) {\n            var errorMsg = parseApiError(err);\n            node.error(errorMsg, msg);\n            node.status({fill: \"red\", shape: \"ring\", text: errorMsg});\n            node.send(msg);\n            \n            \n          }\n          if (resp) {\n                        msg.bot.ttp.curorderid = resp.orderId;\n                        msg.bot.ttp.curstop = stopprice;\n                        msg.bot.ttp.quantity = quantity;\n                        node.send(msg);\n          }\n          node.status({}); //clear status message\n\n          \n          \n          //return;\n        })\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2470,"y":3660,"wires":[["dffed29e.b91ee","eb6c36c7.d20ab8"]],"inputLabels":["orderid, moneta"],"outputLabels":["status"],"icon":"font-awesome/fa-compress"},{"id":"d51f367a.75ebc8","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4050,"y":3040,"wires":[]},{"id":"e68beec2.286ec8","type":"function","z":"5df15275.2888ec","name":"cancel stopsell order if exist","func":"\nfunction parseApiError(error) {\n  if (error.body) {\n    try {\n      var resp = JSON.parse(error.body);\n      return resp.msg;\n    } catch (error) {/* pass thru */}\n  }\n  return \"Unknown error. Status code: \"+error.statsCode;\n}\n\nlet LBinance = global.get('gBinance');\n//node.warn(LBinance);\nlet key = global.get('key');\nlet secret = global.get('secret');\n\nlet binance = new LBinance().options({\n\tAPIKEY: key,\n\tAPISECRET: secret,\n\treconnect: false,\n\tuseServerTime: true\n});\n\nlet moneta = msg.bot.settings.moneta;\nlet orderid = msg.bot.ttp.curorderid;\n\n//msg.payload = \"qjson.status\";\n\nbinance.useServerTime(function() {\n    binance.cancel(moneta, orderid, (err, resp) => {\n     // console.info(\"Limit Buy response\", response);\n     // console.info(\"order id: \" + response.orderId);\n        if (err) {\n            var errorMsg = parseApiError(err) + \", moneta:\" + moneta;\n            node.error(errorMsg, msg);\n            node.status({fill: \"red\", shape: \"ring\", text: errorMsg});\n            \n            \n            \n            node.send(msg);\n            // ;\n        \n        }\n        if (resp) {\n            //msg.orderid = resp.orderId;\n            msg.resp = resp;\n            node.status({fill: \"green\", shape: \"ring\"});\n            \n            \n            let tempfin = Number(Number(msg.bot.finance.baseinorders) - Number(msg.bot.status.currentfloor[14])*Number(msg.bot.status.currentfloor[3]));\n            let tempfin2 = Number(Number(msg.bot.finance.basenal) + Number(msg.bot.status.currentfloor[14])*Number(msg.bot.status.currentfloor[3]));\n            \n            msg.bot.finance.baseinorders = tempfin.toFixed(msg.bot.settings.digitprice);\n            msg.bot.finance.basenal = tempfin2.toFixed(msg.bot.settings.digitprice);\n            \n            \n            node.send(msg);\n            //return [null,msg];\n                    \n        }\n        //node.status({}); //clear status message\n    })\n});\n\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2220,"y":3660,"wires":[["26e2daab.54b4f6","71686c85.5605a4"]]},{"id":"71686c85.5605a4","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2290,"y":3620,"wires":[]},{"id":"a43159c7.39907","type":"function","z":"5df15275.2888ec","name":"set stop sell order","func":"//msg.curstop = Number(msg.bot.ttp.curstop);\n\nmsg.bot.ttp.quantity = msg.bot.ttp.quantity || 0;\n\nfunction parseApiError(error) {\n  if (error.body) {\n    try {\n      var resp = JSON.parse(error.body);\n      return resp.msg;\n    } catch (error) {/* pass thru */}\n  }\n  return \"Unknown error. Status code: \"+error.statsCode;\n}\n\nlet LBinance = global.get('gBinance');\n//node.warn(LBinance);\nlet key = global.get('key');\nlet secret = global.get('secret');\n\nlet binance = new LBinance().options({\n\tAPIKEY: key,\n\tAPISECRET: secret,\n\treconnect: false,\n\tuseServerTime: true\n});\n\nlet moneta = msg.bot.settings.moneta;\nlet quantity = (Number(msg.bot.ttp.quantity)).toFixed(msg.bot.settings.digitq);\n\nlet priceb = (Number((msg.bot.ttp.raschstopprice - msg.bot.ttp.raschstopprice / 100 * msg.bot.settings.ofsetbottom))).toFixed(msg.bot.settings.digitprice);\nlet stopprice = (Number(msg.bot.ttp.raschstopprice)).toFixed(msg.bot.settings.digitprice);\n\n\nnode.warn(\"q:\"+quantity);\nnode.warn(\"p:\"+priceb);\nnode.warn(\"sp:\"+stopprice);\nbinance.useServerTime(function() {\n binance.sell(moneta, quantity, priceb, { stopPrice: stopprice, type: \"STOP_LOSS_LIMIT\" }, function (err, resp) {\n          if (err) {\n            var errorMsg = parseApiError(err);\n            node.error(errorMsg, msg);\n            node.status({fill: \"red\", shape: \"ring\", text: errorMsg});\n             node.send(msg);\n            \n            \n          }\n          if (resp) {\n                        msg.bot.ttp.curorderid = resp.orderId;\n                        msg.bot.ttp.curstop = stopprice;\n                        msg.bot.ttp.quantity = quantity;\n                         node.send(msg);\n          }\n          node.status({}); //clear status message\n\n          \n         \n          //return;\n        })\n    \n});\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1330,"y":3820,"wires":[["5f4c791a.9861c"]],"inputLabels":["orderid, moneta"],"outputLabels":["status"],"icon":"font-awesome/fa-compress"},{"id":"26027bc2.33c794","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":610,"y":3920,"wires":[]},{"id":"5f4c791a.9861c","type":"function","z":"5df15275.2888ec","name":"setbot_ttp","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    \n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nmsg.topic = msg.bot.settings.userid+\"-bots:\"+msg.bot.settings.botname+\":ttp\";\n\nmsg.payload = JSON.stringify(msg.bot.ttp);\nconst upd = global.get('setbot_ttp')(msg.topic, msg.payload);\n\n\nupd.then(upd => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"}); \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1550,"y":3820,"wires":[["d547cd92.0c54d","9c79e520.9495b"]],"icon":"font-awesome/fa-bolt"},{"id":"dffed29e.b91ee","type":"function","z":"5df15275.2888ec","name":"setbot_ttp","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    \n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nmsg.topic = msg.bot.settings.userid+\"-bots:\"+msg.bot.settings.botname+\":ttp\";\n\nmsg.payload = JSON.stringify(msg.bot.ttp);\nconst upd = global.get('setbot_ttp')(msg.topic, msg.payload);\n\n\nupd.then(upd => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"}); \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2670,"y":3660,"wires":[["d4b57e1c.669fd8","6403f47f.b10c44"]],"icon":"font-awesome/fa-bolt"},{"id":"cd12e545.316a28","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1090,"y":4000,"wires":[]},{"id":"9c45c5de.720128","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2030,"y":4400,"wires":[]},{"id":"b8d94599.8e5b7","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1450,"y":4100,"wires":[]},{"id":"d547cd92.0c54d","type":"link out","z":"5df15275.2888ec","name":"заперещено закупать","links":["47e3fbaf.e02fb4","ab5cef16.762b3","fd4caf2b.2d9e58"],"x":1675,"y":3820,"wires":[]},{"id":"ebb62d38.7c53c8","type":"link out","z":"5df15275.2888ec","name":"заперещено закупать","links":["fd4caf2b.2d9e58"],"x":2115,"y":3760,"wires":[]},{"id":"d4b57e1c.669fd8","type":"link out","z":"5df15275.2888ec","name":"заперещено закупать","links":["fd4caf2b.2d9e58"],"x":2795,"y":3660,"wires":[]},{"id":"fd4caf2b.2d9e58","type":"link in","z":"5df15275.2888ec","name":"ttp-pilot-end","links":["6da07a32.a830d4","a527c2ac.97582","bf77a991.3bd89","d4b57e1c.669fd8","d547cd92.0c54d","ebb62d38.7c53c8","3a1dfbef.5e67ec","ba137d19.a93268","2343abca.a6e05c","172f6a3a.7a6aa6","5b3b6b9d.75f874","132b272b.6ab609","99ab4ba3.dc9ae8","dee7cce5.8e846","fbbe4d70.f0912"],"x":1655,"y":3240,"wires":[["6186089a.82589"]]},{"id":"6186089a.82589","type":"function","z":"5df15275.2888ec","name":"setbot_ttp_free","func":"\nmsg.topic = msg.bot.settings.userid+\"-bots:\"+msg.bot.settings.botname+\":ttp\";\nmsg.bot.ttp.ttpbusy = false;\nmsg.payload = JSON.stringify(msg.bot.ttp);\nconst upd = global.get('setbot_ttp')(msg.topic, msg.payload);\n\n\nupd.then(upd => {\n\n   \n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n\n    \n    node.status({fill:\"red\",shape:\"dot\"}); \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1800,"y":3240,"wires":[["9556b8a8.257798"]],"icon":"font-awesome/fa-bolt"},{"id":"eb783101.e13f08","type":"link in","z":"5df15275.2888ec","name":"","links":["f690c3ac.0028f8"],"x":175,"y":3860,"wires":[["fa6bf889.5a7bb8","21fd6400.791a5c"]]},{"id":"f7b6dbb5.36b318","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1930,"y":4140,"wires":[]},{"id":"9c1d60bc.9c10a","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":970,"y":3180,"wires":[]},{"id":"c0331d12.6a72c","type":"link out","z":"5df15275.2888ec","name":"","links":["e34a5b68.726ec8","e3e1e22a.f958b"],"x":2155,"y":2500,"wires":[]},{"id":"d79dfd2c.71bea8","type":"redis-instance","z":"5df15275.2888ec","server":"f120eab2.0a60a8","name":"","topic":"redis","location":"flow","x":1950,"y":240,"wires":[]},{"id":"8c661975.7e3eb","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2190,"y":4000,"wires":[]},{"id":"7b5bb07a.3966c8","type":"function","z":"5df15275.2888ec","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1850,"y":3960,"wires":[[]]},{"id":"f99e723c.db2d7","type":"function","z":"5df15275.2888ec","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2010,"y":3960,"wires":[[]]},{"id":"4d0eee3f.645d18","type":"function","z":"5df15275.2888ec","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2050,"y":4080,"wires":[[]]},{"id":"ba137d19.a93268","type":"link out","z":"5df15275.2888ec","name":"заперещено закупать","links":["47e3fbaf.e02fb4","ab5cef16.762b3","fd4caf2b.2d9e58"],"x":1695,"y":4300,"wires":[]},{"id":"ab47cdd8.3462a8","type":"function","z":"5df15275.2888ec","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1830,"y":4440,"wires":[[]]},{"id":"1cd4ec9e.a768bb","type":"function","z":"5df15275.2888ec","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1830,"y":4480,"wires":[[]]},{"id":"1c171f80.1804b9","type":"function","z":"5df15275.2888ec","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1090,"y":3740,"wires":[[]]},{"id":"3239545c.3e2e34","type":"function","z":"5df15275.2888ec","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1090,"y":4100,"wires":[[]]},{"id":"2343abca.a6e05c","type":"link out","z":"5df15275.2888ec","name":"заперещено закупать","links":["fd4caf2b.2d9e58"],"x":1815,"y":4040,"wires":[]},{"id":"28f62589.1de13a","type":"function","z":"5df15275.2888ec","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2190,"y":4300,"wires":[[]]},{"id":"f7d0483.943af38","type":"function","z":"5df15275.2888ec","name":"setbot_ttp","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    \n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nmsg.topic = msg.bot.settings.userid+\"-bots:\"+msg.bot.settings.botname+\":ttp\";\n\nmsg.payload = JSON.stringify(msg.bot.ttp);\nconst upd = global.get('setbot_ttp')(msg.topic, msg.payload);\n\n\nupd.then(upd => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"}); \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2910,"y":4480,"wires":[[]],"icon":"font-awesome/fa-bolt"},{"id":"52d3da5.b1dbaa4","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":670,"y":3340,"wires":[]},{"id":"e675297d.3373f8","type":"function","z":"5df15275.2888ec","name":"change floors, finance ","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nlet currentfloor = msg.bot.currentfloor;\ncurrentfloor[7] = 1;\ncurrentfloor[8] = msg.resp.orderId;\ncurrentfloor[14] = msg.resp.origQty;\n\nmsg.bot.floors[currentfloor[0]-1] = currentfloor;\n\nmsg.bot.finance.baseinorders = (Number(Number(msg.bot.finance.baseinorders) + Number(msg.resp.origQty) * Number(msg.resp.price))).toFixed(msg.bot.settings.digitprice);\nmsg.bot.finance.basenal = (Number(Number(msg.bot.finance.basenal) - Number(msg.resp.origQty) * Number(msg.resp.price))).toFixed(msg.bot.settings.digitprice);\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: currentfloor[0]});\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3300,"y":3940,"wires":[[]]},{"id":"9c79e520.9495b","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1590,"y":3780,"wires":[]},{"id":"6403f47f.b10c44","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2830,"y":3560,"wires":[]},{"id":"fefaf8d6.ad5958","type":"function","z":"5df15275.2888ec","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1190,"y":1760,"wires":[[]]},{"id":"317ffc4b.f9f944","type":"http in","z":"5df15275.2888ec","g":"8b69f61d.c89028","name":"","url":"/bot_delete","method":"post","upload":false,"swaggerDoc":"","x":4020,"y":80,"wires":[["70ea442f.d8d06c","35298c0e.de04e4"]]},{"id":"2da38506.59c15a","type":"redis-command","z":"5df15275.2888ec","g":"8b69f61d.c89028","server":"f120eab2.0a60a8","command":"hmset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4510,"y":80,"wires":[[]]},{"id":"cd9c83a2.b44c9","type":"function","z":"5df15275.2888ec","g":"8b69f61d.c89028","name":"prepare data for create bot","func":"msg.topic = msg.payload.user_id_from_google+\"-bots:\"+msg.payload.botname+\":data\";\nlet botdata = {\"finance\":msg.payload.finance,\"floors\":msg.payload.floors,\"sales\":msg.payload.sales};\nmsg.payload = botdata;\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4280,"y":80,"wires":[["2da38506.59c15a"]]},{"id":"98e142f2.2387b","type":"function","z":"5df15275.2888ec","g":"8b69f61d.c89028","name":"prepare for get botlist","func":"msg.botlistname = msg.payload.user_id_from_google+\"-botlist\";\nmsg.botname = msg.payload.botname;\nmsg.payload = msg.payload.user_id_from_google;\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4260,"y":140,"wires":[["9814b19b.3a9ff"]]},{"id":"9814b19b.3a9ff","type":"function","z":"5df15275.2888ec","g":"8b69f61d.c89028","name":"getbotlist","func":"\nlet guid = msg.payload;\n\nconst gbl = global.get('getbotlist')(guid);\n\ngbl.then(gbl => {\n    \n    msg.payload = JSON.parse(gbl);\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n    node.status({fill:\"red\",shape:\"dot\"});\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4460,"y":140,"wires":[["657e86cb.b16d68"]]},{"id":"657e86cb.b16d68","type":"function","z":"5df15275.2888ec","g":"8b69f61d.c89028","name":"prepare for add botlist","func":"msg.topic = msg.botlistname;\n\nlet newbotlist = [];\nif (msg.payload == null) {\n    newbotlist = [msg.botname];\n} else {\n    let oldbotlist = msg.payload;\n    newbotlist = [...oldbotlist,msg.botname];\n    }\n\nmsg.payload = JSON.stringify(newbotlist);\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4660,"y":140,"wires":[["e3789e7.ad48a6"]]},{"id":"e3789e7.ad48a6","type":"redis-command","z":"5df15275.2888ec","g":"8b69f61d.c89028","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4870,"y":140,"wires":[[]]},{"id":"70ea442f.d8d06c","type":"http response","z":"5df15275.2888ec","g":"8b69f61d.c89028","name":"","statusCode":"200","headers":{},"x":4040,"y":140,"wires":[]},{"id":"c6f7047b.a7d5b8","type":"function","z":"5df15275.2888ec","g":"8b69f61d.c89028","name":"prepare for add bot status","func":"msg.topic = msg.payload.user_id_from_google+\"-bots:\"+msg.payload.botname+\":status\";\nmsg.payload.status.updated = new Date().getTime();\nmsg.payload = msg.payload.status;\n\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4270,"y":200,"wires":[["b878da1d.130a08"]]},{"id":"b878da1d.130a08","type":"redis-command","z":"5df15275.2888ec","g":"8b69f61d.c89028","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4490,"y":200,"wires":[[]]},{"id":"1b8e9eca.e770e1","type":"function","z":"5df15275.2888ec","g":"8b69f61d.c89028","name":"prepare for add bot settings","func":"msg.topic = msg.payload.user_id_from_google+\"-bots:\"+msg.payload.botname+\":settings\";\n\nmsg.payload = msg.payload.settings;\n\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4280,"y":260,"wires":[["e7053289.ff4a1"]]},{"id":"e7053289.ff4a1","type":"redis-command","z":"5df15275.2888ec","g":"8b69f61d.c89028","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4510,"y":260,"wires":[[]]},{"id":"12823fc.46bb5c","type":"function","z":"5df15275.2888ec","g":"8b69f61d.c89028","name":"prepare for add bot ttp","func":"msg.topic = msg.payload.user_id_from_google+\"-bots:\"+msg.payload.botname+\":ttp\";\n\nmsg.payload = msg.payload.ttp;\n\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4260,"y":320,"wires":[["53c0296c.86d5e8"]]},{"id":"53c0296c.86d5e8","type":"redis-command","z":"5df15275.2888ec","g":"8b69f61d.c89028","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4470,"y":320,"wires":[[]]},{"id":"567ea009.d6895","type":"function","z":"5df15275.2888ec","g":"8b69f61d.c89028","name":"prepare for add bot onoff","func":"msg.topic = msg.payload.user_id_from_google+\"-bots:\"+msg.payload.botname+\":onoff\";\n\nmsg.payload = JSON.stringify(msg.payload.onoff);\n\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4270,"y":380,"wires":[["afeffd54.f2fdf"]]},{"id":"afeffd54.f2fdf","type":"redis-command","z":"5df15275.2888ec","g":"8b69f61d.c89028","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4470,"y":380,"wires":[[]]},{"id":"addf44a8.eeead8","type":"function","z":"5df15275.2888ec","g":"8b69f61d.c89028","name":"prepare for add bot busy","func":"msg.topic = msg.payload.user_id_from_google+\"-bots:\"+msg.payload.botname+\":busy\";\n\nmsg.payload = JSON.stringify(msg.payload.busy);\n\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4270,"y":440,"wires":[["38fa3076.5c174"]]},{"id":"38fa3076.5c174","type":"redis-command","z":"5df15275.2888ec","g":"8b69f61d.c89028","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4490,"y":440,"wires":[[]]},{"id":"51dac58a.ae1ccc","type":"function","z":"5df15275.2888ec","g":"8b69f61d.c89028","name":"prepare for start_set","func":"msg.topic = msg.payload.user_id_from_google+\"-bots:\"+msg.payload.botname+\":start_set\";\n\nmsg.payload = msg.payload.start_set;\n\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4260,"y":500,"wires":[["3b77b4a5.7373fc"]]},{"id":"3b77b4a5.7373fc","type":"redis-command","z":"5df15275.2888ec","g":"8b69f61d.c89028","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":4490,"y":500,"wires":[[]]},{"id":"35298c0e.de04e4","type":"debug","z":"5df15275.2888ec","g":"8b69f61d.c89028","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4010,"y":220,"wires":[]},{"id":"5f8da53c.1cd85c","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":170,"y":3360,"wires":[]},{"id":"49b11422.104a8c","type":"debug","z":"5df15275.2888ec","g":"5b21035.9c9f6fc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4590,"y":1520,"wires":[]},{"id":"94da8ee9.b72fe","type":"inject","z":"5df15275.2888ec","g":"814286d0.6067d8","name":"test","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":2710,"y":3240,"wires":[["bf51802f.063bd"]]},{"id":"bf51802f.063bd","type":"function","z":"5df15275.2888ec","g":"814286d0.6067d8","name":"","func":"msg.payload = [\"355\",\"356.3\",\"358\",\"360\"];\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2900,"y":3240,"wires":[["b7b9b18a.8dfb9"]]},{"id":"b7b9b18a.8dfb9","type":"split","z":"5df15275.2888ec","g":"814286d0.6067d8","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":3090,"y":3240,"wires":[["fded4c6c.fd4ec"]]},{"id":"fded4c6c.fd4ec","type":"delay","z":"5df15275.2888ec","g":"814286d0.6067d8","name":"","pauseType":"rate","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"2","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":3270,"y":3240,"wires":[["8cca2e22.fccc2"]]},{"id":"8cca2e22.fccc2","type":"function","z":"5df15275.2888ec","g":"814286d0.6067d8","name":"","func":"     msg.topic = \"prices:BNBUSDT\";\n\n    \nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3460,"y":3240,"wires":[["c6b1502f.7e4af"]]},{"id":"c9b54b0d.edb998","type":"debug","z":"5df15275.2888ec","g":"814286d0.6067d8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3900,"y":3240,"wires":[]},{"id":"cdb21624.aff3e8","type":"inject","z":"5df15275.2888ec","g":"814286d0.6067d8","name":"test","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":3300,"y":3320,"wires":[["62366394.d8c3cc"]]},{"id":"62366394.d8c3cc","type":"function","z":"5df15275.2888ec","g":"814286d0.6067d8","name":"","func":"msg.payload = \"355\";\nmsg.topic = \"prices:BNBUSDT\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3490,"y":3320,"wires":[["c6b1502f.7e4af"]]},{"id":"c6b1502f.7e4af","type":"redis-command","z":"5df15275.2888ec","g":"814286d0.6067d8","server":"f120eab2.0a60a8","command":"SET","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":3690,"y":3260,"wires":[["c9b54b0d.edb998"]]},{"id":"5a21956f.0a3dac","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3690,"y":2640,"wires":[]},{"id":"8847d1d6.5d69e","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1090,"y":3820,"wires":[]},{"id":"9d3988d2.118d58","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1950,"y":3640,"wires":[]},{"id":"65afe27.430071c","type":"function","z":"5df15275.2888ec","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1270,"y":3880,"wires":[[]]},{"id":"4287fbb4.86f9e4","type":"function","z":"5df15275.2888ec","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1270,"y":3660,"wires":[[]]},{"id":"ac5c2d29.8544f","type":"link in","z":"5df15275.2888ec","name":"","links":["258a6025.bcc3d","6f1b2478.7c43ac","10c52fed.06326","5c2f710c.b0c9d"],"x":355,"y":3360,"wires":[["6fc4c6e7.21c5f"]]},{"id":"f8c97ae2.2be2f8","type":"redis-command","z":"5df15275.2888ec","server":"f120eab2.0a60a8","command":"set","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1800,"y":100,"wires":[[]]},{"id":"6182b5a9.c0565c","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2550,"y":260,"wires":[]},{"id":"a3a3ff62.74a51","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2370,"y":2040,"wires":[]},{"id":"42ef8125.86f6c","type":"function","z":"5df15275.2888ec","name":"ttp finish","func":"msg.bot.ttp.raschstopprice = 0;\nmsg.bot.ttp.curstop = 0;\nmsg.bot.ttp.curorderid = 0;\nmsg.bot.ttp.quantity = 0;\nmsg.bot.ttp.ttpbusy = false;\nmsg.bot.ttp.sold = false;\n\nmsg.topic = msg.bot.settings.userid+\"-bots:\"+msg.bot.settings.botname+\":ttp\";\n\nmsg.payload = JSON.stringify(msg.bot.ttp);\nconst upd = global.get('setbot_ttp')(msg.topic, msg.payload);\n\n\nupd.then(upd => {\n\n    msg.topic = [];\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n\n\n    node.status({fill:\"red\",shape:\"dot\"}); \n    node.error(error);\n});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2780,"y":4360,"wires":[["79e153.b708aeac","5497402c.ad6ae","6f1b2478.7c43ac"]]},{"id":"79e153.b708aeac","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2790,"y":4320,"wires":[]},{"id":"5497402c.ad6ae","type":"redis-out","z":"5df15275.2888ec","server":"f120eab2.0a60a8","command":"publish","name":"","topic":"ttp-stop","obj":true,"x":2980,"y":4360,"wires":[]},{"id":"6f1b2478.7c43ac","type":"link out","z":"5df15275.2888ec","name":"заперещено закупать","links":["ac5c2d29.8544f"],"x":2995,"y":4280,"wires":[]},{"id":"40af92f7.07274c","type":"inject","z":"5df15275.2888ec","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":2860,"y":4420,"wires":[["5497402c.ad6ae"]]},{"id":"d27705fb.b4d258","type":"function","z":"5df15275.2888ec","name":"update bot floors, finance","func":"const sellprice = msg.bot.ttpprice\nlet comsa = Number(msg.payload);\nlet quantityall = msg.bot.ttp.quantity;\n\nnode.warn(\"finish ttp on floor \" + msg.bot.currentfloor[0]);\n\nlet tempfin = Number(Number(msg.bot.finance.quotainorders) - Number(msg.bot.ttp.quantity));\n\nlet tempfin2 = Number(Number(msg.bot.finance.basenal) + Number(msg.bot.ttp.quantity * Number(msg.payload)));\n\nmsg.bot.finance.quotainorders = tempfin.toFixed(msg.bot.settings.digitprice);\nmsg.bot.finance.basenal = tempfin2.toFixed(msg.bot.settings.digitq);\n\nif (msg.bot.finance.baseinorders == -0) { msg.bot.finance.baseinorders = 0; }\nif (msg.bot.finance.basenal == -0) { msg.bot.finance.basenal = 0; }\n\n \n\nlet currentfloor = msg.bot.currentfloor;\n\n//обнуление всех этажей со статусом 3\n\nvar floors = msg.bot.floors;\n\n    floors.forEach(function (item, i, floors) {\n\n        if (item[7] == 3) {\n            let buyprice = item[10];\n            let quantity = Number(item[14]);\n            //msg.bot.sales.today.push((sellprice-buyprice)*quantity);\n            \n            item[7] = 0;\n            item[8] = 0;\n            item[9] = 0;\n            item[10] = 0;\n            item[11] = 0;\n            item[12] = 0;\n            item[13] = 0;\n            item[14] = 0;\n        }\n\n\n    });\n\nmsg.bot.floors = floors;\n\n\nlet volname = msg.bot.settings.userid + \"-bots:\" + msg.botname + \":data\";\nlet botdata = {\n    \"finance\": JSON.stringify(msg.bot.finance),\n    \"floors\": JSON.stringify(msg.bot.floors),\n    \"sales\": JSON.stringify(msg.bot.sales)\n\n};\n\nconst upd = global.get('setbot_data')(volname, botdata);\n\nupd.then(upd => {\n\n    msg.payload = upd;\n\n\n    node.status({ fill: \"green\", shape: \"ring\", text: \"0k\" });\n\n    node.send(msg);\n\n}).catch(error => {\n\n\n    node.status({ fill: \"red\", shape: \"ring\", text: \"error\" });\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2570,"y":4360,"wires":[["a1b52467.3a3f38","42ef8125.86f6c"]],"icon":"font-awesome/fa-bolt"},{"id":"a1b52467.3a3f38","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2610,"y":4320,"wires":[]},{"id":"d9d63754.4e87c8","type":"function","z":"5df15275.2888ec","name":"prepare get ttp order price","func":"\n\nlet moneta = msg.bot.settings.moneta;\nlet orderid = msg.bot.ttp.curorderid;\n\nmsg.payload = [];\nmsg.topic = \"orders-status-\" + msg.bot.settings.userid + \":\" + moneta + \":\" + orderid + \"-price\";\n\n\n\n\nnode.status({fill: \"green\", shape: \"ring\", text: orderid});\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2440,"y":4200,"wires":[["ac60f1a8.5b5c4","3992297f.b5e466"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"ac60f1a8.5b5c4","type":"redis-command","z":"5df15275.2888ec","server":"f120eab2.0a60a8","command":"GET","name":"get order status","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":2700,"y":4200,"wires":[["2ea890b7.0e30e","e90cffd8.f90fb"]]},{"id":"2ea890b7.0e30e","type":"function","z":"5df15275.2888ec","name":"prepare get ttp order comsa","func":"msg.bot.ttpprice = msg.payload;\n\nlet moneta = msg.bot.settings.moneta;\nlet orderid = msg.bot.ttp.curorderid;\n\nmsg.payload = [];\nmsg.topic = \"orders-status-\" + msg.bot.settings.userid + \":\" + moneta + \":\" + orderid + \"-comsa\";\n\n\n\n\nnode.status({fill: \"green\", shape: \"ring\", text: orderid});\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2460,"y":4260,"wires":[["92f5dc20.e902c"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"92f5dc20.e902c","type":"redis-command","z":"5df15275.2888ec","server":"f120eab2.0a60a8","command":"GET","name":"get order status","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":2700,"y":4260,"wires":[["d27705fb.b4d258"]]},{"id":"3992297f.b5e466","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2510,"y":4160,"wires":[]},{"id":"e90cffd8.f90fb","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2730,"y":4160,"wires":[]},{"id":"acd920f8.e2633","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2570,"y":4440,"wires":[]},{"id":"10c52fed.06326","type":"link out","z":"5df15275.2888ec","name":"заперещено закупать","links":["ac5c2d29.8544f"],"x":2135,"y":3240,"wires":[]},{"id":"9556b8a8.257798","type":"switch","z":"5df15275.2888ec","name":"is sold ?","property":"bot.ttp.sold","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":2000,"y":3240,"wires":[["10c52fed.06326"],[]]},{"id":"eb6c36c7.d20ab8","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2510,"y":3620,"wires":[]},{"id":"cac10d2c.dddd8","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2934.28564453125,"y":761.4285888671875,"wires":[]},{"id":"35178afc.5ff306","type":"comment","z":"5df15275.2888ec","name":"Переделать на простое пополнение quntity","info":"","x":3010,"y":2820,"wires":[]},{"id":"ea81bdbd.c8cb8","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1750,"y":3640,"wires":[]},{"id":"8a3bbe0b.219b9","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2090,"y":3800,"wires":[]},{"id":"21bd8b10.ef6684","type":"function","z":"5df15275.2888ec","name":"get_ttp_q()","func":"","outputs":1,"noerr":0,"initialize":"let guid = global.get('guid');\n\n\nlet get_ttp_q = function (botname = msg.payload) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n\n    msg.topic = guid+\"-bots:\"+botname+\":ttpq\";\n    msg.payload = [];\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('get_ttp_q', get_ttp_q);","finalize":"","x":1070,"y":620,"wires":[["13a96a9c.9c1275"]]},{"id":"32d4b8b1.77def8","type":"inject","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"botname","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":900,"y":620,"wires":[["21bd8b10.ef6684"]]},{"id":"6caa2100.198ba","type":"function","z":"5df15275.2888ec","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":1460,"y":620,"wires":[]},{"id":"13a96a9c.9c1275","type":"redis-command","z":"5df15275.2888ec","server":"f120eab2.0a60a8","command":"GET","name":"get ttp q","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1280,"y":620,"wires":[["6caa2100.198ba"]]},{"id":"7b28a869.162e18","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"set_ttp_q()","func":"","outputs":1,"noerr":0,"initialize":"let guid = global.get('guid');\nlet set_ttp_q = function (botname = msg.topic, ttpq = msg.payload) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n\n    msg.topic = guid+\"-bots:\"+botname+\":ttpq\";\n    msg.payload = ttpq;\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('set_ttp_q', set_ttp_q);","finalize":"","x":1110,"y":680,"wires":[["5775cffa.8e5f8"]]},{"id":"4c173f0f.94538","type":"inject","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"botname, ttpq","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":920,"y":680,"wires":[["7b28a869.162e18"]]},{"id":"e7904fa1.77f64","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":1480,"y":680,"wires":[]},{"id":"5775cffa.8e5f8","type":"redis-command","z":"5df15275.2888ec","g":"c625f482.ef7058","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1290,"y":680,"wires":[["e7904fa1.77f64"]]},{"id":"adf2a298.2e768","type":"function","z":"5df15275.2888ec","name":"setbot_ttp_q","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    \n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nlet currentfloor = msg.bot.currentfloor;\nlet guid = global.get('guid');\n\nmsg.topic = guid+\"-bots:\"+botname+\":ttpq\";\nmsg.payload = JSON.stringify(currentfloor[14]);\n\nconst upd = global.get('set_ttp_q')(msg.topic, msg.payload);\n\nupd.then(upd => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"}); \n    node.error(error);\n    node.send(msg);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1650,"y":2720,"wires":[["265f010f.b71d0e"]],"icon":"font-awesome/fa-bolt"},{"id":"265f010f.b71d0e","type":"function","z":"5df15275.2888ec","name":"change floors, finance, ttp","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nnode.warn(\"start ttp on floor \"+msg.bot.currentfloor[0]);     \n\nlet tempfin = Number(Number(msg.bot.finance.quotainorders) + Number(msg.bot.currentfloor[14]));\n\nlet tempfin2 = Number(Number(msg.bot.finance.quotanal) - Number(msg.bot.currentfloor[14]));\n\nmsg.bot.finance.quotainorders = tempfin.toFixed(msg.bot.settings.digitprice);\nmsg.bot.finance.quotanal = tempfin2.toFixed(msg.bot.settings.digitq);\n\nif (msg.bot.finance.baseinorders == -0) {msg.bot.finance.baseinorders = 0;}\nif (msg.bot.finance.basenal == -0) {msg.bot.finance.basenal = 0;}\n\nlet currentfloor = msg.bot.currentfloor;\ncurrentfloor[7] = 3;\n\n\nmsg.bot.floors[currentfloor[0]-1] = currentfloor;\n\n\n\n//>трекер>\n    let end_node_time = new Date().getTime();\n    let duration = end_node_time - start_node_time;\n    let duration_step = end_node_time - last_node_end_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration_node\": duration,\n        \"duration_step\": duration_step\n    });\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: start_node_time});\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1870,"y":2720,"wires":[["ff787c55.b3b9e"]]},{"id":"8f71fdf8.2081f","type":"link out","z":"5df15275.2888ec","name":"","links":["e34a5b68.726ec8","e3e1e22a.f958b"],"x":2215,"y":2680,"wires":[]},{"id":"ff787c55.b3b9e","type":"function","z":"5df15275.2888ec","name":"setbot_data","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nlet volname = msg.bot.settings.userid+\"-bots:\"+msg.botname+\":data\";\nlet botdata = {\n    \"finance\":JSON.stringify(msg.bot.finance),\n    \"floors\":JSON.stringify(msg.bot.floors),\n    \"sales\":JSON.stringify(msg.bot.sales)\n    \n};\n\nconst upd = global.get('setbot_data')(volname, botdata);\n\nupd.then(upd => {\n    \n    msg.payload = upd;\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill: \"green\", shape: \"ring\", text: start_node_time});\n    \n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill: \"red\", shape: \"ring\", text: \"error\"});\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2090,"y":2720,"wires":[["8f71fdf8.2081f"]],"icon":"font-awesome/fa-bolt"},{"id":"8cc08f5b.14782","type":"function","z":"2a761808.610238","name":"duration","func":"\nlet track = flow.get(\"track\");\n\nlet laststep = track[track.length-1];\nlet firststep = track[0];\nlet last_node_end_time = laststep.end_node_time;\nlet first_node_start_time = firststep.start_node_time;\n\nlet duration = last_node_end_time - first_node_start_time;\n//node.warn(duration);\nmsg.payload = duration;\n    \nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3260,"y":360,"wires":[["96646ac9.fc77d8","60eb6ef5.3e20b"]]},{"id":"96646ac9.fc77d8","type":"debug","z":"2a761808.610238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":3430,"y":400,"wires":[]},{"id":"60eb6ef5.3e20b","type":"ui_chart","z":"2a761808.610238","name":"","group":"f244fee6.d2627","order":0,"width":"6","height":"4","label":"chart1","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"cubic","nodata":"","dot":true,"ymin":"","ymax":"","removeOlder":"10","removeOlderPoints":"40","removeOlderUnit":"1","cutout":0,"useOneColor":false,"useUTC":true,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9a244f","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":3410,"y":360,"wires":[[]]},{"id":"9f535577.3cdc98","type":"debug","z":"2a761808.610238","g":"c7dcb289.e5232","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3030,"y":380,"wires":[]},{"id":"203e6ef2.430c62","type":"comment","z":"2a761808.610238","g":"c7dcb289.e5232","name":"Финиш трека. Семафор = \"Свободно\"","info":"","x":3000,"y":260,"wires":[]},{"id":"26cad534.28973a","type":"function","z":"2a761808.610238","g":"c7dcb289.e5232","name":"setttp_free","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n    \n    let firststep = track[0];\n    let first_node_start_time = firststep.start_node_time;\n    \n    let duration_track = last_node_end_time - first_node_start_time;\n//>трекер>\n\nconst upd = global.get('setttp_free')(msg.botname);\n\nupd.then(upd => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_track //только для финишной ноды\n        });\n        flow.set(\"track\", track);\n        \n        flow.set(msg.botname, 0);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    \n    node.send(msg);\n\n}).catch(error => {\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"});\n\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3010,"y":320,"wires":[["9f535577.3cdc98","8cc08f5b.14782"]],"icon":"font-awesome/fa-bolt"},{"id":"d4c6b3ea.b0118","type":"comment","z":"2a761808.610238","g":"74e1a04.6df746","name":"Старт трека","info":"","x":190,"y":280,"wires":[]},{"id":"a0ad9ee6.aa105","type":"trigger","z":"2a761808.610238","g":"74e1a04.6df746","name":"","op1":"1","op2":"0","op1type":"str","op2type":"str","duration":"-250","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":540,"y":340,"wires":[["2e524180.ede67e"]]},{"id":"4c9d9272.a06d2c","type":"delay","z":"2a761808.610238","g":"74e1a04.6df746","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":320,"y":340,"wires":[["a0ad9ee6.aa105"]]},{"id":"ddf77463.b02678","type":"function","z":"2a761808.610238","g":"74e1a04.6df746","name":"stop","func":"msg.reset = true;\nmsg.payload = \"\";\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":310,"y":400,"wires":[["a0ad9ee6.aa105"]]},{"id":"599eef92.8ee31","type":"redis-in","z":"2a761808.610238","g":"74e1a04.6df746","server":"f120eab2.0a60a8","command":"subscribe","name":"","topic":"stop","obj":true,"timeout":0,"x":170,"y":400,"wires":[["ddf77463.b02678"]]},{"id":"77f17fe7.b95ae","type":"function","z":"2a761808.610238","g":"74e1a04.6df746","name":"start","func":"//<трекер<\n    ////>только для стартовой ноды>\n        var track = [];\n        let start_track_time = new Date().getTime();\n        let start_node_time = start_track_time;\n        let steptitle = node.name;\n    ////>только для стартовой ноды>\n//>трекер>\n\n\n\nmsg.payload = global.get('guid');\n\n\n//>трекер>\n    let end_node_time = new Date().getTime();\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration_node\": duration,\n        \"duration_step\": 0\n    });\n\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({ fill: \"green\", shape: \"ring\", text: duration });\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":730,"y":280,"wires":[["da5d3bc9.d65b18"]]},{"id":"799698b0.78a948","type":"redis-in","z":"2a761808.610238","g":"74e1a04.6df746","server":"f120eab2.0a60a8","command":"subscribe","name":"","topic":"start","obj":true,"timeout":0,"x":170,"y":340,"wires":[["4c9d9272.a06d2c"]]},{"id":"fe8b13e1.db5bf","type":"redis-in","z":"2a761808.610238","g":"74e1a04.6df746","server":"f120eab2.0a60a8","command":"subscribe","name":"","topic":"start1","obj":true,"timeout":0,"x":590,"y":280,"wires":[["77f17fe7.b95ae"]]},{"id":"10d73930.850c67","type":"comment","z":"2a761808.610238","g":"74e1a04.6df746","name":"Семафор = \"Занято\"","info":"","x":2220,"y":260,"wires":[]},{"id":"2e524180.ede67e","type":"function","z":"2a761808.610238","g":"74e1a04.6df746","name":"start","func":"//<трекер<\n    ////>только для стартовой ноды>\n        var track = [];\n        let start_track_time = new Date().getTime();\n        let start_node_time = start_track_time;\n        let steptitle = node.name;\n    ////>только для стартовой ноды>\n//>трекер>\n\n\n\nmsg.payload = global.get('guid');\n\n\n//>трекер>\n    let end_node_time = new Date().getTime();\n    let duration = end_node_time - start_node_time;\n    track.push({\n        \"steptitle\": steptitle,\n        \"start_node_time\": start_node_time,\n        \"end_node_time\": end_node_time,\n        \"duration_node\": duration,\n        \"duration_step\": 0\n    });\n\n    flow.set(\"track\", track);\n//>трекер>\nnode.status({ fill: \"green\", shape: \"ring\", text: duration });\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":730,"y":340,"wires":[["da5d3bc9.d65b18"]]},{"id":"da5d3bc9.d65b18","type":"function","z":"2a761808.610238","g":"74e1a04.6df746","name":"getbotlist","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[0];\n\n    let last_node_end_time = laststep.end_node_time;\n\n//>трекер>\n\nlet guid = msg.payload;\n\nconst gbl = global.get('getbotlist')(guid);\n\ngbl.then(gbl => {\n    \n    msg.payload = gbl;\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"});\n    \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":880,"y":340,"wires":[["461d3964.de54f8","7e462ed6.19cfd"]]},{"id":"461d3964.de54f8","type":"json","z":"2a761808.610238","g":"74e1a04.6df746","name":"","property":"payload","action":"obj","pretty":false,"x":1030,"y":340,"wires":[["5b61698e.e6e8b8"]]},{"id":"5b61698e.e6e8b8","type":"split","z":"2a761808.610238","g":"74e1a04.6df746","name":"","splt":"1","spltType":"len","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1170,"y":340,"wires":[["f18cbfd9.f0367","c0f1d50f.14d058"]]},{"id":"f18cbfd9.f0367","type":"function","z":"2a761808.610238","g":"74e1a04.6df746","name":"getbot_onoff","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nlet botname = msg.payload;\nmsg.botname = botname;\n\nconst gb = global.get('getbot_onoff')(botname);\n\ngb.then(gb => {\n    \n    msg.payload = JSON.parse(gb);\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    \n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"});\n    \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1310,"y":340,"wires":[["3d559730.32d2c8","c863368d.dbc0e8"]]},{"id":"3d559730.32d2c8","type":"filter","z":"2a761808.610238","g":"74e1a04.6df746","name":"filter off","property":"payload","propertyType":"msg","asArray":false,"itemProperty":"","itemPropertyType":"item","rules":[{"t":"true","output":1}],"checkall":"true","outputs":1,"x":1480,"y":340,"wires":[["f347b3fa.86c68"]]},{"id":"f347b3fa.86c68","type":"function","z":"2a761808.610238","g":"74e1a04.6df746","name":"get_ttp_q","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nconst gb = global.get('get_ttp_q')(msg.botname);\n\ngb.then(gb => {\n    \n    msg.ttpq = JSON.parse(gb) || 0;\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    \n    \n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"});\n    \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1640,"y":340,"wires":[["3c03470a.507ec8"]]},{"id":"e7cd9c55.03487","type":"function","z":"2a761808.610238","g":"74e1a04.6df746","name":"busy === false ","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nif (msg.payload === false) {\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    \n    return [msg, null];\n}\n\nelse {\n\n    let id = msg.botname;\n    msg.payload = [];\n\n    var count = flow.get(id) || 0;\n    count += 1;\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"blue\",shape:\"dot\"});\n\n\n    if (count > 4) {\n        const upd = global.get('setttp_free')(id);\n\n        upd.then(upd => {\n            \n            //>трекер>\n                let end_node_time = new Date().getTime();\n                let duration = end_node_time - start_node_time;\n                let duration_step = end_node_time - last_node_end_time;\n                track.push({\n                    \"steptitle\": steptitle+\"-reset\",\n                    \"start_node_time\": start_node_time,\n                    \"end_node_time\": end_node_time,\n                    \"duration\": duration,\n                    \"duration_step\": duration_step,\n                });\n                flow.set(\"track\", track);\n            //>трекер>\n            node.status({fill:\"red\",shape:\"dot\"});\n            \n            flow.set(id, 0);\n            node.warn(\"reset busy:\" + id);\n\n        }).catch(error => {\n            node.error(error);\n        });\n\n    }\n    flow.set(id, count);\n    return [null, msg];\n}\n\n\n\n\n\n","outputs":2,"noerr":0,"initialize":"","finalize":"","x":2000,"y":340,"wires":[["3e882d4e.c91df2"],["8ff82160.e2aa7"]],"icon":"font-awesome/fa-bolt"},{"id":"7e462ed6.19cfd","type":"debug","z":"2a761808.610238","g":"74e1a04.6df746","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":970,"y":280,"wires":[]},{"id":"3e882d4e.c91df2","type":"function","z":"2a761808.610238","g":"74e1a04.6df746","name":"setttp_busy","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nconst upd = global.get('setttp_busy')(msg.botname);\n\nupd.then(upd => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    \n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"});\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2210,"y":340,"wires":[["1494284.0d799d8","14218f4f.622ba1","ccbca6c6.392f58"]],"icon":"font-awesome/fa-bolt"},{"id":"1494284.0d799d8","type":"debug","z":"2a761808.610238","g":"74e1a04.6df746","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2230,"y":300,"wires":[]},{"id":"8ff82160.e2aa7","type":"debug","z":"2a761808.610238","g":"74e1a04.6df746","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2090,"y":400,"wires":[]},{"id":"c863368d.dbc0e8","type":"debug","z":"2a761808.610238","g":"74e1a04.6df746","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1410,"y":260,"wires":[]},{"id":"c0f1d50f.14d058","type":"debug","z":"2a761808.610238","g":"74e1a04.6df746","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1270,"y":260,"wires":[]},{"id":"ad12b785.28a248","type":"function","z":"5df15275.2888ec","name":"getttp_busy()","func":"","outputs":1,"noerr":0,"initialize":"let guid = global.get('guid');\n\n\nlet getttp_busy = function (botname = msg.payload) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n\n    msg.topic = guid+\"-bots:\"+botname+\":ttpbusy\";\n    msg.payload = [];\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('getttp_busy', getttp_busy);","finalize":"","x":310,"y":620,"wires":[["1fbec662.47207a"]]},{"id":"c71e397c.950708","type":"inject","z":"5df15275.2888ec","name":"botname","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":140,"y":620,"wires":[["ad12b785.28a248"]]},{"id":"e8138704.566608","type":"function","z":"5df15275.2888ec","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":700,"y":620,"wires":[]},{"id":"1fbec662.47207a","type":"redis-command","z":"5df15275.2888ec","server":"f120eab2.0a60a8","command":"GET","name":"get ttp busy","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":510,"y":620,"wires":[["e8138704.566608"]]},{"id":"f99b5c1c.7331f","type":"function","z":"5df15275.2888ec","name":"setttp_busy()","func":"","outputs":1,"noerr":0,"initialize":"let guid = global.get('guid');\n\nlet setttp_busy = function (botname = msg.topic) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n     msg.topic = guid+\"-bots:\"+botname+\":ttpbusy\";\n    msg.payload = \"true\";\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('setttp_busy', setttp_busy);","finalize":"","x":310,"y":680,"wires":[["aab0c85.ef39438"]]},{"id":"3aeb9fba.62023","type":"inject","z":"5df15275.2888ec","name":"botname","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":140,"y":680,"wires":[["f99b5c1c.7331f"]]},{"id":"723c4563.27929c","type":"function","z":"5df15275.2888ec","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":700,"y":680,"wires":[]},{"id":"aab0c85.ef39438","type":"redis-command","z":"5df15275.2888ec","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":510,"y":680,"wires":[["723c4563.27929c"]]},{"id":"25e06abb.c85db6","type":"function","z":"5df15275.2888ec","name":"setttp_free()","func":"","outputs":1,"noerr":0,"initialize":"let guid = global.get('guid');\n\nlet setttp_free = function (botname = msg.topic) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n    msg.topic = guid+\"-bots:\"+botname+\":ttpbusy\";\n    msg.payload = \"false\";\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('setttp_free', setttp_free);","finalize":"","x":310,"y":740,"wires":[["9645aa68.b48878"]]},{"id":"89e6754d.d02338","type":"inject","z":"5df15275.2888ec","name":"botname","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":140,"y":740,"wires":[["25e06abb.c85db6"]]},{"id":"2b86e90f.d5bac6","type":"function","z":"5df15275.2888ec","g":"c625f482.ef7058","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":700,"y":740,"wires":[]},{"id":"9645aa68.b48878","type":"redis-command","z":"5df15275.2888ec","server":"f120eab2.0a60a8","command":"getset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":510,"y":740,"wires":[["2b86e90f.d5bac6"]]},{"id":"ccd55cdb.7ed72","type":"link in","z":"2a761808.610238","name":"","links":["6686db1e.4b1904","1cd1edd3.c1f1d2","c5493216.68ad1","4dfef6b5.251a18","1d26132c.06016d","b0d5adc0.69eab","4b4fa1ce.2d444","bcd1d88e.da80d8","db26ef3b.7f5f6"],"x":2775,"y":320,"wires":[["26cad534.28973a","e890ca44.273da8"]]},{"id":"14218f4f.622ba1","type":"link out","z":"2a761808.610238","name":"","links":["e9ac4d38.5faef","e84c68c5.b035e8"],"x":2375,"y":320,"wires":[]},{"id":"3c03470a.507ec8","type":"function","z":"2a761808.610238","g":"74e1a04.6df746","name":"getttp_busy","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nconst gb = global.get('getttp_busy')(msg.botname);\n\ngb.then(gb => {\n    \n    msg.payload = JSON.parse(gb);\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    \n    \n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"});\n    \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1810,"y":340,"wires":[["e7cd9c55.03487"]]},{"id":"6ae38ed.612797","type":"inject","z":"2a761808.610238","g":"115b1d61.ba4ba3","name":" stop","props":[{"p":"payload"},{"p":"reset","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":610,"y":100,"wires":[["9539cd06.048d1"]]},{"id":"9539cd06.048d1","type":"redis-out","z":"2a761808.610238","g":"115b1d61.ba4ba3","server":"f120eab2.0a60a8","command":"publish","name":"","topic":"stop","obj":false,"x":610,"y":140,"wires":[]},{"id":"61edcde5.92f5f4","type":"inject","z":"2a761808.610238","g":"115b1d61.ba4ba3","name":"start","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":190,"y":100,"wires":[["4ea4b575.92fb0c"]]},{"id":"4ea4b575.92fb0c","type":"redis-out","z":"2a761808.610238","g":"115b1d61.ba4ba3","server":"f120eab2.0a60a8","command":"publish","name":"","topic":"start","obj":false,"x":190,"y":140,"wires":[]},{"id":"8d2ce50.2e70018","type":"inject","z":"2a761808.610238","g":"115b1d61.ba4ba3","name":"start1","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":370,"y":100,"wires":[["bdd4eff7.879af"]]},{"id":"bdd4eff7.879af","type":"redis-out","z":"2a761808.610238","g":"115b1d61.ba4ba3","server":"f120eab2.0a60a8","command":"publish","name":"","topic":"start1","obj":false,"x":370,"y":140,"wires":[]},{"id":"dfef6495.a62e98","type":"debug","z":"2a761808.610238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":70,"y":900,"wires":[]},{"id":"8cc76823.4b4e68","type":"function","z":"2a761808.610238","name":"getprice","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nlet moneta = msg.bot.settings.moneta;\n\nconst gp = global.get('getprice')(moneta);\n\ngp.then(gp => {\n    \n    msg.bot.ttp.currentprice = gp;\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"});\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":740,"y":940,"wires":[["a8b94df7.7a189","62c4398c.2e9318"]]},{"id":"a8b94df7.7a189","type":"debug","z":"2a761808.610238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":890,"y":900,"wires":[]},{"id":"fb58c58.87c1938","type":"comment","z":"2a761808.610238","name":"ситуация","info":"когда stopsell частично заполнился, но потом цена отросла и бот хочет подвинуть ордер дальше вверх. \nПроблема будет если остаток меньше минимума лота.\nСейчас такой ордер мы просто оставляем висеть до заполненности.\nМожно пока в телеграмм о таких случаях стучать, чтобы хозяин вручную разруливал, но по уму надо двигать ордер, на ходу меняя quantity с соответствующей проекцией во floors","x":3040,"y":880,"wires":[]},{"id":"62c4398c.2e9318","type":"function","z":"2a761808.610238","name":"calculate stop price and quantity","func":"\nlet currentprice = Number(msg.bot.ttp.currentprice);\nmsg.bot.ttp.raschstopprice = Number(Number(currentprice - currentprice / 100 * msg.bot.settings.ofsettop).toFixed(msg.bot.settings.digitprice));\nmsg.bot.ttp.curstop = Number(msg.bot.ttp.curstop || 0);\nmsg.bot.ttp.curorderid = Number(msg.bot.ttp.curorderid);\n\n\nmsg.bot.ttp.quantity = Number(msg.bot.ttp.quantity) + Number(msg.ttpq);\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":980,"y":940,"wires":[["3cfe83ca.3b1c1c","2f9f396e.884876"]]},{"id":"d9cd8b69.9e4298","type":"switch","z":"2a761808.610238","name":"raschstopprice ? curstop","property":"bot.ttp.raschstopprice","propertyType":"msg","rules":[{"t":"gt","v":"bot.ttp.curstop","vt":"msg"},{"t":"lte","v":"bot.ttp.curstop","vt":"msg"}],"checkall":"true","repair":false,"outputs":2,"x":1570,"y":940,"wires":[["75de299e.39af68","d398ced9.86c84","d36ac308.31104"],["22ce871e.981968","d74f254.44f36d8","905085d1.c19a78"]]},{"id":"75de299e.39af68","type":"switch","z":"2a761808.610238","name":"order id > 0 ","property":"bot.ttp.curorderid","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1950,"y":900,"wires":[["dbc40df.8fc84f","bbbe9e0c.c04c3"],["b63e592d.fd0258","459d38de.8e8938"]]},{"id":"22ce871e.981968","type":"function","z":"2a761808.610238","name":"prepare get ttp order status","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nlet moneta = msg.bot.settings.moneta;\nlet orderid = msg.bot.ttp.curorderid;\n\nmsg.payload = [];\nmsg.topic = \"orders-status-\" + msg.bot.settings.userid + \":\" + moneta + \":\" + orderid;\n\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: orderid});\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1940,"y":1520,"wires":[["222120eb.412ab"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"222120eb.412ab","type":"redis-command","z":"2a761808.610238","server":"f120eab2.0a60a8","command":"GET","name":"get order status","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":2180,"y":1520,"wires":[["d1ff77a2.4fa0d8","dd2eff30.71a16"]]},{"id":"d1ff77a2.4fa0d8","type":"switch","z":"2a761808.610238","name":"статус ордера","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"NEW","vt":"str"},{"t":"eq","v":"PARTIALLY_FILLED","vt":"str"},{"t":"eq","v":"CANCELED","vt":"str"},{"t":"eq","v":"FILLED","vt":"str"},{"t":"eq","v":"REJECTED","vt":"str"},{"t":"eq","v":"EXPIRED","vt":"str"}],"checkall":"true","repair":false,"outputs":6,"x":2400,"y":1520,"wires":[["20812514.c92caa","74f15325.97e54c","1d26132c.06016d"],["f6187d73.04a34","1d26132c.06016d"],["dde31f58.2a26c","5a4951b1.e634","b0d5adc0.69eab"],["b5bd6f90.f563b","427396ec.791098"],["487d47c0.c7ede8","14552322.e3a2fd","4b4fa1ce.2d444"],["487d47c0.c7ede8","4b4fa1ce.2d444"]]},{"id":"4534916e.904b6","type":"comment","z":"2a761808.610238","name":"NEW","info":"","x":2630,"y":1380,"wires":[]},{"id":"587bbf9a.07aa8","type":"comment","z":"2a761808.610238","name":"CANCELED","info":"","x":2850,"y":1520,"wires":[]},{"id":"f4e2a24.f2c696","type":"comment","z":"2a761808.610238","name":"FILLED","info":"","x":2630,"y":1580,"wires":[]},{"id":"cb0cab38.a71d88","type":"comment","z":"2a761808.610238","name":"REJECTED или EXPIRED","info":"","x":2690,"y":1720,"wires":[]},{"id":"b6e46ae5.962f68","type":"comment","z":"2a761808.610238","name":"PARTIALLY_FILLED","info":"","x":2790,"y":1380,"wires":[]},{"id":"b5bd6f90.f563b","type":"function","z":"2a761808.610238","name":"set sold","func":"msg.bot.ttp.sold = true;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2820,"y":1580,"wires":[["be5acd7a.49384","10bdbcf7.95c573","e4485160.d6d2d"]]},{"id":"be5acd7a.49384","type":"debug","z":"2a761808.610238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2990,"y":1620,"wires":[]},{"id":"20812514.c92caa","type":"debug","z":"2a761808.610238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2630,"y":1300,"wires":[]},{"id":"427396ec.791098","type":"debug","z":"2a761808.610238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2810,"y":1640,"wires":[]},{"id":"dbc40df.8fc84f","type":"function","z":"2a761808.610238","name":"prepare get ttp order status","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nlet moneta = msg.bot.settings.moneta;\nlet orderid = msg.bot.ttp.curorderid;\n\nmsg.payload = [];\nmsg.topic = \"orders-status-\" + msg.bot.settings.userid + \":\" + moneta + \":\" + orderid;\n\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: orderid});\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2200,"y":840,"wires":[["b42c0df8.13cc3"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"b42c0df8.13cc3","type":"redis-command","z":"2a761808.610238","server":"f120eab2.0a60a8","command":"GET","name":"get order status","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":2420,"y":840,"wires":[["e21a46d3.0d0cd8","8c006fac.a924"]]},{"id":"3f419d0e.63d7e2","type":"switch","z":"2a761808.610238","name":"status NEW ?","property":"payload","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":2780,"y":840,"wires":[["4e9b52a8.6339fc"],["3b67ca17.09d026","c5493216.68ad1"]]},{"id":"e21a46d3.0d0cd8","type":"function","z":"2a761808.610238","name":"prepare data","func":"if (msg.payload == \"NEW\") {\n    msg.payload = true;\n}\nelse {\n    msg.payload = false;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2610,"y":840,"wires":[["3f419d0e.63d7e2","f81dfd6c.f5b49"]]},{"id":"ff59f044.05302","type":"function","z":"2a761808.610238","name":"set stop sell order","func":"//msg.curstop = Number(msg.bot.ttp.curstop);\n\nmsg.bot.ttp.quantity = msg.bot.ttp.quantity || 0;\n\nfunction parseApiError(error) {\n  if (error.body) {\n    try {\n      var resp = JSON.parse(error.body);\n      return resp.msg;\n    } catch (error) {/* pass thru */}\n  }\n  return \"Unknown error. Status code: \"+error.statsCode;\n}\n\nlet LBinance = global.get('gBinance');\n//node.warn(LBinance);\nlet key = global.get('key');\nlet secret = global.get('secret');\n\nlet binance = new LBinance().options({\n\tAPIKEY: key,\n\tAPISECRET: secret,\n\treconnect: false,\n\tuseServerTime: true\n});\n\nlet moneta = msg.bot.settings.moneta;\nlet quantity = (Number(msg.bot.ttp.quantity)).toFixed(msg.bot.settings.digitq);\n\nlet priceb = (Number((msg.bot.ttp.raschstopprice - msg.bot.ttp.raschstopprice / 100 * msg.bot.settings.ofsetbottom))).toFixed(msg.bot.settings.digitprice);\nlet stopprice = (Number(msg.bot.ttp.raschstopprice)).toFixed(msg.bot.settings.digitprice);\n\n\nnode.warn(\"q:\"+quantity);\nnode.warn(\"p:\"+priceb);\nnode.warn(\"sp:\"+stopprice);\nbinance.useServerTime(function() {\n binance.sell(moneta, quantity, priceb, { stopPrice: stopprice, type: \"STOP_LOSS_LIMIT\" }, function (err, resp) {\n          if (err) {\n            var errorMsg = parseApiError(err);\n            node.error(errorMsg, msg);\n            node.status({fill: \"red\", shape: \"ring\", text: errorMsg});\n            node.send(msg);\n            \n            \n          }\n          if (resp) {\n                        msg.bot.ttp.curorderid = resp.orderId;\n                        msg.bot.ttp.curstop = stopprice;\n                        msg.bot.ttp.quantity = quantity;\n                        node.send(msg);\n          }\n          node.status({}); //clear status message\n\n          \n          \n          //return;\n        })\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3310,"y":780,"wires":[["a501d430.a110d8","bc452645.1f3798"]],"inputLabels":["orderid, moneta"],"outputLabels":["status"],"icon":"font-awesome/fa-compress"},{"id":"4e9b52a8.6339fc","type":"function","z":"2a761808.610238","name":"cancel stopsell order if exist","func":"\nfunction parseApiError(error) {\n  if (error.body) {\n    try {\n      var resp = JSON.parse(error.body);\n      return resp.msg;\n    } catch (error) {/* pass thru */}\n  }\n  return \"Unknown error. Status code: \"+error.statsCode;\n}\n\nlet LBinance = global.get('gBinance');\n//node.warn(LBinance);\nlet key = global.get('key');\nlet secret = global.get('secret');\n\nlet binance = new LBinance().options({\n\tAPIKEY: key,\n\tAPISECRET: secret,\n\treconnect: false,\n\tuseServerTime: true\n});\n\nlet moneta = msg.bot.settings.moneta;\nlet orderid = msg.bot.ttp.curorderid;\n\n//msg.payload = \"qjson.status\";\n\nbinance.useServerTime(function() {\n    binance.cancel(moneta, orderid, (err, resp) => {\n     // console.info(\"Limit Buy response\", response);\n     // console.info(\"order id: \" + response.orderId);\n        if (err) {\n            var errorMsg = parseApiError(err) + \", moneta:\" + moneta;\n            node.error(errorMsg, msg);\n            node.status({fill: \"red\", shape: \"ring\", text: errorMsg});\n            \n            \n            \n            node.send(msg);\n            // ;\n        \n        }\n        if (resp) {\n            //msg.orderid = resp.orderId;\n            msg.resp = resp;\n            node.status({fill: \"green\", shape: \"ring\"});\n            \n            \n            let tempfin = Number(Number(msg.bot.finance.baseinorders) - Number(msg.bot.status.currentfloor[14])*Number(msg.bot.status.currentfloor[3]));\n            let tempfin2 = Number(Number(msg.bot.finance.basenal) + Number(msg.bot.status.currentfloor[14])*Number(msg.bot.status.currentfloor[3]));\n            \n            msg.bot.finance.baseinorders = tempfin.toFixed(msg.bot.settings.digitprice);\n            msg.bot.finance.basenal = tempfin2.toFixed(msg.bot.settings.digitprice);\n            \n            \n            node.send(msg);\n            //return [null,msg];\n                    \n        }\n        //node.status({}); //clear status message\n    })\n});\n\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3060,"y":780,"wires":[["ff59f044.05302","6e7cbbc0.0e0694"]]},{"id":"6e7cbbc0.0e0694","type":"debug","z":"2a761808.610238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3130,"y":740,"wires":[]},{"id":"b63e592d.fd0258","type":"function","z":"2a761808.610238","name":"set stop sell order","func":"//msg.curstop = Number(msg.bot.ttp.curstop);\n\nmsg.bot.ttp.quantity = msg.bot.ttp.quantity || 0;\n\nfunction parseApiError(error) {\n  if (error.body) {\n    try {\n      var resp = JSON.parse(error.body);\n      return resp.msg;\n    } catch (error) {/* pass thru */}\n  }\n  return \"Unknown error. Status code: \"+error.statsCode;\n}\n\nlet LBinance = global.get('gBinance');\n//node.warn(LBinance);\nlet key = global.get('key');\nlet secret = global.get('secret');\n\nlet binance = new LBinance().options({\n\tAPIKEY: key,\n\tAPISECRET: secret,\n\treconnect: false,\n\tuseServerTime: true\n});\n\nlet moneta = msg.bot.settings.moneta;\nlet quantity = (Number(msg.bot.ttp.quantity)).toFixed(msg.bot.settings.digitq);\n\nlet priceb = (Number((msg.bot.ttp.raschstopprice - msg.bot.ttp.raschstopprice / 100 * msg.bot.settings.ofsetbottom))).toFixed(msg.bot.settings.digitprice);\nlet stopprice = (Number(msg.bot.ttp.raschstopprice)).toFixed(msg.bot.settings.digitprice);\n\n\nnode.warn(\"q:\"+quantity);\nnode.warn(\"p:\"+priceb);\nnode.warn(\"sp:\"+stopprice);\nbinance.useServerTime(function() {\n binance.sell(moneta, quantity, priceb, { stopPrice: stopprice, type: \"STOP_LOSS_LIMIT\" }, function (err, resp) {\n          if (err) {\n            var errorMsg = parseApiError(err);\n            node.error(errorMsg, msg);\n            node.status({fill: \"red\", shape: \"ring\", text: errorMsg});\n             node.send(msg);\n            \n            \n          }\n          if (resp) {\n                        msg.bot.ttp.curorderid = resp.orderId;\n                        msg.bot.ttp.curstop = stopprice;\n                        msg.bot.ttp.quantity = quantity;\n                         node.send(msg);\n          }\n          node.status({}); //clear status message\n\n          \n         \n          //return;\n        })\n    \n});\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2170,"y":940,"wires":[["81dc0016.b7633"]],"inputLabels":["orderid, moneta"],"outputLabels":["status"],"icon":"font-awesome/fa-compress"},{"id":"3cfe83ca.3b1c1c","type":"debug","z":"2a761808.610238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1070,"y":780,"wires":[]},{"id":"81dc0016.b7633","type":"function","z":"2a761808.610238","name":"setbot_ttp","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    \n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nmsg.topic = msg.bot.settings.userid+\"-bots:\"+msg.bot.settings.botname+\":ttp\";\n\nmsg.payload = JSON.stringify(msg.bot.ttp);\nconst upd = global.get('setbot_ttp')(msg.topic, msg.payload);\n\n\nupd.then(upd => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"}); \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2390,"y":940,"wires":[["ca692531.aee2a8","4dfef6b5.251a18"]],"icon":"font-awesome/fa-bolt"},{"id":"a501d430.a110d8","type":"function","z":"2a761808.610238","name":"setbot_ttp","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    \n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nmsg.topic = msg.bot.settings.userid+\"-bots:\"+msg.bot.settings.botname+\":ttp\";\n\nmsg.payload = JSON.stringify(msg.bot.ttp);\nconst upd = global.get('setbot_ttp')(msg.topic, msg.payload);\n\n\nupd.then(upd => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"}); \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3510,"y":780,"wires":[["9d01f02a.6407","1cd1edd3.c1f1d2"]],"icon":"font-awesome/fa-bolt"},{"id":"d74f254.44f36d8","type":"debug","z":"2a761808.610238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1870,"y":1380,"wires":[]},{"id":"487d47c0.c7ede8","type":"debug","z":"2a761808.610238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2810,"y":1780,"wires":[]},{"id":"dd2eff30.71a16","type":"debug","z":"2a761808.610238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2230,"y":1480,"wires":[]},{"id":"e84c68c5.b035e8","type":"link in","z":"2a761808.610238","name":"","links":["14218f4f.622ba1"],"x":95,"y":940,"wires":[["dfef6495.a62e98","d968ccc2.a1915"]]},{"id":"dde31f58.2a26c","type":"debug","z":"2a761808.610238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2710,"y":1520,"wires":[]},{"id":"3b94541d.3ade6c","type":"debug","z":"2a761808.610238","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2970,"y":1380,"wires":[]},{"id":"74f15325.97e54c","type":"function","z":"2a761808.610238","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2630,"y":1340,"wires":[[]]},{"id":"f6187d73.04a34","type":"function","z":"2a761808.610238","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2790,"y":1340,"wires":[[]]},{"id":"5a4951b1.e634","type":"function","z":"2a761808.610238","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2830,"y":1460,"wires":[[]]},{"id":"14552322.e3a2fd","type":"function","z":"2a761808.610238","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2610,"y":1820,"wires":[[]]},{"id":"ab6082c3.f8b03","type":"function","z":"2a761808.610238","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2610,"y":1860,"wires":[[]]},{"id":"d398ced9.86c84","type":"function","z":"2a761808.610238","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1930,"y":860,"wires":[[]]},{"id":"905085d1.c19a78","type":"function","z":"2a761808.610238","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1870,"y":1480,"wires":[[]]},{"id":"10bdbcf7.95c573","type":"function","z":"2a761808.610238","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2970,"y":1680,"wires":[[]]},{"id":"42681553.94ba8c","type":"function","z":"2a761808.610238","name":"setbot_ttp","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    \n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nmsg.topic = msg.bot.settings.userid+\"-bots:\"+msg.bot.settings.botname+\":ttp\";\n\nmsg.payload = JSON.stringify(msg.bot.ttp);\nconst upd = global.get('setbot_ttp')(msg.topic, msg.payload);\n\n\nupd.then(upd => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"}); \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3690,"y":1860,"wires":[[]],"icon":"font-awesome/fa-bolt"},{"id":"ca692531.aee2a8","type":"debug","z":"2a761808.610238","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2430,"y":900,"wires":[]},{"id":"9d01f02a.6407","type":"debug","z":"2a761808.610238","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3530,"y":740,"wires":[]},{"id":"d36ac308.31104","type":"debug","z":"2a761808.610238","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1930,"y":940,"wires":[]},{"id":"f81dfd6c.f5b49","type":"debug","z":"2a761808.610238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2790,"y":760,"wires":[]},{"id":"459d38de.8e8938","type":"function","z":"2a761808.610238","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2110,"y":1000,"wires":[[]]},{"id":"bbbe9e0c.c04c3","type":"function","z":"2a761808.610238","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2110,"y":780,"wires":[[]]},{"id":"14be27d6.273e48","type":"function","z":"2a761808.610238","name":"ttp finish","func":"msg.bot.ttp.raschstopprice = 0;\nmsg.bot.ttp.curstop = 0;\nmsg.bot.ttp.curorderid = 0;\nmsg.bot.ttp.quantity = 0;\nmsg.bot.ttp.ttpbusy = false;\nmsg.bot.ttp.sold = false;\nmsg.bot.ttp.currentprice = 0;\n\n\nmsg.topic = msg.bot.settings.userid+\"-bots:\"+msg.bot.settings.botname+\":ttp\";\n\nmsg.payload = JSON.stringify(msg.bot.ttp);\nconst upd = global.get('setbot_ttp')(msg.topic, msg.payload);\n\n\nupd.then(upd => {\n\n    msg.topic = [];\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n\n\n    node.status({fill:\"red\",shape:\"dot\"}); \n    node.error(error);\n});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3560,"y":1740,"wires":[["d44906f6.bf8848","bcd1d88e.da80d8"]]},{"id":"d44906f6.bf8848","type":"debug","z":"2a761808.610238","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3570,"y":1700,"wires":[]},{"id":"f2c66c64.6f93a","type":"redis-out","z":"2a761808.610238","server":"f120eab2.0a60a8","command":"publish","name":"","topic":"ttp-stop","obj":true,"x":3840,"y":1820,"wires":[]},{"id":"1f502284.9a9e7d","type":"inject","z":"2a761808.610238","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":3640,"y":1800,"wires":[["f2c66c64.6f93a"]]},{"id":"73657060.c09f3","type":"function","z":"2a761808.610238","name":"update bot floors, finance","func":"const sellprice = msg.bot.ttpprice\nlet comsa = Number(msg.payload);\nlet quantityall = msg.bot.ttp.quantity;\n\nnode.warn(\"finish ttp on floor \");\n\nlet tempfin = Number(Number(msg.bot.finance.quotainorders) - Number(msg.bot.ttp.quantity));\n\nlet tempfin2 = Number(Number(msg.bot.finance.basenal) + Number(msg.bot.ttp.quantity * Number(msg.payload)));\n\nmsg.bot.finance.quotainorders = tempfin.toFixed(msg.bot.settings.digitprice);\nmsg.bot.finance.basenal = tempfin2.toFixed(msg.bot.settings.digitq);\n\nif (msg.bot.finance.baseinorders == -0) { msg.bot.finance.baseinorders = 0; }\nif (msg.bot.finance.basenal == -0) { msg.bot.finance.basenal = 0; }\n\n \n\nlet currentfloor = msg.bot.currentfloor;\n\n//обнуление всех этажей со статусом 3\n\nvar floors = msg.bot.floors;\n\n    floors.forEach(function (item, i, floors) {\n\n        if (item[7] == 3) {\n            let buyprice = item[10];\n            let quantity = Number(item[14]);\n            //msg.bot.sales.today.push((sellprice-buyprice)*quantity);\n            \n            item[7] = 0;\n            item[8] = 0;\n            item[9] = 0;\n            item[10] = 0;\n            item[11] = 0;\n            item[12] = 0;\n            item[13] = 0;\n            item[14] = 0;\n        }\n\n\n    });\n\nmsg.bot.floors = floors;\n\n\nlet volname = msg.bot.settings.userid + \"-bots:\" + msg.botname + \":data\";\nlet botdata = {\n    \"finance\": JSON.stringify(msg.bot.finance),\n    \"floors\": JSON.stringify(msg.bot.floors),\n    \"sales\": JSON.stringify(msg.bot.sales)\n\n};\n\nconst upd = global.get('setbot_data')(volname, botdata);\n\nupd.then(upd => {\n\n    msg.payload = upd;\n\n\n    node.status({ fill: \"green\", shape: \"ring\", text: \"0k\" });\n\n    node.send(msg);\n\n}).catch(error => {\n\n\n    node.status({ fill: \"red\", shape: \"ring\", text: \"error\" });\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3350,"y":1740,"wires":[["27708697.64545a","14be27d6.273e48"]],"icon":"font-awesome/fa-bolt"},{"id":"27708697.64545a","type":"debug","z":"2a761808.610238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3390,"y":1700,"wires":[]},{"id":"e4485160.d6d2d","type":"function","z":"2a761808.610238","name":"prepare get ttp order price","func":"\n\nlet moneta = msg.bot.settings.moneta;\nlet orderid = msg.bot.ttp.curorderid;\n\nmsg.payload = [];\nmsg.topic = \"orders-status-\" + msg.bot.settings.userid + \":\" + moneta + \":\" + orderid + \"-price\";\n\n\n\n\nnode.status({fill: \"green\", shape: \"ring\", text: orderid});\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3220,"y":1580,"wires":[["609e4747.ed43d8","e4dcf502.4624e8"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"609e4747.ed43d8","type":"redis-command","z":"2a761808.610238","server":"f120eab2.0a60a8","command":"GET","name":"get order status","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":3480,"y":1580,"wires":[["5363504.bb8c6b","787721f9.31529"]]},{"id":"5363504.bb8c6b","type":"function","z":"2a761808.610238","name":"prepare get ttp order comsa","func":"msg.bot.ttpprice = msg.payload;\n\nlet moneta = msg.bot.settings.moneta;\nlet orderid = msg.bot.ttp.curorderid;\n\nmsg.payload = [];\nmsg.topic = \"orders-status-\" + msg.bot.settings.userid + \":\" + moneta + \":\" + orderid + \"-comsa\";\n\n\n\n\nnode.status({fill: \"green\", shape: \"ring\", text: orderid});\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3240,"y":1640,"wires":[["60ff720b.4d65bc"]],"inputLabels":["orderid"],"outputLabels":["status"],"icon":"node-red-contrib-binance/binance.png"},{"id":"60ff720b.4d65bc","type":"redis-command","z":"2a761808.610238","server":"f120eab2.0a60a8","command":"GET","name":"get order status","topic":"msg.payload","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":3480,"y":1640,"wires":[["73657060.c09f3"]]},{"id":"e4dcf502.4624e8","type":"debug","z":"2a761808.610238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3290,"y":1540,"wires":[]},{"id":"787721f9.31529","type":"debug","z":"2a761808.610238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3510,"y":1540,"wires":[]},{"id":"e65ff6f6.027888","type":"debug","z":"2a761808.610238","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3350,"y":1820,"wires":[]},{"id":"bc452645.1f3798","type":"debug","z":"2a761808.610238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3350,"y":740,"wires":[]},{"id":"8c006fac.a924","type":"debug","z":"2a761808.610238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2590,"y":760,"wires":[]},{"id":"3b67ca17.09d026","type":"debug","z":"2a761808.610238","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2930,"y":920,"wires":[]},{"id":"f690c3ac.0028f8","type":"link out","z":"5df15275.2888ec","name":"","links":["eb783101.e13f08"],"x":1495,"y":3240,"wires":[]},{"id":"1cd1edd3.c1f1d2","type":"link out","z":"2a761808.610238","name":"","links":["ccd55cdb.7ed72"],"x":3695,"y":760,"wires":[]},{"id":"c5493216.68ad1","type":"link out","z":"2a761808.610238","name":"","links":["ccd55cdb.7ed72"],"x":3135,"y":880,"wires":[]},{"id":"4dfef6b5.251a18","type":"link out","z":"2a761808.610238","name":"","links":["ccd55cdb.7ed72"],"x":2575,"y":940,"wires":[]},{"id":"1d26132c.06016d","type":"link out","z":"2a761808.610238","name":"","links":["ccd55cdb.7ed72"],"x":2595,"y":1420,"wires":[]},{"id":"b0d5adc0.69eab","type":"link out","z":"2a761808.610238","name":"","links":["ccd55cdb.7ed72"],"x":3015,"y":1500,"wires":[]},{"id":"4b4fa1ce.2d444","type":"link out","z":"2a761808.610238","name":"","links":["ccd55cdb.7ed72"],"x":2535,"y":1680,"wires":[]},{"id":"bcd1d88e.da80d8","type":"link out","z":"2a761808.610238","name":"","links":["ccd55cdb.7ed72"],"x":3835,"y":1660,"wires":[]},{"id":"d968ccc2.a1915","type":"function","z":"2a761808.610238","name":"getbot_settings","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nlet bot = {};\nmsg.bot = bot;\nconst gb = global.get('getbot_settings')(msg.botname);\n\ngb.then(gb => {\n    \n    msg.bot.settings = JSON.parse(gb);\n    \n        //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    \n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"});\n    \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":220,"y":940,"wires":[["31599a11.e73036"]]},{"id":"b725a5cd.6eb798","type":"function","z":"2a761808.610238","name":"getbot_ttp","func":"\nconst gb = global.get('getbot_ttp')(msg.bot.settings.botname);\n\ngb.then(gb => {\n    msg.bot.ttp = JSON.parse(gb);\n    \nnode.status({fill: \"green\", shape: \"ring\"});\n\n    node.send(msg);\n\n}).catch(error => {\n    \n    \n    node.status({fill: \"red\", shape: \"ring\", text: \"error\"});\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":570,"y":940,"wires":[["8cc76823.4b4e68","101ffeb5.6d8b01"]]},{"id":"91267b22.6af548","type":"switch","z":"2a761808.610238","name":"quantity > 0","property":"bot.ttp.quantity","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"gt","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1540,"y":860,"wires":[["db26ef3b.7f5f6","8db98543.8bf858"],["d9cd8b69.9e4298"]]},{"id":"db26ef3b.7f5f6","type":"link out","z":"2a761808.610238","name":"","links":["ccd55cdb.7ed72"],"x":1695,"y":780,"wires":[]},{"id":"101ffeb5.6d8b01","type":"debug","z":"2a761808.610238","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":610,"y":860,"wires":[]},{"id":"31599a11.e73036","type":"function","z":"2a761808.610238","name":"getbot_data","func":"\nlet botname = msg.botname;\n\nconst gb = global.get('getbot_data')(botname);\n\ngb.then(gb => {\n    //node.warn(gb);\n    let bot = {...msg.bot,\n        \"floors\":JSON.parse(gb.floors),\n        \"finance\":JSON.parse(gb.finance),\n        \"sales\":JSON.parse(gb.sales)\n    };\n    msg.bot = bot;\n    node.send(msg);\n\n}).catch(error => {\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":410,"y":940,"wires":[["b725a5cd.6eb798"]]},{"id":"2f9f396e.884876","type":"function","z":"2a761808.610238","name":"setttp_q 0","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    \n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nmsg.topic = msg.bot.settings.userid+\"-bots:\"+msg.bot.settings.botname+\":ttpq\";\nmsg.payload = \"0\";\nconst upd = global.get('set_ttp_q')(msg.topic, msg.payload);\n\n\nupd.then(upd => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill:\"red\",shape:\"dot\"}); \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1240,"y":940,"wires":[["91267b22.6af548"]],"icon":"font-awesome/fa-bolt"},{"id":"8db98543.8bf858","type":"function","z":"2a761808.610238","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1710,"y":720,"wires":[[]]},{"id":"e890ca44.273da8","type":"function","z":"2a761808.610238","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2890,"y":460,"wires":[[]]},{"id":"ccbca6c6.392f58","type":"function","z":"2a761808.610238","name":"tester","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: last_node_end_time});\n    \n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2430,"y":400,"wires":[[]]},{"id":"11f5815b.2198c7","type":"debug","z":"5df15275.2888ec","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2230,"y":780,"wires":[]},{"id":"7417b1f3.5548","type":"function","z":"5df15275.2888ec","g":"5b21035.9c9f6fc","name":"prepare for add floors","func":"let botname = msg.payload.settings.botname;\n\nbotname = botname.split('-').join('');\n\nlet timestamp = new Date().getTime();\n\nmsg.column_name = [\"timestamp\",\"column1\",\"column2\",\"column3\"];\nmsg.column_sort = [timestamp, 5,\"Text\",8];\nmsg.database = botname;\nmsg.command = \"insert\";\n\nnode.status({fill:\"green\",shape:\"dot\"});\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":4440,"y":1940,"wires":[["aba256c7.c8362","d65790eb.cb2978"]]},{"id":"5602a224.0e7904","type":"sqlite","z":"5df15275.2888ec","g":"5b21035.9c9f6fc","mydb":"654fe96.8349098","sqlquery":"msg.topic","sql":"","name":"db","x":4630,"y":1940,"wires":[["35ea30c8.7cd8b8"]]},{"id":"35ea30c8.7cd8b8","type":"debug","z":"5df15275.2888ec","g":"5b21035.9c9f6fc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4750,"y":1940,"wires":[]},{"id":"aba256c7.c8362","type":"sql-prepare","z":"5df15275.2888ec","name":"","x":4500,"y":2040,"wires":[["5602a224.0e7904"]]},{"id":"d65790eb.cb2978","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4310,"y":2040,"wires":[]},{"id":"231989f1.7a0efe","type":"function","z":"5f98db3a.7ab21c","name":"set_buy_order()","func":"","outputs":1,"noerr":0,"initialize":"let guid = global.get('guid');\n\n\nlet set_buy_order = function (volname = msg.topic, data = msg.payload) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n\n    msg.topic = volname;\n    msg.payload = data;\n\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('set_buy_order', set_buy_order);","finalize":"","x":1400,"y":80,"wires":[["aa73240b.b25d98"]]},{"id":"25f57e72.c9eb0a","type":"inject","z":"5f98db3a.7ab21c","name":"botname","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":1220,"y":80,"wires":[["231989f1.7a0efe"]]},{"id":"caeb9ab1.ee6bb","type":"function","z":"5f98db3a.7ab21c","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":1780,"y":80,"wires":[]},{"id":"aa73240b.b25d98","type":"redis-command","z":"5f98db3a.7ab21c","server":"f120eab2.0a60a8","command":"hmset","name":"","topic":"","params":"[]","paramsType":"json","payloadType":"json","block":false,"x":1590,"y":80,"wires":[["caeb9ab1.ee6bb"]]},{"id":"4b4af36b.c4905c","type":"inject","z":"5f98db3a.7ab21c","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1960,"y":80,"wires":[["6f360750.44fe08"]]},{"id":"6f360750.44fe08","type":"function","z":"5f98db3a.7ab21c","name":"","func":"let t = \"qqq\";\nlet p = {q:1,a:2};\nconst gbl = global.get('set_buy_order')(t,p);\n\ngbl.then(gbl => {\n    \n\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n    \n\n    node.status({fill:\"red\",shape:\"dot\"});\n    \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2110,"y":80,"wires":[["ba20ff78.d1b0a"]]},{"id":"ba20ff78.d1b0a","type":"debug","z":"5f98db3a.7ab21c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":2300,"y":80,"wires":[]},{"id":"387fcf8a.76cff","type":"function","z":"5f98db3a.7ab21c","name":"order_exec()","func":"","outputs":1,"noerr":0,"initialize":"let guid = global.get('guid');\n\n\nlet order_exec = function (cmd = msg.topic, data = msg.payload) {\n    \n    let promise = new Promise((resolve, reject) => {\n        msg.resolve = resolve;\n        msg.reject = reject;\n    });\n    \n\n    msg.topic = cmd;\n    msg.payload = data;\n    msg.bot = data.bot;\n    node.send(Object.assign({}, msg));\n    \n    return promise;\n};\n\nglobal.set('order_exec', order_exec);","finalize":"","x":290,"y":240,"wires":[["ac3992bd.d4dd5"]]},{"id":"c985b525.212f78","type":"inject","z":"5f98db3a.7ab21c","name":"cmd, data, bot","props":[],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":120,"y":240,"wires":[["387fcf8a.76cff"]]},{"id":"2bed7653.30adaa","type":"function","z":"5f98db3a.7ab21c","name":"resolve","func":"msg.resolve(msg.payload);\n\n// reject\n// setTimeout(function () {\n//     msg.reject({message: 'Could not request joke'});\n// }, 2000);","outputs":"0","noerr":0,"initialize":"","finalize":"","x":580,"y":240,"wires":[]},{"id":"56d868a8.14442","type":"function","z":"5f98db3a.7ab21c","name":"","func":"let t = \"qqqq\";\nlet p = {q:3,a:4};\nconst gbl = global.get('set_buy_order')(t,p);\n\ngbl.then(gbl => {\n    \n\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n    \n\n    node.status({fill:\"red\",shape:\"dot\"});\n    \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1500,"y":120,"wires":[[]]},{"id":"53f55eaa.16e338","type":"inject","z":"5f98db3a.7ab21c","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"bot","v":"ww","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1360,"y":1040,"wires":[["a9098e38.7393"]]},{"id":"ae951733.066bd","type":"function","z":"5f98db3a.7ab21c","name":"orderexec","func":"let cmd = \"setbuy\";\nlet data = {moneta:\"BNBSDT\", price: \"281.2\", quantity: 0.11, bot: msg.bot};\nconst gbl = global.get('order_exec')(cmd,data);\n\ngbl.then(gbl => {\n    msg.gbl = gbl;\n    if (gbl.statusCode === \"ok\"){\n        node.status({fill:\"green\",shape:\"dot\", text: gbl.statusBody.orderId});\n    node.send(msg);\n    } else {\n        node.status({fill:\"red\",shape:\"dot\"});\n        node.send(msg);\n    }\n    \n\n}).catch(error => {\n    \n    msg.error = error;\n    node.status({fill:\"red\",shape: \"ring\"});\n    \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1680,"y":1040,"wires":[["c5e0a09d.da0f6"]]},{"id":"c5e0a09d.da0f6","type":"debug","z":"5f98db3a.7ab21c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1850,"y":1040,"wires":[]},{"id":"ade3bf55.b02e3","type":"switch","z":"5f98db3a.7ab21c","name":"cmd","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"setbuy","vt":"str"},{"t":"eq","v":"cansel","vt":"str"},{"t":"eq","v":"setsell","vt":"str"},{"t":"eq","v":"marketsell","vt":"str"},{"t":"eq","v":"marketbuy","vt":"str"}],"checkall":"true","repair":false,"outputs":5,"x":1000,"y":340,"wires":[["2cfa357e.60327a"],["84990bf8.e9db8"],["40b91664.72912"],["cc5b16dd.4820c8"],["46152e90.390ef8"]]},{"id":"9606b8d3.0957","type":"comment","z":"5f98db3a.7ab21c","name":"setbuy","info":"","x":1270,"y":240,"wires":[]},{"id":"2cfa357e.60327a","type":"function","z":"5f98db3a.7ab21c","name":"set buy order on binance","func":"\nfunction parseApiError(error) {\n  if (error.body) {\n    try {\n      var resp = JSON.parse(error.body);\n      return resp.msg;\n    } catch (error) {/* pass thru */}\n  }\n  return \"Unknown error. Status code: \"+error.statsCode;\n}\n\nlet LBinance = global.get('gBinance');\n//node.warn(LBinance);\nlet key = global.get('key');\nlet secret = global.get('secret');\n\n\nlet binance = new LBinance().options({\n\tAPIKEY: key,\n\tAPISECRET: secret,\n\tuseServerTime: true,\n\tadjustForTimeDifference: true \n});\n\n\n\n\nlet moneta = msg.payload.moneta;\nlet quantity = Number(msg.payload.quantity);\nlet price = Number(msg.payload.price);\nnode.warn(moneta+\" set buy order q = \"+quantity+\" p = \"+price);\n\n\n\n\nbinance.useServerTime(function() {\n    binance.buy(moneta, quantity, price, {type:'LIMIT'}, (err, resp) => {\n // console.info(\"Limit Buy response\", response);\n // console.info(\"order id: \" + response.orderId);\n    if (err) {\n        var errorMsg = parseApiError(err) + \", moneta:\" + moneta;\n        node.error(errorMsg, msg);\n\n        msg.err = err;\n        node.status({fill: \"red\", shape: \"ring\", text: errorMsg});\n        \n        node.send(msg);\n        //return [msg, null];\n    \n    }\n    if (resp) {\n        msg.orderid = resp.orderId;\n        msg.resp = resp;\n        node.status({fill: \"green\", shape: \"ring\", text: resp.orderId});\n        \n        node.send(msg);\n       // return [null,msg];\n                \n    }\n    //node.status({}); //clear status message\n});\n\t\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1450,"y":240,"wires":[["c795560e.e0ffe8","be53914b.bf62b"]]},{"id":"84990bf8.e9db8","type":"function","z":"5f98db3a.7ab21c","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1400,"y":300,"wires":[[]]},{"id":"40b91664.72912","type":"function","z":"5f98db3a.7ab21c","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1400,"y":360,"wires":[[]]},{"id":"cc5b16dd.4820c8","type":"function","z":"5f98db3a.7ab21c","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1400,"y":420,"wires":[[]]},{"id":"46152e90.390ef8","type":"function","z":"5f98db3a.7ab21c","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1400,"y":480,"wires":[[]]},{"id":"df242fa3.762dc","type":"comment","z":"5f98db3a.7ab21c","name":"cansel","info":"","x":1270,"y":300,"wires":[]},{"id":"f8fb32fa.8c38e","type":"comment","z":"5f98db3a.7ab21c","name":"setsell","info":"","x":1270,"y":360,"wires":[]},{"id":"7fc0c8c6.6d262","type":"comment","z":"5f98db3a.7ab21c","name":"marketsell","info":"","x":1260,"y":420,"wires":[]},{"id":"594b48ef.1a0e68","type":"comment","z":"5f98db3a.7ab21c","name":"marketbuy","info":"","x":1260,"y":480,"wires":[]},{"id":"c795560e.e0ffe8","type":"debug","z":"5f98db3a.7ab21c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1510,"y":200,"wires":[]},{"id":"8eca3137.03e0a8","type":"switch","z":"5f98db3a.7ab21c","name":"work mode","property":"workmode","propertyType":"msg","rules":[{"t":"eq","v":"binance","vt":"str"},{"t":"eq","v":"binance_backtest","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":710,"y":520,"wires":[["ade3bf55.b02e3"],["72c134ed.8f07cc"]]},{"id":"8af21b87.015cb","type":"comment","z":"5f98db3a.7ab21c","name":"binance","info":"","x":840,"y":480,"wires":[]},{"id":"90c4f7da.42c3b8","type":"comment","z":"5f98db3a.7ab21c","name":"binance_backtest","info":"","x":870,"y":560,"wires":[]},{"id":"ac3992bd.d4dd5","type":"function","z":"5f98db3a.7ab21c","name":"get workmode","func":"let workmode = global.get('workmode');\nmsg.workmode = workmode;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":520,"y":520,"wires":[["8eca3137.03e0a8","4cfd5bbd.59f8dc"]]},{"id":"1adeb6d2.0028b1","type":"function","z":"5f98db3a.7ab21c","g":"79e296b2.11a2d8","name":"register work mode","func":"let key = msg.payload;\n\nglobal.set('workmode',key);\n\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":350,"y":80,"wires":[["9a835f6c.6a1ab"]]},{"id":"174c55c9.364c72","type":"inject","z":"5f98db3a.7ab21c","g":"79e296b2.11a2d8","name":"workmode","props":[{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"binance","payloadType":"str","x":130,"y":60,"wires":[["1adeb6d2.0028b1"]]},{"id":"af87984e.38efa8","type":"ui_button","z":"5f98db3a.7ab21c","g":"79e296b2.11a2d8","name":"","group":"261e447.e94ad3c","order":1,"width":0,"height":0,"passthru":false,"label":"binance","tooltip":"","color":"","bgcolor":"","icon":"","payload":"binance","payloadType":"str","topic":"","x":100,"y":100,"wires":[["1adeb6d2.0028b1"]]},{"id":"af6bd09e.c7c798","type":"ui_button","z":"5f98db3a.7ab21c","g":"79e296b2.11a2d8","name":"","group":"261e447.e94ad3c","order":1,"width":0,"height":0,"passthru":false,"label":"binance_backtest","tooltip":"","color":"","bgcolor":"","icon":"","payload":"binance_backtest","payloadType":"str","topic":"","x":130,"y":140,"wires":[["1adeb6d2.0028b1"]]},{"id":"9a835f6c.6a1ab","type":"ui_text","z":"5f98db3a.7ab21c","g":"79e296b2.11a2d8","group":"261e447.e94ad3c","order":2,"width":0,"height":0,"name":"","label":"mode now","format":"{{msg.payload}}","layout":"row-spread","x":550,"y":80,"wires":[]},{"id":"4cfd5bbd.59f8dc","type":"debug","z":"5f98db3a.7ab21c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":550,"y":480,"wires":[]},{"id":"d91e5b6e.e583c","type":"function","z":"5f98db3a.7ab21c","name":"","func":"let t = \"qqqq\";\nlet p = {q:3,a:4};\nconst gbl = global.get('set_buy_order')(t,p);\n\ngbl.then(gbl => {\n    \n\n    node.status({fill:\"green\",shape:\"dot\"});\n    node.send(msg);\n\n}).catch(error => {\n    \n\n    node.status({fill:\"red\",shape:\"dot\"});\n    \n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1820,"y":620,"wires":[[]]},{"id":"72c134ed.8f07cc","type":"switch","z":"5f98db3a.7ab21c","name":"cmd","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"setbuy","vt":"str"},{"t":"eq","v":"cansel","vt":"str"},{"t":"eq","v":"setsell","vt":"str"},{"t":"eq","v":"marketsell","vt":"str"},{"t":"eq","v":"marketbuy","vt":"str"}],"checkall":"true","repair":false,"outputs":5,"x":1000,"y":720,"wires":[["d9e1bbad.d8dc4"],["7d460277.6d43cc"],["83dab1d2.d3929"],["c2ee13d8.13fab8"],["4fd27ca5.37d60c"]]},{"id":"937d8df0.8d461","type":"comment","z":"5f98db3a.7ab21c","name":"setbuy","info":"","x":1270,"y":620,"wires":[]},{"id":"d9e1bbad.d8dc4","type":"function","z":"5f98db3a.7ab21c","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1400,"y":620,"wires":[["f6791e2.e72656"]]},{"id":"7d460277.6d43cc","type":"function","z":"5f98db3a.7ab21c","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1400,"y":680,"wires":[["4b18cb02.0baa0c"]]},{"id":"83dab1d2.d3929","type":"function","z":"5f98db3a.7ab21c","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1400,"y":740,"wires":[["2827f6dd.5c7162"]]},{"id":"c2ee13d8.13fab8","type":"function","z":"5f98db3a.7ab21c","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1400,"y":800,"wires":[["5f7186a8.0ea498"]]},{"id":"4fd27ca5.37d60c","type":"function","z":"5f98db3a.7ab21c","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1400,"y":860,"wires":[["e5d314a7.f6825"]]},{"id":"8044def5.ed945","type":"comment","z":"5f98db3a.7ab21c","name":"cansel","info":"","x":1270,"y":680,"wires":[]},{"id":"f52a6bcf.7d3728","type":"comment","z":"5f98db3a.7ab21c","name":"setsell","info":"","x":1270,"y":740,"wires":[]},{"id":"fa849ff6.802878","type":"comment","z":"5f98db3a.7ab21c","name":"marketsell","info":"","x":1260,"y":800,"wires":[]},{"id":"f38ba797.bdd398","type":"comment","z":"5f98db3a.7ab21c","name":"marketbuy","info":"","x":1260,"y":860,"wires":[]},{"id":"f6791e2.e72656","type":"debug","z":"5f98db3a.7ab21c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1610,"y":620,"wires":[]},{"id":"4b18cb02.0baa0c","type":"debug","z":"5f98db3a.7ab21c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1610,"y":680,"wires":[]},{"id":"2827f6dd.5c7162","type":"debug","z":"5f98db3a.7ab21c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1610,"y":740,"wires":[]},{"id":"5f7186a8.0ea498","type":"debug","z":"5f98db3a.7ab21c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1610,"y":800,"wires":[]},{"id":"e5d314a7.f6825","type":"debug","z":"5f98db3a.7ab21c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1610,"y":860,"wires":[]},{"id":"be53914b.bf62b","type":"function","z":"5f98db3a.7ab21c","name":"обработчик ошибок","func":"if (msg.err) {\n    msg.payload.statusCode = \"not ok\";\n    msg.payload.statusBody = msg.err.body;\n    //node.warn(msg.err.statusCode)\n    return [null,msg];\n} else {\n    msg.payload.statusCode = \"ok\";\n    msg.payload.statusBody = msg.resp;\n    return [msg,null];\n}\n\n\n\n","outputs":2,"noerr":0,"initialize":"","finalize":"","x":1700,"y":240,"wires":[["980f6440.f26b68","53332eac.962be"],["23e4ce30.03554a","c0b46394.7bd6e"]]},{"id":"980f6440.f26b68","type":"debug","z":"5f98db3a.7ab21c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1750,"y":200,"wires":[]},{"id":"53332eac.962be","type":"function","z":"5f98db3a.7ab21c","name":"change floors, finance ","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\n\nlet currentfloor = msg.bot.currentfloor;\ncurrentfloor[7] = 1;\ncurrentfloor[8] = msg.resp.orderId;\ncurrentfloor[14] = msg.resp.origQty;\n\nmsg.bot.floors[currentfloor[0]-1] = currentfloor;\n\nmsg.bot.finance.baseinorders = (Number(Number(msg.bot.finance.baseinorders) + Number(msg.resp.origQty) * Number(msg.resp.price))).toFixed(msg.bot.settings.digitprice);\nmsg.bot.finance.basenal = (Number(Number(msg.bot.finance.basenal) - Number(msg.resp.origQty) * Number(msg.resp.price))).toFixed(msg.bot.settings.digitprice);\n\n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\nnode.status({fill: \"green\", shape: \"ring\", text: currentfloor[0]});\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1980,"y":220,"wires":[["a4f775c6.77bf78"]]},{"id":"a4f775c6.77bf78","type":"function","z":"5f98db3a.7ab21c","name":"update bot floors, finance","func":"//<трекер<\n    let track = flow.get(\"track\");\n    let start_node_time = new Date().getTime();\n    let steptitle = node.name;\n\n    let laststep = track[track.length-1];\n    let last_node_end_time = laststep.end_node_time;\n//>трекер>\nlet volname = msg.bot.settings.userid+\"-bots:\"+msg.botname+\":data\";\nlet botdata = {\n    \"finance\":JSON.stringify(msg.bot.finance),\n    \"floors\":JSON.stringify(msg.bot.floors),\n    \"sales\":JSON.stringify(msg.bot.sales)\n    \n};\n\nconst upd = global.get('setbot_data')(volname, botdata);\n\nupd.then(upd => {\n    \n    msg.payload = upd;\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle,\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration_node\": duration,\n            \"duration_step\": duration_step\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill: \"green\", shape: \"ring\"});\n    \n    node.send(msg);\n\n}).catch(error => {\n    \n    //>трекер>\n        let end_node_time = new Date().getTime();\n        let duration = end_node_time - start_node_time;\n        let duration_step = end_node_time - last_node_end_time;\n        track.push({\n            \"steptitle\": steptitle+\"-faile\",\n            \"start_node_time\": start_node_time,\n            \"end_node_time\": end_node_time,\n            \"duration\": duration,\n            \"duration_step\": duration_step,\n            \"error\": error\n        });\n        flow.set(\"track\", track);\n    //>трекер>\n    node.status({fill: \"red\", shape: \"ring\", text: \"error\"});\n    node.error(error);\n});","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2230,"y":220,"wires":[["563d14b6.3a5db4"]],"icon":"font-awesome/fa-bolt"},{"id":"9dd3d4e2.3685e8","type":"debug","z":"5df15275.2888ec","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1430,"y":1780,"wires":[]},{"id":"a9098e38.7393","type":"function","z":"5f98db3a.7ab21c","name":"","func":"msg.bot = {\"settings\":{\"botname\":\"LINKDOWNUSDT-1626469485\",\"isrunning\":false,\"handyzapretnazakup\":false,\"comment\":null,\"quotacoin\":\"LINKDOWN\",\"basecoin\":\"USDT\",\"moneta\":\"LINKDOWNUSDT\",\"digitq\":\"2\",\"digitprice\":\"4\",\"minprice\":\"0.2\",\"maxprice\":\"0.4\",\"profitproc\":\"0.8\",\"ordersize\":\"20\",\"ofsetbottom\":\"0.1\",\"ofsettop\":\"0.5\",\"ma1\":3,\"ma2\":30,\"maxpriceforzakup\":null,\"minpriceforzakup\":null,\"userid\":\"d3fmoh2rVoVNgIcpLTFZBE0jHnI2\"},\"status\":{\"currentprice\":\"0.32970000\",\"lastprice\":-1,\"currentfloor\":33,\"lastfloor\":-1,\"sr_ma_big\":-1,\"sr_ma_small\":-1,\"rezhim\":\"МА - закуп разрешен\",\"updated\":1626469645844},\"zapret_na_zakup\":false,\"floors\":[[1,0.2,0.2031,0.20020000000000002,0.2005,0.2015,0.20210000000000003,0,0,0,0,0,0,0,0],[2,0.2031,0.20624805000000002,0.20330310000000001,0.20360775,0.20462325,0.20523255,0,0,0,0,0,0,0,0],[3,0.20624805000000002,0.20944489477500003,0.20645429805,0.20676367012500002,0.20779491037500003,0.20841365452500002,0,0,0,0,0,0,0,0],[4,0.20944489477500003,0.21269129064401254,0.20965433966977504,0.20996850701193753,0.21101573148581254,0.21164406617013753,0,0,0,0,0,0,0,0],[5,0.21269129064401254,0.21598800564899473,0.21290398193465657,0.2132230188706226,0.21428647532384265,0.2149245491957747,0,0,0,0,0,0,0,0],[6,0.21598800564899473,0.21933581973655414,0.2162039936546437,0.2165279756631172,0.21760791569136217,0.21825587970830918,0,0,0,0,0,0,0,0],[7,0.21933581973655414,0.22273552494247073,0.21955515555629068,0.21988415928589553,0.2209808383845783,0.22163884584378796,0,0,0,0,0,0,0,0],[8,0.22273552494247073,0.22618792557907902,0.2229582604674132,0.22329236375482692,0.22440604137953926,0.22507424795436667,0,0,0,0,0,0,0,0],[9,0.22618792557907902,0.22969383842555474,0.2264141135046581,0.22675339539302672,0.22788433502092212,0.22856289879765934,0,0,0,0,0,0,0,0],[10,0.22969383842555474,0.23325409292115085,0.2299235322639803,0.23026807302161864,0.2314165422137464,0.23210562372902308,0,0,0,0,0,0,0,0],[11,0.23325409292115085,0.2368695313614287,0.233487347014072,0.23383722815345373,0.2350034986180595,0.23570326089682295,0,0,0,0,0,0,0,0],[12,0.2368695313614287,0.24054100909753084,0.23710640089279011,0.23746170518983226,0.2386460528466394,0.23935666144072368,0,0,0,0,0,0,0,0],[13,0.24054100909753084,0.24426939473854256,0.24078155010662838,0.2411423616202747,0.24234506666576236,0.24306668969305492,0,0,0,0,0,0,0,0],[14,0.24426939473854256,0.24805557035698997,0.2445136641332811,0.2448800682253889,0.24610141519908163,0.24683422338329725,0,0,0,0,0,0,0,0],[15,0.24805557035698997,0.2519004316975233,0.24830362592734695,0.24867570928288243,0.2499159871346674,0.25066015384573836,0,0,0,0,0,0,0,0],[16,0.2519004316975233,0.2558048883888349,0.25215233212922084,0.25253018277676714,0.2537896849352548,0.2545453862303473,0,0,0,0,0,0,0,0],[17,0.2558048883888349,0.25976986415886183,0.25606069327722375,0.256444400609807,0.25772342505175116,0.25849083971691766,0,0,0,0,0,0,0,0],[18,0.25976986415886183,0.2637962970533242,0.2600296340230207,0.260419288819259,0.26171813814005335,0.2624974477325299,0,0,0,0,0,0,0,0],[19,0.2637962970533242,0.2678851396576507,0.2640600933503775,0.26445578779595746,0.26577476928122407,0.2665661581723841,0,0,0,0,0,0,0,0],[20,0.2678851396576507,0.2720373593223443,0.26815302479730835,0.26855485250679484,0.2698942782050831,0.27069793362405603,0,0,0,0,0,0,0,0],[21,0.2720373593223443,0.27625393839184065,0.27230939668166665,0.2727174527206502,0.2740776395172619,0.27489375159522894,0,0,0,0,0,0,0,0],[22,0.27625393839184065,0.2805358744369142,0.2765301923302325,0.2769445732378203,0.2783258429297795,0.279154604744955,0,0,0,0,0,0,0,0],[23,0.2805358744369142,0.28488418049068637,0.28081641031135113,0.2812372141230065,0.2826398934951911,0.2834815011185018,0,0,0,0,0,0,0,0],[24,0.28488418049068637,0.289299885288292,0.28516906467117703,0.2855963909419131,0.2870208118443665,0.28787546438583855,0,0,0,0,0,0,0,0],[25,0.289299885288292,0.2937840335102605,0.2895891851735803,0.2900231350015127,0.2914696344279542,0.2923375340838191,0,0,0,0,0,0,0,0],[26,0.2937840335102605,0.29833768602966954,0.29407781754377077,0.29451849359403615,0.29598741376158744,0.29686876586211824,0,0,0,0,0,0,0,0],[27,0.29833768602966954,0.3029619201631294,0.2986360237156992,0.2990835302447437,0.30057521867489206,0.30147023173298104,0,0,0,0,0,0,0,0],[28,0.3029619201631294,0.3076578299256579,0.3032648820832925,0.3037193249635372,0.30523413456435283,0.30614302032484225,0,0,0,0,0,0,0,0],[29,0.3076578299256579,0.31242652628950557,0.3079654877555835,0.308426974500472,0.3099652636501003,0.3108882371398773,0,0,0,0,0,0,0,0],[30,0.31242652628950557,0.3172691374469929,0.31273895281579506,0.3132075926052293,0.31476972523667685,0.31570700481554537,0,0,0,0,0,0,0,0],[31,0.3172691374469929,0.3221868090774213,0.31758640658443993,0.31806231029061044,0.3196486559778454,0.3206004633901864,0,0,0,0,0,0,0,0],[32,0.3221868090774213,0.3271807046181213,0.32250899588649873,0.3229922761001149,0.324603210145502,0.32556977057273423,0,0,0,0,0,0,0,0],[33,0.3271807046181213,0.3322520055397022,0.32750788532273944,0.32799865637966663,0.32963455990275725,0.3306161020166116,0,0,0,0,0,0,0,0],[34,0.3322520055397022,0.3374019116255676,0.3325842575452419,0.33308263555355144,0.33474389558124995,0.3357406515978691,0,0,0,0,0,0,0,0],[35,0.3374019116255676,0.3426316412557639,0.33773931353719316,0.3382454164046315,0.33993242596275935,0.34094463169763606,0,0,0,0,0,0,0,0],[36,0.3426316412557639,0.34794243169522826,0.34297427289701965,0.3434882203589033,0.3452013785651821,0.3462292734889494,0,0,0,0,0,0,0,0],[37,0.34794243169522826,0.3533355393865043,0.3482903741269235,0.3488122877744663,0.35055199993294245,0.3515958272280282,0,0,0,0,0,0,0,0],[38,0.3533355393865043,0.3588122402469951,0.3536888749258908,0.35421887823497056,0.35598555593190306,0.3570455625500626,0,0,0,0,0,0,0,0],[39,0.3588122402469951,0.3643738299708235,0.35917105248724207,0.35970927084761256,0.36150333204884755,0.36257976876958853,0,0,0,0,0,0,0,0],[40,0.3643738299708235,0.3700216243353713,0.36473820380079436,0.3652847645457506,0.3671066336956047,0.3681997551855172,0,0,0,0,0,0,0,0],[41,0.3700216243353713,0.37575695951256954,0.37039164595970664,0.3709466783962097,0.37279678651788656,0.3739068513908927,0,0,0,0,0,0,0,0],[42,0.37575695951256954,0.38158119238501437,0.37613271647208213,0.376696351911351,0.37857513670891385,0.37970240758745155,0,0,0,0,0,0,0,0],[43,0.38158119238501437,0.3874957008669821,0.3819627735773994,0.3825351453659769,0.38444305132790196,0.385587794905057,0,0,0,0,0,0,0,0],[44,0.3874957008669821,0.3935018842304203,0.3878831965678491,0.38846444011914955,0.39040191862348445,0.3915644057260854,0,0,0,0,0,0,0,0],[45,0.3935018842304203,0.39960116343599184,0.39389538611465075,0.39448563894099636,0.39645314836214846,0.39763365401483974,0,0,0,0,0,0,0,0],[46,0.39960116343599184,0.4057949814692497,0.40000076459942785,0.40060016634458184,0.4025981721617618,0.4037969756520698,0,0,0,0,0,0,0,0]],\"finance\":{\"startdepo\":\"80\",\"depo\":\"80\",\"quotanal\":0,\"quotainorders\":0,\"basenal\":\"80\",\"baseinorders\":0,\"profittoday\":0},\"sales\":{\"today\":[],\"days\":[],\"all\":[]},\"currentfloor\":[33,0.3271807046181213,0.3322520055397022,0.32750788532273944,0.32799865637966663,0.32963455990275725,0.3306161020166116,0,0,0,0,0,0,0,0]};\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1500,"y":1080,"wires":[["ae951733.066bd"]]},{"id":"5a624a9b.734534","type":"link in","z":"5f98db3a.7ab21c","name":"","links":["563d14b6.3a5db4","c0b46394.7bd6e"],"x":475,"y":240,"wires":[["2bed7653.30adaa"]]},{"id":"563d14b6.3a5db4","type":"link out","z":"5f98db3a.7ab21c","name":"","links":["5a624a9b.734534"],"x":2385,"y":220,"wires":[]},{"id":"23e4ce30.03554a","type":"debug","z":"5f98db3a.7ab21c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1990,"y":260,"wires":[]},{"id":"c0b46394.7bd6e","type":"link out","z":"5f98db3a.7ab21c","name":"","links":["5a624a9b.734534"],"x":1895,"y":260,"wires":[]}]